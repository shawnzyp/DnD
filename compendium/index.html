<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compendium</title>
  <link rel="stylesheet" href="/css/theme.css" />
  <script src="/js/loader.js" defer></script>
  <style>
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--color-bg-alt);
      color: var(--color-text);
    }
    header {
      position: sticky;
      top: 0;
      padding: 1rem 1.25rem 0.75rem;
      background: linear-gradient(180deg, var(--scrim-strong) 0%, var(--scrim-soft) 60%, transparent 100%);
      backdrop-filter: blur(18px);
      z-index: 3;
    }
    h1 {
      margin: 0 0 0.5rem;
      font-size: 1.35rem;
    }
    .pack-meta {
      margin: 0;
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }
    .search-shell {
      display: grid;
      gap: 0.6rem;
      margin-top: 0.5rem;
    }
    .search-shell label {
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }
    .search-shell input[type="search"] {
      width: 100%;
      padding: 0.85rem 1rem;
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      color: inherit;
      font-size: 1rem;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding-bottom: 0.35rem;
    }
    .chip {
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      color: var(--color-text-muted);
      font-size: 0.78rem;
      letter-spacing: 0.02em;
      transition: background 160ms ease, color 160ms ease, border-color 160ms ease;
    }
    .chip[aria-pressed="true"] {
      background: var(--color-accent-soft);
      border-color: var(--color-accent-border);
      color: var(--color-text);
      font-weight: 600;
    }
    main {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    #list-viewport {
      flex: 1;
      overflow-y: auto;
      padding: 0 0.75rem 6rem;
    }
    .virtual-list {
      position: relative;
    }
    .virtual-row {
      position: absolute;
      left: 0;
      right: 0;
      padding: 0.75rem 0.5rem;
    }
    .entry {
      border-radius: 0.9rem;
      padding: 0.85rem 1rem;
      background: var(--color-surface-raised);
      border: 1px solid var(--color-border);
      display: grid;
      gap: 0.4rem;
      box-shadow: var(--shadow-elevated);
    }
    .entry h3 {
      margin: 0;
      font-size: 1rem;
    }
    .entry small {
      color: var(--color-text-muted);
      font-size: 0.8rem;
    }
    .entry p {
      margin: 0;
    }
    .entry-summary {
      color: var(--color-text-subtle);
      font-size: 0.82rem;
    }
    .entry button {
      justify-self: flex-start;
      padding: 0.45rem 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      color: inherit;
      font-size: 0.8rem;
    }
    #detail-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface-raised);
      border-radius: 1.1rem 1.1rem 0 0;
      border-top: 1px solid var(--color-border-strong);
      padding: 1rem 1.25rem calc(env(safe-area-inset-bottom) + 1.25rem);
      transform: translateY(100%);
      transition: transform 220ms ease;
      max-height: 65vh;
      overflow-y: auto;
      box-shadow: var(--shadow-floating);
      z-index: 5;
      pointer-events: none;
      visibility: hidden;
    }
    #detail-drawer.open {
      transform: translateY(0);
      pointer-events: auto;
      visibility: visible;
    }
    .drawer-header {
      position: sticky;
      top: 0;
      background: var(--color-surface-raised);
      padding: 0 0 0.75rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
    }
    .drawer-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }
    .drawer-close {
      background: transparent;
      border: 1px solid var(--color-border);
      color: var(--color-text);
      border-radius: 999px;
      width: 2.25rem;
      height: 2.25rem;
      display: grid;
      place-items: center;
      font-size: 1.1rem;
    }
    .detail-subtitle {
      margin: 0;
      color: var(--color-text-muted);
      font-size: 0.85rem;
    }
    #detail-body {
      font-size: 0.88rem;
      color: var(--color-text);
      line-height: 1.6;
      white-space: pre-wrap;
    }
    #favorite-toggle {
      margin-top: 1rem;
      padding: 0.6rem 1rem;
      border-radius: 0.85rem;
      border: 1px solid var(--color-accent-border);
      background: var(--color-accent);
      color: var(--color-accent-contrast);
      font-weight: 600;
    }
    #favorite-toggle[aria-pressed="true"] {
      background: var(--color-surface);
      color: var(--color-text);
      border-color: var(--color-border);
    }
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      padding: 0.45rem calc(env(safe-area-inset-left) + 0.85rem) calc(env(safe-area-inset-bottom) + 0.6rem);
      background: linear-gradient(180deg, var(--scrim-soft) 0%, var(--scrim-strong) 80%);
      backdrop-filter: blur(16px);
      border-top: 1px solid var(--color-border);
      z-index: 6;
      gap: 0.75rem;
    }
    .tab-bar a {
      flex: 1;
      text-align: center;
      text-decoration: none;
      color: var(--color-text-subtle);
      font-size: 0.82rem;
      padding: 0.65rem 0.5rem;
      border-radius: 0.75rem;
      transition: background 160ms ease, color 160ms ease;
    }
    .tab-bar a.active,
    .tab-bar a[aria-current="page"] {
      background: var(--color-accent-soft);
      color: var(--color-text);
      font-weight: 600;
    }
    .legal-link {
      padding: 0.75rem 1.25rem;
      font-size: 0.8rem;
      color: var(--color-text-subtle);
      text-align: center;
    }
    .legal-link a {
      color: inherit;
    }
  </style>
</head>
<body data-accent="sky">
  <a class="skip-link" href="#compendium-main">Skip to compendium results</a>
  <header>
    <h1>Compendium</h1>
    <p id="compendium-pack-meta" class="pack-meta" aria-live="polite">Loading SRD entries…</p>
    <div class="search-shell" role="search">
      <label class="sr-only" for="search-input">Search the compendium</label>
      <input type="search" id="search-input" placeholder="Search spells, feats, and rules" />
      <div class="chips" role="group" aria-label="Filters">
        <button type="button" class="chip" data-filter="spell" aria-pressed="false">Spell</button>
        <button type="button" class="chip" data-filter="feat" aria-pressed="false">Feat</button>
        <button type="button" class="chip" data-filter="item" aria-pressed="false">Item</button>
        <button type="button" class="chip" data-filter="rule" aria-pressed="false">Rule</button>
      </div>
    </div>
  </header>
  <main id="compendium-main" role="main" tabindex="-1">
    <div id="list-viewport">
      <div id="virtual-list" class="virtual-list" role="list"></div>
    </div>
  </main>
  <p class="legal-link">
    <a href="/LEGAL/NOTICE.txt" target="_blank" rel="noopener noreferrer">SRD 5.1 licensing notice</a>
  </p>
  <aside
    id="detail-drawer"
    role="dialog"
    aria-modal="true"
    aria-hidden="true"
    aria-labelledby="detail-title"
    aria-describedby="detail-body"
    tabindex="-1"
  >
    <div class="drawer-header">
      <div>
        <h2 id="detail-title">Detail</h2>
        <p id="detail-type" class="detail-subtitle"></p>
      </div>
      <button type="button" class="drawer-close" data-action="close-detail">
        <span aria-hidden="true">×</span>
        <span class="sr-only">Close detail drawer</span>
      </button>
    </div>
    <div id="detail-body"></div>
    <button id="favorite-toggle" type="button" aria-pressed="false">Save to Favorites</button>
  </aside>
  <nav class="tab-bar" aria-label="Primary navigation">
    <a href="/index.html">Home</a>
    <a href="/builder/index.html">Builder</a>
    <a href="/compendium/index.html" class="active" aria-current="page">Compendium</a>
  </nav>
  <script>
    const FAVORITES_KEY = 'dndCompendiumFavorites';
    const TYPE_LABELS = { spell: 'Spell', feat: 'Feat', item: 'Item', rule: 'Rule' };

    const viewport = document.getElementById('list-viewport');
    const list = document.getElementById('virtual-list');
    const rowHeight = 132;
    const detailDrawer = document.getElementById('detail-drawer');
    const detailTitle = document.getElementById('detail-title');
    const detailType = document.getElementById('detail-type');
    const detailBody = document.getElementById('detail-body');
    const favoriteToggleButton = document.getElementById('favorite-toggle');
    const detailClose = detailDrawer ? detailDrawer.querySelector('[data-action="close-detail"]') : null;
    const mainRegion = document.getElementById('compendium-main');
    const headerEl = document.querySelector('header');
    const navBar = document.querySelector('.tab-bar');
    const legalNotice = document.querySelector('.legal-link');
    const backgroundRegions = [headerEl, mainRegion, navBar, legalNotice].filter(Boolean);
    let data = [];
    let filtered = [];
    let startIndex = 0;
    let endIndex = 0;
    let favorites = loadFavorites();
    let releaseDetailFocus = null;

    function getPackData() {
      return window.dndData || { spells: [], feats: [], items: [], rules: [], packs: [] };
    }

    function loadFavorites() {
      try {
        const raw = localStorage.getItem(FAVORITES_KEY);
        return raw ? JSON.parse(raw) : { ids: [] };
      } catch (err) {
        console.warn('Failed to read favorites', err);
        return { ids: [] };
      }
    }

    function saveFavorites() {
      try {
        localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
      } catch (err) {
        console.warn('Failed to save favorites', err);
      }
      window.dispatchEvent(new CustomEvent('dnd-state-changed'));
    }

    function createFocusTrap(container, onClose) {
      if (!container) return () => {};
      const selectors = [
        'a[href]',
        'button:not([disabled])',
        'textarea:not([disabled])',
        'input:not([disabled])',
        'select:not([disabled])',
        '[tabindex]:not([tabindex="-1"])'
      ].join(',');
      const previous = document.activeElement instanceof HTMLElement ? document.activeElement : null;
      let focusable = Array.from(container.querySelectorAll(selectors)).filter((element) => !element.hasAttribute('aria-hidden'));
      if (!focusable.length) {
        container.setAttribute('tabindex', '-1');
        focusable = [container];
      }
      const [first] = focusable;
      const last = focusable[focusable.length - 1];

      function handleKeydown(event) {
        if (event.key === 'Tab') {
          if (focusable.length === 1) {
            event.preventDefault();
            first.focus();
            return;
          }
          if (event.shiftKey && document.activeElement === first) {
            event.preventDefault();
            last.focus();
          } else if (!event.shiftKey && document.activeElement === last) {
            event.preventDefault();
            first.focus();
          }
        }
        if (event.key === 'Escape') {
          event.preventDefault();
          onClose?.();
        }
      }

      container.addEventListener('keydown', handleKeydown);
      requestAnimationFrame(() => {
        if (first && typeof first.focus === 'function') {
          first.focus();
        }
      });

      return () => {
        container.removeEventListener('keydown', handleKeydown);
        if (previous && typeof previous.focus === 'function') {
          previous.focus();
        }
      };
    }

    function markBackgroundHidden(hidden) {
      backgroundRegions.forEach((region) => {
        if (!region) return;
        if (hidden) {
          region.setAttribute('aria-hidden', 'true');
        } else {
          region.removeAttribute('aria-hidden');
        }
      });
      document.body.style.overflow = hidden ? 'hidden' : '';
    }

    function summarise(text) {
      const value = (text || '').trim();
      if (!value) return 'Open the detail drawer for full rules text.';
      return value.length > 160 ? `${value.slice(0, 157)}…` : value;
    }

    function formatSourceBadge(source) {
      if (!source) return '';
      const parts = [];
      if (source.name) parts.push(source.name);
      if (source.edition) parts.push(source.edition);
      return parts.join(' · ');
    }

    function formatSourceDetail(source) {
      if (!source) return '';
      const parts = [];
      if (source.name) parts.push(source.name);
      if (source.edition) parts.push(source.edition);
      if (source.license) parts.push(source.license);
      return parts.length ? `Source: ${parts.join(' • ')}` : '';
    }

    function buildSpellEntry(spell) {
      const description = (spell.description || '').trim();
      const badge = formatSourceBadge(spell.source);
      const subtitleParts = [TYPE_LABELS.spell];
      if (typeof spell.level === 'number') subtitleParts.push(`Level ${spell.level}`);
      if (spell.school) subtitleParts.push(spell.school);
      if (badge) subtitleParts.push(badge);
      const detailParts = [
        `${spell.school || 'Spell'} • Level ${typeof spell.level === 'number' ? spell.level : 0}`,
        `Casting Time: ${spell.casting_time || '1 action'}`,
        `Range: ${spell.range || 'Self'}`,
        `Components: ${spell.components || 'V, S'}`,
        `Duration: ${spell.duration || 'Instantaneous'}`,
        '',
        description,
        '',
        formatSourceDetail(spell.source)
      ].filter(Boolean);
      return {
        id: `spell:${spell.slug}`,
        slug: spell.slug,
        name: spell.name,
        type: 'spell',
        level: spell.level ?? 0,
        summary: summarise(description),
        detail: detailParts.join('\n'),
        subtitle: subtitleParts.filter(Boolean).join(' · '),
        searchText: [spell.name, spell.school, spell.casting_time, spell.range, spell.components, description, formatSourceDetail(spell.source)].filter(Boolean).join(' ').toLowerCase()
      };
    }

    function buildFeatEntry(feat) {
      const description = (feat.description || '').trim();
      const badge = formatSourceBadge(feat.source);
      const subtitleParts = [TYPE_LABELS.feat];
      if (badge) subtitleParts.push(badge);
      const detailParts = [TYPE_LABELS.feat, '', description, '', formatSourceDetail(feat.source)].filter(Boolean);
      return {
        id: `feat:${feat.slug}`,
        slug: feat.slug,
        name: feat.name,
        type: 'feat',
        summary: summarise(description),
        detail: detailParts.join('\n'),
        subtitle: subtitleParts.join(' · '),
        searchText: [feat.name, description, formatSourceDetail(feat.source)].filter(Boolean).join(' ').toLowerCase()
      };
    }

    function buildItemEntry(item) {
      const description = (item.description || '').trim();
      const badge = formatSourceBadge(item.source);
      const subtitleParts = [TYPE_LABELS.item];
      if (item.category) subtitleParts.push(item.category);
      if (badge) subtitleParts.push(badge);
      const detailParts = [
        `${item.category || 'Item'} • Cost ${item.cost || '—'} • Weight ${item.weight || '—'}`,
        '',
        description,
        '',
        formatSourceDetail(item.source)
      ].filter(Boolean);
      return {
        id: `item:${item.slug}`,
        slug: item.slug,
        name: item.name,
        type: 'item',
        summary: summarise(description),
        detail: detailParts.join('\n'),
        subtitle: subtitleParts.join(' · '),
        searchText: [item.name, item.category, item.cost, item.weight, description, formatSourceDetail(item.source)].filter(Boolean).join(' ').toLowerCase()
      };
    }

    function buildRuleEntry(rule) {
      const description = (rule.description || '').trim();
      const badge = formatSourceBadge(rule.source);
      const subtitleParts = [TYPE_LABELS.rule];
      if (rule.category) subtitleParts.push(rule.category);
      if (badge) subtitleParts.push(badge);
      const detailParts = [rule.category || TYPE_LABELS.rule, '', description, '', formatSourceDetail(rule.source)].filter(Boolean);
      return {
        id: `rule:${rule.slug}`,
        slug: rule.slug,
        name: rule.name,
        type: 'rule',
        summary: summarise(description),
        detail: detailParts.join('\n'),
        subtitle: subtitleParts.join(' · '),
        searchText: [rule.name, rule.category, description, formatSourceDetail(rule.source)].filter(Boolean).join(' ').toLowerCase()
      };
    }

    function buildEntries() {
      const { spells = [], feats = [], items = [], rules = [] } = getPackData();
      const entries = [];
      spells.forEach(spell => entries.push(buildSpellEntry(spell)));
      feats.forEach(feat => entries.push(buildFeatEntry(feat)));
      items.forEach(item => entries.push(buildItemEntry(item)));
      rules.forEach(rule => entries.push(buildRuleEntry(rule)));
      return entries.sort((a, b) => a.name.localeCompare(b.name, 'en', { sensitivity: 'base' }));
    }

    function updatePackMeta() {
      const target = document.getElementById('compendium-pack-meta');
      if (!target) return;
      const { packs = [] } = getPackData();
      if (!packs.length) {
        target.textContent = 'No licensed content packs loaded.';
        return;
      }
      const text = packs.map(pack => {
        const edition = pack.edition ? ` · ${pack.edition}` : '';
        const license = pack.license ? ` • ${pack.license}` : '';
        return `${pack.name}${edition}${license}`;
      }).join(' | ');
      target.textContent = `Loaded packs: ${text}`;
    }

    function rebuildFromData() {
      data = buildEntries();
      applyFilters();
      updatePackMeta();
    }

    function applyFilters() {
      const query = document.getElementById('search-input').value.trim().toLowerCase();
      const activeFilters = Array.from(document.querySelectorAll('.chip[aria-pressed="true"]')).map(chip => chip.dataset.filter);
      filtered = data.filter(entry => {
        const matchesQuery = !query || entry.searchText.includes(query);
        const matchesFilter = !activeFilters.length || activeFilters.includes(entry.type);
        return matchesQuery && matchesFilter;
      });
      list.style.height = filtered.length ? `${filtered.length * rowHeight}px` : '0px';
      renderVirtualRows();
    }

    function renderVirtualRows() {
      const scrollTop = viewport.scrollTop;
      const viewportHeight = viewport.clientHeight;
      const buffer = 4;
      startIndex = Math.max(0, Math.floor(scrollTop / rowHeight) - buffer);
      endIndex = Math.min(filtered.length, Math.ceil((scrollTop + viewportHeight) / rowHeight) + buffer);

      list.innerHTML = '';
      for (let i = startIndex; i < endIndex; i++) {
        const entry = filtered[i];
        const row = document.createElement('div');
        row.className = 'virtual-row';
        row.style.top = `${i * rowHeight}px`;

        const article = document.createElement('article');
        article.className = 'entry';
        article.dataset.id = entry.id;
        article.dataset.type = entry.type;
        article.setAttribute('role', 'listitem');
        article.setAttribute('aria-posinset', String(i + 1));
        article.setAttribute('aria-setsize', String(filtered.length));

        const title = document.createElement('h3');
        title.textContent = entry.name;
        article.appendChild(title);

        const subtitle = document.createElement('small');
        subtitle.textContent = entry.subtitle;
        article.appendChild(subtitle);

        const summary = document.createElement('p');
        summary.className = 'entry-summary';
        summary.textContent = entry.summary;
        article.appendChild(summary);

        const button = document.createElement('button');
        button.type = 'button';
        button.dataset.action = 'details';
        button.textContent = 'Quick look';
        button.setAttribute('aria-haspopup', 'dialog');
        button.setAttribute('aria-controls', 'detail-drawer');
        article.appendChild(button);

        row.appendChild(article);
        list.appendChild(row);
      }
    }

    function openDetail(id) {
      const entry = filtered.find(item => item.id === id);
      if (!entry || !detailDrawer) return;
      if (detailDrawer.classList.contains('open')) {
        closeDetail();
      }
      detailTitle.textContent = entry.name;
      detailType.textContent = entry.subtitle;
      detailBody.textContent = entry.detail;
      if (favoriteToggleButton) {
        favoriteToggleButton.dataset.id = entry.id;
        const isFav = favorites.ids.includes(entry.id);
        favoriteToggleButton.textContent = isFav ? 'Remove Favorite' : 'Save to Favorites';
        favoriteToggleButton.setAttribute('aria-pressed', String(isFav));
      }
      detailDrawer.scrollTop = 0;
      detailDrawer.classList.add('open');
      detailDrawer.setAttribute('aria-hidden', 'false');
      markBackgroundHidden(true);
      releaseDetailFocus = createFocusTrap(detailDrawer, closeDetail);
    }

    function closeDetail() {
      if (!detailDrawer) return;
      if (!detailDrawer.classList.contains('open')) return;
      detailDrawer.classList.remove('open');
      detailDrawer.setAttribute('aria-hidden', 'true');
      markBackgroundHidden(false);
      if (releaseDetailFocus) {
        const release = releaseDetailFocus;
        releaseDetailFocus = null;
        release();
      }
    }

    function toggleFavorite(id) {
      const index = favorites.ids.indexOf(id);
      if (index >= 0) {
        favorites.ids.splice(index, 1);
      } else {
        favorites.ids.push(id);
      }
      saveFavorites();
      if (favoriteToggleButton) {
        const isFav = favorites.ids.includes(id);
        favoriteToggleButton.textContent = isFav ? 'Remove Favorite' : 'Save to Favorites';
        favoriteToggleButton.setAttribute('aria-pressed', String(isFav));
      }
    }

    viewport.addEventListener('scroll', () => {
      requestAnimationFrame(renderVirtualRows);
    });

    document.getElementById('search-input').addEventListener('input', () => {
      requestAnimationFrame(applyFilters);
    });

    document.querySelector('.chips').addEventListener('click', (event) => {
      const button = event.target.closest('.chip');
      if (!button) return;
      const pressed = button.getAttribute('aria-pressed') === 'true';
      button.setAttribute('aria-pressed', String(!pressed));
      requestAnimationFrame(applyFilters);
    });

    list.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-action="details"]');
      if (!button) return;
      const article = button.closest('.entry');
      if (!article) return;
      openDetail(article.dataset.id);
    });

    if (favoriteToggleButton) {
      favoriteToggleButton.addEventListener('click', (event) => {
        const target = event.currentTarget;
        if (!(target instanceof HTMLElement)) return;
        const id = target.dataset.id;
        if (!id) return;
        toggleFavorite(id);
      });
    }

    if (detailDrawer) {
      detailDrawer.addEventListener('click', (event) => {
        if (event.target === detailDrawer) {
          closeDetail();
        }
      });
    }

    if (detailClose) {
      detailClose.addEventListener('click', () => {
        closeDetail();
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && detailDrawer && detailDrawer.classList.contains('open')) {
        closeDetail();
      }
    });

    async function init() {
      favorites = loadFavorites();
      if (detailDrawer) {
        detailDrawer.setAttribute('aria-hidden', 'true');
      }
      if (favoriteToggleButton) {
        favoriteToggleButton.setAttribute('aria-pressed', 'false');
      }
      markBackgroundHidden(false);
      if (window.dndDataReady && typeof window.dndDataReady.then === 'function') {
        try {
          await window.dndDataReady;
        } catch (error) {
          console.warn('Unable to hydrate compendium packs', error);
        }
      }
      rebuildFromData();
    }

    document.addEventListener('DOMContentLoaded', () => {
      list.style.height = '0px';
      init();
    });

    window.addEventListener('dnd-data-ready', () => {
      if (document.readyState === 'loading') return;
      rebuildFromData();
    });
  </script>
</body>
</html>
