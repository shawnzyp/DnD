<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>D&D Companion – Ask the DM</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0e141a;
        --surface: rgba(255, 255, 255, 0.08);
        --text: #f5f5f5;
        --accent: #d96d28;
        --accent-dark: #b3571e;
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      }

      body {
        margin: 0;
        background: radial-gradient(circle at top, rgba(255, 255, 255, 0.08), transparent 70%), var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 1.5rem 1rem 1rem;
        text-align: center;
      }

      h1 {
        margin: 0 0 0.25rem;
        font-size: clamp(1.8rem, 4vw, 2.4rem);
        letter-spacing: 0.08em;
      }

      header p {
        margin: 0;
        opacity: 0.8;
        font-size: 0.95rem;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 0 1rem 2rem;
        max-width: 980px;
        width: 100%;
        margin: 0 auto;
      }

      .card {
        background: rgba(15, 22, 32, 0.82);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 18px;
        padding: 1.25rem;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.28);
        backdrop-filter: blur(12px);
      }

      nav {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.5rem;
      }

      nav button {
        background: transparent;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 0.65rem 0.9rem;
        color: inherit;
        font-weight: 600;
        letter-spacing: 0.04em;
        cursor: pointer;
        transition: all 180ms ease;
      }

      nav button.active {
        background: var(--accent);
        border-color: transparent;
        color: #fff;
        box-shadow: 0 8px 20px rgba(217, 109, 40, 0.4);
      }

      nav button:active {
        transform: translateY(1px);
      }

      .encounter-layout {
        display: grid;
        gap: 1rem;
      }

      .encounter-column {
        display: grid;
        gap: 0.85rem;
        padding: 1rem;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .encounter-column header h3 {
        margin: 0;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        font-size: 0.85rem;
        opacity: 0.75;
      }

      .encounter-column header p {
        margin: 0.35rem 0 0;
        line-height: 1.5;
        opacity: 0.8;
        font-size: 0.9rem;
      }

      .party-config {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: flex-end;
      }

      .party-config label {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        font-size: 0.85rem;
        opacity: 0.85;
      }

      .party-config input {
        background: rgba(0, 0, 0, 0.4);
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        padding: 0.55rem 0.6rem;
        font-size: 1rem;
        min-width: 4.5rem;
      }

      .encounter-search {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .encounter-search input[type="search"] {
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.45);
        color: inherit;
        padding: 0.7rem 0.9rem;
        font-size: 1rem;
      }

      .encounter-search-results {
        display: grid;
        gap: 0.6rem;
      }

      .encounter-result {
        display: flex;
        justify-content: space-between;
        gap: 0.75rem;
        align-items: center;
        padding: 0.75rem 0.9rem;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .encounter-result strong {
        display: block;
        font-size: 1rem;
      }

      .encounter-result span {
        display: block;
        font-size: 0.85rem;
        opacity: 0.75;
      }

      .encounter-result button {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 0.55rem 0.9rem;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        box-shadow: 0 10px 22px rgba(217, 109, 40, 0.35);
      }

      .roster-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.55rem;
      }

      .roster-empty {
        opacity: 0.7;
        font-size: 0.9rem;
      }

      .roster-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0.85rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(0, 0, 0, 0.35);
      }

      .roster-meta {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .roster-meta strong {
        font-size: 1rem;
      }

      .roster-meta span {
        font-size: 0.85rem;
        opacity: 0.75;
      }

      .roster-actions {
        display: inline-flex;
        gap: 0.35rem;
        align-items: center;
      }

      .roster-actions button {
        background: rgba(255, 255, 255, 0.1);
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 10px;
        padding: 0.35rem 0.6rem;
        cursor: pointer;
        font-weight: 600;
      }

      .encounter-roster button {
        margin-top: 0.5rem;
        background: rgba(255, 255, 255, 0.08);
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 10px;
        padding: 0.4rem 0.75rem;
        font-weight: 600;
        cursor: pointer;
        width: fit-content;
      }

      .roster-count {
        font-variant-numeric: tabular-nums;
        min-width: 2ch;
        text-align: center;
      }

      .encounter-summary {
        display: grid;
        gap: 0.75rem;
        padding: 0.85rem 0.95rem;
        border-radius: 14px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .difficulty-indicator {
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .difficulty-indicator::before {
        content: "";
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #9ca3af;
      }

      .difficulty-indicator[data-difficulty="Easy"]::before {
        background: #31c48d;
      }

      .difficulty-indicator[data-difficulty="Medium"]::before {
        background: #fbbf24;
      }

      .difficulty-indicator[data-difficulty="Hard"]::before {
        background: #f97316;
      }

      .difficulty-indicator[data-difficulty="Deadly"]::before {
        background: #ef4444;
      }

      .threshold-grid {
        display: grid;
        gap: 0.45rem;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }

      .threshold-grid span {
        display: block;
        font-size: 0.85rem;
        opacity: 0.75;
      }

      .threshold-grid strong {
        display: block;
        font-size: 1rem;
      }

      .encounter-quick-adjust {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
      }

      .encounter-quick-adjust span {
        opacity: 0.7;
        font-size: 0.85rem;
      }

      .encounter-quick-adjust button {
        background: transparent;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        padding: 0.35rem 0.75rem;
        color: inherit;
        font-weight: 600;
        cursor: pointer;
      }

      .encounter-footnote {
        font-size: 0.8rem;
        opacity: 0.65;
        line-height: 1.4;
      }

      .initiative-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .initiative-controls button {
        background: rgba(255, 255, 255, 0.08);
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 999px;
        padding: 0.45rem 0.85rem;
        font-weight: 600;
        cursor: pointer;
      }

      .initiative-form {
        display: grid;
        gap: 0.5rem;
      }

      .initiative-form-row {
        display: grid;
        gap: 0.5rem;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }

      .initiative-form label {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        font-size: 0.85rem;
        opacity: 0.85;
      }

      .initiative-form input,
      .initiative-form select {
        background: rgba(0, 0, 0, 0.45);
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 10px;
        padding: 0.6rem 0.7rem;
        font-size: 1rem;
      }

      .initiative-form button[type="submit"] {
        justify-self: start;
        background: var(--accent);
        border: none;
        color: #fff;
        padding: 0.6rem 1.1rem;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 12px 24px rgba(217, 109, 40, 0.4);
      }

      .initiative-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.6rem;
      }

      .initiative-entry {
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 0.75rem 0.85rem;
        background: rgba(0, 0, 0, 0.35);
        display: grid;
        gap: 0.6rem;
      }

      .initiative-entry.active {
        border-color: rgba(217, 109, 40, 0.55);
        box-shadow: 0 0 0 1px rgba(217, 109, 40, 0.35);
      }

      .initiative-header {
        display: flex;
        justify-content: space-between;
        gap: 0.75rem;
        align-items: flex-start;
      }

      .initiative-header strong {
        font-size: 1rem;
      }

      .initiative-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem 0.65rem;
        font-size: 0.8rem;
        opacity: 0.75;
      }

      .initiative-conditions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
      }

      .condition-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.25rem 0.55rem;
        border-radius: 999px;
        background: rgba(217, 109, 40, 0.22);
        font-size: 0.8rem;
        letter-spacing: 0.05em;
      }

      .condition-chip button {
        background: transparent;
        border: none;
        color: inherit;
        cursor: pointer;
        padding: 0;
        line-height: 1;
      }

      .initiative-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        align-items: center;
      }

      .initiative-actions select,
      .initiative-actions input {
        background: rgba(0, 0, 0, 0.45);
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 10px;
        padding: 0.45rem 0.6rem;
        font-size: 0.9rem;
      }

      .initiative-actions button {
        background: rgba(255, 255, 255, 0.08);
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 10px;
        padding: 0.35rem 0.6rem;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      section {
        display: none;
      }

      section.active {
        display: block;
      }

      .collapsible-card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 0.75rem 1rem;
        background: rgba(255, 255, 255, 0.04);
      }

      .collapsible-card summary {
        cursor: pointer;
        list-style: none;
        font-weight: 600;
        letter-spacing: 0.04em;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .collapsible-card summary::-webkit-details-marker {
        display: none;
      }

      .collapsible-card[open] {
        background: rgba(255, 255, 255, 0.06);
      }

      .collapsible-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem 0.75rem;
        margin-top: 0.4rem;
        font-size: 0.85rem;
        opacity: 0.85;
      }

      .collapsible-content {
        margin-top: 0.75rem;
        line-height: 1.55;
        font-size: 0.95rem;
        opacity: 0.9;
      }

      .class-accordion {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 0.65rem;
      }

      .class-card,
      .subclass-card {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        padding: 0.75rem 1rem;
      }

      .class-card summary,
      .subclass-card summary {
        cursor: pointer;
        list-style: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        font-weight: 600;
        letter-spacing: 0.04em;
      }

      .class-card summary::-webkit-details-marker,
      .subclass-card summary::-webkit-details-marker {
        display: none;
      }

      .class-card[open],
      .subclass-card[open] {
        background: rgba(255, 255, 255, 0.08);
      }

      .class-meta,
      .subclass-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem 1rem;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        opacity: 0.8;
      }

      .class-meta strong,
      .subclass-meta strong {
        font-weight: 600;
      }

      .subclass-group {
        margin-top: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }

      .comparison-note {
        margin-top: 0.6rem;
        font-size: 0.85rem;
        color: #f4b17d;
        line-height: 1.45;
      }

      .comparison-note a {
        color: inherit;
        text-decoration: underline;
      }

      .tag-row {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin-top: 0.5rem;
      }

      .collapsible-card summary .tag-row {
        margin-top: 0;
      }

      .status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        opacity: 0.8;
      }

      .status span {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #ffbe4d;
        display: inline-block;
      }

      .status.ready span { background: #31c48d; }
      .status.generating span { background: #ff7849; }

      .chat-log {
        height: clamp(240px, 40vh, 420px);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem;
        border-radius: 14px;
        background: rgba(5, 9, 16, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .bubble {
        padding: 0.85rem 1rem;
        border-radius: 12px;
        line-height: 1.45;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      .bubble.user {
        align-self: flex-end;
        background: rgba(217, 109, 40, 0.18);
        border-top-right-radius: 4px;
      }

      .bubble.assistant {
        background: rgba(255, 255, 255, 0.04);
        border-top-left-radius: 4px;
      }

      .chat-input {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      .chat-input textarea {
        flex: 1;
        min-height: 68px;
        resize: vertical;
        border-radius: 12px;
        padding: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.45);
        color: inherit;
        font-size: 1rem;
      }

      .chat-input button {
        background: var(--accent);
        border: none;
        color: #fff;
        padding: 0.75rem 1.1rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        min-width: 110px;
        box-shadow: 0 12px 30px rgba(217, 109, 40, 0.4);
        transition: background 160ms ease, transform 160ms ease;
      }

      .chat-input button:disabled {
        opacity: 0.6;
        cursor: wait;
        box-shadow: none;
      }

      .chat-input button:not(:disabled):active {
        transform: translateY(1px);
        background: var(--accent-dark);
      }

      .quick-prompts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-top: 1.25rem;
      }

      .reference-grid {
        display: grid;
        gap: 1.25rem;
        margin-top: 1.25rem;
      }

      .reference-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 1.1rem 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }

      .reference-card header {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }

      .reference-card h3 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: 0.04em;
      }

      .reference-card p {
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.55;
        opacity: 0.85;
      }

      .table-scroll {
        overflow-x: auto;
        border-radius: 12px;
      }

      .reference-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 420px;
        background: rgba(9, 14, 20, 0.65);
      }

      .reference-table caption {
        caption-side: bottom;
        text-align: left;
        font-size: 0.85rem;
        opacity: 0.7;
        padding-top: 0.6rem;
      }

      .reference-table th,
      .reference-table td {
        padding: 0.7rem 0.85rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        font-size: 0.9rem;
        vertical-align: top;
      }

      .reference-table th {
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.85);
      }

      .reference-table tbody tr:last-child td {
        border-bottom: none;
      }

      .reference-table tbody tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.03);
      }

      .reference-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        background: rgba(217, 109, 40, 0.22);
        color: #ffdcb5;
        border-radius: 999px;
        padding: 0.1rem 0.55rem;
        white-space: nowrap;
      }

      .quick-prompts-group {
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        padding: 1rem;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .quick-prompts-group h3 {
        margin: 0;
        font-size: 0.95rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        opacity: 0.85;
      }

      .quick-prompts-group p {
        margin: 0;
        font-size: 0.85rem;
        opacity: 0.75;
        line-height: 1.4;
      }

      .quick-prompts-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.5rem;
      }

      .quick-prompts button {
        background: rgba(255, 255, 255, 0.08);
        border: none;
        color: inherit;
        padding: 0.55rem 0.8rem;
        border-radius: 999px;
        cursor: pointer;
        font-size: 0.85rem;
        text-align: left;
        line-height: 1.35;
        transition: background 150ms ease;
      }

      .quick-prompts button:hover {
        background: rgba(255, 255, 255, 0.16);
      }

      @media (max-width: 640px) {
        .quick-prompts {
          grid-template-columns: 1fr;
        }

        .quick-prompts-buttons {
          grid-template-columns: 1fr;
        }
      }

      details {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        padding: 1rem;
        background: rgba(5, 9, 16, 0.65);
      }

      details summary {
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.05em;
      }

      .rules-grid {
        display: grid;
        gap: 1rem;
      }

      .setting-controls {
        margin-top: 1.25rem;
      }

      .setting-controls.items-search {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .setting-controls.items-search > * {
        flex: 1 1 220px;
      }

      .settings-grid {
        margin-top: 1.25rem;
        display: grid;
        gap: 1rem;
      }

      .setting-card {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        padding: 1rem 1rem 1.15rem;
        background: rgba(5, 9, 16, 0.7);
      }

      .setting-card summary {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 0.75rem;
        cursor: pointer;
        list-style: none;
      }

      .setting-card summary::-webkit-details-marker {
        display: none;
      }

      .setting-card[open] {
        background: rgba(5, 9, 16, 0.82);
      }

      .setting-name {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .setting-name span:first-child {
        font-size: 1.05rem;
        letter-spacing: 0.05em;
      }

      .setting-era {
        font-size: 0.8rem;
        opacity: 0.65;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .setting-body {
        margin-top: 0.85rem;
        display: grid;
        gap: 0.75rem;
      }

      .setting-image {
        border-radius: 12px;
        padding: 1.5rem 1rem;
        background: linear-gradient(135deg, rgba(217, 109, 40, 0.35), rgba(25, 45, 66, 0.85));
        position: relative;
        overflow: hidden;
      }

      .setting-image span {
        display: block;
        font-size: 0.85rem;
        letter-spacing: 0.04em;
        opacity: 0.8;
      }

      .setting-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem 1rem;
        font-size: 0.85rem;
        opacity: 0.85;
      }

      .setting-section {
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        padding-top: 0.75rem;
      }

      .setting-section strong {
        display: block;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        font-size: 0.75rem;
        opacity: 0.8;
        margin-bottom: 0.35rem;
      }

      .setting-section ul {
        margin: 0;
        padding-left: 1.2rem;
      }

      .setting-links {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem 0.75rem;
        font-size: 0.85rem;
      }

      .setting-links a {
        color: var(--accent);
        text-decoration: none;
      }

      @media (min-width: 768px) {
        .settings-grid {
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
      }

      .rules-meta {
        margin-top: 0.75rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem 1.25rem;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.85);
      }

      .rules-meta strong {
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      .rules-section {
        margin-top: 0.75rem;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        padding-top: 0.75rem;
      }

      .rules-section ul,
      .expansion-list ul {
        margin: 0.35rem 0 0;
        padding-left: 1.25rem;
      }

      .setting-links {
        margin-top: 0.35rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.85rem;
        opacity: 0.85;
      }

      .setting-links a {
        color: var(--accent);
        text-decoration: none;
      }

      .setting-links a:hover {
        text-decoration: underline;
      }

      .expansion-list li {
        margin-bottom: 0.2rem;
      }

      .pill {
        display: inline-block;
        background: rgba(217, 109, 40, 0.22);
        color: #ffdcb5;
        border-radius: 999px;
        padding: 0.2rem 0.6rem;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
      }

      .pill.attunement {
        background: rgba(141, 198, 63, 0.25);
        color: #e6ffd1;
      }

      .pill.edition-flag {
        background: rgba(64, 181, 219, 0.25);
        color: #d1f3ff;
      }

      .items-search {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .items-search input,
      .items-search select {
        width: 100%;
        padding: 0.65rem 0.85rem;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.45);
        color: inherit;
      }

      .downtime-tool {
        margin-top: 1.5rem;
        display: grid;
        gap: 1rem;
        padding: 1rem;
        border-radius: 16px;
        background: rgba(0, 0, 0, 0.32);
        border: 1px solid rgba(255, 255, 255, 0.12);
      }

      .downtime-tool h3 {
        margin: 0;
        font-size: 1.15rem;
        letter-spacing: 0.04em;
      }

      .downtime-tool p {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.85;
        line-height: 1.5;
      }

      .downtime-form {
        display: grid;
        gap: 0.85rem;
      }

      .downtime-form label {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        font-size: 0.85rem;
        opacity: 0.85;
      }

      .downtime-form select,
      .downtime-form input {
        width: 100%;
        padding: 0.6rem 0.75rem;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.45);
        color: inherit;
      }

      .downtime-checkboxes {
        display: grid;
        gap: 0.45rem;
      }

      .downtime-checkboxes label {
        display: inline-flex;
        align-items: flex-start;
        gap: 0.5rem;
        font-size: 0.85rem;
        opacity: 0.85;
      }

      .downtime-summary {
        display: grid;
        gap: 0.6rem;
        padding: 0.75rem 0.85rem;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .downtime-summary strong {
        font-size: 0.95rem;
      }

      .downtime-summary dl {
        display: grid;
        gap: 0.35rem;
        margin: 0;
      }

      .downtime-summary dt {
        font-weight: 600;
        font-size: 0.85rem;
        opacity: 0.75;
      }

      .downtime-summary dd {
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.45;
      }

      .downtime-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
      }

      .downtime-actions button {
        background: rgba(255, 255, 255, 0.12);
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 999px;
        padding: 0.45rem 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 160ms ease, transform 160ms ease;
      }

      .downtime-actions button:active {
        transform: translateY(1px);
      }

      .downtime-actions button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .item-meta,
      .monster-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem 0.75rem;
        align-items: center;
        margin: 0.45rem 0 0;
        font-size: 0.9rem;
        opacity: 0.85;
      }

      .item-meta strong,
      .monster-meta strong {
        font-weight: 600;
      }

      .item-card,
      .monster-card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.04);
      }

      .item-card h4,
      .monster-card h4 {
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        font-size: 1rem;
      }

      .item-card p,
      .monster-card p {
        margin: 0.45rem 0 0;
        line-height: 1.5;
        opacity: 0.85;
      }

      .monster-abilities {
        margin: 0.35rem 0 0.15rem;
        padding-left: 1.2rem;
        line-height: 1.5;
        opacity: 0.9;
      }

      .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        min-width: 600px;
      }

      .comparison-table thead th {
        background: #f3f4f6;
        font-weight: 600;
        padding: 0.75rem;
        text-align: left;
      }

      .comparison-table thead th:first-child {
        background: transparent;
      }

      .comparison-table tbody th {
        background: #fafbff;
        width: 16rem;
        font-weight: 600;
        padding: 0.75rem;
        vertical-align: top;
      }

      .comparison-table td {
        border-top: 1px solid rgba(15, 23, 42, 0.1);
        padding: 0.75rem;
        vertical-align: top;
      }

      .comparison-table ul {
        margin: 0.25rem 0 0.5rem;
        padding-left: 1.2rem;
      }

      .comparison-table p {
        margin: 0;
        line-height: 1.5;
      }

      .comparison-table .key-systems {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(129, 140, 248, 0.08));
        border-radius: 0.35rem;
        padding: 0.5rem 0.75rem;
        display: inline-block;
      }

      .comparison-table .key-systems ul {
        margin: 0.25rem 0 0;
      }

      footer {
        text-align: center;
        padding: 1.5rem 1rem 2rem;
        opacity: 0.7;
        font-size: 0.8rem;
      }

      @media (min-width: 768px) {
        main {
          padding: 0 2rem 2.5rem;
        }

        .reference-grid {
          grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }

        .encounter-layout {
          grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }
      }

      @media (min-width: 1024px) {
        .encounter-layout {
          grid-template-columns: 1.4fr 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>D&D Companion</h1>
      <p>Ask the DM · Browse every edition · Reference gear &amp; loot</p>
    </header>

    <main>
      <nav class="card">
        <button class="active" data-target="ask">Ask the DM</button>
        <button data-target="details">DM Screen</button>
        <button data-target="encounters">Encounters</button>
        <button data-target="rules">Rules Compendium</button>
        <button data-target="items">Item &amp; Gear Vault</button>
        <button data-target="spells">Spellbook</button>
        <button data-target="conditions">Condition Codex</button>
        <button data-target="bestiary">Bestiary</button>
        <button data-target="compare">Edition Comparison</button>
      </nav>

      <section id="ask" class="card active">
        <h2>Ask the DM</h2>
        <p>Chat with a lore-savvy Dungeon Master powered by an on-device LLM. Ask about rules, ruling conflicts, worldbuilding prompts, or create custom content for any edition.</p>
        <div class="status" id="status"><span></span><strong>Initializing engine…</strong></div>
        <div class="chat-log" id="chat-log"></div>
        <div class="chat-input">
          <textarea id="prompt" placeholder="Ask anything about D&D…" aria-label="Ask the DM"></textarea>
          <button id="send" disabled>Send</button>
        </div>
        <div class="quick-prompts" aria-label="Quick prompts"></div>
      </section>

      <section id="details" class="card">
        <h2>DM Screen Reference</h2>
        <p>Keep essential adjudication tables within reach. These SRD-friendly summaries cover actions, typical DC benchmarks, overland travel, and common environmental hazards.</p>
        <div id="dm-reference" class="reference-grid" aria-live="polite"></div>
      </section>

      <section id="encounters" class="card">
        <h2>Encounter Workshop</h2>
        <p>Balance combat on the fly with XP math, curated monsters, and a persistent initiative tracker.</p>
        <div class="encounter-layout">
          <article class="encounter-column">
            <header>
              <h3 id="encounter-party-heading">Encounter Builder</h3>
              <p>Set party parameters, add monsters from the bestiary roster, and watch encounter difficulty update in real time.</p>
            </header>
            <div class="party-config" role="group" aria-labelledby="encounter-party-heading">
              <label for="encounter-party-level">Average party level
                <input type="number" id="encounter-party-level" name="encounter-party-level" min="1" max="20" value="5" />
              </label>
              <label for="encounter-party-size">Party size
                <input type="number" id="encounter-party-size" name="encounter-party-size" min="1" max="8" value="4" />
              </label>
            </div>
            <div class="encounter-search">
              <label class="sr-only" for="encounter-monster-query">Search monsters for the encounter roster</label>
              <input type="search" id="encounter-monster-query" placeholder="Search monsters by name, role, or biome" autocomplete="off" />
              <div id="encounter-monster-results" class="encounter-search-results" aria-live="polite"></div>
            </div>
            <div class="encounter-roster">
              <h4>Encounter roster</h4>
              <ul id="encounter-roster" class="roster-list" aria-live="polite"></ul>
              <button id="encounter-clear" type="button">Clear roster</button>
            </div>
            <div id="encounter-summary" class="encounter-summary" aria-live="polite"></div>
          </article>
          <article class="encounter-column initiative-column">
            <header>
              <h3 id="initiative-heading">Initiative Tracker</h3>
              <p>Capture turn order, apply relevant conditions, and keep state synced between visits thanks to local storage.</p>
            </header>
            <form id="initiative-form" class="initiative-form" aria-labelledby="initiative-heading">
              <div class="initiative-form-row">
                <label for="initiative-name">Name
                  <input type="text" id="initiative-name" name="initiative-name" placeholder="Creature or character" required />
                </label>
                <label for="initiative-score">Initiative
                  <input type="number" id="initiative-score" name="initiative-score" placeholder="15" />
                </label>
                <label for="initiative-type">Role
                  <select id="initiative-type" name="initiative-type">
                    <option value="PC">PC</option>
                    <option value="Ally">Ally</option>
                    <option value="NPC">NPC</option>
                    <option value="Monster">Monster</option>
                  </select>
                </label>
              </div>
              <button type="submit">Add participant</button>
            </form>
            <div class="initiative-controls" aria-label="Initiative tools">
              <button type="button" id="initiative-sort">Sort by initiative</button>
              <button type="button" id="initiative-next">Advance turn</button>
              <button type="button" id="initiative-clear">Clear tracker</button>
            </div>
            <ul id="initiative-list" class="initiative-list" aria-live="polite"></ul>
          </article>
        </div>
      </section>

      <section id="rules" class="card">
        <h2>Rules Compendium</h2>
        <p>Review every major Dungeons &amp; Dragons edition. Each entry includes core rules coverage, iconic subsystems, and the official SRDs or rulebooks to consult for full detail.</p>
        <div class="rules-grid" id="rules-grid"></div>
        <div class="setting-controls items-search" role="search">
          <input type="search" id="setting-query" placeholder="Search settings by name, pitch, or products" aria-label="Search settings" />
          <select id="setting-genre-filter" aria-label="Filter settings by genre">
            <option value="all">All genres</option>
          </select>
        </div>
        <div id="settings-grid" class="settings-grid" aria-live="polite"></div>
      </section>

      <section id="items" class="card">
        <h2>Item &amp; Gear Vault</h2>
        <p>Search across equipment, magic items, and artifacts spanning multiple editions. Filter by type or rarity and tap an item to review its summary and primary source.</p>
        <div class="items-search">
          <input type="search" id="item-query" placeholder="Search by name, effect, or source" aria-label="Search items" />
          <select id="item-filter" aria-label="Filter rarity">
            <option value="all">All rarities</option>
          </select>
          <select id="attunement-filter" aria-label="Filter attunement requirement">
            <option value="all">All attunement states</option>
            <option value="required">Requires attunement</option>
            <option value="none">No attunement</option>
            <option value="conditional">Conditional or edition-based</option>
          </select>
          <select id="item-type-filter" aria-label="Filter item type">
            <option value="all">All item types</option>
          </select>
          <select id="edition-filter" aria-label="Filter edition availability">
            <option value="all">All editions</option>
          </select>
        </div>
        <div class="downtime-tool" aria-live="polite">
          <div>
            <h3>Downtime Activity Calculator</h3>
            <p>Estimate SRD-friendly downtime costs, workdays, and check guidance for crafting equipment, scribing spells, or training new proficiencies.</p>
          </div>
          <form id="downtime-form" class="downtime-form">
            <label for="downtime-activity">Activity type
              <select id="downtime-activity" name="activity">
                <option value="crafting">Crafting (mundane item)</option>
                <option value="scribing">Scribing a spell</option>
                <option value="training">Training proficiency</option>
              </select>
            </label>
            <div id="downtime-dynamic-fields"></div>
          </form>
          <div class="downtime-summary" id="downtime-summary">
            <strong>Results will appear here as you enter details.</strong>
            <p style="margin: 0; font-size: 0.85rem; opacity: 0.75;">Downtime math follows SRD 5.1 downtime activities and wizard spellbook rules.</p>
          </div>
          <div class="downtime-actions">
            <button type="button" id="downtime-copy" disabled>Copy summary</button>
          </div>
        </div>
        <div id="items-list" style="margin-top: 1rem; display: grid; gap: 0.85rem;"></div>
      </section>

      <section id="spells" class="card">
        <h2>Spellbook Archives</h2>
        <p>Explore SRD-friendly spells with quick access to casting details, save mechanics, and reliable sources. Filter by level, school, class, or edition to prep the perfect list.</p>
        <div class="items-search">
          <input type="search" id="spell-query" placeholder="Search spells by name, summary, or tags" aria-label="Search spells" />
          <select id="spell-level-filter" aria-label="Filter spell level">
            <option value="all">All levels</option>
          </select>
          <select id="spell-school-filter" aria-label="Filter spell school">
            <option value="all">All schools</option>
          </select>
          <select id="spell-class-filter" aria-label="Filter spell class">
            <option value="all">All classes</option>
          </select>
          <select id="spell-edition-filter" aria-label="Filter spell edition">
            <option value="all">All editions</option>
          </select>
        </div>
        <div id="spells-list" style="margin-top: 1rem; display: grid; gap: 0.75rem;"></div>
      </section>

      <section id="conditions" class="card">
        <h2>Condition Codex</h2>
        <p>Review the most common conditions adventurers face, from poisoned to paralyzed. Each entry summarizes the mechanical impact and saving throws so you can adjudicate quickly at the table.</p>
        <div class="items-search">
          <input type="search" id="condition-query" placeholder="Search conditions by name" aria-label="Search conditions by name" />
          <select id="condition-duration-filter" aria-label="Filter condition duration">
            <option value="all">All durations</option>
          </select>
          <select id="condition-save-filter" aria-label="Filter required saving throw">
            <option value="all">All saving throws</option>
          </select>
          <input type="search" id="condition-keyword-filter" placeholder="Filter conditions by keyword (movement, senses…)" aria-label="Filter conditions by keyword" />
        </div>
        <div id="conditions-list" style="margin-top: 1rem; display: grid; gap: 0.75rem;"></div>
      </section>

      <section id="bestiary" class="card">
        <h2>Bestiary</h2>
        <p>Discover iconic creatures with quick access to their tactics, challenge ratings, and SRD-friendly reference links. Filter by role or biome to slot foes into your next encounter.</p>
        <div class="items-search">
          <input type="search" id="monster-query" placeholder="Search by name, ability, or lore" aria-label="Search monsters" />
          <select id="monster-cr-filter" aria-label="Filter challenge rating">
            <option value="all">All challenge ratings</option>
          </select>
          <select id="monster-terrain-filter" aria-label="Filter terrain">
            <option value="all">All terrains</option>
          </select>
          <select id="monster-role-filter" aria-label="Filter combat role">
            <option value="all">All roles</option>
          </select>
        </div>
        <div id="bestiary-list" style="margin-top: 1rem; display: grid; gap: 0.85rem;"></div>
      </section>

      <section id="compare" class="card">
        <h2>Edition Comparison Dashboard</h2>
        <p>Contrast design philosophies, release windows, and key systems at a glance. Use this dashboard to spot how each ruleset approaches combat cadence, narrative support, and supplemental material.</p>
        <div id="comparison-matrix" style="overflow-x: auto;"></div>
      </section>
    </main>

    <footer>
      Built with WebLLM (Gemma-2-2B-it) so your DM helper runs entirely in the browser. Sources reference the SRD/OGL materials for each edition.
    </footer>

    <script type="module">
      const QUICK_PROMPTS = [
        {
          theme: "Rules & Rulings",
          description: "Clarify tricky mechanics across popular editions.",
          prompts: [
            {
              label: "Concentration rules (5e)",
              prompt: "How do concentration checks work in D&D 5e?"
            },
            {
              label: "Grapple contest (3.5)",
              prompt: "Explain the grapple rules in D&D 3.5 with examples."
            },
            {
              label: "Counterspell variants",
              prompt: "Outline how counterspell options differ between the Player's Handbook and Xanathar's Guide to Everything."
            }
          ]
        },
        {
          theme: "Narrative Sparks",
          description: "Jump-start quests, factions, and lore hooks.",
          prompts: [
            {
              label: "Planar portal complication",
              prompt: "Create a planar travel complication for a party of tier 2 adventurers."
            },
            {
              label: "Faction intrigue",
              prompt: "Draft a political intrigue plot hook involving the Zhentarim and the Harpers."
            },
            {
              label: "Archfey villain monologue",
              prompt: "Write a villain monologue for a scheming archfey antagonizing the party."
            }
          ]
        },
        {
          theme: "Loot & Rewards",
          description: "Design treasure hoards and bespoke magic gear.",
          prompts: [
            {
              label: "Treasure hoard",
              prompt: "Generate a level 5 treasure hoard with items from multiple editions."
            },
            {
              label: "Custom storm giant weapon",
              prompt: "Design a rare magic weapon themed around storm giants with balanced mechanics."
            },
            {
              label: "Downtime boons",
              prompt: "Suggest downtime rewards for a tier 3 party finishing a planar expedition."
            }
          ]
        },
        {
          theme: "Edition Insights",
          description: "Compare design philosophies and table expectations.",
          prompts: [
            {
              label: "Edition comparison",
              prompt: "What are the core differences between D&D 5e and One D&D 2024 classes?"
            },
            {
              label: "OSR conversion guidance",
              prompt: "Give guidance on converting an OSR dungeon crawl to D&D 5e pacing."
            },
            {
              label: "4e encounter cadence",
              prompt: "Summarize how encounter pacing differs between D&D 4e and 5e."
            }
          ]
        }
      ];

      const DM_REFERENCES = [
        {
          key: "actions",
          title: "Combat Actions",
          description: "Standard combat options most characters can take on their turn.",
          columns: ["Action", "Summary", "Key Notes"],
          caption: "Actions are available unless a specific rule or condition prevents their use.",
          rows: [
            {
              cells: [
                { text: "Attack", tag: "Action" },
                { text: "Make one melee or ranged weapon attack with a wielded weapon." },
                { text: "Extra Attack features let you repeat the option; you can replace one attack with a grapple or shove." }
              ]
            },
            {
              cells: [
                { text: "Cast a Spell", tag: "Action" },
                { text: "Cast a spell that has a casting time of one action." },
                { text: "Provide required components; concentration begins once the spell takes effect." }
              ]
            },
            {
              cells: [
                { text: "Dash", tag: "Action" },
                { text: "Gain extra movement equal to your speed for the turn." },
                { text: "Applies after other bonuses to speed; difficult terrain still increases the cost of movement." }
              ]
            },
            {
              cells: [
                { text: "Disengage", tag: "Action" },
                { text: "Your movement doesn't provoke opportunity attacks this turn." },
                { text: "Ideal for slipping out of melee; some creatures ignore the benefit with special senses or features." }
              ]
            },
            {
              cells: [
                { text: "Dodge", tag: "Action" },
                { text: "Attacks against you have disadvantage and you gain advantage on Dexterity saves until your next turn." },
                { text: "The benefit ends if you are incapacitated or if your speed drops to 0." }
              ]
            },
            {
              cells: [
                { text: "Help", tag: "Action" },
                { text: "Grant advantage on an ally's next ability check, or attack a creature within 5 feet of you." },
                { text: "Assisting an attack requires the target to be in reach; you can also narrate tool proficiencies to justify help." }
              ]
            },
            {
              cells: [
                { text: "Hide", tag: "Action" },
                { text: "Attempt to become unseen using Dexterity (Stealth)." },
                { text: "You need cover or heavy obscurity; success ends once you reveal yourself or leave concealment." }
              ]
            },
            {
              cells: [
                { text: "Ready", tag: "Action" },
                { text: "Prepare an action to use later as a reaction when a trigger occurs." },
                { text: "Describe the trigger and response; holding a spell requires concentration until the reaction resolves." }
              ]
            },
            {
              cells: [
                { text: "Search", tag: "Action" },
                { text: "Focus on finding clues using Wisdom (Perception) or Intelligence (Investigation)." },
                { text: "The DM chooses the skill involved and may apply advantage or disadvantage from circumstances." }
              ]
            },
            {
              cells: [
                { text: "Use an Object", tag: "Action" },
                { text: "Interact with a second object or activate an item that specifically requires an action." },
                { text: "Covers complex manipulations beyond the free interaction granted each turn." }
              ]
            }
          ]
        },
        {
          key: "dcs",
          title: "Ability Check Benchmarks",
          description: "Use these typical difficulty classes when an ability check needs a target number.",
          columns: ["Difficulty", "Target DC", "Typical Use Cases"],
          rows: [
            {
              cells: [
                { text: "Very Easy" },
                { text: "5" },
                { text: "Tasks almost anyone can accomplish, such as noticing a loud conversation or walking across a sturdy bridge." }
              ]
            },
            {
              cells: [
                { text: "Easy" },
                { text: "10" },
                { text: "Routine adventuring tasks: climbing a knotted rope, recalling common monster lore, or calming a skittish mount." }
              ]
            },
            {
              cells: [
                { text: "Moderate" },
                { text: "15" },
                { text: "Meaningful challenges like picking a standard lock, tracking in soft ground, or resisting common toxins." }
              ]
            },
            {
              cells: [
                { text: "Hard" },
                { text: "20" },
                { text: "Serious obstacles: spotting a hidden door, persuading a reluctant official, or balancing on a narrow ledge." }
              ]
            },
            {
              cells: [
                { text: "Very Hard" },
                { text: "25" },
                { text: "Expert-level feats such as bypassing arcane wards, deciphering an ancient cipher, or besting a seasoned warrior." }
              ]
            },
            {
              cells: [
                { text: "Nearly Impossible" },
                { text: "30" },
                { text: "Legendary achievements: stealing secrets from an ancient dragon or disabling a deity's vault lock." }
              ]
            }
          ]
        },
        {
          key: "travel",
          title: "Overland Travel Pace",
          description: "Pick a pace to determine how far the party moves and what tradeoffs apply.",
          columns: ["Pace", "Per Hour", "Per Day", "Effect"],
          rows: [
            {
              cells: [
                { text: "Fast", tag: "Speed" },
                { text: "4 miles" },
                { text: "30 miles" },
                { text: "-5 penalty to passive Wisdom (Perception) scores; creatures may surprise the party more easily." }
              ]
            },
            {
              cells: [
                { text: "Normal", tag: "Speed" },
                { text: "3 miles" },
                { text: "24 miles" },
                { text: "Default travel pace with no special modifiers." }
              ]
            },
            {
              cells: [
                { text: "Slow", tag: "Speed" },
                { text: "2 miles" },
                { text: "18 miles" },
                { text: "Allows the group to move stealthily; passive perception scores remain unchanged." }
              ]
            },
            {
              cells: [
                { text: "Forced March", tag: "Check" },
                { text: "—" },
                { text: "Beyond 8 hours" },
                { text: "After 8 hours of travel, each additional hour requires a DC 10 Constitution save or the creature takes one level of exhaustion." }
              ]
            },
            {
              cells: [
                { text: "Difficult Terrain", tag: "Terrain" },
                { text: "Halved" },
                { text: "Halved" },
                { text: "Each foot of movement costs an extra foot; combine with the chosen pace to find the final distance." }
              ]
            }
          ]
        },
        {
          key: "hazards",
          title: "Environmental Hazards",
          description: "Common exploration hazards and how to adjudicate them at the table.",
          columns: ["Hazard", "Threat", "Effect", "Mitigation"],
          rows: [
            {
              cells: [
                { text: "Extreme Cold", tag: "Arctic" },
                { text: "Freezing temperatures" },
                { text: "Each hour exposed requires a DC 10 Constitution save or the creature gains one level of exhaustion." },
                { text: "Cold weather gear, magical warmth, or natural resistance to cold prevents the save; shelter grants advantage." }
              ]
            },
            {
              cells: [
                { text: "Extreme Heat", tag: "Desert" },
                { text: "Scorching sun and high humidity" },
                { text: "Each hour requires a Constitution save starting at DC 5 and increasing by 1 for each additional hour; failure causes one level of exhaustion." },
                { text: "Shade, ample water, or immunity to fire damage avoids the save; heavy armor imposes disadvantage." }
              ]
            },
            {
              cells: [
                { text: "Frigid Water", tag: "Aquatic" },
                { text: "Icy lakes, winter seas" },
                { text: "A creature can swim for a number of minutes equal to its Constitution score; afterward it must succeed on a DC 10 Constitution save each minute or gain one level of exhaustion." },
                { text: "Resistance or immunity to cold damage prevents the checks; leaving the water and warming up ends the risk." }
              ]
            },
            {
              cells: [
                { text: "Thin Air", tag: "Altitude" },
                { text: "Elevations above 20,000 feet" },
                { text: "After 1 hour, each hour requires a DC 10 Constitution save; failure imposes disadvantage on all ability checks until acclimated and a second failure adds one level of exhaustion." },
                { text: "Spending time acclimating or using magic such as create food and water or lesser restoration mitigates the effect." }
              ]
            },
            {
              cells: [
                { text: "Strong Wind", tag: "Storm" },
                { text: "Gale-force gusts" },
                { text: "Disadvantage on ranged weapon attacks and Wisdom (Perception) checks relying on hearing; open flames are extinguished." },
                { text: "Take shelter behind windbreaks, secure flight with tethering, or rely on spells like control winds." }
              ]
            }
          ]
        }
      ];

      const createCell = (cell) => {
        if (typeof cell === "string") {
          return { textContent: cell };
        }
        return cell ?? { textContent: "" };
      };

      const renderReferenceTables = (container, references) => {
        if (!container) return;

        references.forEach(ref => {
          const card = document.createElement("article");
          card.className = "reference-card";

          const header = document.createElement("header");
          const heading = document.createElement("h3");
          heading.textContent = ref.title;
          header.appendChild(heading);

          if (ref.description) {
            const blurb = document.createElement("p");
            blurb.textContent = ref.description;
            header.appendChild(blurb);
          }

          card.appendChild(header);

          const scroll = document.createElement("div");
          scroll.className = "table-scroll";

          const table = document.createElement("table");
          table.className = "reference-table";
          table.setAttribute("data-reference", ref.key);

          if (ref.caption) {
            const caption = document.createElement("caption");
            caption.textContent = ref.caption;
            table.appendChild(caption);
          }

          const thead = document.createElement("thead");
          const headerRow = document.createElement("tr");
          ref.columns.forEach(col => {
            const th = document.createElement("th");
            th.textContent = col;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");
          ref.rows.forEach(row => {
            const tr = document.createElement("tr");
            (row.cells ?? []).forEach(cell => {
              const td = document.createElement("td");
              const normalized = createCell(cell);

              if (normalized.tag) {
                const tagEl = document.createElement("span");
                tagEl.className = "reference-tag";
                tagEl.textContent = normalized.tag;
                td.appendChild(tagEl);
              }

              if (normalized.text) {
                if (normalized.tag) {
                  td.appendChild(document.createElement("br"));
                }
                td.appendChild(document.createTextNode(normalized.text));
              } else if (normalized.textContent) {
                td.textContent = normalized.textContent;
              }

              if (Array.isArray(normalized.points) && normalized.points.length > 0) {
                const list = document.createElement("ul");
                list.style.margin = "0.35rem 0 0";
                list.style.paddingLeft = "1.2rem";
                normalized.points.forEach(point => {
                  const li = document.createElement("li");
                  li.textContent = point;
                  list.appendChild(li);
                });
                td.appendChild(list);
              }

              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);

          scroll.appendChild(table);
          card.appendChild(scroll);
          container.appendChild(card);
        });
      };

      const RULES_DATA = [
        {
          editionKey: "5e",
          edition: "5th Edition (2014 SRD, 2016 SRD 5.1)",
          tagline: "Modern streamlined rules built on bounded accuracy and advantage/disadvantage.",
          released: "Core trilogy released 2014 · SRD 5.1 Creative Commons refresh 2023",
          playstyle: [
            "Narrative-forward play where backgrounds and bonds steer spotlight moments",
            "Fast combat that leans on advantage/disadvantage instead of dense modifiers",
            "Flexible downtime and exploration pillars supporting episodic or sandbox pacing"
          ],
          adventureHooks: [
            "A wild magic bloom beneath Waterdeep's Yawning Portal warps spells into unpredictable surges",
            "The Emerald Enclave hires the party to reseal a planar rift spilling Fey crossings into the Sword Coast",
            "Faction envoys vie for heroes to mediate a brewing guild war before Luskan descends into chaos"
          ],
          keySystems: [
            "Advantage & Disadvantage mechanics",
            "Proficiency bonus progression",
            "Backgrounds, feats (optional), multiclass prerequisites",
            "Concentration-based spell maintenance",
            "Unified challenge rating and encounter building guidelines"
          ],
          expansions: [
            "Player's Handbook (core classes, species, spells)",
            "Dungeon Master's Guide (magic item creation, optional rules)",
            "Monster Manual + Mordenkainen Presents (creature lore)",
            "Xanathar's Guide to Everything (expanded subclasses, downtime)",
            "Tasha's Cauldron of Everything (group patrons, alternate class features)"
          ],
          settings: [
            {
              name: "Forgotten Realms",
              tone: "Kitchen-sink high fantasy along the Sword Coast with factions, gods, and Realmslore supporting every playstyle.",
              source: {
                label: "Sword Coast Adventurer's Guide",
                url: "https://dnd.wizards.com/products/tabletop-games/rpg-products/sc-adventurers-guide"
              }
            },
            {
              name: "Eberron",
              tone: "Noir pulp adventures with magitech conveniences, dragonmarked intrigue, and post-war espionage.",
              source: {
                label: "Eberron: Rising from the Last War",
                url: "https://dnd.wizards.com/products/eberron-rising-last-war"
              }
            },
            {
              name: "Exandria (Wildemount)",
              tone: "Character-driven drama across war-torn continents where dunamis magic and Vestiges of Divergence shape hero arcs.",
              source: {
                label: "Explorer's Guide to Wildemount",
                url: "https://dnd.wizards.com/products/explorers-guide-wildemount"
              }
            }
          ],
          srds: [
            { label: "Systems Reference Document 5.1", url: "https://media.wizards.com/2023/downloads/dnd/SRD_CC_v5.1.pdf" },
            { label: "Basic Rules", url: "https://dnd.wizards.com/resources/basic-rules" }
          ]
        },
        {
          editionKey: "onednd",
          edition: "One D&D / 2024 Core Rules",
          tagline: "Upcoming refresh with revised classes, species terminology, and weapon masteries.",
          released: "Player's Handbook 2024 · Dungeon Master's Guide 2024 · Monster Manual 2025",
          playstyle: [
            "Bridging 5e familiarity with more codified class progression milestones",
            "Weapon masteries encourage tactical choices for martial characters each turn",
            "Unified spell lists streamline prep for tables juggling multiple casters"
          ],
          adventureHooks: [
            "An arcane bastion prototype malfunctions, merging its demiplane with a frontier keep",
            "Rival traditions of magic duel for control of a ley nexus revealed by the new rules glossary",
            "A dragonflight tests heroes with tiered challenges that unlock epic boons as rewards"
          ],
          keySystems: [
            "Rebalanced class progression with common subclass levels",
            "Weapon mastery properties and new weapon categories",
            "Revised spell lists grouped by class-specific traditions",
            "Species traits grouped into Heritage & Culture blocks",
            "Epic boons and tiered play updates"
          ],
          expansions: [
            "Player's Handbook (2024)",
            "Dungeon Master's Guide (2024) with revised encounter-building and bastions",
            "Monster Manual (2025) introducing updated stat block templates"
          ],
          settings: [
            {
              name: "Greyhawk",
              tone: "Classic sword & sorcery around the Free City and its factions, spotlighting elemental cults and political scheming.",
              source: {
                label: "Return to Greyhawk Preview",
                url: "https://www.dndbeyond.com/posts/1561-return-to-greyhawk-in-2024"
              }
            },
            {
              name: "Planescape: Turn of Fortune's Wheel",
              tone: "Planar intrigue in Sigil where faction philosophies and multiversal secrets shape every choice.",
              source: {
                label: "Planescape: Adventures in the Multiverse",
                url: "https://dnd.wizards.com/products/planescape-adventures-sigil-and-outlands"
              }
            },
            {
              name: "Vecna: Eve of Ruin",
              tone: "High-octane multiverse rescue linking iconic worlds against Vecna's looming apotheosis.",
              source: {
                label: "Vecna: Eve of Ruin",
                url: "https://dnd.wizards.com/products/vecna-eve-of-ruin"
              }
            }
          ],
          srds: [
            { label: "Unearthed Arcana archive", url: "https://www.dndbeyond.com/sources/ua" },
            { label: "Rules Glossary (Playtest 8)", url: "https://www.dndbeyond.com/sources/ua/ph-playtest-8" }
          ]
        },
        {
          editionKey: "35e",
          edition: "3.5 Edition (Revised d20 System)",
          tagline: "Crunch-heavy rules with granular feats, prestige classes, and tactical combat options.",
          released: "Revised core books 2003 · Supplemental line through 2007",
          playstyle: [
            "Highly tactical combat featuring iterative attacks and stacking modifiers",
            "Character optimization via prestige classes, feat chains, and skill ranks",
            "Simulationist dungeon crawls with detailed subsystems for crafting and spells"
          ],
          adventureHooks: [
            "A forgotten wizard college releases a metamagic plague that alters spell slots across the realm",
            "The party must infiltrate a secret cabal trading forbidden prestige class manuals",
            "An ancient warforged titan reactivates, demanding heroes master combat maneuvers to disable it"
          ],
          keySystems: [
            "Base attack bonus (BAB) and iterative attacks",
            "Skill ranks with cross-class costs",
            "AoO (attacks of opportunity) trigger matrix",
            "Prestige class entry requirements",
            "Metamagic level adjustments and item creation feats"
          ],
          expansions: [
            "Player's Handbook v3.5",
            "Dungeon Master's Guide v3.5",
            "Monster Manual v3.5",
            "Complete series (Arcane, Divine, Warrior, Adventurer)",
            "Tome of Battle, Expanded Psionics Handbook"
          ],
          settings: [
            {
              name: "Forgotten Realms",
              tone: "Expansive Realmslore with region guides, epic NPCs, and high-magic threats calibrated for crunchy play.",
              source: {
                label: "Forgotten Realms Campaign Setting (3e)",
                url: "https://www.dmsguild.com/product/284252/Forgotten-Realms-Campaign-Setting-3e"
              }
            },
            {
              name: "Eberron",
              tone: "Pulp-noir magitech mixing dragonmarked house intrigue with lightning rail heists and pulp relic hunts.",
              source: {
                label: "Eberron Campaign Setting (3.5)",
                url: "https://www.dmsguild.com/product/288607/Eberron-Campaign-Setting-35"
              }
            },
            {
              name: "Living Greyhawk",
              tone: "Organized play sandbox where regional meta-plots let tables explore politics, wars, and heroic legacies.",
              source: {
                label: "Living Greyhawk Gazetteer",
                url: "https://www.dmsguild.com/product/221268/Living-Greyhawk-Gazetteer-3e"
              }
            }
          ],
          srds: [
            { label: "d20 SRD", url: "https://www.d20srd.org/" },
            { label: "3.5 Expanded SRD", url: "https://www.dandwiki.com/wiki/3.5e_SRD" }
          ]
        },
        {
          edition: "Pathfinder 1e (3.5 derivative)",
          tagline: "Paizo's revision with archetypes, favored class bonuses, and robust adventure paths.",
          released: "Core Rulebook 2009 · Unchained & consolidated errata 2015 · Final updates 2019",
          playstyle: [
            "Heroic fantasy with crunchy subsystems for downtime, kingdom building, and mythic tiers",
            "Archetypes and traits tailor classes to campaign tone without rewriting chassis",
            "Dense tactical encounters supported by extensive bestiaries and templates"
          ],
          adventureHooks: [
            "A Pathfinder lodge uncovers a corrupted artifact that twists favored class bonuses",
            "The kingdom's nascent colony needs heroes to chart hexes while fending off rival factions",
            "Mythic echoes awaken in ancient ruins, offering ascension to those who survive their trials"
          ],
          keySystems: [
            "Combat maneuvers (CMB/CMD)",
            "Archetypes to customize base classes",
            "Favored class bonuses and traits",
            "Mythic Adventures & kingdom building subsystems",
            "Extensive bestiary with template rules"
          ],
          expansions: [
            "Core Rulebook",
            "Advanced Player's Guide",
            "Ultimate Combat & Magic",
            "Mythic Adventures",
            "Ultimate Campaign (kingdom & downtime rules)"
          ],
          settings: [
            {
              name: "Inner Sea (Golarion)",
              tone: "Kitchen-sink fantasy where each nation delivers a distinct genre, deity pantheon, and adventure hook density.",
              source: {
                label: "Inner Sea World Guide",
                url: "https://paizo.com/products/btpy8v0z?Pathfinder-Campaign-Setting-The-Inner-Sea-World-Guide"
              }
            },
            {
              name: "Kingmaker",
              tone: "Hex-crawl sandbox that evolves into kingdom management with political dilemmas and wilderness threats.",
              source: {
                label: "Kingmaker Adventure Path",
                url: "https://paizo.com/products/btpy8j5w?Pathfinder-Adventure-Path-Kingmaker"
              }
            },
            {
              name: "Skull & Shackles",
              tone: "Swashbuckling pirate saga of ship battles, infamy, and freedom on the high seas of the Shackles.",
              source: {
                label: "Skull & Shackles Adventure Path",
                url: "https://paizo.com/pathfinder/adventurePath/skullAndShackles"
              }
            }
          ],
          srds: [
            { label: "Archives of Nethys", url: "https://aonprd.com/" }
          ]
        },
        {
          edition: "4th Edition",
          tagline: "Tactical, power-card driven combat with roles and structured encounters.",
          released: "Core launch 2008 · Essentials refresh 2010 · Digital tools sunset 2016",
          playstyle: [
            "Team-focused tactical battles with defined combat roles",
            "Encounter design around set-piece maps, hazards, and skill challenge pacing",
            "Resource management via healing surges and milestone rewards"
          ],
          adventureHooks: [
            "A living dungeon shifts each round, forcing heroes to leverage role synergies to escape",
            "The Raven Queen tasks the party with sealing planar rifts that destabilize the World Axis",
            "An elite warband tournament offers artifact boons to teams that master tactical objectives"
          ],
          keySystems: [
            "At-will/encounter/daily power cadence",
            "Role-based design (Defender, Striker, Leader, Controller)",
            "Healing surges and short-rest resource loops",
            "Skill challenges for narrative resolution",
            "Monster design math with level-based templates"
          ],
          expansions: [
            "Player's Handbooks I-III",
            "Martial, Arcane, Primal, Divine Power",
            "Essentials line (Heroes of the Fallen Lands/Feywild)",
            "Dungeon Master's Guide I-II",
            "Monster Manuals I-III"
          ],
          settings: [
            {
              name: "Nentir Vale",
              tone: "Points-of-Light frontier where Fallcrest, Winterhaven, and roving threats frame heroic-tier sandboxes.",
              source: {
                label: "Nentir Vale Primer",
                url: "https://www.dndbeyond.com/posts/1445-return-to-the-nentir-vale"
              }
            },
            {
              name: "Dark Sun (Athas)",
              tone: "Brutal swords-and-sand survival with psionics, defiling magic, and tyrannical sorcerer-kings.",
              source: {
                label: "Dark Sun Campaign Setting (4e)",
                url: "https://www.dmsguild.com/product/17532/Dark-Sun-Campaign-Setting-4e"
              }
            },
            {
              name: "Eberron",
              tone: "High-action pulp where dragonmarked houses, airships, and manifest zones get tuned for tactical encounters.",
              source: {
                label: "Eberron Campaign Guide (4e)",
                url: "https://www.dmsguild.com/product/17536/Eberron-Campaign-Guide-4e"
              }
            }
          ],
          srds: [
            { label: "4e Compendium (archived)", url: "https://web.archive.org/web/20160817123609/http://www.wizards.com/dndinsider/compendium/database.aspx" },
            { label: "4e Quick Rules Reference", url: "https://rpg.stackexchange.com/questions/12304/quick-reference-for-dnd-4e-rules" }
          ]
        },
        {
          editionKey: "2e",
          edition: "AD&D 2nd Edition",
          tagline: "THAC0-based combat, proficiencies, and classic campaign settings like Planescape and Dark Sun.",
          released: "Original launch 1989 · Player's Option revisions 1995 · Support through late 1990s",
          playstyle: [
            "Classic dungeon crawls where THAC0 math rewards planning",
            "Character-driven campaigns powered by kits, proficiencies, and setting flavor",
            "High-magic planar adventures leveraging specialty priests and school rivalries"
          ],
          adventureHooks: [
            "A Planescape portal hub jams, scattering keys that must be recovered across the planes",
            "Dark Sun templars recruit off-world heroes to investigate a defiled oasis",
            "The Harpers request a covert mission to sway a city's morale before war erupts"
          ],
          keySystems: [
            "THAC0 progression and descending Armor Class",
            "Non-weapon proficiencies",
            "Spheres of priest magic",
            "Specialist wizards and school opposition",
            "Morale, reaction, and encounter tables"
          ],
          expansions: [
            "Player's Handbook",
            "Dungeon Master's Guide",
            "Monstrous Compendium/Manual",
            "Skills & Powers, Spells & Magic optional rules",
            "Campaign settings: Planescape, Dark Sun, Ravenloft"
          ],
          settings: [
            {
              name: "Planescape",
              tone: "Philosophical planar travel centered on Sigil, factions, and belief-driven conflicts across the multiverse.",
              source: {
                label: "Planescape Campaign Setting (2e)",
                url: "https://www.dmsguild.com/product/431552/Planescape-Campaign-Setting-2e"
              }
            },
            {
              name: "Dark Sun",
              tone: "Harsh desert survival on Athas featuring psionics, ecological collapse, and defiling sorcery.",
              source: {
                label: "Dark Sun Campaign Setting (2e)",
                url: "https://www.dmsguild.com/product/17091/Dark-Sun-Campaign-Setting-Expanded-and-Revised-2e"
              }
            },
            {
              name: "Ravenloft",
              tone: "Gothic horror domains ruled by Darklords where moral choices and fear checks drive the story.",
              source: {
                label: "Ravenloft Campaign Setting (2e)",
                url: "https://www.dmsguild.com/product/17043/Ravenloft-Campaign-Setting-2e"
              }
            }
          ],
          srds: [
            { label: "AD&D 2e Core Rules (archive)", url: "https://annarchive.com/files/Drmg244.pdf" },
            { label: "TSR Reference (mirror)", url: "https://www.dragonsfoot.org/forums/viewtopic.php?t=30584" }
          ]
        },
        {
          editionKey: "becmi",
          edition: "BECMI / Rules Cyclopedia",
          tagline: "Classic basic-to-immortal progression with race-as-class and domain play.",
          released: "BECMI boxed sets 1983-1986 · Rules Cyclopedia compilation 1991",
          playstyle: [
            "Heroic fantasy arcs that graduate characters from village protectors to domain rulers",
            "Streamlined dungeon exploration with race-as-class simplicity",
            "High-level play focused on war machine battles and immortality quests"
          ],
          adventureHooks: [
            "A dominion's war machine muster uncovers sabotage from a rival baron",
            "Mystaran Immortals beckon the heroes to stop a rogue artifact before it reshapes the Hollow World",
            "A caravan disappears along the merchant's road, leaving only strange weapon mastery glyphs behind"
          ],
          keySystems: [
            "Race-as-class progression",
            "Race-specific spell lists",
            "War machine mass combat",
            "Domain management at Name level",
            "Weapon mastery tiers"
          ],
          expansions: [
            "Basic/Expert/Companion/Master/Immortal boxed sets",
            "Rules Cyclopedia",
            "Gazetteer series for Mystara",
            "Wrath of the Immortals",
            "Creature Catalogue"
          ],
          settings: [
            {
              name: "Mystara (Known World)",
              tone: "Classic exploration with nation-focused Gazetteers, pulpy politics, and quirky Immortal meddling.",
              source: {
                label: "Mystara Gazetteer Compilation",
                url: "https://www.dmsguild.com/product/229802/Mystara-Gazetteer-Compilation"
              }
            },
            {
              name: "Hollow World",
              tone: "Lost-world pulp adventures beneath the planet's crust featuring preserved cultures and dinosaur-filled wilds.",
              source: {
                label: "Hollow World Campaign Setting",
                url: "https://www.dmsguild.com/product/17152/Hollow-World-Campaign-Setting-Basic"
              }
            },
            {
              name: "Savage Coast",
              tone: "Swashbuckling frontier of red steel, cursed regions, and colonial intrigue along Mystara's western shores.",
              source: {
                label: "Savage Coast Campaign Book",
                url: "https://www.dmsguild.com/product/17150/Savage-Coast-Campaign-Book"
              }
            }
          ],
          srds: [
            { label: "Rules Cyclopedia Index", url: "https://www.dragonsfoot.org/forums/viewtopic.php?t=36241" }
          ]
        }
      ];

      const SETTINGS = [
        {
          name: "Ravenloft: Domains of Dread",
          era: "1983 origins · 5e revivals 2016–2021",
          elevatorPitch:
            "A web of mist-shrouded realms ruled by tragic Darklords where fear, temptation, and moral choices shape the horror.",
          genres: ["Gothic Horror", "Survival", "Low Magic"],
          flagshipProducts: [
            {
              label: "Curse of Strahd",
              url: "https://dnd.wizards.com/products/curse-strahd",
              description: "Modern hardcover remix of the classic Barovian vampire saga."
            },
            {
              label: "Van Richten's Guide to Ravenloft",
              url: "https://dnd.wizards.com/products/van-richtens-guide-ravenloft",
              description: "2021 setting book expanding the Domains of Dread with genre toolkits."
            }
          ],
          officialSources: [
            {
              label: "Ravenloft hub",
              url: "https://dnd.wizards.com/products/ravenloft"
            }
          ],
          adventureHooks: [
            "A harvest festival in Barovia twists into a cursed masquerade as Strahd hunts a reincarnated love.",
            "Van Richten requests escorts into the mists to confront a new Darklord born from a bard's betrayal.",
            "A desperate village bargains with the Vistani for safe passage, but the price erases cherished memories."
          ],
          art: {
            caption: "Silhouetted castle looming over crimson fog banks—describe the dread that stalks the mists.",
            background: "linear-gradient(135deg, rgba(122, 41, 53, 0.68), rgba(16, 12, 24, 0.92))"
          }
        },
        {
          name: "Eberron: The Last War's Aftermath",
          era: "2004 debut · 5e resurgence 2018–2019",
          elevatorPitch:
            "Magitech-noir pulp adventures across the Five Nations where dragonmarks, airships, and living constructs collide after war.",
          genres: ["Magitech", "Pulp Adventure", "Noir"],
          flagshipProducts: [
            {
              label: "Eberron: Rising from the Last War",
              url: "https://dnd.wizards.com/products/eberron-rising-last-war",
              description: "Comprehensive 5e sourcebook with races, artificer class, and lightning rail sandbox."
            },
            {
              label: "Wayfinder's Guide to Eberron",
              url: "https://dnd.wizards.com/products/wayfinders-guide-eberron",
              description: "Digital-first gazetteer introducing 5e rules for dragonmarks and Sharn adventures."
            }
          ],
          officialSources: [
            {
              label: "Explore Eberron",
              url: "https://dnd.wizards.com/products/eberron"
            }
          ],
          adventureHooks: [
            "A lightning rail heist uncovers a House Cannith prototype that could reignite the Last War.",
            "The party investigates missing warforged veterans whose memories were scrubbed by the Trust.",
            "Scholars of the Draconic Prophecy recruit the heroes to seal a planar breach in Xen'drik."
          ],
          art: {
            caption: "Skyships, soot-stained towers, and neon dragonmarks beg for daring pulp descriptions.",
            background: "linear-gradient(135deg, rgba(48, 132, 178, 0.6), rgba(18, 36, 58, 0.9))"
          }
        },
        {
          name: "Planescape: Cities of Doors",
          era: "1994 boxed set · 2023 multiverse relaunch",
          elevatorPitch:
            "Philosophical planar travel centered on Sigil where belief literally reshapes reality and factions feud over ideals.",
          genres: ["Planar", "Philosophical", "Weird Fantasy"],
          flagshipProducts: [
            {
              label: "Planescape: Adventures in the Multiverse",
              url: "https://dnd.wizards.com/products/planescape-adventures-multiverse",
              description: "Three-book slipcase reintroducing Sigil, the Outlands, and planar campaign options."
            },
            {
              label: "Planescape Campaign Setting (1994)",
              url: "https://dnd.wizards.com/products/planescape",
              description: "Original boxed set detailing factions, portals, and planar cant."
            }
          ],
          officialSources: [
            {
              label: "Planescape portal",
              url: "https://dnd.wizards.com/products/planescape"
            }
          ],
          adventureHooks: [
            "A faction war threatens to fracture Sigil as the Harmonium declares martial law on the Lady's Ward.",
            "A rogue portal key drags the party into a belief-fueled reality storm on the Outlands' rim.",
            "Sensates hire the heroes to catalogue new sensations from an uncharted demiplane of living music."
          ],
          art: {
            caption: "Impossible architecture spiraling around a torus invites planar spectacle narration.",
            background: "linear-gradient(135deg, rgba(160, 93, 206, 0.55), rgba(32, 25, 70, 0.9))"
          }
        },
        {
          name: "Dark Sun: Athas Reborn",
          era: "1991 boxed set · 4e revitalization 2010",
          elevatorPitch:
            "Sun-scorched sword-and-sand survival where psionics thrive, arcane defilers drain life, and resources are priceless.",
          genres: ["Post-Apocalyptic", "Sword & Sorcery", "Survival"],
          flagshipProducts: [
            {
              label: "Dark Sun Campaign Setting",
              url: "https://dnd.wizards.com/products/dark-sun",
              description: "Classic boxed set introducing Athas, sorcerer-kings, and deadly wastes."
            },
            {
              label: "Dark Sun Campaign Setting (4e)",
              url: "https://dnd.wizards.com/products/tabletop-games/rpg-products/dark-sun",
              description: "Updated rules for defiling magic, survival themes, and arena combat."
            }
          ],
          officialSources: [
            {
              label: "Athas overview",
              url: "https://dnd.wizards.com/products/dark-sun"
            }
          ],
          adventureHooks: [
            "An oasis city hires the party to escort a rare water caravan past silt skimmer raiders.",
            "A Veiled Alliance cell seeks allies to sabotage a templar's new defiling engine.",
            "Thri-kreen hunting packs converge on an ancient psionic monolith awakened by the crimson sun."
          ],
          art: {
            caption: "Blasted mesas, bone weapons, and a dying sun ready for harsh survival imagery.",
            background: "linear-gradient(135deg, rgba(199, 120, 45, 0.65), rgba(66, 24, 10, 0.88))"
          }
        },
        {
          name: "Spelljammer: Wildspace & Beyond",
          era: "1989 boxed set · 2022 slipcase revival",
          elevatorPitch:
            "Swashbuckling fantasy ships sailing the Astral Sea, bridging worlds with crystal spheres and cosmic whimsy.",
          genres: ["Space Fantasy", "Planar", "High Adventure"],
          flagshipProducts: [
            {
              label: "Spelljammer: Adventures in Space",
              url: "https://dnd.wizards.com/products/spelljammer-adventures-space",
              description: "5e slipcase with Astral Adventurer's Guide, light rules, and starter campaign."
            },
            {
              label: "Spelljammer Campaign Setting (1989)",
              url: "https://dnd.wizards.com/products/spelljammer",
              description: "Original boxed set of ship combat, crystal spheres, and phlogiston travel."
            }
          ],
          officialSources: [
            {
              label: "Spelljammer dock",
              url: "https://dnd.wizards.com/products/spelljammer"
            }
          ],
          adventureHooks: [
            "A giff armada hires the crew to reclaim a derelict nautiloid drifting toward a black hole.",
            "The party charts a crystal sphere whose stars are actually dormant living spells.",
            "Space clowns spread chaos on the Rock of Bral, threatening its mercantile treaty."
          ],
          art: {
            caption: "Void-sailing galleons and kaleidoscopic nebulae await your spelljamming narration.",
            background: "linear-gradient(135deg, rgba(63, 131, 215, 0.55), rgba(15, 18, 54, 0.9))"
          }
        },
        {
          name: "Dragonlance: War of the Lance",
          era: "1984 DL series · 2022 Shadow of the Dragon Queen",
          elevatorPitch:
            "Epic war chronicles on Krynn where heroes rally nations against dragon armies under the Dark Queen's banner.",
          genres: ["Epic Fantasy", "War Stories", "Heroic Saga"],
          flagshipProducts: [
            {
              label: "Dragonlance: Shadow of the Dragon Queen",
              url: "https://dnd.wizards.com/products/dragonlance-shadow-dragon-queen",
              description: "5e campaign weaving mass battles, Lunar Sorcery, and Solamnic Knights."
            },
            {
              label: "Dragonlance Chronicles (DL1–DL14)",
              url: "https://dnd.wizards.com/products/dragonlance",
              description: "Classic module arc following the Heroes of the Lance through the War."
            }
          ],
          officialSources: [
            {
              label: "Dragonlance gateway",
              url: "https://dnd.wizards.com/products/dragonlance"
            }
          ],
          adventureHooks: [
            "A Solamnic outpost needs covert operatives to free prisoners from a draconian work camp.",
            "Lunar sorcerers seek escorts to a hidden tower before the next triple moon alignment.",
            "Dragonarmies mass at Kalaman, and resistance cells beg the heroes to sabotage siege engines."
          ],
          art: {
            caption: "Dragonlances lowered against a storm-lit sky invite stirring war chronicles.",
            background: "linear-gradient(135deg, rgba(201, 78, 54, 0.62), rgba(48, 17, 24, 0.9))"
          }
        }
      ];

      const CLASSES = {
        "5e": [
          {
            name: "Barbarian",
            role: "Primal frontliner & damage sponge",
            primaryAbility: "Strength",
            hitDie: "d12",
            summary:
              "Unleash rage-fueled durability and explosive melee damage while shrugging off blows for the party.",
            signatureFeatures: [
              "Rage grants bonus damage and resistance to bludgeoning, piercing, and slashing damage",
              "Reckless Attack trades defense for advantage on heavy-hitting swings",
              "Danger Sense keeps you nimble against traps and area effects"
            ],
            sources: [
              {
                label: "Player's Handbook (2014)",
                url: "https://dnd.wizards.com/products/tabletop-games/rpg-products/rpg_playershandbook"
              },
              {
                label: "SRD 5.1 Barbarian",
                url: "https://www.dndbeyond.com/sources/srd/classes#Barbarian"
              }
            ],
            comparison: {
              note:
                "The One D&D 2024 Barbarian keeps Rage scaling but folds weapon mastery options directly into class progression, tightening the gap between primal and martial kits.",
              link: {
                label: "Playtest 8 Barbarian",
                url: "https://www.dndbeyond.com/sources/ua/ph-playtest-8/barbarian"
              }
            },
            subclasses: [
              {
                name: "Path of the Totem Warrior",
                spotlight:
                  "Channel guardian spirits to tailor resistances, mobility, or pack tactics for your crew.",
                features: [
                  "Totem Spirit choices at 3rd level reshape defenses or positioning to match party needs",
                  "Aspect and Totemic Attunement scale exploration and social advantages with primal flavor"
                ],
                sources: [
                  {
                    label: "Player's Handbook",
                    url: "https://dnd.wizards.com/products/tabletop-games/rpg-products/rpg_playershandbook"
                  }
                ],
                comparison: {
                  note:
                    "Compared to BECMI's Berserker-style fighter, the Totem Warrior layers narrative-driven spirit boons rather than flat attack bonuses.",
                  link: {
                    label: "SRD Totem Options",
                    url: "https://www.dndbeyond.com/sources/srd/subclasses#BarbarianPaths"
                  }
                }
              },
              {
                name: "Path of Wild Magic",
                spotlight:
                  "Ride chaotic surges that weave support, control, and extra damage into every rage.",
                features: [
                  "Wild Magic Surge table introduces unpredictable effects each time you rage",
                  "Bolstering Magic fuels allies with additional d3 bonuses reminiscent of 3.5e aid spells"
                ],
                sources: [
                  {
                    label: "Tasha's Cauldron of Everything",
                    url: "https://dnd.wizards.com/products/tashas-cauldron-everything"
                  }
                ],
                comparison: {
                  note:
                    "Shares the chaos niche with the 2024 Path of the World Tree but keeps surges swingier, so tables wanting steadier reliability might prefer the newer design.",
                  link: {
                    label: "World Tree Barbarian Preview",
                    url: "https://www.dndbeyond.com/posts/1560-barbarian-class-features-in-one-dnd"
                  }
                }
              }
            ]
          },
          {
            name: "Wizard",
            role: "Versatile arcane controller & utility expert",
            primaryAbility: "Intelligence",
            hitDie: "d6",
            summary:
              "Prepare spells from the largest arcane list, bending encounters with control, rituals, and raw damage.",
            signatureFeatures: [
              "Arcane Recovery refreshes spell slots on a short rest",
              "Spellbook preparation lets you flex answers for every arcane problem",
              "Traditions reward specialization without locking out generalist tools"
            ],
            sources: [
              {
                label: "Player's Handbook (2014)",
                url: "https://dnd.wizards.com/products/tabletop-games/rpg-products/rpg_playershandbook"
              },
              {
                label: "SRD 5.1 Wizard",
                url: "https://www.dndbeyond.com/sources/srd/classes#Wizard"
              }
            ],
            comparison: {
              note:
                "3.5e wizards juggle spell slots with metamagic costs; the 5e chassis trims bookkeeping but keeps iconic prep flexibility.",
              link: {
                label: "3.5 SRD Wizard",
                url: "https://www.d20srd.org/srd/classes/wizard.htm"
              }
            },
            subclasses: [
              {
                name: "School of Abjuration",
                spotlight:
                  "Shield allies with spell wards and absorb damage with a replenishing arcane ward.",
                features: [
                  "Arcane Ward temp HP functions like a portable spell battery for defense",
                  "Projected Ward lets you intercept hits, echoing 4e's defender mechanics"
                ],
                sources: [
                  {
                    label: "Player's Handbook",
                    url: "https://dnd.wizards.com/products/tabletop-games/rpg-products/rpg_playershandbook"
                  }
                ],
                comparison: {
                  note:
                    "One D&D retools the ward to scale with proficiency, so legacy 5e abjurers may feel swingier but reward heavy spell-slot investment.",
                  link: {
                    label: "2024 Wizard Playtest",
                    url: "https://www.dndbeyond.com/sources/ua/ph-playtest-7/wizard"
                  }
                }
              },
              {
                name: "Bladesinging",
                spotlight:
                  "Blend swordplay and spellcasting with mobility boosts and defensive flourishes.",
                features: [
                  "Bladesong adds AC, speed, and concentration resilience for finesse builds",
                  "Extra Attack at 6th level mirrors 4e swordmage tactics without sacrificing high-level spells"
                ],
                sources: [
                  {
                    label: "Tasha's Cauldron of Everything",
                    url: "https://dnd.wizards.com/products/tashas-cauldron-everything"
                  }
                ],
                comparison: {
                  note:
                    "3.5e gish builds relied on prestige classes like Eldritch Knight; Bladesinging packages that chassis for faster table onboarding.",
                  link: {
                    label: "Eldritch Knight (3.5 SRD)",
                    url: "https://www.d20srd.org/srd/prestigeClasses/eldritchKnight.htm"
                  }
                }
              }
            ]
          }
        ],
        onednd: [
          {
            name: "Barbarian",
            role: "Weapon mastery bruiser",
            primaryAbility: "Strength",
            hitDie: "d12",
            summary:
              "Refined rage progression that locks in weapon masteries and streamlined defensive boosts.",
            signatureFeatures: [
              "Persistent rage that no longer ends automatically when incapacitated",
              "Weapon Mastery options let barbarians swap rider effects as they level",
              "Primal Knowledge grants utility skills to keep pace with 5e support classes"
            ],
            sources: [
              {
                label: "Player's Handbook (2024)",
                url: "https://www.dndbeyond.com/posts/1548-everything-we-know-about-the-2024-players-handbook"
              },
              {
                label: "UA Playtest 8",
                url: "https://www.dndbeyond.com/sources/ua/ph-playtest-8/barbarian"
              }
            ],
            comparison: {
              note:
                "Legacy 5e barbarians must chase feats for mastery-like riders, while the 2024 chassis bakes them into class levels for parity with fighter options.",
              link: {
                label: "5e Barbarian SRD",
                url: "https://www.dndbeyond.com/sources/srd/classes#Barbarian"
              }
            },
            subclasses: [
              {
                name: "Path of the World Tree",
                spotlight:
                  "Teleport allies and root foes with planar tendrils inspired by cosmic Yggdrasil lore.",
                features: [
                  "Aspect of the Tree grants short-range teleportation similar to 5e's Horizon Walker",
                  "Rage of the World Tree punishes movement, emulating Sentinel-style lockdown"
                ],
                sources: [
                  {
                    label: "UA Playtest 6",
                    url: "https://www.dndbeyond.com/sources/ua/ph-playtest-6/barbarian"
                  }
                ],
                comparison: {
                  note:
                    "Builds on 5e's Path of Wild Magic mobility but replaces random surges with deterministic ally repositioning for steadier teamwork.",
                  link: {
                    label: "Wild Magic Path (5e)",
                    url: "https://www.dndbeyond.com/sources/tcoe/subclasses-barbarian#PathoftheWildMagic"
                  }
                }
              },
              {
                name: "Path of the Zealot",
                spotlight:
                  "Channel divine wrath for relentless frontline pressure that is hard to keep down.",
                features: [
                  "Divine Fury adds radiant or necrotic riders on the first hit each turn",
                  "Zealous Presence offers party-wide advantage as a bonus action"
                ],
                sources: [
                  {
                    label: "Player's Handbook (2024)",
                    url: "https://www.dndbeyond.com/posts/1548-everything-we-know-about-the-2024-players-handbook"
                  }
                ],
                comparison: {
                  note:
                    "The 2024 update mirrors 5e's Zealot but explicitly ties resurrection perks to the revised death save rules, simplifying rulings versus 3.5's raise dead costs.",
                  link: {
                    label: "Raise Dead SRD (5e)",
                    url: "https://www.dndbeyond.com/sources/srd/spells#RaiseDead"
                  }
                }
              }
            ]
          },
          {
            name: "Bard",
            role: "Flexible support caster & inspiration engine",
            primaryAbility: "Charisma",
            hitDie: "d8",
            summary:
              "Harmonize spell lists with refreshed inspiration mechanics and clearer role definitions across tiers.",
            signatureFeatures: [
              "Songs of Restoration guarantee staple healing spells without preparation",
              "Bardic Inspiration recharges on a short rest and can be used reactively when allies fail",
              "Magical Secrets unlock themed spell list swaps at tier-based milestones"
            ],
            sources: [
              {
                label: "Player's Handbook (2024)",
                url: "https://www.dndbeyond.com/posts/1548-everything-we-know-about-the-2024-players-handbook"
              },
              {
                label: "UA Playtest 5",
                url: "https://www.dndbeyond.com/sources/ua/ph-playtest-5/bard"
              }
            ],
            comparison: {
              note:
                "5e bards had to expend inspiration before seeing rolls; the 2024 design mirrors 3.5's immediate-action boosts so you can react to a failed d20.",
              link: {
                label: "Bardic Music (3.5 SRD)",
                url: "https://www.d20srd.org/srd/classes/bard.htm"
              }
            },
            subclasses: [
              {
                name: "College of Dance",
                spotlight:
                  "Spin into melee with agile footwork that fuels inspiration and battlefield control.",
                features: [
                  "Dance Step lets you reposition without provoking, similar to 5e's Rogue Cunning Action",
                  "Rhythm of War trades inspiration dice for ally movement, echoing 4e warlord tactics"
                ],
                sources: [
                  {
                    label: "UA Playtest 5",
                    url: "https://www.dndbeyond.com/sources/ua/ph-playtest-5/bard"
                  }
                ],
                comparison: {
                  note:
                    "Compared to the 5e College of Swords, Dance focuses on support repositioning instead of raw damage, pairing well with the refreshed inspiration timing.",
                  link: {
                    label: "College of Swords (Xanathar's)",
                    url: "https://www.dndbeyond.com/sources/xgte/subclasses-bard#CollegeofSwords"
                  }
                }
              },
              {
                name: "College of Lore",
                spotlight:
                  "Knowledge-focused bard with expanded cutting words and bonus spells for every occasion.",
                features: [
                  "Lore Bards gain more prepared spells per tier than 5e predecessors",
                  "Improved Cutting Words can blunt spell damage as well as attack rolls"
                ],
                sources: [
                  {
                    label: "Player's Handbook (2024)",
                    url: "https://www.dndbeyond.com/posts/1548-everything-we-know-about-the-2024-players-handbook"
                  }
                ],
                comparison: {
                  note:
                    "The subclass keeps its 5e identity but the new Magical Secrets cadence mirrors 3.5's bard spell access, smoothing multiclass conversions.",
                  link: {
                    label: "5e Lore Bard SRD",
                    url: "https://www.dndbeyond.com/sources/srd/subclasses#BardColleges"
                  }
                }
              }
            ]
          }
        ],
        "35e": [
          {
            name: "Fighter",
            role: "Martial specialist & feat engine",
            primaryAbility: "Strength or Dexterity",
            hitDie: "d10",
            summary:
              "Stack iterative attacks, feat chains, and prestige classes to sculpt any battlefield role.",
            signatureFeatures: [
              "Bonus feats at nearly every even level enable bespoke combat styles",
              "High base attack bonus grants four attacks by level 20",
              "Access to weapon-specific feats like Shock Trooper for tactical spikes"
            ],
            sources: [
              {
                label: "Player's Handbook v3.5",
                url: "https://www.dmsguild.com/product/23615/Players-Handbook-v35"
              },
              {
                label: "d20 SRD Fighter",
                url: "https://www.d20srd.org/srd/classes/fighter.htm"
              }
            ],
            comparison: {
              note:
                "Compared to 5e's fighter, the 3.5 version leans on feat trees instead of per-short-rest maneuvers, so onboarding players often port Battle Master superiority dice for a modern feel.",
              link: {
                label: "5e Battle Master",
                url: "https://www.dndbeyond.com/sources/srd/subclasses#FighterMartialArchetypes"
              }
            },
            subclasses: [
              {
                name: "Eldritch Knight (Prestige)",
                spotlight:
                  "Blend martial prowess with arcane spellcasting through prestige progression.",
                features: [
                  "Advances base attack while adding up to 9th-level spellcasting",
                  "Bonus feats tailor gish combos unavailable in 5e's subclass version"
                ],
                sources: [
                  {
                    label: "Dungeon Master's Guide v3.5",
                    url: "https://www.dmsguild.com/product/23731/Dungeon-Masters-Guide-v35"
                  },
                  {
                    label: "d20 SRD Eldritch Knight",
                    url: "https://www.d20srd.org/srd/prestigeClasses/eldritchKnight.htm"
                  }
                ],
                comparison: {
                  note:
                    "5e folds the Eldritch Knight into a fighter subclass with limited spells known; porting that chassis back trims spellbook maintenance for new groups.",
                  link: {
                    label: "5e Eldritch Knight",
                    url: "https://www.dndbeyond.com/sources/srd/subclasses#FighterMartialArchetypes"
                  }
                }
              },
              {
                name: "Dervish",
                spotlight:
                  "Whirlwind across the battlefield with acrobatic slashes and full-attack mobility.",
                features: [
                  "Dervish Dance enables full attacks after moving, something 5e handles via Action Surge",
                  "Slashing Frenzy adds bonus damage during whirlwind rounds"
                ],
                sources: [
                  {
                    label: "Complete Warrior",
                    url: "https://www.dmsguild.com/product/17539/Complete-Warrior-35"
                  }
                ],
                comparison: {
                  note:
                    "Its move-and-full-attack niche mirrors 4e's martial strikers; modern tables often translate it to 5e via the Mobile feat plus Echo Knight teleports.",
                  link: {
                    label: "Mobile Feat (5e SRD)",
                    url: "https://www.dndbeyond.com/sources/srd/feats#Mobile"
                  }
                }
              }
            ]
          },
          {
            name: "Cleric",
            role: "Divine buffer & versatile caster",
            primaryAbility: "Wisdom",
            hitDie: "d8",
            summary:
              "Tailor spell prep and domain powers to either frontline durability or potent support.",
            signatureFeatures: [
              "Two domain choices add bonus spells and unique powers",
              "Turn Undead scales into destroy effects against weak undead",
              "Spontaneous cure or inflict casting keeps slots flexible"
            ],
            sources: [
              {
                label: "Player's Handbook v3.5",
                url: "https://www.dmsguild.com/product/23615/Players-Handbook-v35"
              },
              {
                label: "d20 SRD Cleric",
                url: "https://www.d20srd.org/srd/classes/cleric.htm"
              }
            ],
            comparison: {
              note:
                "5e domains arrive at level 1 with lighter bookkeeping, while 3.5 clerics juggle turning pools and domain slots for granular customization.",
              link: {
                label: "5e Cleric SRD",
                url: "https://www.dndbeyond.com/sources/srd/classes#Cleric"
              }
            },
            subclasses: [
              {
                name: "Radiant Servant of Pelor",
                spotlight:
                  "Specialize in turning undead and blasting foes with intensified light spells.",
                features: [
                  "Greater turning destroys undead outright, similar to 5e's Channel Divinity: Turn Undead at higher tiers",
                  "Empower Healing boosts cure spells, echoing 2024 domain scaling"
                ],
                sources: [
                  {
                    label: "Complete Divine",
                    url: "https://www.dmsguild.com/product/17519/Complete-Divine-35"
                  }
                ],
                comparison: {
                  note:
                    "The subclass prefigures 5e's Light Domain; modern conversions often swap in radiant flame strike dice from the SRD for smoother math.",
                  link: {
                    label: "Light Domain (5e)",
                    url: "https://www.dndbeyond.com/sources/srd/subclasses#ClericDivineDomains"
                  }
                }
              },
              {
                name: "Warpriest",
                spotlight:
                  "Blend martial attacks and divine spellcasting for frontline pressure.",
                features: [
                  "Battle Blessing reduces metamagic overhead on buffs",
                  "Weapon Focus/Specialization bonuses mirror 5e's Blessed Warrior fighting style"
                ],
                sources: [
                  {
                    label: "Complete Divine",
                    url: "https://www.dmsguild.com/product/17519/Complete-Divine-35"
                  }
                ],
                comparison: {
                  note:
                    "5e's War Domain compresses this kit into Channel Divinity options, making iterative attack math unnecessary for quick conversion.",
                  link: {
                    label: "War Domain (5e SRD)",
                    url: "https://www.dndbeyond.com/sources/srd/subclasses#ClericDivineDomains"
                  }
                }
              }
            ]
          }
        ],
        "2e": [
          {
            name: "Cleric",
            role: "Armor-clad miracle worker",
            primaryAbility: "Wisdom",
            hitDie: "d8",
            summary:
              "Access spheres of influence based on deity, wielding both healing and battlefield miracles.",
            signatureFeatures: [
              "Spheres replace 3.5 domains, dictating spell availability",
              "Turning undead uses d20 tables unique to each faith",
              "Specialty priest kits tailor granted powers and weapon proficiencies"
            ],
            sources: [
              {
                label: "Player's Handbook (2e)",
                url: "https://www.dmsguild.com/product/16868/Players-Handbook-2e"
              },
              {
                label: "Faiths & Avatars",
                url: "https://www.dmsguild.com/product/17469/Faiths-and-Avatars-2e"
              }
            ],
            comparison: {
              note:
                "5e streamlined clerics into unified spell lists; referencing specialty priest kits helps port bespoke miracles back into modern campaigns.",
              link: {
                label: "Cleric Basics (5e)",
                url: "https://www.dndbeyond.com/sources/basic-rules/classes#Cleric"
              }
            },
            subclasses: [
              {
                name: "Morninglord of Lathander",
                spotlight:
                  "Radiant-themed specialty priest with resurrection boons and sunlight powers.",
                features: [
                  "Bonus spells mimic 5e's Light Domain list",
                  "Greater Resurrection reduces material costs, a perk later echoed by 2024 epic boons"
                ],
                sources: [
                  {
                    label: "Faiths & Avatars",
                    url: "https://www.dmsguild.com/product/17469/Faiths-and-Avatars-2e"
                  }
                ],
                comparison: {
                  note:
                    "Modern tables can mirror the Morninglord's dawnfire aura with 5e's Dawn spell while keeping 2e's unique resurrections intact.",
                  link: {
                    label: "Dawn Spell (5e SRD)",
                    url: "https://www.dndbeyond.com/sources/srd/spells#Dawn"
                  }
                }
              },
              {
                name: "Battle Priest of Tempus",
                spotlight:
                  "Martial-focused clergy wielding heavy armor and commanding war rites.",
                features: [
                  "Access to Combat and War spheres keeps damage spells online",
                  "Battle fury abilities foreshadow 5e's War Domain Channel Divinity"
                ],
                sources: [
                  {
                    label: "Faiths & Avatars",
                    url: "https://www.dmsguild.com/product/17469/Faiths-and-Avatars-2e"
                  }
                ],
                comparison: {
                  note:
                    "Easily mapped onto 5e by combining the War Domain with martial weapon proficiency feats from Tasha's optional rules.",
                  link: {
                    label: "Martial Adept (5e SRD)",
                    url: "https://www.dndbeyond.com/sources/srd/feats#MartialAdept"
                  }
                }
              }
            ]
          },
          {
            name: "Ranger",
            role: "Wilderness scout & skirmisher",
            primaryAbility: "Strength and Dexterity",
            hitDie: "d10",
            summary:
              "Excel at ambushes, animal empathy, and planar tracking with kit-based customization.",
            signatureFeatures: [
              "Two-weapon fighting without penalties at low levels",
              "Tracking proficiency scales with level and favored enemy bonuses",
              "Spellcasting arrives late but includes unique animal friendship rites"
            ],
            sources: [
              {
                label: "Player's Handbook (2e)",
                url: "https://www.dmsguild.com/product/16868/Players-Handbook-2e"
              },
              {
                label: "Complete Ranger's Handbook",
                url: "https://www.dmsguild.com/product/16899/The-Complete-Rangers-Handbook-2e"
              }
            ],
            comparison: {
              note:
                "3.5 and 5e rangers both revise favored enemy math; referencing 2e kits like Stalker helps add exploration abilities modern subclasses sometimes lack.",
              link: {
                label: "Ranger (5e Basic Rules)",
                url: "https://www.dndbeyond.com/sources/basic-rules/classes#Ranger"
              }
            },
            subclasses: [
              {
                name: "Stalker Kit",
                spotlight:
                  "Urban infiltrator variant specializing in stealth and informant networks.",
                features: [
                  "Contacts and disguise proficiencies echo 5e's Gloom Stalker options",
                  "Backstab multipliers reward ambush tactics similar to rogue Sneak Attack"
                ],
                sources: [
                  {
                    label: "Complete Ranger's Handbook",
                    url: "https://www.dmsguild.com/product/16899/The-Complete-Rangers-Handbook-2e"
                  }
                ],
                comparison: {
                  note:
                    "Pairs cleanly with 5e's Gloom Stalker by porting umbral sight and initiative bonuses to emulate kit advantages.",
                  link: {
                    label: "Gloom Stalker (Xanathar's)",
                    url: "https://www.dndbeyond.com/sources/xgte/subclasses-ranger#GloomStalker"
                  }
                }
              },
              {
                name: "Beastmaster Kit",
                spotlight:
                  "Leverage animal companions with morale rules and shared tricks.",
                features: [
                  "Multiple animal followers scale with level, unlike 5e's single companion",
                  "Special handling rules inform modern sidekick stat blocks"
                ],
                sources: [
                  {
                    label: "Complete Ranger's Handbook",
                    url: "https://www.dmsguild.com/product/16899/The-Complete-Rangers-Handbook-2e"
                  }
                ],
                comparison: {
                  note:
                    "5e's revised Beast Master from Tasha's streamlines action economy; use those stat blocks when porting kits to cut down micro-managing morale checks.",
                  link: {
                    label: "Primal Companion (Tasha's)",
                    url: "https://www.dndbeyond.com/sources/tcoe/subclasses-ranger#BeastMasterConclave"
                  }
                }
              }
            ]
          }
        ],
        becmi: [
          {
            name: "Fighter",
            role: "Straightforward warrior scaling into domain leadership",
            primaryAbility: "Strength",
            hitDie: "d8",
            summary:
              "Simple early play that graduates into weapon mastery trees and dominion command.",
            signatureFeatures: [
              "Name level unlocks dominion management and mass combat options",
              "Weapon mastery tiers add crit ranges and damage bumps absent from OD&D",
              "Plate armor access from level 1 keeps survivability high"
            ],
            sources: [
              {
                label: "Rules Cyclopedia",
                url: "https://www.dmsguild.com/product/17171/Rules-Cyclopedia-Basic"
              }
            ],
            comparison: {
              note:
                "5e fighters chase magic items for mastery-style boosts, while BECMI builds them directly into the class—great inspiration for optional mastery modules in modern campaigns.",
              link: {
                label: "Weapon Mastery (Rules Cyclopedia)",
                url: "https://www.dragonsfoot.org/forums/viewtopic.php?t=36241"
              }
            },
            subclasses: [
              {
                name: "Knight of the Order",
                spotlight:
                  "Chivalric path with heraldry, followers, and dominion obligations.",
                features: [
                  "Gains a keep and loyal retainers at Name level",
                  "Order codes foreshadow 5e's paladin oaths and downtime guidelines"
                ],
                sources: [
                  {
                    label: "Companion Set",
                    url: "https://www.dmsguild.com/product/17182/Companion-Set-Basic"
                  }
                ],
                comparison: {
                  note:
                    "Map the order's tenets onto 5e paladin oaths to modernize roleplay expectations while keeping BECMI domain play intact.",
                  link: {
                    label: "Oath of Devotion (5e SRD)",
                    url: "https://www.dndbeyond.com/sources/srd/subclasses#PaladinSacredOaths"
                  }
                }
              },
              {
                name: "Warlord",
                spotlight:
                  "Mass-combat specialist using War Machine rules to command troops.",
                features: [
                  "Adds tactical bonuses to army morale and initiative",
                  "Integrates with dominion taxation and troop upkeep subsystems"
                ],
                sources: [
                  {
                    label: "Companion Set",
                    url: "https://www.dmsguild.com/product/17182/Companion-Set-Basic"
                  }
                ],
                comparison: {
                  note:
                    "4e's warlord and 5e's Battle Master maneuvers borrow similar command themes—porting superiority dice can simplify War Machine swings for new players.",
                  link: {
                    label: "Battle Master (5e SRD)",
                    url: "https://www.dndbeyond.com/sources/srd/subclasses#FighterMartialArchetypes"
                  }
                }
              }
            ]
          },
          {
            name: "Magic-User",
            role: "Classic Vancian spellcaster",
            primaryAbility: "Intelligence",
            hitDie: "d4",
            summary:
              "Prepare a handful of potent spells and rely on clever resource management until higher circles unlock.",
            signatureFeatures: [
              "Spells are memorized verbatim and forgotten when cast",
              "Stronghold research unlocks new spells and magical experiments",
              "At name level you can craft constructs and magical items"
            ],
            sources: [
              {
                label: "Rules Cyclopedia",
                url: "https://www.dmsguild.com/product/17171/Rules-Cyclopedia-Basic"
              }
            ],
            comparison: {
              note:
                "3.5 and 5e wizards share the spellbook DNA but offer more low-level slots; blending modern ritual casting with BECMI memorization keeps nostalgia without stalling pacing.",
              link: {
                label: "Ritual Casting (5e Basic)",
                url: "https://www.dndbeyond.com/sources/basic-rules/spellcasting#Rituals"
              }
            },
            subclasses: [
              {
                name: "Elementalist",
                spotlight:
                  "Focus your spell research on elemental devastation and planar contacts.",
                features: [
                  "Expanded lists add exclusive elemental spells unavailable to generalists",
                  "Circle rituals open gateways similar to 5e's Planar Binding"
                ],
                sources: [
                  {
                    label: "Master Set",
                    url: "https://www.dmsguild.com/product/17183/Master-Set-Basic"
                  }
                ],
                comparison: {
                  note:
                    "Translate Elementalist blasts using 5e's elemental adept feats to maintain high damage without breaking bounded accuracy.",
                  link: {
                    label: "Elemental Adept (5e SRD)",
                    url: "https://www.dndbeyond.com/sources/srd/feats#ElementalAdept"
                  }
                }
              },
              {
                name: "Wyrd",
                spotlight:
                  "Mystic seer who blends enchantment and divination with fate-weaving.",
                features: [
                  "Prophecy rituals mimic 5e's divination spells but with campaign-scale stakes",
                  "Can craft talismans granting limited rerolls akin to 2024 Heroic Inspiration"
                ],
                sources: [
                  {
                    label: "Gazetteer Series",
                    url: "https://www.dmsguild.com/product/229802/Mystara-Gazetteer-Compilation"
                  }
                ],
                comparison: {
                  note:
                    "Layer in 5e's Portent mechanic from the Divination wizard to emulate Wyrd fate dice without bespoke charts.",
                  link: {
                    label: "Divination Tradition (5e SRD)",
                    url: "https://www.dndbeyond.com/sources/srd/subclasses#WizardArcaneTraditions"
                  }
                }
              }
            ]
          }
        ]
      };

      const ITEMS = [
        {
          name: "Vorpal Sword",
          type: "Weapon",
          rarity: "Legendary",
          edition: "1e+",
          description: "On a critical hit, the sword severs the target's head if it has one and is susceptible to critical hits.",
          source: "DMG (multiple editions)",
          attunement: "Requires attunement by a creature proficient with martial weapons in modern rules; early printings assume any competent wielder.",
          attunementTag: "conditional",
          cost: "Priceless; treated as artifact-tier treasure rather than a market commodity.",
          notes: "Decapitation triggers on natural 20s in later editions; 1e uses a broader critical range against some foes.",
          editionSpecific: true
        },
        {
          name: "Bag of Holding",
          type: "Wondrous Item",
          rarity: "Uncommon",
          edition: "OD&D+",
          description: "Extra-dimensional storage holding up to 500 lb while weighing a fraction of the contents.",
          source: "SRD 5.1, DMG",
          attunement: "No attunement needed; anyone can reach inside to retrieve gear with an action.",
          attunementTag: "none",
          cost: "Typically 2,500–5,000 gp depending on edition and setting economy.",
          notes: "Overfilling or puncturing risks planar rupture; mixing with portable holes can tear a gate to the Astral Plane.",
          editionSpecific: true
        },
        {
          name: "Deck of Many Things",
          type: "Wondrous Item",
          rarity: "Legendary",
          edition: "1e+",
          description: "Draw from the deck to gain boons or banes ranging from treasure and XP to imprisonment.",
          source: "DMG",
          attunement: "No attunement; cards are activated by declaring and drawing.",
          attunementTag: "none",
          cost: "Never sold—its chaos value makes it a plot device instead of trade goods.",
          notes: "Deck size varies by edition: 13-card truncated versions exist alongside the full 22-card spread.",
          editionSpecific: true
        },
        {
          name: "Sun Blade",
          type: "Weapon",
          rarity: "Rare",
          edition: "1e+",
          description: "Versatile finesse longsword emitting radiant damage and bright sunlight on command.",
          source: "SRD 5.1",
          attunement: "Requires attunement by a creature proficient with martial weapons, harmonizing with the blade's solar core.",
          attunementTag: "required",
          cost: "Valued around 15,000 gp in 3.5e pricing; most tables treat it as relic-tier loot.",
          notes: "Functions as a shortsword for finesse users; older editions call it a bastard sword with variable damage dice.",
          editionSpecific: true
        },
        {
          name: "Winged Boots",
          type: "Wondrous Item",
          rarity: "Uncommon",
          edition: "1e+",
          description: "Grants a flying speed equal to your walking speed for limited durations per day.",
          source: "SRD 5.1",
          attunement: "Requires attunement; the wearer channels magic with each step to gain flight.",
          attunementTag: "required",
          cost: "Usually 4,000–5,000 gp where magic gear is traded.",
          notes: "Flight duration refreshes after short rests in 5e; earlier editions use a pooled hour total per day.",
          editionSpecific: true
        },
        {
          name: "Portable Hole",
          type: "Wondrous Item",
          rarity: "Rare",
          edition: "1e+",
          description: "Creates an extradimensional space 10 ft deep that can be folded and carried.",
          source: "SRD 5.1",
          attunement: "No attunement; the hole responds to any creature unfolding it against a surface.",
          attunementTag: "none",
          cost: "Commonly listed around 20,000 gp in pre-5e sources.",
          notes: "Contact with a bag of holding or similar space tears a 1d10 round rift to the Astral Plane in most editions.",
          editionSpecific: true
        },
        {
          name: "Immovable Rod",
          type: "Wondrous Item",
          rarity: "Uncommon",
          edition: "1e+",
          description: "Pressing a button causes the rod to defy gravity and remain fixed in space until released.",
          source: "SRD 5.1",
          attunement: "No attunement needed; activation is purely mechanical.",
          attunementTag: "none",
          cost: "Typically 5,000 gp but varies with availability.",
          notes: "Supports up to 8,000 lb in 5e; AD&D references 10,000 gp weight limits before bending.",
          editionSpecific: true
        },
        {
          name: "Plate Armor",
          type: "Armor",
          rarity: "Standard",
          edition: "All",
          description: "Heavy armor granting high AC with disadvantage on Stealth checks and a Strength requirement in newer editions.",
          source: "PHB",
          attunement: "No attunement; mundane craftsmanship suits any trained wearer.",
          attunementTag: "none",
          cost: "1,500 gp baseline in 5e; Basic/AD&D pricing ranges from 50–400 gp depending on the ruleset.",
          notes: "5e adds STR 15 requirement and disadvantage on Stealth; older editions adjust movement rate instead.",
          editionSpecific: true
        },
        {
          name: "Elven Chain",
          type: "Armor",
          rarity: "Rare",
          edition: "1e+",
          description: "Lightweight chainmail granting advantage on Dexterity checks to avoid stealth penalties.",
          source: "DMG",
          attunement: "Requires attunement by a creature proficient with light armor in 5e; AD&D versions can be worn without attuning.",
          attunementTag: "conditional",
          cost: "Priced around 16,000 gp in 3.5e references; often gifted instead of purchased.",
          notes: "Counts as medium armor in some editions but allows proficiency-free wear for elves in AD&D.",
          editionSpecific: true
        },
        {
          name: "Staff of Power",
          type: "Staff",
          rarity: "Very Rare",
          edition: "1e+",
          description: "Versatile arcane focus with charges for spells, a retributive strike, and AC/attack bonuses.",
          source: "DMG",
          attunement: "Requires attunement by a sorcerer, warlock, or wizard (or similar arcane caster in older systems).",
          attunementTag: "required",
          cost: "Valued at 235,000 gp in 3.5e; otherwise treated as relic-level treasure.",
          notes: "Retributive strike detonates remaining charges; AD&D calls for percentile survival checks on the wielder.",
          editionSpecific: true
        },
        {
          name: "Manual of Quickness of Action",
          type: "Wondrous Item",
          rarity: "Very Rare",
          edition: "1e+",
          description: "Study increases Dexterity permanently once and then loses magic.",
          source: "DMG",
          attunement: "Requires attunement during the 48-hour study period to absorb its magic.",
          attunementTag: "required",
          cost: "About 55,000 gp in 3.5e guidelines; unique lore tomes may command higher bids.",
          notes: "Ability score increase occurs over six days of dedicated study; earlier editions boost Dexterity by a flat amount.",
          editionSpecific: true
        },
        {
          name: "Alchemy Jug",
          type: "Wondrous Item",
          rarity: "Uncommon",
          edition: "5e",
          description: "Produces various liquids each day like mayonnaise, acid, or oil as chosen.",
          source: "SRD 5.1",
          attunement: "No attunement; command words pour the desired fluid.",
          attunementTag: "none",
          cost: "Estimated 2,000 gp in Xanathar-style pricing charts.",
          notes: "Daily allotments reset at dawn; the volume of each liquid is fixed to the SRD table.",
          editionSpecific: false
        },
        {
          name: "Keoghtom's Ointment",
          type: "Wondrous Item",
          rarity: "Uncommon",
          edition: "1e+",
          description: "Salve that heals hit points, cures poison, and disease when applied.",
          source: "DMG",
          attunement: "No attunement; sealed vials activate when unstoppered.",
          attunementTag: "none",
          cost: "Typically sold in lots of 5 doses for 500 gp.",
          notes: "Each dose heals 2d8+2 in 5e; AD&D heals 1d8+2 and neutralizes poison on contact.",
          editionSpecific: true
        },
        {
          name: "Bracers of Defense",
          type: "Wondrous Item",
          rarity: "Rare",
          edition: "1e+",
          description: "Grants AC bonus when not wearing armor or using a shield.",
          source: "SRD 5.1",
          attunement: "Requires attunement; the bands sync to the wearer's aura for a protective field.",
          attunementTag: "required",
          cost: "Around 25,000 gp in AD&D; 5e treatises suggest 6,000 gp when sold.",
          notes: "Ideal for monks and sorcerers; earlier editions set AC bonuses by bracer type (AC 6 through AC 2).",
          editionSpecific: true
        },
        {
          name: "Cloak of Displacement",
          type: "Wondrous Item",
          rarity: "Rare",
          edition: "1e+",
          description: "Projects an illusion causing attackers to have disadvantage until you are hit.",
          source: "DMG",
          attunement: "Requires attunement; the cloak bends light for the wearer after synchronization.",
          attunementTag: "required",
          cost: "Often listed near 50,000 gp in AD&D value charts.",
          notes: "Effect ends until next turn after you take damage in 5e; 3.5 grants a constant 20% miss chance.",
          editionSpecific: true
        }
      ];

      const SPELLS = [
        {
          name: "Magic Missile",
          level: 1,
          school: "Evocation",
          classes: ["Wizard", "Sorcerer", "Arcane Trickster", "Eldritch Knight"],
          edition: "OD&D · AD&D 1e · 3.5e SRD · 5e SRD",
          summary: "Loose darts of force that automatically strike and scale with slot level, making the spell a reliable answer to evasive foes across every SRD.",
          castingTime: "1 action (5e) · 1 segment (AD&D)",
          range: "120 feet",
          duration: "Instantaneous",
          components: "V, S",
          savingThrow: "None",
          source: "SRD 5.1, d20 SRD",
          keywords: ["force", "auto-hit", "damage"]
        },
        {
          name: "Fireball",
          level: 3,
          school: "Evocation",
          classes: ["Wizard", "Sorcerer", "Artificer (Artillerist)"],
          edition: "AD&D 1e · 3.5e SRD · 5e SRD",
          summary: "Unleash a 20-foot radius inferno for 8d6 fire damage, a benchmark area spell that trades precision for devastating battlefield control across editions.",
          castingTime: "1 action (5e) · 1 segment (AD&D)",
          range: "150 feet",
          duration: "Instantaneous",
          components: "V, S, M (a bat guano and sulfur pellet)",
          savingThrow: "Dexterity half",
          source: "SRD 5.1, d20 SRD",
          keywords: ["fire", "area", "damage"]
        },
        {
          name: "Cure Wounds",
          level: 1,
          school: "Evocation",
          classes: ["Cleric", "Druid", "Bard", "Paladin"],
          edition: "BECMI · AD&D 2e · 3.5e SRD · 5e SRD",
          summary: "Channel divine energy through a touch to restore 1d8 plus your spellcasting modifier, scaling with slot investment in every SRD release.",
          castingTime: "1 action (5e) · 1 round (BECMI)",
          range: "Touch",
          duration: "Instantaneous",
          components: "V, S",
          savingThrow: "None",
          source: "SRD 5.1, Basic/Expert Set",
          keywords: ["healing", "support", "touch"]
        },
        {
          name: "Hold Person",
          level: 2,
          school: "Enchantment",
          classes: ["Cleric", "Druid", "Wizard", "Bard", "Paladin"],
          edition: "OD&D · AD&D 1e · 3.5e SRD · 5e SRD",
          summary: "Lock a humanoid in place with a Wisdom save or remain paralyzed, a classic control option that forces repeat saves at the end of each turn.",
          castingTime: "1 action",
          range: "60 feet",
          duration: "Up to 1 minute (concentration)",
          components: "V, S, M (a straight iron bar)",
          savingThrow: "Wisdom negates",
          source: "SRD 5.1, d20 SRD",
          keywords: ["control", "paralysis", "concentration"]
        },
        {
          name: "Detect Magic",
          level: 1,
          school: "Divination",
          classes: ["Wizard", "Cleric", "Druid", "Bard", "Paladin (Devotion)"],
          edition: "OD&D · AD&D 1e · 3.5e SRD · 5e SRD",
          summary: "Sense active spells and magical auras within 30 feet, revealing the school of magic with focused attention and available as a ritual in most modern rulesets.",
          castingTime: "1 action",
          range: "Self (30-foot radius)",
          duration: "Up to 10 minutes (concentration)",
          components: "V, S",
          savingThrow: "None",
          source: "SRD 5.1, d20 SRD",
          keywords: ["utility", "detection", "ritual"]
        },
        {
          name: "Shield",
          level: 1,
          school: "Abjuration",
          classes: ["Wizard", "Sorcerer", "Arcane Trickster", "Eldritch Knight"],
          edition: "AD&D 1e · 3.5e SRD · 5e SRD",
          summary: "Summon an instant barrier to boost AC by 5 and negate Magic Missile, keeping fragile casters alive when an attack slips past their defenses.",
          castingTime: "1 reaction (triggered when targeted)",
          range: "Self",
          duration: "1 round",
          components: "V, S",
          savingThrow: "None",
          source: "SRD 5.1, d20 SRD",
          keywords: ["defense", "reaction", "abjuration"]
        },
        {
          name: "Cone of Cold",
          level: 5,
          school: "Evocation",
          classes: ["Wizard", "Sorcerer"],
          edition: "AD&D 1e · 3.5e SRD · 5e SRD",
          summary: "Project a 60-foot cone of freezing wind for 8d8 cold damage, a higher-tier alternative to fireball that punishes clustered foes with a different damage type.",
          castingTime: "1 action",
          range: "Self (60-foot cone)",
          duration: "Instantaneous",
          components: "V, S, M (a crystal or glass cone)",
          savingThrow: "Constitution half",
          source: "SRD 5.1, d20 SRD",
          keywords: ["cold", "area", "damage"]
        },
        {
          name: "Silence",
          level: 2,
          school: "Illusion",
          classes: ["Cleric", "Druid", "Bard", "Ranger"],
          edition: "BECMI · AD&D 1e · 3.5e SRD · 5e SRD",
          summary: "Create a 20-foot-radius zone where no sound can be created, crippling verbal spellcasting and stealth checks that rely on noise.",
          castingTime: "1 action",
          range: "120 feet",
          duration: "Up to 10 minutes (concentration)",
          components: "V, S",
          savingThrow: "None",
          source: "SRD 5.1, d20 SRD",
          keywords: ["control", "utility", "area"]
        },
        {
          name: "Mage Hand",
          level: 0,
          school: "Conjuration",
          classes: ["Wizard", "Sorcerer", "Bard", "Warlock"],
          edition: "OD&D · AD&D 1e · 3.5e SRD · 5e SRD",
          summary: "Conjure a spectral hand that manipulates unattended objects, pulls levers, and delivers small items safely from a distance.",
          castingTime: "1 action",
          range: "30 feet",
          duration: "1 minute",
          components: "V, S",
          savingThrow: "None",
          source: "SRD 5.1, d20 SRD",
          keywords: ["utility", "manipulation", "cantrip"]
        }
      ];

      const CONDITIONS = [
        {
          name: "Blinded",
          duration: "Varies by source",
          durationTag: "ongoing",
          savingThrow: "None",
          summary: "A blinded creature can't see, automatically fails sight-based checks, and attack rolls against it gain advantage while its own attacks suffer disadvantage.",
          source: "SRD 5.1",
          effects: [
            "Vision-based Perception checks automatically fail",
            "Attack rolls against the creature have advantage",
            "The creature's attack rolls have disadvantage"
          ],
          keywords: ["senses", "perception", "advantage"]
        },
        {
          name: "Charmed",
          duration: "Varies by source",
          durationTag: "ongoing",
          savingThrow: "Varies",
          summary: "A charmed creature can't attack the charmer and treats the charmer's social checks with friendly bias.",
          source: "SRD 5.1",
          effects: [
            "The charmed creature can't target the charmer with harmful abilities",
            "The charmer has advantage on social ability checks to interact with the creature"
          ],
          keywords: ["influence", "social", "enchantment"]
        },
        {
          name: "Frightened",
          duration: "Varies by source",
          durationTag: "ongoing",
          savingThrow: "Varies",
          summary: "Fearful creatures struggle to focus, gaining disadvantage on ability checks and attacks while the source is in sight and cannot willingly move closer to it.",
          source: "SRD 5.1",
          effects: [
            "Disadvantage on ability checks and attack rolls while the source of fear is in sight",
            "Cannot willingly move closer to the source of fear"
          ],
          keywords: ["fear", "control", "movement"]
        },
        {
          name: "Grappled",
          duration: "Until escaped or released",
          durationTag: "special",
          savingThrow: "Varies (usually Strength or Dexterity to escape)",
          summary: "Movement drops to 0 and can't be increased. Ends if the grappler is incapacitated or moved away from the target's reach.",
          source: "SRD 5.1",
          effects: [
            "Speed becomes 0",
            "Bonuses to speed don't apply",
            "Condition ends if the grappler is incapacitated or the creature is removed from reach"
          ],
          keywords: ["movement", "escape", "control"]
        },
        {
          name: "Paralyzed",
          duration: "Varies by source",
          durationTag: "ongoing",
          savingThrow: "Varies",
          summary: "The creature is incapacitated, can't move or speak, automatically fails Strength and Dexterity saves, and critical hits land at close range.",
          source: "SRD 5.1",
          effects: [
            "The creature is incapacitated and can't move or speak",
            "Automatically fails Strength and Dexterity saving throws",
            "Attack rolls against the creature have advantage, and within 5 feet they become critical hits on a hit"
          ],
          keywords: ["incapacitated", "dexterity", "critical"]
        },
        {
          name: "Poisoned",
          duration: "Varies by source",
          durationTag: "ongoing",
          savingThrow: "Varies",
          summary: "Toxic afflictions sap vitality, imposing disadvantage on attack rolls and ability checks until cured or the effect ends.",
          source: "SRD 5.1",
          effects: [
            "Disadvantage on attack rolls",
            "Disadvantage on ability checks"
          ],
          keywords: ["toxins", "penalty", "disease"]
        },
        {
          name: "Prone",
          duration: "Until standing or otherwise moved",
          durationTag: "instant",
          savingThrow: "None",
          summary: "Fallen creatures crawl or stand slowly, making melee swings against them easier while ranged shots are harder.",
          source: "SRD 5.1",
          effects: [
            "The creature's only movement option is to crawl unless it stands, costing half its movement",
            "Attack rolls against the creature have advantage if within 5 feet, otherwise disadvantage",
            "The creature's attack rolls have disadvantage"
          ],
          keywords: ["movement", "melee", "positioning"]
        },
        {
          name: "Stunned",
          duration: "Varies by source",
          durationTag: "ongoing",
          savingThrow: "Varies",
          summary: "A stunned creature is incapacitated, can't move, and can speak only falteringly, while attackers enjoy advantage and the victim fails Strength and Dexterity saves.",
          source: "SRD 5.1",
          effects: [
            "The creature is incapacitated, can't move, and can speak only falteringly",
            "Automatically fails Strength and Dexterity saving throws",
            "Attack rolls against the creature have advantage"
          ],
          keywords: ["incapacitated", "control", "stagger"]
        }
      ];

      const XP_BY_CR = {
        "0": 10,
        "1/8": 25,
        "1/4": 50,
        "1/2": 100,
        "1": 200,
        "2": 450,
        "3": 700,
        "4": 1100,
        "5": 1800,
        "6": 2300,
        "7": 2900,
        "8": 3900,
        "9": 5000,
        "10": 5900,
        "11": 7200,
        "12": 8400,
        "13": 10000,
        "14": 11500,
        "15": 13000,
        "16": 15000,
        "17": 18000,
        "18": 20000,
        "19": 22000,
        "20": 25000,
        "21": 33000,
        "22": 41000,
        "23": 50000,
        "24": 62000,
        "25": 75000,
        "26": 90000,
        "27": 105000,
        "28": 120000,
        "29": 135000,
        "30": 155000
      };

      function parseCR(cr) {
        if (typeof cr === "number") return cr;
        if (typeof cr === "string") {
          const trimmed = cr.trim();
          if (trimmed.includes("/")) {
            const [num, denom] = trimmed.split("/").map(Number);
            if (!Number.isNaN(num) && !Number.isNaN(denom) && denom !== 0) {
              return num / denom;
            }
          }
          const numeric = Number(trimmed);
          if (!Number.isNaN(numeric)) {
            return numeric;
          }
        }
        return 0;
      }

      const slugify = (value) => value.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");

      const MONSTERS = [
        {
          name: "Adult Black Dragon",
          size: "Huge",
          creatureType: "Dragon",
          alignment: "Chaotic evil",
          challenge: "14",
          terrain: ["Swamp", "Coastal"],
          role: ["Solo", "Controller"],
          overview: "A patient tyrant that lurks in fetid marshes, reshaping the landscape with acid and dominating local tribes as expendable scouts.",
          signatureAbilities: [
            "Acid Breath (Recharge 5–6): Unleashes a corrosive line that eats through ranks and cover alike, forcing Dexterity saves for half damage.",
            "Amphibious Ambusher: A swim speed and superior darkvision let the dragon strike from underwater tunnels or night skies without warning.",
            "Legendary Actions: Wing beats, tail lashes, and perception sweeps keep the dragon airborne and responsive between turns."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Monstrous Manual (AD&D 2e)", url: "https://www.dmsguild.com/product/17171/Monstrous-Compendium--Volume-One-and-Two" }
          ]
        },
        {
          name: "Behir",
          size: "Huge",
          creatureType: "Monstrosity",
          alignment: "Neutral evil",
          challenge: "11",
          terrain: ["Mountain", "Underdark"],
          role: ["Skirmisher", "Striker"],
          overview: "Serpentine predators that coil around storm-lashed peaks or deep caverns, hunting with sudden pounces and lightning blasts.",
          signatureAbilities: [
            "Multiattack & Swallow: Claws and bites restrain prey so the behir can swallow and keep fighting with a belly full of heroes.",
            "Lightning Breath (Recharge 5–6): A focused blast that punishes tightly packed parties climbing a ridge or tunnel.",
            "Spider Climb: Its innate climbing lets it ambush from ceilings, cliffs, or stalagmites far from melee reprisal."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Monster Manual (1e)", url: "https://www.dmsguild.com/product/17004/Monster-Manual-1e" }
          ]
        },
        {
          name: "Frost Giant",
          size: "Huge",
          creatureType: "Giant",
          alignment: "Neutral evil",
          challenge: "8",
          terrain: ["Arctic", "Mountain"],
          role: ["Brute", "Soldier"],
          overview: "Raid leaders from the frozen north who wield great axes like siege engines and command loyal winter wolves.",
          signatureAbilities: [
            "Greataxe Strikes: High damage per swing makes the giant a threat to any front-liner without strong defenses.",
            "Rock Hurling: Giants keep pressure on distant foes or fortifications with improvised boulders.",
            "Frigid Resilience: Cold immunity and hardy saves let them ignore many Arctic hazards the party relies on."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Against the Giants (1e)", url: "https://www.dmsguild.com/product/17035/G1-3-Against-the-Giants-1e" }
          ]
        },
        {
          name: "Gelatinous Cube",
          size: "Large",
          creatureType: "Ooze",
          alignment: "Unaligned",
          challenge: "2",
          terrain: ["Dungeon", "Underdark"],
          role: ["Controller", "Hazard"],
          overview: "Transparent dungeon sweepers that dissolve gear and creatures alike while sliding silently through corridors.",
          signatureAbilities: [
            "Engulf: Creatures sharing its space are paralyzed and dissolved, making tight halls terrifying chokepoints.",
            "Transparent Form: Without careful perception checks the cube remains unseen until it strikes.",
            "Pseudopod Reach: Extends to capture stragglers or retrieve suspended treasure from within."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "d20 SRD", url: "https://www.d20srd.org/srd/monsters/gelatinousCube.htm" }
          ]
        },
        {
          name: "Kobold Saboteur",
          size: "Small",
          creatureType: "Humanoid",
          alignment: "Lawful evil",
          challenge: "1/8",
          terrain: ["Dungeon", "Mountain"],
          role: ["Skirmisher", "Trapmaker"],
          overview: "Pack hunters that soften intruders with sling stones, traps, and clever tactics before darting into narrow tunnels.",
          signatureAbilities: [
            "Pack Tactics: Gains advantage when swarming a foe alongside another ally.",
            "Saboteur's Satchel: Carries caltrops, oil, and noise-makers to delay pursuit.",
            "Nimble Escape: Uses bonus actions to hide or disengage after laying snares."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Volo's Guide to Monsters", url: "https://www.dndbeyond.com/sources/vgm" }
          ]
        },
        {
          name: "Skeleton Archer",
          size: "Medium",
          creatureType: "Undead",
          alignment: "Lawful evil",
          challenge: "1/4",
          terrain: ["Dungeon", "Desert", "Ruins"],
          role: ["Artillery"],
          overview: "Reanimated archers that hold defensible chokepoints while their necromancer masters advance with melee troops.",
          signatureAbilities: [
            "Sharpened Volley: Longbows pepper the backline with reliable piercing damage.",
            "Undead Fortitude: Keeps the archer fighting through blows that would drop living soldiers.",
            "Siege Awareness: Ignores sleep and fear, ideal for long sieges and midnight assaults."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Rules Cyclopedia", url: "https://www.dmsguild.com/product/17171/Rules-Cyclopedia-Basic" }
          ]
        },
        {
          name: "Orc Raider",
          size: "Medium",
          creatureType: "Humanoid",
          alignment: "Chaotic evil",
          challenge: "1/2",
          terrain: ["Grassland", "Mountain", "Tundra"],
          role: ["Brute", "Skirmisher"],
          overview: "Shock troops that close quickly with greataxes and aggressive charges to overwhelm frontier settlements.",
          signatureAbilities: [
            "Aggressive: Covers extra ground each round to stay in melee with fleeing targets.",
            "Relentless Endurance: Survives finishing blows long enough to retreat or retaliate.",
            "Tribal War Calls: Uses bonus actions to grant advantage on the next attack for nearby orcs."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Monster Manual (1e)", url: "https://www.dmsguild.com/product/17004/Monster-Manual-1e" }
          ]
        },
        {
          name: "Bandit Captain",
          size: "Medium",
          creatureType: "Humanoid",
          alignment: "Any non-lawful",
          challenge: "2",
          terrain: ["Urban", "Forest", "Coastal"],
          role: ["Leader", "Striker"],
          overview: "Seasoned raiders that coordinate ambushes, leverage multiattack, and direct minions with ruthless efficiency.",
          signatureAbilities: [
            "Parry: Uses reactions to turn away a crucial hit while allies reposition.",
            "Multiattack: Combines scimitar and dagger strikes to threaten lightly armored foes.",
            "Tactical Orders: Grants allied bandits a bonus to damage when focusing fire on a single hero."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Ghosts of Saltmarsh", url: "https://www.dndbeyond.com/sources/gos" }
          ]
        },
        {
          name: "Cult Fanatic",
          size: "Medium",
          creatureType: "Humanoid",
          alignment: "Any evil",
          challenge: "2",
          terrain: ["Urban", "Dungeon"],
          role: ["Support", "Caster"],
          overview: "Devoted priests who combine dagger strikes with dark prayers, bolstering cult cells during infiltration missions.",
          signatureAbilities: [
            "Dark Blessing: Imbues allies with temporary hit points before combat erupts.",
            "Inflict Wounds: Delivers swingy burst damage to punish distracted defenders.",
            "Fanatic Zeal: Fights to the death and triggers morale bonuses for surviving cultists."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Princes of the Apocalypse", url: "https://www.dndbeyond.com/sources/pota" }
          ]
        },
        {
          name: "Veteran Sellsword",
          size: "Medium",
          creatureType: "Humanoid",
          alignment: "Any",
          challenge: "3",
          terrain: ["Urban", "Road", "Siege"],
          role: ["Soldier", "Bodyguard"],
          overview: "Battle-tested mercenaries wielding sword and crossbow, often hired to defend caravans or noble envoys.",
          signatureAbilities: [
            "Crossbow Volley: Opens with a heavy crossbow before closing to melee.",
            "Second Wind: Recovers hit points mid-fight to stay in the fray longer than green troops.",
            "Formation Fighter: Grants advantage on opportunity attacks when fighting shoulder-to-shoulder."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Waterdeep: Dragon Heist", url: "https://www.dndbeyond.com/sources/wdh" }
          ]
        },
        {
          name: "Wraith",
          size: "Medium",
          creatureType: "Undead",
          alignment: "Neutral evil",
          challenge: "5",
          terrain: ["Dungeon", "Shadowfell", "Graveyard"],
          role: ["Skirmisher", "Controller"],
          overview: "Malevolent spirits that drain life and spawn specters, perfect for set pieces in haunted keeps.",
          signatureAbilities: [
            "Life Drain: On a failed save, reduces hit point maximum, terrifying even seasoned parties.",
            "Incorporeal Movement: Phases through walls to attack backlines or retreat through sealed crypts.",
            "Create Specter: Fallen heroes might rise as minions, escalating drawn-out fights."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Monster Manual (1e)", url: "https://www.dmsguild.com/product/17004/Monster-Manual-1e" }
          ]
        },
        {
          name: "Yuan-ti Malison",
          size: "Medium",
          creatureType: "Monstrosity",
          alignment: "Neutral evil",
          challenge: "5",
          terrain: ["Jungle", "Temple", "Swamp"],
          role: ["Controller", "Caster"],
          overview: "Serpentine masterminds that blend swordplay with venomous magic to defend hidden temples.",
          signatureAbilities: [
            "Multiattack: Strikes with scimitars and venomous bites to lock down front-liners.",
            "Innate Spellcasting: Access to suggestion and hold person keeps heroes off-balance.",
            "Shapechanging: Infiltrates humanoid societies before revealing serpentine forms."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Tomb of Annihilation", url: "https://www.dndbeyond.com/sources/toa" }
          ]
        },
        {
          name: "Githyanki Knight",
          size: "Medium",
          creatureType: "Humanoid",
          alignment: "Lawful evil",
          challenge: "8",
          terrain: ["Astral Sea", "Planar Stronghold"],
          role: ["Elite", "Striker"],
          overview: "Astral raiders who lead silver-sword charges from red dragons or spelljamming ships.",
          signatureAbilities: [
            "Silver Greatsword: Carves through planar foes and severs astral cords.",
            "Innate Psionics: Casts plane shift and telekinesis to reposition the battlefield.",
            "Martial Advantage: Deals extra damage when allies surround a target."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Mordenkainen Presents", url: "https://www.dndbeyond.com/sources/mpmm" }
          ]
        },
        {
          name: "Young Red Dragon",
          size: "Large",
          creatureType: "Dragon",
          alignment: "Chaotic evil",
          challenge: "10",
          terrain: ["Mountain", "Volcano"],
          role: ["Solo", "Artillery"],
          overview: "Volcanic tyrants that claim tribute from mountainside villages while raining fire upon rivals.",
          signatureAbilities: [
            "Fire Breath (Recharge 5–6): Cone of fire devastates clustered adventurers.",
            "Frightful Presence: Forces morale checks that can scatter low-level retainers.",
            "Molten Lair Actions: Melts footing or spews magma vents inside its lair."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Dragonlance Campaign Setting", url: "https://www.dmsguild.com/product/36821/Dragonlance-Campaign-Setting" }
          ]
        },
        {
          name: "Stone Golem",
          size: "Large",
          creatureType: "Construct",
          alignment: "Unaligned",
          challenge: "10",
          terrain: ["Dungeon", "Temple"],
          role: ["Defender", "Solo"],
          overview: "Runic guardians carved from granite that obey ancient commands and shrug off most magic.",
          signatureAbilities: [
            "Immutable Form: Immune to many effects that would disable living guards.",
            "Slow Gaze: Recharges a cone that hinders quick-moving parties.",
            "Magic Resistance: Advantage on saves keeps the golem standing amid spell barrages."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "d20 SRD", url: "https://www.d20srd.org/srd/monsters/golem.htm" }
          ]
        },
        {
          name: "Storm Giant Quintessent",
          size: "Huge",
          creatureType: "Giant",
          alignment: "Chaotic good",
          challenge: "16",
          terrain: ["Coastal", "Planar", "Storm"],
          role: ["Solo", "Controller"],
          overview: "Elemental avatars of the tempest that stride storms as living thunderheads, defending giant realms from titanic threats.",
          signatureAbilities: [
            "Arc Lightning: Strikes two targets at once with searing storm bolts.",
            "Tempestuous Touch: Forces Strength saves to avoid being hurled from cliffs.",
            "Mythic Lair Actions: Summons cyclone walls and hurricane-force winds each round."
          ],
          sources: [
            { label: "Mordenkainen Presents", url: "https://www.dndbeyond.com/sources/mpmm" },
            { label: "Storm King's Thunder", url: "https://www.dndbeyond.com/sources/skt" }
          ]
        },
        {
          name: "Goblin Boss",
          size: "Small",
          creatureType: "Humanoid",
          alignment: "Neutral evil",
          challenge: "1",
          terrain: ["Forest", "Cavern", "Urban"],
          role: ["Leader", "Skirmisher"],
          overview: "Cunning commanders who weaponize mobility and minions to harry caravans before slipping back into the dark.",
          signatureAbilities: [
            "Redirect Attack: Uses nearby goblins as unwilling shields to blunt incoming blows.",
            "Multiattack: Combines scimitar and dagger strikes for swingy burst damage on isolated targets.",
            "Nimble Escape: Bonus-action Disengage or Hide keeps the boss alive long enough to rally reinforcements."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Basic Rules", url: "https://dnd.wizards.com/resources/basic-rules" }
          ]
        },
        {
          name: "Treant",
          size: "Huge",
          creatureType: "Plant",
          alignment: "Chaotic good",
          challenge: "9",
          terrain: ["Forest"],
          role: ["Defender", "Support"],
          overview: "Ancient guardians of woodland realms who animate allies and reshape the battlefield with living roots.",
          signatureAbilities: [
            "Animate Trees: Calls nearby trees into battle, turning a clearing into a crowd of allied bludgeons.",
            "Slam Attacks: Heavy melee swings crush siege gear and punish fire-bearing intruders.",
            "Siege Monster: Deals double damage to structures, making treants ideal for defending or toppling fortifications."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "d20 SRD", url: "https://www.d20srd.org/srd/monsters/treant.htm" }
          ]
        },
        {
          name: "Lich",
          size: "Medium",
          creatureType: "Undead",
          alignment: "Any evil",
          challenge: "21",
          terrain: ["Dungeon", "Urban", "Shadowfell"],
          role: ["Solo", "Artillery"],
          overview: "Immortal spellcasters who trade mortality for arcane supremacy, defending phylacteries with layered wards and minions.",
          signatureAbilities: [
            "Paralyzing Touch: A chilling melee strike that locks down foes for follow-up spells.",
            "Legendary Resistance & Actions: Ensures the lich maintains control of the battlefield despite control effects.",
            "Spellcasting Arsenal: Access to high-level necromancy and control magic lets the lich script entire encounters."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "d20 SRD", url: "https://www.d20srd.org/srd/monsters/lich.htm" }
          ]
        }
      ].map(monster => {
        const challengeKey = typeof monster.challenge === "number" ? String(monster.challenge) : monster.challenge;
        const crValue = parseCR(monster.challenge);
        return {
          ...monster,
          id: monster.id || slugify(monster.name),
          xp: monster.xp ?? XP_BY_CR[challengeKey] ?? XP_BY_CR[String(crValue)] ?? 0,
          crValue
        };
      });

      const MONSTER_LOOKUP = new Map(MONSTERS.map(monster => [monster.id, monster]));

      const encounterPartyLevelInput = document.getElementById("encounter-party-level");
      const encounterPartySizeInput = document.getElementById("encounter-party-size");
      const encounterSearchInput = document.getElementById("encounter-monster-query");
      const encounterResultsContainer = document.getElementById("encounter-monster-results");
      const encounterRosterList = document.getElementById("encounter-roster");
      const encounterSummaryContainer = document.getElementById("encounter-summary");
      const encounterClearButton = document.getElementById("encounter-clear");

      if (
        encounterPartyLevelInput &&
        encounterPartySizeInput &&
        encounterSearchInput &&
        encounterResultsContainer &&
        encounterRosterList &&
        encounterSummaryContainer &&
        encounterClearButton
      ) {
        const PARTY_XP_THRESHOLDS = {
          1: { easy: 25, medium: 50, hard: 75, deadly: 100 },
          2: { easy: 50, medium: 100, hard: 150, deadly: 200 },
          3: { easy: 75, medium: 150, hard: 225, deadly: 400 },
          4: { easy: 125, medium: 250, hard: 375, deadly: 500 },
          5: { easy: 250, medium: 500, hard: 750, deadly: 1100 },
          6: { easy: 300, medium: 600, hard: 900, deadly: 1400 },
          7: { easy: 350, medium: 750, hard: 1100, deadly: 1700 },
          8: { easy: 450, medium: 900, hard: 1400, deadly: 2100 },
          9: { easy: 550, medium: 1100, hard: 1600, deadly: 2400 },
          10: { easy: 600, medium: 1200, hard: 1900, deadly: 2800 },
          11: { easy: 800, medium: 1600, hard: 2400, deadly: 3600 },
          12: { easy: 1000, medium: 2000, hard: 3000, deadly: 4500 },
          13: { easy: 1100, medium: 2200, hard: 3400, deadly: 5100 },
          14: { easy: 1250, medium: 2500, hard: 3800, deadly: 5700 },
          15: { easy: 1400, medium: 2800, hard: 4300, deadly: 6400 },
          16: { easy: 1600, medium: 3200, hard: 4800, deadly: 7200 },
          17: { easy: 2000, medium: 3900, hard: 5900, deadly: 8800 },
          18: { easy: 2100, medium: 4200, hard: 6300, deadly: 9500 },
          19: { easy: 2400, medium: 4900, hard: 7300, deadly: 10900 },
          20: { easy: 2800, medium: 5700, hard: 8500, deadly: 12700 }
        };

        const MULTIPLIER_STEPS = [
          { max: 1, label: "Single monster", multiplier: 1 },
          { max: 2, label: "Pair of monsters", multiplier: 1.5 },
          { max: 6, label: "3–6 monsters", multiplier: 2 },
          { max: 10, label: "7–10 monsters", multiplier: 2.5 },
          { max: 14, label: "11–14 monsters", multiplier: 3 },
          { max: Infinity, label: "15+ monsters", multiplier: 4 }
        ];

        const numberFormatter = new Intl.NumberFormat("en-US");
        const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

        const encounterState = {
          partyLevel: clamp(Math.floor(Number(encounterPartyLevelInput.value) || 1), 1, 20),
          partySize: clamp(Math.floor(Number(encounterPartySizeInput.value) || 4), 1, 8),
          monsters: []
        };

        encounterPartyLevelInput.value = String(encounterState.partyLevel);
        encounterPartySizeInput.value = String(encounterState.partySize);

        const formatXP = (value) => numberFormatter.format(Math.max(0, Math.round(value || 0)));

        const ensureRosterSorted = () => {
          encounterState.monsters.sort((a, b) => {
            const monsterA = MONSTER_LOOKUP.get(a.id);
            const monsterB = MONSTER_LOOKUP.get(b.id);
            const crDiff = (monsterB?.crValue ?? 0) - (monsterA?.crValue ?? 0);
            if (crDiff !== 0) return crDiff;
            return (monsterB?.xp ?? 0) - (monsterA?.xp ?? 0);
          });
        };

        const getMultiplierInfo = (count, partySize) => {
          if (count <= 0) {
            return {
              multiplier: 1,
              baseLabel: "No monsters",
              appliedLabel: "No monsters",
              adjustment: "Add creatures to calculate encounter difficulty"
            };
          }

          let index = MULTIPLIER_STEPS.findIndex(step => count <= step.max);
          if (index === -1) index = MULTIPLIER_STEPS.length - 1;
          const baseIndex = index;

          if (partySize <= 2 && index < MULTIPLIER_STEPS.length - 1) {
            index += 1;
          } else if (partySize >= 6 && index > 0) {
            index -= 1;
          }

          const adjustment =
            partySize <= 2
              ? "Adjusted up for a small party"
              : partySize >= 6
                ? "Adjusted down for a large party"
                : "Standard party size";

          return {
            multiplier: MULTIPLIER_STEPS[index].multiplier,
            baseLabel: MULTIPLIER_STEPS[baseIndex].label,
            appliedLabel: MULTIPLIER_STEPS[index].label,
            adjustment
          };
        };

        const getPartyThresholds = () => {
          const template = PARTY_XP_THRESHOLDS[encounterState.partyLevel] || PARTY_XP_THRESHOLDS[20];
          return {
            easy: template.easy * encounterState.partySize,
            medium: template.medium * encounterState.partySize,
            hard: template.hard * encounterState.partySize,
            deadly: template.deadly * encounterState.partySize
          };
        };

        const renderEncounterRoster = () => {
          encounterRosterList.innerHTML = "";

          if (!encounterState.monsters.length) {
            const empty = document.createElement("li");
            empty.className = "roster-empty";
            empty.textContent = "No creatures added yet. Use the search above to populate your encounter.";
            encounterRosterList.appendChild(empty);
            return;
          }

          encounterState.monsters.forEach(entry => {
            const monster = MONSTER_LOOKUP.get(entry.id);
            if (!monster) return;

            const item = document.createElement("li");
            item.className = "roster-row";
            item.dataset.id = entry.id;

            const meta = document.createElement("div");
            meta.className = "roster-meta";

            const title = document.createElement("strong");
            title.textContent = monster.name;
            meta.appendChild(title);

            const detail = document.createElement("span");
            detail.textContent = `CR ${monster.challenge} · ${formatXP(monster.xp)} XP each`;
            meta.appendChild(detail);

            const total = document.createElement("span");
            total.textContent = `${formatXP((monster.xp || 0) * entry.count)} XP total`;
            meta.appendChild(total);

            item.appendChild(meta);

            const actions = document.createElement("div");
            actions.className = "roster-actions";

            const decrease = document.createElement("button");
            decrease.type = "button";
            decrease.dataset.action = "decrease";
            decrease.textContent = "–";
            decrease.setAttribute("aria-label", `Remove one ${monster.name}`);
            actions.appendChild(decrease);

            const count = document.createElement("span");
            count.className = "roster-count";
            count.textContent = String(entry.count);
            actions.appendChild(count);

            const increase = document.createElement("button");
            increase.type = "button";
            increase.dataset.action = "increase";
            increase.textContent = "+";
            increase.setAttribute("aria-label", `Add another ${monster.name}`);
            actions.appendChild(increase);

            const remove = document.createElement("button");
            remove.type = "button";
            remove.dataset.action = "remove";
            remove.textContent = "Remove";
            remove.setAttribute("aria-label", `Remove ${monster.name} from the encounter`);
            actions.appendChild(remove);

            item.appendChild(actions);
            encounterRosterList.appendChild(item);
          });
        };

        const nudgeEncounter = (direction) => {
          if (!encounterState.monsters.length) return;
          ensureRosterSorted();
          const sorted = encounterState.monsters
            .map(entry => ({ ...entry }))
            .sort((a, b) => {
              const xpA = MONSTER_LOOKUP.get(a.id)?.xp ?? 0;
              const xpB = MONSTER_LOOKUP.get(b.id)?.xp ?? 0;
              return xpB - xpA;
            });

          const target = sorted[0];
          if (!target) return;

          const original = encounterState.monsters.find(entry => entry.id === target.id);
          if (!original) return;

          if (direction < 0) {
            original.count -= 1;
            if (original.count <= 0) {
              encounterState.monsters = encounterState.monsters.filter(entry => entry.id !== original.id);
            }
          } else {
            original.count += 1;
          }

          ensureRosterSorted();
          renderEncounterRoster();
          renderEncounterSummary();
          renderEncounterSearch();
        };

        const renderEncounterSummary = () => {
          encounterSummaryContainer.innerHTML = "";

          const totalMonsters = encounterState.monsters.reduce((sum, entry) => sum + entry.count, 0);
          const thresholds = getPartyThresholds();
          const multiplierInfo = getMultiplierInfo(totalMonsters, encounterState.partySize);

          let baseXP = 0;
          encounterState.monsters.forEach(entry => {
            const monster = MONSTER_LOOKUP.get(entry.id);
            if (!monster) return;
            baseXP += (monster.xp || 0) * entry.count;
          });

          const adjustedXP = totalMonsters ? Math.round(baseXP * multiplierInfo.multiplier) : 0;

          let difficulty = "Trivial";
          if (totalMonsters === 0) {
            difficulty = "Trivial";
          } else if (adjustedXP >= thresholds.deadly) {
            difficulty = "Deadly";
          } else if (adjustedXP >= thresholds.hard) {
            difficulty = "Hard";
          } else if (adjustedXP >= thresholds.medium) {
            difficulty = "Medium";
          } else if (adjustedXP >= thresholds.easy) {
            difficulty = "Easy";
          }

          const indicator = document.createElement("div");
          indicator.className = "difficulty-indicator";
          indicator.dataset.difficulty = difficulty;
          indicator.textContent =
            totalMonsters === 0
              ? "No monsters selected"
              : `${difficulty === "Trivial" ? "Trivial (below easy)" : `${difficulty} encounter`}`;
          encounterSummaryContainer.appendChild(indicator);

          const xpSummary = document.createElement("p");
          xpSummary.textContent = `Base XP ${formatXP(baseXP)} · Adjusted XP ${formatXP(adjustedXP)}`;
          encounterSummaryContainer.appendChild(xpSummary);

          const thresholdGrid = document.createElement("div");
          thresholdGrid.className = "threshold-grid";
          [
            ["Easy", thresholds.easy],
            ["Medium", thresholds.medium],
            ["Hard", thresholds.hard],
            ["Deadly", thresholds.deadly]
          ].forEach(([label, value]) => {
            const cell = document.createElement("div");
            const caption = document.createElement("span");
            caption.textContent = label;
            const amount = document.createElement("strong");
            amount.textContent = formatXP(value);
            cell.appendChild(caption);
            cell.appendChild(amount);
            thresholdGrid.appendChild(cell);
          });
          encounterSummaryContainer.appendChild(thresholdGrid);

          if (totalMonsters > 0) {
            const quickAdjust = document.createElement("div");
            quickAdjust.className = "encounter-quick-adjust";
            const label = document.createElement("span");
            label.textContent = "Quick adjust:";
            quickAdjust.appendChild(label);

            const easierButton = document.createElement("button");
            easierButton.type = "button";
            easierButton.dataset.adjust = "easier";
            easierButton.textContent = "Ease encounter";
            quickAdjust.appendChild(easierButton);

            const harderButton = document.createElement("button");
            harderButton.type = "button";
            harderButton.dataset.adjust = "harder";
            harderButton.textContent = "Raise stakes";
            quickAdjust.appendChild(harderButton);

            encounterSummaryContainer.appendChild(quickAdjust);
          }

          const multiplierText = Number.isInteger(multiplierInfo.multiplier)
            ? multiplierInfo.multiplier.toString()
            : multiplierInfo.multiplier.toFixed(1);

          const footnote = document.createElement("p");
          footnote.className = "encounter-footnote";
          footnote.textContent = `XP multiplier ×${multiplierText} (${multiplierInfo.appliedLabel}; ${multiplierInfo.adjustment}).`;
          encounterSummaryContainer.appendChild(footnote);
        };

        const renderEncounterSearch = () => {
          encounterResultsContainer.innerHTML = "";
          const query = encounterSearchInput.value.toLowerCase().trim();
          const targetCR = encounterState.partyLevel;

          const results = MONSTERS.filter(monster => {
            if (!query) return true;
            const haystack = [
              monster.name,
              monster.creatureType,
              monster.alignment,
              monster.overview,
              ...(monster.role || []),
              ...(monster.terrain || [])
            ]
              .filter(Boolean)
              .join(" ")
              .toLowerCase();
            return haystack.includes(query);
          })
            .sort((a, b) => {
              const diff = Math.abs((a.crValue ?? parseCR(a.challenge)) - targetCR)
                - Math.abs((b.crValue ?? parseCR(b.challenge)) - targetCR);
              if (diff !== 0) return diff;
              return a.name.localeCompare(b.name);
            })
            .slice(0, 8);

          if (!results.length) {
            const empty = document.createElement("p");
            empty.className = "roster-empty";
            empty.textContent = "No monsters match that search. Try a different role, biome, or CR.";
            encounterResultsContainer.appendChild(empty);
            return;
          }

          results.forEach(monster => {
            const result = document.createElement("div");
            result.className = "encounter-result";

            const text = document.createElement("div");
            const title = document.createElement("strong");
            title.textContent = monster.name;
            text.appendChild(title);

            const subtitle = document.createElement("span");
            subtitle.textContent = `CR ${monster.challenge} · ${formatXP(monster.xp)} XP`;
            text.appendChild(subtitle);

            const tags = document.createElement("span");
            tags.textContent = `${(monster.role || []).join(", ") || "Unknown role"} · ${(monster.terrain || []).join(", ") || "Any biome"}`;
            tags.style.opacity = "0.65";
            tags.style.fontSize = "0.8rem";
            text.appendChild(tags);

            result.appendChild(text);

            const button = document.createElement("button");
            button.type = "button";
            button.dataset.monsterId = monster.id;
            const existing = encounterState.monsters.find(entry => entry.id === monster.id);
            button.textContent = existing ? "Add another" : "Add";
            result.appendChild(button);

            encounterResultsContainer.appendChild(result);
          });
        };

        const addMonsterToEncounter = (id) => {
          const monster = MONSTER_LOOKUP.get(id);
          if (!monster) return;
          const existing = encounterState.monsters.find(entry => entry.id === id);
          if (existing) {
            existing.count += 1;
          } else {
            encounterState.monsters.push({ id, count: 1 });
          }
          ensureRosterSorted();
          renderEncounterRoster();
          renderEncounterSummary();
          renderEncounterSearch();
        };

        encounterPartyLevelInput.addEventListener("input", () => {
          const parsed = Math.floor(Number(encounterPartyLevelInput.value));
          if (Number.isNaN(parsed)) return;
          encounterState.partyLevel = clamp(parsed, 1, 20);
          encounterPartyLevelInput.value = String(encounterState.partyLevel);
          renderEncounterSummary();
          renderEncounterSearch();
        });

        encounterPartySizeInput.addEventListener("input", () => {
          const parsed = Math.floor(Number(encounterPartySizeInput.value));
          if (Number.isNaN(parsed)) return;
          encounterState.partySize = clamp(parsed, 1, 8);
          encounterPartySizeInput.value = String(encounterState.partySize);
          renderEncounterSummary();
        });

        encounterSearchInput.addEventListener("input", renderEncounterSearch);

        encounterResultsContainer.addEventListener("click", (event) => {
          const button = event.target.closest("button[data-monster-id]");
          if (!button) return;
          addMonsterToEncounter(button.dataset.monsterId);
        });

        encounterRosterList.addEventListener("click", (event) => {
          const button = event.target.closest("button[data-action]");
          if (!button) return;
          const item = event.target.closest("li[data-id]");
          if (!item) return;
          const entry = encounterState.monsters.find(mon => mon.id === item.dataset.id);
          if (!entry) return;

          if (button.dataset.action === "increase") {
            entry.count += 1;
          } else if (button.dataset.action === "decrease") {
            entry.count -= 1;
            if (entry.count <= 0) {
              encounterState.monsters = encounterState.monsters.filter(mon => mon.id !== entry.id);
            }
          } else if (button.dataset.action === "remove") {
            encounterState.monsters = encounterState.monsters.filter(mon => mon.id !== entry.id);
          }

          ensureRosterSorted();
          renderEncounterRoster();
          renderEncounterSummary();
          renderEncounterSearch();
        });

        encounterSummaryContainer.addEventListener("click", (event) => {
          const button = event.target.closest("button[data-adjust]");
          if (!button) return;
          if (button.dataset.adjust === "easier") {
            nudgeEncounter(-1);
          } else if (button.dataset.adjust === "harder") {
            nudgeEncounter(1);
          }
        });

        encounterClearButton.addEventListener("click", () => {
          if (!encounterState.monsters.length) return;
          encounterState.monsters = [];
          renderEncounterRoster();
          renderEncounterSummary();
          renderEncounterSearch();
        });

        ensureRosterSorted();
        renderEncounterRoster();
        renderEncounterSummary();
        renderEncounterSearch();
      }

      const initiativeForm = document.getElementById("initiative-form");
      const initiativeList = document.getElementById("initiative-list");
      const initiativeSortButton = document.getElementById("initiative-sort");
      const initiativeClearButton = document.getElementById("initiative-clear");
      const initiativeNextButton = document.getElementById("initiative-next");

      if (initiativeForm && initiativeList && initiativeSortButton && initiativeClearButton && initiativeNextButton) {
        const INIT_STORAGE_KEY = "dnd-companion-initiative-v1";
        const initiativeNameInput = document.getElementById("initiative-name");
        const initiativeScoreInput = document.getElementById("initiative-score");
        const initiativeTypeSelect = document.getElementById("initiative-type");

        const conditionOptionsMarkup = [
          '<option value="">Add condition…</option>',
          ...CONDITIONS.map(condition => `<option value="${condition.name}">${condition.name}</option>`)
        ].join("");

        const createId = () =>
          `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 7)}`;

        const normalizeParticipant = (participant) => ({
          id: participant.id || createId(),
          name: participant.name || "Unnamed",
          initiative: typeof participant.initiative === "number" ? participant.initiative : Number(participant.initiative) || 0,
          type: participant.type || "PC",
          conditions: Array.isArray(participant.conditions) ? participant.conditions.filter(Boolean) : []
        });

        let initiativeState = { participants: [], activeId: null };

        try {
          const stored = localStorage.getItem(INIT_STORAGE_KEY);
          if (stored) {
            const parsed = JSON.parse(stored);
            if (Array.isArray(parsed?.participants)) {
              initiativeState.participants = parsed.participants.map(normalizeParticipant);
              if (parsed.activeId && initiativeState.participants.some(p => p.id === parsed.activeId)) {
                initiativeState.activeId = parsed.activeId;
              }
            }
          }
        } catch (error) {
          console.warn("Failed to load initiative tracker state", error);
        }

        const saveInitiativeState = () => {
          try {
            localStorage.setItem(
              INIT_STORAGE_KEY,
              JSON.stringify({
                participants: initiativeState.participants,
                activeId: initiativeState.activeId
              })
            );
          } catch (error) {
            console.warn("Unable to persist initiative state", error);
          }
        };

        const renderInitiative = () => {
          initiativeList.innerHTML = "";

          if (!initiativeState.participants.length) {
            const empty = document.createElement("li");
            empty.className = "roster-empty";
            empty.textContent = "No participants yet. Add adventurers, allies, or foes to start tracking initiative.";
            initiativeList.appendChild(empty);
            return;
          }

          initiativeState.participants.forEach(participant => {
            const item = document.createElement("li");
            item.className = "initiative-entry";
            item.dataset.id = participant.id;
            if (participant.id === initiativeState.activeId) {
              item.classList.add("active");
            }

            const header = document.createElement("div");
            header.className = "initiative-header";

            const info = document.createElement("div");
            const name = document.createElement("strong");
            name.textContent = participant.name;
            info.appendChild(name);

            const meta = document.createElement("div");
            meta.className = "initiative-meta";
            meta.innerHTML = `
              <span>Initiative ${participant.initiative ?? "—"}</span>
              <span>${participant.type}</span>
            `;
            info.appendChild(meta);
            header.appendChild(info);

            const headerActions = document.createElement("div");
            headerActions.className = "initiative-actions";

            const focusButton = document.createElement("button");
            focusButton.type = "button";
            focusButton.dataset.action = "activate";
            focusButton.textContent = participant.id === initiativeState.activeId ? "Active" : "Focus";
            headerActions.appendChild(focusButton);

            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.dataset.action = "remove";
            removeButton.textContent = "Remove";
            headerActions.appendChild(removeButton);

            header.appendChild(headerActions);
            item.appendChild(header);

            if (participant.conditions.length) {
              const conditionRow = document.createElement("div");
              conditionRow.className = "initiative-conditions";
              participant.conditions.forEach(condition => {
                const chip = document.createElement("span");
                chip.className = "condition-chip";
                chip.dataset.condition = condition;
                chip.textContent = condition;
                const remove = document.createElement("button");
                remove.type = "button";
                remove.className = "condition-remove";
                remove.setAttribute("aria-label", `Remove ${condition} from ${participant.name}`);
                remove.textContent = "×";
                chip.appendChild(remove);
                conditionRow.appendChild(chip);
              });
              item.appendChild(conditionRow);
            }

            const actions = document.createElement("div");
            actions.className = "initiative-actions";

            const initiativeInput = document.createElement("input");
            initiativeInput.type = "number";
            initiativeInput.className = "initiative-score-input";
            initiativeInput.value = participant.initiative ?? "";
            initiativeInput.placeholder = "Init";
            initiativeInput.dataset.id = participant.id;
            initiativeInput.setAttribute("aria-label", `Initiative score for ${participant.name}`);
            actions.appendChild(initiativeInput);

            const conditionSelect = document.createElement("select");
            conditionSelect.className = "condition-selector";
            conditionSelect.innerHTML = conditionOptionsMarkup;
            conditionSelect.dataset.id = participant.id;
            actions.appendChild(conditionSelect);

            const upButton = document.createElement("button");
            upButton.type = "button";
            upButton.dataset.action = "move-up";
            upButton.textContent = "▲";
            upButton.setAttribute("aria-label", `Move ${participant.name} up`);
            actions.appendChild(upButton);

            const downButton = document.createElement("button");
            downButton.type = "button";
            downButton.dataset.action = "move-down";
            downButton.textContent = "▼";
            downButton.setAttribute("aria-label", `Move ${participant.name} down`);
            actions.appendChild(downButton);

            item.appendChild(actions);
            initiativeList.appendChild(item);
          });
        };

        const moveParticipant = (id, delta) => {
          const index = initiativeState.participants.findIndex(p => p.id === id);
          if (index === -1) return;
          const newIndex = index + delta;
          if (newIndex < 0 || newIndex >= initiativeState.participants.length) return;
          const [participant] = initiativeState.participants.splice(index, 1);
          initiativeState.participants.splice(newIndex, 0, participant);
        };

        const sortParticipantsByInitiative = () => {
          initiativeState.participants.sort((a, b) => {
            if ((b.initiative ?? 0) !== (a.initiative ?? 0)) {
              return (b.initiative ?? 0) - (a.initiative ?? 0);
            }
            return a.name.localeCompare(b.name);
          });
        };

        initiativeForm.addEventListener("submit", (event) => {
          event.preventDefault();
          const name = initiativeNameInput.value.trim();
          if (!name) return;
          const initiativeScore = Math.floor(Number(initiativeScoreInput.value));
          const participant = {
            id: createId(),
            name,
            initiative: Number.isNaN(initiativeScore) ? 0 : initiativeScore,
            type: initiativeTypeSelect.value || "PC",
            conditions: []
          };
          initiativeState.participants.push(participant);
          if (!initiativeState.activeId) {
            initiativeState.activeId = participant.id;
          }
          sortParticipantsByInitiative();
          renderInitiative();
          saveInitiativeState();
          initiativeForm.reset();
          initiativeNameInput.focus();
        });

        initiativeList.addEventListener("change", (event) => {
          const item = event.target.closest("li[data-id]");
          if (!item) return;
          const participant = initiativeState.participants.find(p => p.id === item.dataset.id);
          if (!participant) return;

          if (event.target.matches(".initiative-score-input")) {
            const value = Math.floor(Number(event.target.value));
            participant.initiative = Number.isNaN(value) ? 0 : value;
            renderInitiative();
            saveInitiativeState();
          } else if (event.target.matches(".condition-selector")) {
            const condition = event.target.value;
            if (condition && !participant.conditions.includes(condition)) {
              participant.conditions.push(condition);
              renderInitiative();
              saveInitiativeState();
            }
            event.target.value = "";
          }
        });

        initiativeList.addEventListener("click", (event) => {
          const item = event.target.closest("li[data-id]");
          if (!item) return;
          const participant = initiativeState.participants.find(p => p.id === item.dataset.id);
          if (!participant) return;

          if (event.target.classList.contains("condition-remove")) {
            const condition = event.target.parentElement?.dataset.condition;
            if (condition) {
              participant.conditions = participant.conditions.filter(name => name !== condition);
              renderInitiative();
              saveInitiativeState();
            }
            return;
          }

          const button = event.target.closest("button[data-action]");
          if (!button) return;

          if (button.dataset.action === "remove") {
            initiativeState.participants = initiativeState.participants.filter(p => p.id !== participant.id);
            if (initiativeState.activeId === participant.id) {
              initiativeState.activeId = initiativeState.participants[0]?.id ?? null;
            }
          } else if (button.dataset.action === "activate") {
            initiativeState.activeId = participant.id;
          } else if (button.dataset.action === "move-up") {
            moveParticipant(participant.id, -1);
          } else if (button.dataset.action === "move-down") {
            moveParticipant(participant.id, 1);
          }

          renderInitiative();
          saveInitiativeState();
        });

        initiativeSortButton.addEventListener("click", () => {
          sortParticipantsByInitiative();
          renderInitiative();
          saveInitiativeState();
        });

        initiativeClearButton.addEventListener("click", () => {
          if (!initiativeState.participants.length) return;
          if (!confirm("Clear all participants from the initiative tracker?")) return;
          initiativeState = { participants: [], activeId: null };
          renderInitiative();
          saveInitiativeState();
        });

        initiativeNextButton.addEventListener("click", () => {
          if (!initiativeState.participants.length) return;
          if (!initiativeState.activeId) {
            initiativeState.activeId = initiativeState.participants[0].id;
          } else {
            const currentIndex = initiativeState.participants.findIndex(p => p.id === initiativeState.activeId);
            const nextIndex = currentIndex === -1 ? 0 : (currentIndex + 1) % initiativeState.participants.length;
            initiativeState.activeId = initiativeState.participants[nextIndex].id;
          }
          renderInitiative();
          saveInitiativeState();
        });

        renderInitiative();
      }

      const settingQuery = document.getElementById("setting-query");
      const settingGenreSelect = document.getElementById("setting-genre-filter");
      const settingsGrid = document.getElementById("settings-grid");

      const rarityOptions = [
        "Common",
        "Uncommon",
        "Rare",
        "Very Rare",
        "Legendary",
        "Artifact",
        "Standard"
      ];

      const spellQuery = document.getElementById("spell-query");
      const spellLevelSelect = document.getElementById("spell-level-filter");
      const spellSchoolSelect = document.getElementById("spell-school-filter");
      const spellClassSelect = document.getElementById("spell-class-filter");
      const spellEditionSelect = document.getElementById("spell-edition-filter");
      const spellsList = document.getElementById("spells-list");

      const conditionQuery = document.getElementById("condition-query");
      const conditionDurationSelect = document.getElementById("condition-duration-filter");
      const conditionSaveSelect = document.getElementById("condition-save-filter");
      const conditionKeywordInput = document.getElementById("condition-keyword-filter");
      const conditionsList = document.getElementById("conditions-list");
      const referenceContainer = document.getElementById("dm-reference");

      if (settingGenreSelect && settingsGrid) {
        const genreOptions = Array.from(
          new Set(
            SETTINGS.flatMap(setting => setting.genres ?? []).map(genre => genre.trim())
          )
        )
          .filter(Boolean)
          .sort((a, b) => a.localeCompare(b));

        genreOptions.forEach(genre => {
          const option = document.createElement("option");
          option.value = genre;
          option.textContent = genre;
          settingGenreSelect.appendChild(option);
        });

        const renderSettings = () => {
          const query = settingQuery?.value.toLowerCase().trim() ?? "";
          const genreFilter = settingGenreSelect.value;

          settingsGrid.innerHTML = "";

          const results = SETTINGS.filter(setting => {
            const normalizedGenres = (setting.genres || []).map(genre => genre.toLowerCase());
            const matchesGenre =
              genreFilter === "all" || normalizedGenres.includes(genreFilter.toLowerCase());

            const searchableText = [
              setting.name,
              setting.era,
              setting.elevatorPitch,
              ...(setting.flagshipProducts || []).map(product => `${product.label} ${product.description ?? ""}`),
              ...(setting.adventureHooks || [])
            ]
              .filter(Boolean)
              .join(" ")
              .toLowerCase();

            const matchesQuery = !query || searchableText.includes(query);

            return matchesGenre && matchesQuery;
          });

          if (!results.length) {
            const empty = document.createElement("p");
            empty.textContent = "No settings match those filters yet. Try another keyword or genre.";
            empty.style.opacity = "0.75";
            settingsGrid.appendChild(empty);
            return;
          }

          results.forEach(setting => {
            const details = document.createElement("details");
            details.className = "setting-card";

            const summary = document.createElement("summary");

            const nameGroup = document.createElement("div");
            nameGroup.className = "setting-name";

            const nameSpan = document.createElement("span");
            nameSpan.textContent = setting.name;
            nameGroup.appendChild(nameSpan);

            const eraSpan = document.createElement("span");
            eraSpan.className = "setting-era";
            eraSpan.textContent = setting.era;
            nameGroup.appendChild(eraSpan);

            summary.appendChild(nameGroup);

            if (Array.isArray(setting.genres) && setting.genres.length) {
              const tagRow = document.createElement("div");
              tagRow.className = "tag-row";
              setting.genres.forEach(genre => {
                const tag = document.createElement("span");
                tag.className = "pill";
                tag.textContent = genre;
                tagRow.appendChild(tag);
              });
              summary.appendChild(tagRow);
            }

            details.appendChild(summary);

            const body = document.createElement("div");
            body.className = "setting-body";

            const image = document.createElement("div");
            image.className = "setting-image";
            if (setting.art?.background) {
              image.style.background = setting.art.background;
            }
            const caption = document.createElement("span");
            caption.textContent =
              setting.art?.caption || "Imagery placeholder—describe what your party witnesses.";
            image.appendChild(caption);
            body.appendChild(image);

            const pitch = document.createElement("p");
            pitch.textContent = setting.elevatorPitch;
            pitch.style.margin = "0";
            pitch.style.lineHeight = "1.55";
            pitch.style.opacity = "0.9";
            body.appendChild(pitch);

            const metaRow = document.createElement("div");
            metaRow.className = "setting-meta";
            const eraLabel = document.createElement("span");
            eraLabel.innerHTML = `<strong>Era:</strong> ${setting.era}`;
            metaRow.appendChild(eraLabel);
            if (setting.genres?.length) {
              const toneLabel = document.createElement("span");
              toneLabel.innerHTML = `<strong>Genres:</strong> ${setting.genres.join(", ")}`;
              metaRow.appendChild(toneLabel);
            }
            body.appendChild(metaRow);

            if (Array.isArray(setting.flagshipProducts) && setting.flagshipProducts.length) {
              const flagshipSection = document.createElement("div");
              flagshipSection.className = "setting-section";
              const heading = document.createElement("strong");
              heading.textContent = "Flagship products";
              flagshipSection.appendChild(heading);

              const list = document.createElement("ul");
              setting.flagshipProducts.forEach(product => {
                const item = document.createElement("li");
                const link = document.createElement("a");
                link.href = product.url;
                link.target = "_blank";
                link.rel = "noopener";
                link.textContent = product.label;
                item.appendChild(link);
                if (product.description) {
                  item.appendChild(document.createTextNode(` — ${product.description}`));
                }
                list.appendChild(item);
              });
              flagshipSection.appendChild(list);
              body.appendChild(flagshipSection);
            }

            if (Array.isArray(setting.officialSources) && setting.officialSources.length) {
              const linkSection = document.createElement("div");
              linkSection.className = "setting-section";
              const label = document.createElement("strong");
              label.textContent = "Official sources";
              linkSection.appendChild(label);

              const linkRow = document.createElement("div");
              linkRow.className = "setting-links";
              setting.officialSources.forEach(source => {
                const link = document.createElement("a");
                link.href = source.url;
                link.target = "_blank";
                link.rel = "noopener";
                link.textContent = source.label;
                linkRow.appendChild(link);
              });
              linkSection.appendChild(linkRow);
              body.appendChild(linkSection);
            }

            if (Array.isArray(setting.adventureHooks) && setting.adventureHooks.length) {
              const hooksSection = document.createElement("div");
              hooksSection.className = "setting-section";
              const hooksLabel = document.createElement("strong");
              hooksLabel.textContent = "Adventure hooks";
              hooksSection.appendChild(hooksLabel);

              const hookList = document.createElement("ul");
              setting.adventureHooks.forEach(hook => {
                const li = document.createElement("li");
                li.textContent = hook;
                hookList.appendChild(li);
              });
              hooksSection.appendChild(hookList);
              body.appendChild(hooksSection);
            }

            details.appendChild(body);
            settingsGrid.appendChild(details);
          });
        };

        settingGenreSelect.addEventListener("change", renderSettings);
        settingQuery?.addEventListener("input", renderSettings);

        renderSettings();
      }

      const formatSpellLevel = (level) => (Number(level) === 0 ? "Cantrip" : `Level ${level}`);

      const uniqueSpellLevels = Array.from(new Set(SPELLS.map(spell => spell.level)))
        .sort((a, b) => a - b);
      uniqueSpellLevels.forEach(level => {
        const option = document.createElement("option");
        option.value = String(level);
        option.textContent = formatSpellLevel(level);
        spellLevelSelect.appendChild(option);
      });

      const uniqueSpellSchools = Array.from(new Set(SPELLS.map(spell => spell.school))).sort();
      uniqueSpellSchools.forEach(school => {
        const option = document.createElement("option");
        option.value = school;
        option.textContent = school;
        spellSchoolSelect.appendChild(option);
      });

      const uniqueSpellClasses = Array.from(new Set(SPELLS.flatMap(spell => spell.classes || []))).sort();
      uniqueSpellClasses.forEach(cls => {
        const option = document.createElement("option");
        option.value = cls;
        option.textContent = cls;
        spellClassSelect.appendChild(option);
      });

      const uniqueSpellEditions = Array.from(new Set(SPELLS.map(spell => spell.edition))).sort();
      uniqueSpellEditions.forEach(edition => {
        const option = document.createElement("option");
        option.value = edition;
        option.textContent = edition;
        spellEditionSelect.appendChild(option);
      });

      const durationLabels = {
        ongoing: "Ongoing effects",
        instant: "Instant or until acted",
        special: "Special conditions"
      };

      const uniqueDurationTags = Array.from(new Set(CONDITIONS.map(condition => condition.durationTag))).sort();
      uniqueDurationTags.forEach(tag => {
        const option = document.createElement("option");
        option.value = tag;
        option.textContent = durationLabels[tag] || tag;
        conditionDurationSelect.appendChild(option);
      });

      const uniqueConditionSaves = Array.from(new Set(CONDITIONS.map(condition => condition.savingThrow))).sort();
      uniqueConditionSaves.forEach(save => {
        const option = document.createElement("option");
        option.value = save;
        option.textContent = save;
        conditionSaveSelect.appendChild(option);
      });

      const renderSpells = () => {
        const nameQuery = spellQuery.value.toLowerCase().trim();
        const levelFilter = spellLevelSelect.value;
        const schoolFilter = spellSchoolSelect.value;
        const classFilter = spellClassSelect.value;
        const editionFilter = spellEditionSelect.value;

        spellsList.innerHTML = "";

        const results = SPELLS.filter(spell => {
          const searchableFields = [
            spell.name,
            spell.summary,
            spell.school,
            spell.edition,
            spell.source,
            spell.castingTime,
            spell.range,
            spell.duration,
            spell.components,
            spell.savingThrow,
            ...(spell.classes || []),
            ...(spell.keywords || [])
          ]
            .filter(Boolean)
            .map(field => field.toLowerCase());

          const matchesQuery = !nameQuery || searchableFields.some(field => field.includes(nameQuery));
          const matchesLevel = levelFilter === "all" || String(spell.level) === levelFilter;
          const matchesSchool = schoolFilter === "all" || spell.school === schoolFilter;
          const matchesClass = classFilter === "all" || (spell.classes || []).includes(classFilter);
          const matchesEdition = editionFilter === "all" || spell.edition === editionFilter;

          return matchesQuery && matchesLevel && matchesSchool && matchesClass && matchesEdition;
        });

        if (!results.length) {
          const empty = document.createElement("p");
          empty.textContent = "No spells match your filters yet. Try adjusting the level, school, class, or edition.";
          empty.style.opacity = "0.75";
          spellsList.appendChild(empty);
          return;
        }

        results.forEach(spell => {
          const details = document.createElement("details");
          details.className = "collapsible-card";

          const summary = document.createElement("summary");
          summary.innerHTML = `
            <span>${spell.name}</span>
            <span class="tag-row">
              <span class="pill">${formatSpellLevel(spell.level)}</span>
              <span class="pill">${spell.school}</span>
            </span>
          `;
          details.appendChild(summary);

          const meta = document.createElement("div");
          meta.className = "collapsible-meta";
          meta.innerHTML = `
            <span><strong>Classes:</strong> ${spell.classes?.join(", ") || "—"}</span>
            <span><strong>Edition Coverage:</strong> ${spell.edition}</span>
            <span><strong>Casting Time:</strong> ${spell.castingTime}</span>
            <span><strong>Range:</strong> ${spell.range}</span>
            <span><strong>Duration:</strong> ${spell.duration}</span>
            <span><strong>Components:</strong> ${spell.components}</span>
            <span><strong>Save:</strong> ${spell.savingThrow}</span>
            <span><strong>Source:</strong> ${spell.source}</span>
          `;
          details.appendChild(meta);

          const body = document.createElement("div");
          body.className = "collapsible-content";
          body.textContent = spell.summary;
          details.appendChild(body);

          if (spell.keywords?.length) {
            const tagRow = document.createElement("div");
            tagRow.className = "tag-row";
            spell.keywords.forEach(keyword => {
              const pill = document.createElement("span");
              pill.className = "pill";
              pill.textContent = keyword;
              tagRow.appendChild(pill);
            });
            details.appendChild(tagRow);
          }

          spellsList.appendChild(details);
        });
      };

      const renderConditions = () => {
        const nameQuery = conditionQuery.value.toLowerCase().trim();
        const durationFilter = conditionDurationSelect.value;
        const saveFilter = conditionSaveSelect.value;
        const keywordQuery = conditionKeywordInput.value.toLowerCase().trim();

        conditionsList.innerHTML = "";

        const results = CONDITIONS.filter(condition => {
          const matchesName = !nameQuery || condition.name.toLowerCase().includes(nameQuery);
          const matchesDuration = durationFilter === "all" || condition.durationTag === durationFilter;
          const matchesSave = saveFilter === "all" || condition.savingThrow === saveFilter;
          const matchesKeyword = !keywordQuery || [
            condition.summary,
            condition.duration,
            condition.savingThrow,
            ...(condition.effects || []),
            ...(condition.keywords || [])
          ]
            .filter(Boolean)
            .some(field => field.toLowerCase().includes(keywordQuery));

          return matchesName && matchesDuration && matchesSave && matchesKeyword;
        });

        if (!results.length) {
          const empty = document.createElement("p");
          empty.textContent = "No conditions match your filters yet. Try a different keyword or duration.";
          empty.style.opacity = "0.75";
          conditionsList.appendChild(empty);
          return;
        }

        results.forEach(condition => {
          const details = document.createElement("details");
          details.className = "collapsible-card";

          const summary = document.createElement("summary");
          summary.innerHTML = `
            <span>${condition.name}</span>
            <span class="tag-row">
              <span class="pill">${durationLabels[condition.durationTag] || condition.duration}</span>
              <span class="pill">Save: ${condition.savingThrow}</span>
            </span>
          `;
          details.appendChild(summary);

          const meta = document.createElement("div");
          meta.className = "collapsible-meta";
          meta.innerHTML = `
            <span><strong>Duration:</strong> ${condition.duration}</span>
            <span><strong>Saving Throw:</strong> ${condition.savingThrow}</span>
            <span><strong>Source:</strong> ${condition.source}</span>
          `;
          details.appendChild(meta);

          const body = document.createElement("div");
          body.className = "collapsible-content";
          body.textContent = condition.summary;
          details.appendChild(body);

          if (condition.effects?.length) {
            const list = document.createElement("ul");
            list.style.margin = "0.5rem 0 0";
            list.style.paddingLeft = "1.25rem";
            condition.effects.forEach(effect => {
              const li = document.createElement("li");
              li.textContent = effect;
              list.appendChild(li);
            });
            details.appendChild(list);
          }

          if (condition.keywords?.length) {
            const tagRow = document.createElement("div");
            tagRow.className = "tag-row";
            condition.keywords.forEach(keyword => {
              const pill = document.createElement("span");
              pill.className = "pill";
              pill.textContent = keyword;
              tagRow.appendChild(pill);
            });
            details.appendChild(tagRow);
          }

          conditionsList.appendChild(details);
        });
      };

      spellQuery.addEventListener("input", renderSpells);
      spellLevelSelect.addEventListener("change", renderSpells);
      spellSchoolSelect.addEventListener("change", renderSpells);
      spellClassSelect.addEventListener("change", renderSpells);
      spellEditionSelect.addEventListener("change", renderSpells);

      conditionQuery.addEventListener("input", renderConditions);
      conditionDurationSelect.addEventListener("change", renderConditions);
      conditionSaveSelect.addEventListener("change", renderConditions);
      conditionKeywordInput.addEventListener("input", renderConditions);

      renderSpells();
      renderConditions();
      renderReferenceTables(referenceContainer, DM_REFERENCES);

      const quickPromptsContainer = document.querySelector(".quick-prompts");

      const renderQuickPrompts = () => {
        if (!quickPromptsContainer) return [];
        quickPromptsContainer.innerHTML = "";

        const createdButtons = [];
        QUICK_PROMPTS.forEach(group => {
          const groupCard = document.createElement("article");
          groupCard.className = "quick-prompts-group";

          const heading = document.createElement("h3");
          heading.textContent = group.theme;
          groupCard.appendChild(heading);

          if (group.description) {
            const description = document.createElement("p");
            description.textContent = group.description;
            groupCard.appendChild(description);
          }

          const buttonGrid = document.createElement("div");
          buttonGrid.className = "quick-prompts-buttons";

          group.prompts.forEach(promptItem => {
            const button = document.createElement("button");
            button.type = "button";
            button.dataset.prompt = promptItem.prompt;
            button.textContent = promptItem.label;
            buttonGrid.appendChild(button);
            createdButtons.push(button);
          });

          groupCard.appendChild(buttonGrid);
          quickPromptsContainer.appendChild(groupCard);
        });

        return createdButtons;
      };

      const navButtons = document.querySelectorAll("nav button");
      const sections = document.querySelectorAll("main section");
      navButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          navButtons.forEach(b => b.classList.remove("active"));
          sections.forEach(sec => sec.classList.remove("active"));
          btn.classList.add("active");
          const targetSection = document.getElementById(btn.dataset.target);
          if (targetSection) {
            targetSection.classList.add("active");
          }
        });
      });

      const monsterQuery = document.getElementById("monster-query");
      const monsterCRSelect = document.getElementById("monster-cr-filter");
      const monsterTerrainSelect = document.getElementById("monster-terrain-filter");
      const monsterRoleSelect = document.getElementById("monster-role-filter");
      const bestiaryList = document.getElementById("bestiary-list");

      const uniqueCRs = Array.from(new Set(MONSTERS.map(monster => monster.challenge)))
        .sort((a, b) => parseCR(a) - parseCR(b));
      uniqueCRs.forEach(cr => {
        const option = document.createElement("option");
        option.value = cr;
        option.textContent = `CR ${cr}`;
        monsterCRSelect.appendChild(option);
      });

      const uniqueTerrains = Array.from(new Set(MONSTERS.flatMap(monster => monster.terrain))).sort();
      uniqueTerrains.forEach(terrain => {
        const option = document.createElement("option");
        option.value = terrain;
        option.textContent = terrain;
        monsterTerrainSelect.appendChild(option);
      });

      const uniqueRoles = Array.from(new Set(MONSTERS.flatMap(monster => monster.role))).sort();
      uniqueRoles.forEach(role => {
        const option = document.createElement("option");
        option.value = role;
        option.textContent = role;
        monsterRoleSelect.appendChild(option);
      });

      const renderMonsters = () => {
        const query = monsterQuery.value.toLowerCase().trim();
        const crFilter = monsterCRSelect.value;
        const terrainFilter = monsterTerrainSelect.value;
        const roleFilter = monsterRoleSelect.value;

        bestiaryList.innerHTML = "";

        const results = MONSTERS.filter(monster => {
          const searchableFields = [
            monster.name,
            monster.overview,
            monster.creatureType,
            monster.alignment,
            monster.size,
            monster.signatureAbilities.join(" "),
            monster.terrain.join(" "),
            monster.role.join(" ")
          ]
            .filter(Boolean)
            .map(field => field.toLowerCase());

          const matchesQuery = !query || searchableFields.some(field => field.includes(query));
          const matchesCR = crFilter === "all" || monster.challenge === crFilter;
          const matchesTerrain = terrainFilter === "all" || monster.terrain.includes(terrainFilter);
          const matchesRole = roleFilter === "all" || monster.role.includes(roleFilter);
          return matchesQuery && matchesCR && matchesTerrain && matchesRole;
        });

        if (!results.length) {
          const empty = document.createElement("p");
          empty.textContent = "No monsters match those filters. Try broadening your search or removing a filter.";
          empty.style.opacity = "0.75";
          bestiaryList.appendChild(empty);
          return;
        }

        results.forEach(monster => {
          const card = document.createElement("article");
          card.className = "monster-card";
          const abilityList = monster.signatureAbilities
            .map(ability => `<li>${ability}</li>`)
            .join("");
          const sourceLinks = monster.sources
            .map(source => `<a href="${source.url}" target="_blank" rel="noopener">${source.label}</a>`)
            .join(", ");

          card.innerHTML = `
            <h4>
              ${monster.name}
              <span class="pill">CR ${monster.challenge}</span>
            </h4>
            <div class="monster-meta">
              <span><strong>Size:</strong> ${monster.size}</span>
              <span><strong>Type:</strong> ${monster.creatureType}</span>
              <span><strong>Alignment:</strong> ${monster.alignment}</span>
              <span><strong>Role:</strong> ${monster.role.join(", ")}</span>
              <span><strong>Terrain:</strong> ${monster.terrain.join(", ")}</span>
            </div>
            <p>${monster.overview}</p>
            ${monster.signatureAbilities.length ? `<p><strong>Signature abilities & tactics</strong></p>` : ""}
            ${monster.signatureAbilities.length ? `<ul class="monster-abilities">${abilityList}</ul>` : ""}
            <p style="font-size: 0.85rem; opacity: 0.7;"><strong>Sources:</strong> ${sourceLinks}</p>
          `;

          bestiaryList.appendChild(card);
        });
      };

      monsterQuery.addEventListener("input", renderMonsters);
      monsterCRSelect.addEventListener("change", renderMonsters);
      monsterTerrainSelect.addEventListener("change", renderMonsters);
      monsterRoleSelect.addEventListener("change", renderMonsters);
      renderMonsters();

      const comparisonContainer = document.getElementById("comparison-matrix");
      if (comparisonContainer) {
        const table = document.createElement("table");
        table.className = "comparison-table";

        const headerRow = document.createElement("tr");
        const blank = document.createElement("th");
        blank.scope = "col";
        headerRow.appendChild(blank);
        RULES_DATA.forEach(rule => {
          const th = document.createElement("th");
          th.scope = "col";
          th.textContent = rule.edition;
          headerRow.appendChild(th);
        });

        const thead = document.createElement("thead");
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        const categories = [
          { key: "tagline", label: "Design Thesis" },
          { key: "released", label: "Release Window" },
          { key: "keySystems", label: "Signature Systems", className: "key-systems" },
          { key: "playstyle", label: "Table Feel & Playstyle" },
          { key: "expansions", label: "Essential Expansions" },
          { key: "adventureHooks", label: "Adventure Hooks" },
          { key: "srds", label: "Primary References" }
        ];

        const renderList = (items, mapper = (item) => item) => {
          const ul = document.createElement("ul");
          items.forEach(item => {
            const li = document.createElement("li");
            li.innerHTML = mapper(item);
            ul.appendChild(li);
          });
          return ul;
        };

        categories.forEach(({ key, label, className }) => {
          const row = document.createElement("tr");
          const heading = document.createElement("th");
          heading.scope = "row";
          heading.textContent = label;
          row.appendChild(heading);

          RULES_DATA.forEach(rule => {
            const td = document.createElement("td");
            const value = rule[key];

            if (Array.isArray(value) && value.length) {
              const content = renderList(
                value,
                key === "srds"
                  ? (item) => `<a href="${item.url}" target="_blank" rel="noopener">${item.label}</a>`
                  : (item) => item
              );
              if (className) {
                const wrapper = document.createElement("div");
                wrapper.className = className;
                wrapper.appendChild(content);
                td.appendChild(wrapper);
              } else {
                td.appendChild(content);
              }
            } else if (typeof value === "string" && value.trim()) {
              const paragraph = document.createElement("p");
              paragraph.textContent = value;
              td.appendChild(paragraph);
            } else if (value?.label && value?.url) {
              td.innerHTML = `<a href="${value.url}" target="_blank" rel="noopener">${value.label}</a>`;
            } else {
              const placeholder = document.createElement("span");
              placeholder.style.opacity = "0.65";
              placeholder.textContent = "—";
              td.appendChild(placeholder);
            }

            row.appendChild(td);
          });

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        comparisonContainer.appendChild(table);
      }

      // Populate rules compendium
      const rulesGrid = document.getElementById("rules-grid");
      RULES_DATA.forEach(rule => {
        const details = document.createElement("details");
        const summary = document.createElement("summary");
        summary.innerHTML = `<span>${rule.edition}</span>`;
        details.appendChild(summary);

        const tagline = document.createElement("p");
        tagline.textContent = rule.tagline;
        tagline.style.marginTop = "0.5rem";
        tagline.style.opacity = "0.85";
        details.appendChild(tagline);

        if (rule.released) {
          const meta = document.createElement("div");
          meta.className = "rules-meta";
          const release = document.createElement("span");
          release.innerHTML = `<strong>Released</strong> ${rule.released}`;
          meta.appendChild(release);
          details.appendChild(meta);
        }

        const systems = document.createElement("div");
        systems.className = "rules-section";
        systems.innerHTML = `<strong>Signature systems</strong>`;
        const ul = document.createElement("ul");
        rule.keySystems.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          ul.appendChild(li);
        });
        systems.appendChild(ul);
        details.appendChild(systems);

        if (rule.playstyle?.length) {
          const playstyle = document.createElement("div");
          playstyle.className = "rules-section";
          playstyle.innerHTML = `<strong>Table feel & playstyle</strong>`;
          const playList = document.createElement("ul");
          rule.playstyle.forEach(item => {
            const li = document.createElement("li");
            li.textContent = item;
            playList.appendChild(li);
          });
          playstyle.appendChild(playList);
          details.appendChild(playstyle);
        }

        const expansions = document.createElement("div");
        expansions.className = "rules-section expansion-list";
        expansions.innerHTML = `<strong>Key rulebooks & expansions</strong>`;
        const ulExp = document.createElement("ul");
        rule.expansions.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          ulExp.appendChild(li);
        });
        expansions.appendChild(ulExp);
        details.appendChild(expansions);

        const classEntries = CLASSES[rule.editionKey] || [];
        if (classEntries.length) {
          const classSection = document.createElement("div");
          classSection.className = "rules-section";
          const classHeading = document.createElement("strong");
          classHeading.textContent = "Classes & subclass spotlights";
          classHeading.style.display = "block";
          classHeading.style.marginBottom = "0.4rem";
          classSection.appendChild(classHeading);

          const accordion = document.createElement("div");
          accordion.className = "class-accordion";

          classEntries.forEach(cls => {
            const classDetails = document.createElement("details");
            classDetails.className = "class-card";

            const classSummary = document.createElement("summary");
            const nameSpan = document.createElement("span");
            nameSpan.textContent = cls.name;
            classSummary.appendChild(nameSpan);

            if (cls.hitDie) {
              const hitDie = document.createElement("span");
              hitDie.className = "pill";
              hitDie.textContent = `${cls.hitDie} Hit Die`;
              classSummary.appendChild(hitDie);
            }

            classDetails.appendChild(classSummary);

            const content = document.createElement("div");
            content.className = "collapsible-content";

            if (cls.summary) {
              const summaryParagraph = document.createElement("p");
              summaryParagraph.textContent = cls.summary;
              content.appendChild(summaryParagraph);
            }

            const metaRow = document.createElement("div");
            metaRow.className = "class-meta";
            if (cls.role) {
              const roleSpan = document.createElement("span");
              roleSpan.innerHTML = `<strong>Role:</strong> ${cls.role}`;
              metaRow.appendChild(roleSpan);
            }
            if (cls.primaryAbility) {
              const abilitySpan = document.createElement("span");
              abilitySpan.innerHTML = `<strong>Primary ability:</strong> ${cls.primaryAbility}`;
              metaRow.appendChild(abilitySpan);
            }
            if (metaRow.childNodes.length) {
              content.appendChild(metaRow);
            }

            if (Array.isArray(cls.signatureFeatures) && cls.signatureFeatures.length) {
              const featuresWrapper = document.createElement("div");
              featuresWrapper.style.marginTop = "0.65rem";
              const featuresTitle = document.createElement("strong");
              featuresTitle.textContent = "Signature features";
              featuresWrapper.appendChild(featuresTitle);

              const featureList = document.createElement("ul");
              cls.signatureFeatures.forEach(feature => {
                const featureItem = document.createElement("li");
                featureItem.textContent = feature;
                featureList.appendChild(featureItem);
              });
              featuresWrapper.appendChild(featureList);
              content.appendChild(featuresWrapper);
            }

            if (Array.isArray(cls.sources) && cls.sources.length) {
              const sourcesRow = document.createElement("div");
              sourcesRow.className = "class-meta";
              const label = document.createElement("strong");
              label.textContent = "Sources:";
              sourcesRow.appendChild(label);

              cls.sources.forEach((source, index) => {
                if (index > 0) {
                  sourcesRow.appendChild(document.createTextNode(" · "));
                }
                const link = document.createElement("a");
                link.href = source.url;
                link.target = "_blank";
                link.rel = "noopener";
                link.textContent = source.label;
                link.style.color = "var(--accent)";
                link.style.textDecoration = "none";
                sourcesRow.appendChild(link);
              });
              content.appendChild(sourcesRow);
            }

            if (cls.comparison?.note) {
              const comparison = document.createElement("p");
              comparison.className = "comparison-note";
              const label = document.createElement("strong");
              label.textContent = "Cross-edition insight:";
              comparison.appendChild(label);
              comparison.appendChild(document.createTextNode(` ${cls.comparison.note}`));

              if (cls.comparison.link?.url) {
                comparison.appendChild(document.createTextNode(" "));
                const link = document.createElement("a");
                link.href = cls.comparison.link.url;
                link.target = "_blank";
                link.rel = "noopener";
                link.textContent = cls.comparison.link.label || "Read more";
                comparison.appendChild(link);
              }

              content.appendChild(comparison);
            }

            if (Array.isArray(cls.subclasses) && cls.subclasses.length) {
              const subclassGroup = document.createElement("div");
              subclassGroup.className = "subclass-group";
              const subHeading = document.createElement("strong");
              subHeading.textContent = "Subclass highlights";
              subHeading.style.display = "block";
              subHeading.style.marginBottom = "0.35rem";
              subclassGroup.appendChild(subHeading);

              cls.subclasses.forEach(sub => {
                const subDetails = document.createElement("details");
                subDetails.className = "subclass-card";

                const subSummary = document.createElement("summary");
                const subName = document.createElement("span");
                subName.textContent = sub.name;
                subSummary.appendChild(subName);
                subDetails.appendChild(subSummary);

                const subContent = document.createElement("div");
                subContent.className = "collapsible-content";

                if (sub.spotlight) {
                  const spotlight = document.createElement("p");
                  spotlight.textContent = sub.spotlight;
                  subContent.appendChild(spotlight);
                }

                if (Array.isArray(sub.features) && sub.features.length) {
                  const featureWrap = document.createElement("div");
                  featureWrap.style.marginTop = "0.5rem";
                  const featureHeading = document.createElement("strong");
                  featureHeading.textContent = "Signature moves";
                  featureWrap.appendChild(featureHeading);
                  const subFeatureList = document.createElement("ul");
                  sub.features.forEach(point => {
                    const li = document.createElement("li");
                    li.textContent = point;
                    subFeatureList.appendChild(li);
                  });
                  featureWrap.appendChild(subFeatureList);
                  subContent.appendChild(featureWrap);
                }

                if (Array.isArray(sub.sources) && sub.sources.length) {
                  const subSources = document.createElement("div");
                  subSources.className = "subclass-meta";
                  const label = document.createElement("strong");
                  label.textContent = "Sources:";
                  subSources.appendChild(label);
                  sub.sources.forEach((source, index) => {
                    if (index > 0) {
                      subSources.appendChild(document.createTextNode(" · "));
                    }
                    const link = document.createElement("a");
                    link.href = source.url;
                    link.target = "_blank";
                    link.rel = "noopener";
                    link.textContent = source.label;
                    link.style.color = "var(--accent)";
                    link.style.textDecoration = "none";
                    subSources.appendChild(link);
                  });
                  subContent.appendChild(subSources);
                }

                if (sub.comparison?.note) {
                  const comparison = document.createElement("p");
                  comparison.className = "comparison-note";
                  const label = document.createElement("strong");
                  label.textContent = "Cross-edition insight:";
                  comparison.appendChild(label);
                  comparison.appendChild(document.createTextNode(` ${sub.comparison.note}`));
                  if (sub.comparison.link?.url) {
                    comparison.appendChild(document.createTextNode(" "));
                    const link = document.createElement("a");
                    link.href = sub.comparison.link.url;
                    link.target = "_blank";
                    link.rel = "noopener";
                    link.textContent = sub.comparison.link.label || "Read more";
                    comparison.appendChild(link);
                  }
                  subContent.appendChild(comparison);
                }

                subDetails.appendChild(subContent);
                subclassGroup.appendChild(subDetails);
              });

              content.appendChild(subclassGroup);
            }

            classDetails.appendChild(content);
            accordion.appendChild(classDetails);
          });

          classSection.appendChild(accordion);
          details.appendChild(classSection);
        }

        if (rule.settings?.length) {
          const settingsSection = document.createElement("div");
          settingsSection.className = "rules-section";
          settingsSection.innerHTML = `<strong>Iconic Campaign Settings</strong>`;
          const settingsList = document.createElement("ul");

          rule.settings.forEach(setting => {
            const li = document.createElement("li");
            const name = document.createElement("strong");
            name.textContent = setting.name;
            li.appendChild(name);

            if (setting.tone) {
              li.appendChild(document.createTextNode(` — ${setting.tone}`));
            }

            const linkRow = document.createElement("div");
            linkRow.className = "setting-links";

            if (setting.source?.url) {
              const sourceLink = document.createElement("a");
              sourceLink.href = setting.source.url;
              sourceLink.target = "_blank";
              sourceLink.rel = "noopener";
              sourceLink.textContent = setting.source.label || "Sourcebook";
              linkRow.appendChild(sourceLink);
            }

            const askLink = document.createElement("a");
            askLink.href = "#ask";
            askLink.className = "setting-prompt";
            askLink.dataset.prompt = setting.prompt
              || `What signature lore should I highlight when running a ${setting.name} campaign for ${rule.edition}?`;
            askLink.textContent = `Ask the DM about ${setting.name}`;

            if (linkRow.childNodes.length) {
              const divider = document.createElement("span");
              divider.textContent = "·";
              linkRow.appendChild(divider);
            }

            linkRow.appendChild(askLink);
            li.appendChild(linkRow);

            settingsList.appendChild(li);
          });

          settingsSection.appendChild(settingsList);
          details.appendChild(settingsSection);
        }

        if (rule.adventureHooks?.length) {
          const hooks = document.createElement("div");
          hooks.className = "rules-section";
          hooks.innerHTML = `<strong>Adventure hook prompts</strong>`;
          const hookList = document.createElement("ul");
          rule.adventureHooks.forEach(item => {
            const li = document.createElement("li");
            li.textContent = item;
            hookList.appendChild(li);
          });
          hooks.appendChild(hookList);
          details.appendChild(hooks);
        }

        const links = document.createElement("div");
        links.className = "rules-section";
        links.innerHTML = `<strong>Primary references & SRDs</strong>`;
        const linkList = document.createElement("ul");
        rule.srds.forEach(srd => {
          const li = document.createElement("li");
          li.innerHTML = `<a href="${srd.url}" target="_blank" rel="noopener">${srd.label}</a>`;
          linkList.appendChild(li);
        });
        links.appendChild(linkList);
        details.appendChild(links);

        rulesGrid.appendChild(details);
      });

      // Populate item filters
      const raritySelect = document.getElementById("item-filter");
      const attunementSelect = document.getElementById("attunement-filter");
      const typeSelect = document.getElementById("item-type-filter");
      const editionSelect = document.getElementById("edition-filter");
      rarityOptions.forEach(rarity => {
        const option = document.createElement("option");
        option.value = rarity;
        option.textContent = rarity;
        raritySelect.appendChild(option);
      });

      const uniqueTypes = Array.from(new Set(ITEMS.map(item => item.type))).sort();
      uniqueTypes.forEach(type => {
        const option = document.createElement("option");
        option.value = type;
        option.textContent = type;
        typeSelect.appendChild(option);
      });

      const uniqueEditions = Array.from(new Set(ITEMS.map(item => item.edition)));
      uniqueEditions.forEach(edition => {
        const option = document.createElement("option");
        option.value = edition;
        option.textContent = edition;
        editionSelect.appendChild(option);
      });

      const itemsList = document.getElementById("items-list");
      const itemQuery = document.getElementById("item-query");

      const downtimeForm = document.getElementById("downtime-form");
      const downtimeActivitySelect = document.getElementById("downtime-activity");
      const downtimeDynamicFields = document.getElementById("downtime-dynamic-fields");
      const downtimeSummary = document.getElementById("downtime-summary");
      const downtimeCopyBtn = document.getElementById("downtime-copy");

      const numberFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2, minimumFractionDigits: 0 });

      const formatGp = (value) => {
        const safeValue = Number.isFinite(value) ? value : 0;
        const rounded = Math.round((safeValue + Number.EPSILON) * 100) / 100;
        const formatted = numberFormatter.format(rounded);
        return `${formatted} gp`;
      };

      const formatHours = (value) => {
        if (!Number.isFinite(value) || value <= 0) return "0 hours";
        const rounded = Math.round((value + Number.EPSILON) * 10) / 10;
        const digits = Number.isInteger(rounded) ? 0 : 1;
        const formatted = rounded.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits });
        return `${formatted} hour${rounded === 1 ? "" : "s"}`;
      };

      const formatDays = (value) => {
        if (!Number.isFinite(value) || value <= 0) return "0 days";
        const rounded = Math.round((value + Number.EPSILON) * 10) / 10;
        const digits = Number.isInteger(rounded) ? 0 : 1;
        const formatted = rounded.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits });
        return `${formatted} day${rounded === 1 ? "" : "s"}`;
      };

      const DOWNTIME_CONFIG = {
        crafting: {
          label: "Crafting (mundane item)",
          reference: "SRD 5.1, Downtime Activities – Crafting (Player's Handbook p. 187)",
          fields: [
            {
              id: "craft-market-price",
              name: "marketPrice",
              label: "Market price of the finished item (gp)",
              type: "number",
              min: 0,
              step: 1,
              value: 50,
              helper: "Enter the list cost of the item you want to produce.",
            },
            {
              id: "craft-days",
              name: "availableDays",
              label: "Downtime days you can invest now",
              type: "number",
              min: 1,
              step: 1,
              placeholder: "Optional",
              helper: "Track partial progress for a short crafting season.",
            },
          ],
          checkboxes: [
            {
              id: "craft-proficiency",
              name: "proficient",
              label: "Crafter is proficient with the required artisan's tools (advantage when appropriate)",
              defaultChecked: true,
            },
            {
              id: "craft-assistant",
              name: "assistant",
              label: "Working alongside at least one skilled helper (adds +5 gp progress/day)",
            },
            {
              id: "craft-guild",
              name: "guild",
              label: "Guild workshop or bulk materials discount (reduce costs by 25%)",
            },
          ],
          compute(values) {
            const marketPrice = Math.max(0, Number(values.marketPrice) || 0);
            if (!marketPrice) {
              return {
                headline: "Enter an item's market price to calculate a crafting plan.",
                timeText: "Awaiting input",
                costText: "Materials cost unknown",
                checkText: "Use the relevant artisan's tools with an ability check vs. a DC the DM sets for the item.",
                reference: this.reference,
                note: "Crafting requires access to tools and materials before work can begin.",
                copyText: "",
              };
            }

            const baseProgress = 5;
            const progressPerDay = baseProgress + (values.assistant ? 5 : 0);
            const totalDaysRaw = marketPrice / progressPerDay;
            const totalDays = Math.max(1, Math.ceil(totalDaysRaw));
            let materialsCost = marketPrice / 2;
            if (values.guild) {
              materialsCost *= 0.75;
            }

            const availableDays = Number.isFinite(values.availableDays) && values.availableDays > 0
              ? values.availableDays
              : null;
            const noteParts = [];

            if (availableDays) {
              const daysWorked = Math.min(availableDays, totalDaysRaw);
              const gpProgress = daysWorked * progressPerDay;
              const percentComplete = Math.min(gpProgress / marketPrice, 1) * 100;
              if (availableDays < totalDaysRaw) {
                const remainingDays = Math.ceil(totalDaysRaw - availableDays);
                noteParts.push(`With ${formatDays(availableDays)} scheduled you'll finish about ${Math.round(percentComplete)}% (${formatGp(gpProgress)}) and still need roughly ${formatDays(remainingDays)} later.`);
              } else {
                noteParts.push(`You can finish within the allotted ${formatDays(availableDays)} of downtime.`);
              }
            }

            if (values.assistant) {
              noteParts.push("A skilled assistant doubles your progress to 10 gp per day as long as they contribute their downtime.");
            }
            if (values.proficient) {
              noteParts.push("Tool proficiency supports advantage when the DM allows and avoids mishaps.");
            } else {
              noteParts.push("Without the right tool proficiency the DM may impose disadvantage or additional complications.");
            }

            const headline = `Crafting ${formatGp(marketPrice)} item`;
            const timeText = `${formatDays(totalDays)} of downtime at ${progressPerDay} gp progress per day.`;
            const costText = `${formatGp(materialsCost)} in materials${values.guild ? " after the guild discount." : "."}`;
            const checkText = `Ability check with the relevant artisan's tools vs. a DC the DM sets for the item's complexity${values.proficient ? "; you qualify for proficiency bonuses" : "."}`;
            const reference = this.reference;
            const note = noteParts.join(" ");

            const copyLines = [
              `Downtime activity: Crafting`,
              `Item market price: ${formatGp(marketPrice)}`,
              `Daily progress: ${progressPerDay} gp`,
              `Downtime required: ${formatDays(totalDays)}`,
              availableDays ? `Scheduled now: ${formatDays(availableDays)}` : null,
              `Materials needed: ${formatGp(materialsCost)}${values.guild ? " (25% guild discount)" : ""}`,
              `Check guidance: ${checkText}`,
              note ? `Notes: ${note}` : null,
              `Reference: ${reference}`,
            ].filter(Boolean).join("\n");

            return { headline, timeText, costText, checkText, reference, note, copyText: copyLines };
          },
        },
        scribing: {
          label: "Scribing a spell",
          reference: "SRD 5.1, Wizard Spellbook – Copying a Spell (Player's Handbook p. 114)",
          fields: [
            {
              id: "scribe-level",
              name: "spellLevel",
              label: "Spell level",
              type: "select",
              options: [
                { value: "0", label: "Cantrip" },
                { value: "1", label: "1st level" },
                { value: "2", label: "2nd level" },
                { value: "3", label: "3rd level" },
                { value: "4", label: "4th level" },
                { value: "5", label: "5th level" },
                { value: "6", label: "6th level" },
                { value: "7", label: "7th level" },
                { value: "8", label: "8th level" },
                { value: "9", label: "9th level" },
              ],
              value: "1",
            },
            {
              id: "scribe-count",
              name: "copies",
              label: "Number of spells",
              type: "number",
              min: 1,
              step: 1,
              value: 1,
            },
          ],
          checkboxes: [
            {
              id: "scribe-tradition",
              name: "traditionDiscount",
              label: "Arcane tradition (e.g., School Savant) halves the gold and time",
            },
            {
              id: "scribe-owned-source",
              name: "ownSource",
              label: "Copying from your own scroll or notes (time halved, gold unchanged)",
            },
          ],
          compute(values) {
            const level = Number(values.spellLevel ?? 0);
            const copies = Math.max(0, Number(values.copies) || 0);

            if (!copies) {
              return {
                headline: "Enter how many spells you're transcribing to see costs.",
                timeText: "Awaiting input",
                costText: "Inks and rare parchment cost unknown",
                checkText: "No check is normally required; you spend the time and gold automatically.",
                reference: this.reference,
                note: "Scribing demands the spell must already be prepared or available to copy.",
                copyText: "",
              };
            }

            const baseLevelCost = level <= 0 ? 0 : level * 50;
            const baseLevelHours = level <= 0 ? 0 : level * 2;
            let totalCost = baseLevelCost * copies;
            let totalHours = baseLevelHours * copies;

            if (values.traditionDiscount) {
              totalCost *= 0.5;
              totalHours *= 0.5;
            }
            if (values.ownSource) {
              totalHours *= 0.5;
            }

            const downtimeDays = totalHours / 8;
            const timeText = totalHours > 0
              ? `${formatHours(totalHours)} of focused writing (~${formatDays(Math.max(1, Math.ceil(downtimeDays || 0)))})`
              : "No downtime needed; cantrips don't require copying in the SRD.";
            const costText = totalCost > 0
              ? `${formatGp(totalCost)} in inks and fine parchment.`
              : "No gold cost for cantrips.";
            const checkText = "No check required; failure only occurs if you lack time or the spell is higher level than you can prepare.";

            const noteParts = [];
            if (values.traditionDiscount) {
              noteParts.push("Tradition features halve both cost and time.");
            }
            if (values.ownSource) {
              noteParts.push("Copying from your own notes halves the remaining time requirement.");
            }
            if (level === 0) {
              noteParts.push("Cantrips are usually gained through leveling, so copying rules may not apply—confirm with your DM.");
            }

            const headline = copies === 1
              ? `Scribing a ${level === 0 ? "cantrip" : `${level}th-level`} spell`
              : `Scribing ${copies} spells of level ${level}`;
            const reference = this.reference;
            const note = noteParts.join(" ");

            const copyLines = [
              `Downtime activity: Scribing spells`,
              `Spell level: ${level}`,
              `Number of spells: ${copies}`,
              `Time required: ${timeText}`,
              `Cost: ${costText}`,
              `Check guidance: ${checkText}`,
              note ? `Notes: ${note}` : null,
              `Reference: ${reference}`,
            ].filter(Boolean).join("\n");

            return { headline, timeText, costText, checkText, reference, note, copyText: copyLines };
          },
        },
        training: {
          label: "Training proficiency",
          reference: "SRD 5.1, Downtime Activities – Training (Player's Handbook p. 187)",
          fields: [
            {
              id: "training-focus",
              name: "focus",
              label: "Training goal",
              type: "select",
              options: [
                { value: "tool", label: "Tool proficiency" },
                { value: "language", label: "New language" },
              ],
              value: "tool",
            },
            {
              id: "training-days",
              name: "availableDays",
              label: "Downtime days you can commit now",
              type: "number",
              min: 1,
              step: 1,
              placeholder: "Optional",
              helper: "Track how long the current training block lasts.",
            },
          ],
          checkboxes: [
            {
              id: "training-mentor",
              name: "mentor",
              label: "Dedicated tutor speeds training (time halved, gold doubled per day)",
            },
            {
              id: "training-related",
              name: "related",
              label: "Already proficient in a closely related skill (time reduced by 25%)",
            },
          ],
          compute(values) {
            const baseDays = 250;
            let totalDays = baseDays;
            let dailyCost = 1;

            if (values.mentor) {
              totalDays *= 0.5;
              dailyCost = 2;
            }
            if (values.related) {
              totalDays *= 0.75;
            }

            totalDays = Math.max(1, Math.ceil(totalDays));
            const totalCost = totalDays * dailyCost;

            const availableDays = Number.isFinite(values.availableDays) && values.availableDays > 0
              ? values.availableDays
              : null;

            const noteParts = [];
            if (values.mentor) {
              noteParts.push("A tutor accelerates progress but charges 2 gp per day.");
            }
            if (values.related) {
              noteParts.push("Related experience trims 25% off the schedule.");
            }
            if (availableDays) {
              if (availableDays < totalDays) {
                const remaining = Math.max(0, totalDays - availableDays);
                noteParts.push(`After ${formatDays(availableDays)} you'll need about ${formatDays(remaining)} more to finish.`);
              } else {
                noteParts.push(`You can complete the training within ${formatDays(availableDays)}.`);
              }
            }

            const focusText = values.focus === "language" ? "a new language" : "a tool proficiency";
            const headline = `Training ${focusText}`;
            const timeText = `${formatDays(totalDays)} of instruction at ${dailyCost} gp per day.`;
            const costText = `${formatGp(totalCost)} total tuition.`;
            const checkText = "No roll required; completion grants the proficiency after you invest the downtime and gold.";
            const reference = this.reference;
            const note = noteParts.join(" ");

            const copyLines = [
              `Downtime activity: Training`,
              `Goal: ${focusText}`,
              `Downtime required: ${formatDays(totalDays)}`,
              availableDays ? `Scheduled now: ${formatDays(availableDays)}` : null,
              `Daily cost: ${formatGp(dailyCost)}`,
              `Total cost: ${formatGp(totalCost)}`,
              `Check guidance: ${checkText}`,
              note ? `Notes: ${note}` : null,
              `Reference: ${reference}`,
            ].filter(Boolean).join("\n");

            return { headline, timeText, costText, checkText, reference, note, copyText: copyLines };
          },
        },
      };

      const buildFieldControl = (field) => {
        const wrapper = document.createElement("label");
        wrapper.htmlFor = field.id;
        wrapper.appendChild(document.createTextNode(field.label));

        let control;
        if (field.type === "select") {
          control = document.createElement("select");
          control.id = field.id;
          control.name = field.name;
          field.options.forEach(opt => {
            const option = document.createElement("option");
            option.value = opt.value;
            option.textContent = opt.label;
            control.appendChild(option);
          });
          if (field.value !== undefined) {
            control.value = field.value;
          }
        } else {
          control = document.createElement("input");
          control.type = field.type || "text";
          control.id = field.id;
          control.name = field.name;
          if (field.placeholder) control.placeholder = field.placeholder;
          if (field.min !== undefined) control.min = field.min;
          if (field.max !== undefined) control.max = field.max;
          if (field.step !== undefined) control.step = field.step;
          if (field.value !== undefined && field.value !== null) control.value = field.value;
        }

        wrapper.appendChild(control);

        if (field.helper) {
          const helper = document.createElement("span");
          helper.style.fontSize = "0.75rem";
          helper.style.opacity = "0.7";
          helper.textContent = field.helper;
          wrapper.appendChild(helper);
        }

        return wrapper;
      };

      const buildCheckboxControl = (checkbox) => {
        const wrapper = document.createElement("label");
        wrapper.htmlFor = checkbox.id;
        const control = document.createElement("input");
        control.type = "checkbox";
        control.id = checkbox.id;
        control.name = checkbox.name;
        control.checked = Boolean(checkbox.defaultChecked);
        wrapper.appendChild(control);
        const text = document.createElement("span");
        text.textContent = checkbox.label;
        wrapper.appendChild(text);
        return wrapper;
      };

      const renderDowntimeFields = (activityKey) => {
        const config = DOWNTIME_CONFIG[activityKey];
        downtimeDynamicFields.innerHTML = "";
        if (!config) return;

        config.fields?.forEach(field => {
          const fieldControl = buildFieldControl(field);
          downtimeDynamicFields.appendChild(fieldControl);
        });

        if (config.checkboxes?.length) {
          const checkboxGroup = document.createElement("div");
          checkboxGroup.className = "downtime-checkboxes";
          config.checkboxes.forEach(box => {
            const checkboxControl = buildCheckboxControl(box);
            checkboxGroup.appendChild(checkboxControl);
          });
          downtimeDynamicFields.appendChild(checkboxGroup);
        }
      };

      const collectDowntimeValues = (activityKey) => {
        const config = DOWNTIME_CONFIG[activityKey];
        const values = {};
        if (!config) return values;
        config.fields?.forEach(field => {
          const control = downtimeForm.querySelector(`[name="${field.name}"]`);
          if (!control) return;
          if (field.type === "number") {
            const raw = control.value.trim();
            values[field.name] = raw === "" ? null : Number(raw);
          } else {
            values[field.name] = control.value;
          }
        });
        config.checkboxes?.forEach(box => {
          const control = downtimeForm.querySelector(`[name="${box.name}"]`);
          if (!control) return;
          values[box.name] = control.checked;
        });
        return values;
      };

      const updateDowntimeSummary = () => {
        const activityKey = downtimeActivitySelect.value;
        const config = DOWNTIME_CONFIG[activityKey];
        if (!config) return;
        const values = collectDowntimeValues(activityKey);
        const result = config.compute(values);

        downtimeSummary.innerHTML = `
          <strong>${result.headline}</strong>
          <dl>
            <dt>Time required</dt>
            <dd>${result.timeText}</dd>
            <dt>Gold cost</dt>
            <dd>${result.costText}</dd>
            <dt>Checks</dt>
            <dd>${result.checkText}</dd>
            <dt>Reference</dt>
            <dd>${result.reference}</dd>
          </dl>
          ${result.note ? `<p style="margin: 0; font-size: 0.8rem; opacity: 0.75;">${result.note}</p>` : ""}
        `;

        const copyText = result.copyText ?? "";
        if (copyText) {
          downtimeCopyBtn.disabled = false;
          downtimeCopyBtn.dataset.summary = copyText;
          downtimeCopyBtn.textContent = "Copy summary";
        } else {
          downtimeCopyBtn.disabled = true;
          downtimeCopyBtn.dataset.summary = "";
        }
      };

      downtimeActivitySelect.addEventListener("change", () => {
        renderDowntimeFields(downtimeActivitySelect.value);
        updateDowntimeSummary();
      });

      downtimeForm.addEventListener("input", () => {
        updateDowntimeSummary();
      });

      downtimeForm.addEventListener("change", () => {
        updateDowntimeSummary();
      });

      downtimeCopyBtn.addEventListener("click", async () => {
        const summary = downtimeCopyBtn.dataset.summary;
        if (!summary) return;
        let copied = false;
        if (navigator.clipboard?.writeText) {
          try {
            await navigator.clipboard.writeText(summary);
            copied = true;
          } catch (err) {
            console.warn("Clipboard API failed, falling back", err);
          }
        }
        if (!copied) {
          const temp = document.createElement("textarea");
          temp.value = summary;
          temp.setAttribute("readonly", "readonly");
          temp.style.position = "absolute";
          temp.style.left = "-9999px";
          document.body.appendChild(temp);
          temp.select();
          try {
            document.execCommand("copy");
            copied = true;
          } catch (err) {
            console.error("Fallback copy failed", err);
          }
          document.body.removeChild(temp);
        }
        if (copied) {
          const originalText = downtimeCopyBtn.textContent;
          downtimeCopyBtn.textContent = "Copied!";
          downtimeCopyBtn.disabled = true;
          setTimeout(() => {
            downtimeCopyBtn.textContent = originalText;
            downtimeCopyBtn.disabled = false;
          }, 2000);
        }
      });

      renderDowntimeFields(downtimeActivitySelect.value);
      updateDowntimeSummary();

      const renderItems = () => {
        const query = itemQuery.value.toLowerCase().trim();
        const rarity = raritySelect.value;
        const attunement = attunementSelect.value;
        const type = typeSelect.value;
        const edition = editionSelect.value;
        itemsList.innerHTML = "";
        const results = ITEMS.filter(item => {
          const matchesQuery =
            !query ||
            [item.name, item.description, item.source, item.type, item.edition, item.attunement, item.notes, item.cost]
              .filter(Boolean)
              .some(field => field.toLowerCase().includes(query));
          const matchesRarity = rarity === "all" || item.rarity === rarity;
          const matchesAttunement = attunement === "all" || item.attunementTag === attunement;
          const matchesType = type === "all" || item.type === type;
          const matchesEdition = edition === "all" || item.edition === edition;
          return matchesQuery && matchesRarity && matchesAttunement && matchesType && matchesEdition;
        });

        if (!results.length) {
          const empty = document.createElement("p");
          empty.textContent = "No items match your filters yet. Try a different search term.";
          empty.style.opacity = "0.75";
          itemsList.appendChild(empty);
          return;
        }

        results.forEach(item => {
          const card = document.createElement("article");
          card.className = "item-card";
          const badgePieces = [`<span class="pill">${item.rarity}</span>`];
          if (item.attunementTag === "required") {
            badgePieces.push('<span class="pill attunement">Requires attunement</span>');
          } else if (item.attunementTag === "conditional") {
            badgePieces.push('<span class="pill attunement">Conditional attunement</span>');
          }
          if (item.editionSpecific) {
            badgePieces.push('<span class="pill edition-flag">Edition variants</span>');
          }

          card.innerHTML = `
            <h4>${item.name}</h4>
            <div class="item-meta">
              <span><strong>Type:</strong> ${item.type}</span>
              <span><strong>Edition:</strong> ${item.edition}</span>
              ${badgePieces.join(" ")}
            </div>
            <p>${item.description}</p>
            <p><strong>Attunement:</strong> ${item.attunement}</p>
            <p><strong>Cost:</strong> ${item.cost}</p>
            <p><strong>Notes:</strong> ${item.notes}</p>
            <p style="font-size: 0.85rem; opacity: 0.7;"><strong>Source:</strong> ${item.source}</p>
          `;
          itemsList.appendChild(card);
        });
      };

      itemQuery.addEventListener("input", renderItems);
      raritySelect.addEventListener("change", renderItems);
      attunementSelect.addEventListener("change", renderItems);
      typeSelect.addEventListener("change", renderItems);
      editionSelect.addEventListener("change", renderItems);
      renderItems();

      // WebLLM setup
      const logEl = document.getElementById("chat-log");
      const promptEl = document.getElementById("prompt");
      const sendBtn = document.getElementById("send");
      const statusEl = document.getElementById("status");

      const messages = [
        {
          role: "system",
          content: `You are an expert Dungeon Master and rules archivist for every edition of Dungeons & Dragons.
Provide concise, citation-style answers drawing on SRDs, rulebooks, and designer commentary.
If content might differ between editions, call out each edition explicitly.
Always encourage players to consult the cited books for full rules text.
Avoid reproducing copyrighted text verbatim; summarize mechanics instead.
Stay family friendly and inclusive.`
        }
      ];

      function openAskTab() {
        const askButton = document.querySelector('nav button[data-target="ask"]');
        if (askButton && !askButton.classList.contains("active")) {
          askButton.click();
        }
      }

      function wirePromptPrefill(elements) {
        elements.forEach(el => {
          el.addEventListener("click", (event) => {
            const prompt = el.dataset.prompt?.trim();
            if (!prompt) return;
            if (el.tagName === "A") {
              event.preventDefault();
            }
            openAskTab();
            promptEl.value = prompt;
            promptEl.focus();
            document.getElementById("ask")?.scrollIntoView({ behavior: "smooth", block: "start" });
          });
        });
      }

      const quickPromptButtons = renderQuickPrompts();
      wirePromptPrefill(quickPromptButtons);
      wirePromptPrefill(document.querySelectorAll(".setting-prompt"));

      const appendMessage = (role, content) => {
        const bubble = document.createElement("div");
        bubble.className = `bubble ${role}`;
        bubble.textContent = content;
        logEl.appendChild(bubble);
        logEl.scrollTop = logEl.scrollHeight;
      };

      appendMessage("assistant", "Welcome, adventurer! I'm your digital Dungeon Master. Ask me about any rule, edition, or item and I'll guide you to the right table, chapter, or adjudication.");

      const updateStatus = (text, state = "") => {
        statusEl.classList.remove("ready", "generating");
        if (state) statusEl.classList.add(state);
        statusEl.querySelector("strong").textContent = text;
      };

      updateStatus("Initializing engine…");

      const webllm = await import("https://esm.run/@mlc-ai/web-llm");
      const models = webllm.prebuiltAppConfig.model_list;
      const selectedModel =
        models.find(m => /Gemma-2.*2B.*it/i.test(m.model_id))?.model_id
        ?? models.find(m => /Phi-3\.5.*mini.*it/i.test(m.model_id))?.model_id
        ?? models[0].model_id;

      let engine;
      try {
        engine = await webllm.CreateMLCEngine(selectedModel, {
          initProgressCallback: (p) => updateStatus(`${Math.floor(p.progress * 100)}% · ${p.text || p.stage}`)
        });
        updateStatus("Ready to answer questions", "ready");
        sendBtn.disabled = false;
      } catch (err) {
        console.error(err);
        updateStatus("Failed to load WebLLM. Refresh and ensure WebGPU is enabled.");
        return;
      }

      async function streamReply(messages, opts = {}) {
        const chunks = await engine.chat.completions.create({
          messages,
          temperature: 0.5,
          max_tokens: 400,
          stream: true,
          stream_options: { include_usage: true },
          ...opts
        });
        let out = "";
        for await (const c of chunks) {
          const delta = c.choices?.[0]?.delta?.content || "";
          out += delta;
          if (delta) {
            if (!logEl.lastChild || !logEl.lastChild.classList.contains("assistant")) {
              const bubble = document.createElement("div");
              bubble.className = "bubble assistant";
              bubble.textContent = delta;
              logEl.appendChild(bubble);
            } else {
              logEl.lastChild.textContent += delta;
            }
            logEl.scrollTop = logEl.scrollHeight;
          }
          updateStatus("Generating response…", "generating");
        }
        return out.trim();
      }

      const sendPrompt = async () => {
        const text = promptEl.value.trim();
        if (!text) return;
        promptEl.value = "";
        appendMessage("user", text);
        messages.push({ role: "user", content: text });
        sendBtn.disabled = true;
        try {
          const reply = await streamReply(messages);
          messages.push({ role: "assistant", content: reply });
          updateStatus("Ready", "ready");
        } catch (error) {
          console.error(error);
          appendMessage("assistant", "I ran into an error generating that response. Please try again.");
          updateStatus("Encountered an error");
        } finally {
          sendBtn.disabled = false;
        }
      };

      sendBtn.addEventListener("click", sendPrompt);
      promptEl.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && !ev.shiftKey) {
          ev.preventDefault();
          sendPrompt();
        }
      });

    </script>
  </body>
</html>
