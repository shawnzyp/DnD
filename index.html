<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>D&D Companion – Ask the DM</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0e141a;
        --surface: rgba(255, 255, 255, 0.08);
        --text: #f5f5f5;
        --accent: #d96d28;
        --accent-dark: #b3571e;
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      }

      body {
        margin: 0;
        background: radial-gradient(circle at top, rgba(255, 255, 255, 0.08), transparent 70%), var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 1.5rem 1rem 1rem;
        text-align: center;
      }

      h1 {
        margin: 0 0 0.25rem;
        font-size: clamp(1.8rem, 4vw, 2.4rem);
        letter-spacing: 0.08em;
      }

      header p {
        margin: 0;
        opacity: 0.8;
        font-size: 0.95rem;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 0 1rem 2rem;
        max-width: 980px;
        width: 100%;
        margin: 0 auto;
      }

      .card {
        background: rgba(15, 22, 32, 0.82);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 18px;
        padding: 1.25rem;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.28);
        backdrop-filter: blur(12px);
      }

      nav {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.5rem;
      }

      nav button {
        background: transparent;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 0.65rem 0.9rem;
        color: inherit;
        font-weight: 600;
        letter-spacing: 0.04em;
        cursor: pointer;
        transition: all 180ms ease;
      }

      nav button.active {
        background: var(--accent);
        border-color: transparent;
        color: #fff;
        box-shadow: 0 8px 20px rgba(217, 109, 40, 0.4);
      }

      nav button:active {
        transform: translateY(1px);
      }

      section {
        display: none;
      }

      section.active {
        display: block;
      }

      .status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        opacity: 0.8;
      }

      .status span {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #ffbe4d;
        display: inline-block;
      }

      .status.ready span { background: #31c48d; }
      .status.generating span { background: #ff7849; }

      .chat-log {
        height: clamp(240px, 40vh, 420px);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem;
        border-radius: 14px;
        background: rgba(5, 9, 16, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .bubble {
        padding: 0.85rem 1rem;
        border-radius: 12px;
        line-height: 1.45;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      .bubble.user {
        align-self: flex-end;
        background: rgba(217, 109, 40, 0.18);
        border-top-right-radius: 4px;
      }

      .bubble.assistant {
        background: rgba(255, 255, 255, 0.04);
        border-top-left-radius: 4px;
      }

      .chat-input {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      .chat-input textarea {
        flex: 1;
        min-height: 68px;
        resize: vertical;
        border-radius: 12px;
        padding: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.45);
        color: inherit;
        font-size: 1rem;
      }

      .chat-input button {
        background: var(--accent);
        border: none;
        color: #fff;
        padding: 0.75rem 1.1rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        min-width: 110px;
        box-shadow: 0 12px 30px rgba(217, 109, 40, 0.4);
        transition: background 160ms ease, transform 160ms ease;
      }

      .chat-input button:disabled {
        opacity: 0.6;
        cursor: wait;
        box-shadow: none;
      }

      .chat-input button:not(:disabled):active {
        transform: translateY(1px);
        background: var(--accent-dark);
      }

      .quick-prompts {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .quick-prompts button {
        background: rgba(255, 255, 255, 0.08);
        border: none;
        color: inherit;
        padding: 0.5rem 0.8rem;
        border-radius: 999px;
        cursor: pointer;
        font-size: 0.85rem;
      }

      .quick-prompts button:hover {
        background: rgba(255, 255, 255, 0.16);
      }

      details {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        padding: 1rem;
        background: rgba(5, 9, 16, 0.65);
      }

      details summary {
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.05em;
      }

      .rules-grid {
        display: grid;
        gap: 1rem;
      }

      .rules-meta {
        margin-top: 0.75rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem 1.25rem;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.85);
      }

      .rules-meta strong {
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      .rules-section {
        margin-top: 0.75rem;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        padding-top: 0.75rem;
      }

      .rules-section ul,
      .expansion-list ul {
        margin: 0.35rem 0 0;
        padding-left: 1.25rem;
      }

      .setting-links {
        margin-top: 0.35rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.85rem;
        opacity: 0.85;
      }

      .setting-links a {
        color: var(--accent);
        text-decoration: none;
      }

      .setting-links a:hover {
        text-decoration: underline;
      }

      .expansion-list li {
        margin-bottom: 0.2rem;
      }

      .pill {
        display: inline-block;
        background: rgba(217, 109, 40, 0.22);
        color: #ffdcb5;
        border-radius: 999px;
        padding: 0.2rem 0.6rem;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
      }

      .pill.attunement {
        background: rgba(141, 198, 63, 0.25);
        color: #e6ffd1;
      }

      .pill.edition-flag {
        background: rgba(64, 181, 219, 0.25);
        color: #d1f3ff;
      }

      .items-search {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .items-search input,
      .items-search select {
        width: 100%;
        padding: 0.65rem 0.85rem;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.45);
        color: inherit;
      }

      .item-meta,
      .monster-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem 0.75rem;
        align-items: center;
        margin: 0.45rem 0 0;
        font-size: 0.9rem;
        opacity: 0.85;
      }

      .item-meta strong,
      .monster-meta strong {
        font-weight: 600;
      }

      .item-card,
      .monster-card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.04);
      }

      .item-card h4,
      .monster-card h4 {
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        font-size: 1rem;
      }

      .item-card p,
      .monster-card p {
        margin: 0.45rem 0 0;
        line-height: 1.5;
        opacity: 0.85;
      }

      .monster-abilities {
        margin: 0.35rem 0 0.15rem;
        padding-left: 1.2rem;
        line-height: 1.5;
        opacity: 0.9;
      }

      .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        min-width: 600px;
      }

      .comparison-table thead th {
        background: #f3f4f6;
        font-weight: 600;
        padding: 0.75rem;
        text-align: left;
      }

      .comparison-table thead th:first-child {
        background: transparent;
      }

      .comparison-table tbody th {
        background: #fafbff;
        width: 16rem;
        font-weight: 600;
        padding: 0.75rem;
        vertical-align: top;
      }

      .comparison-table td {
        border-top: 1px solid rgba(15, 23, 42, 0.1);
        padding: 0.75rem;
        vertical-align: top;
      }

      .comparison-table ul {
        margin: 0.25rem 0 0.5rem;
        padding-left: 1.2rem;
      }

      .comparison-table p {
        margin: 0;
        line-height: 1.5;
      }

      .comparison-table .key-systems {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(129, 140, 248, 0.08));
        border-radius: 0.35rem;
        padding: 0.5rem 0.75rem;
        display: inline-block;
      }

      .comparison-table .key-systems ul {
        margin: 0.25rem 0 0;
      }

      footer {
        text-align: center;
        padding: 1.5rem 1rem 2rem;
        opacity: 0.7;
        font-size: 0.8rem;
      }

      @media (min-width: 768px) {
        main {
          padding: 0 2rem 2.5rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>D&D Companion</h1>
      <p>Ask the DM · Browse every edition · Reference gear &amp; loot</p>
    </header>

    <main>
      <nav class="card">
        <button class="active" data-target="ask">Ask the DM</button>
        <button data-target="rules">Rules Compendium</button>
        <button data-target="items">Item &amp; Gear Vault</button>
        <button data-target="bestiary">Bestiary</button>
        <button data-target="compare">Edition Comparison</button>
      </nav>

      <section id="ask" class="card active">
        <h2>Ask the DM</h2>
        <p>Chat with a lore-savvy Dungeon Master powered by an on-device LLM. Ask about rules, ruling conflicts, worldbuilding prompts, or create custom content for any edition.</p>
        <div class="status" id="status"><span></span><strong>Initializing engine…</strong></div>
        <div class="chat-log" id="chat-log"></div>
        <div class="chat-input">
          <textarea id="prompt" placeholder="Ask anything about D&D…" aria-label="Ask the DM"></textarea>
          <button id="send" disabled>Send</button>
        </div>
        <div class="quick-prompts" aria-label="Quick prompts">
          <button data-prompt="How do concentration checks work in D&D 5e?">Concentration rules (5e)</button>
          <button data-prompt="Explain the grapple rules in D&D 3.5 with examples.">Grapple (3.5)</button>
          <button data-prompt="What are the core differences between D&D 5e and One D&D 2024 classes?">Edition comparison</button>
          <button data-prompt="Generate a level 5 treasure hoard with items from multiple editions.">Treasure hoard</button>
        </div>
      </section>

      <section id="rules" class="card">
        <h2>Rules Compendium</h2>
        <p>Review every major Dungeons &amp; Dragons edition. Each entry includes core rules coverage, iconic subsystems, and the official SRDs or rulebooks to consult for full detail.</p>
        <div class="rules-grid" id="rules-grid"></div>
      </section>

      <section id="items" class="card">
        <h2>Item &amp; Gear Vault</h2>
        <p>Search across equipment, magic items, and artifacts spanning multiple editions. Filter by type or rarity and tap an item to review its summary and primary source.</p>
        <div class="items-search">
          <input type="search" id="item-query" placeholder="Search by name, effect, or source" aria-label="Search items" />
          <select id="item-filter" aria-label="Filter rarity">
            <option value="all">All rarities</option>
          </select>
          <select id="attunement-filter" aria-label="Filter attunement requirement">
            <option value="all">All attunement states</option>
            <option value="required">Requires attunement</option>
            <option value="none">No attunement</option>
            <option value="conditional">Conditional or edition-based</option>
          </select>
          <select id="item-type-filter" aria-label="Filter item type">
            <option value="all">All item types</option>
          </select>
          <select id="edition-filter" aria-label="Filter edition availability">
            <option value="all">All editions</option>
          </select>
        </div>
        <div id="items-list" style="margin-top: 1rem; display: grid; gap: 0.85rem;"></div>
      </section>

      <section id="bestiary" class="card">
        <h2>Bestiary</h2>
        <p>Discover iconic creatures with quick access to their tactics, challenge ratings, and SRD-friendly reference links. Filter by role or biome to slot foes into your next encounter.</p>
        <div class="items-search">
          <input type="search" id="monster-query" placeholder="Search by name, ability, or lore" aria-label="Search monsters" />
          <select id="monster-cr-filter" aria-label="Filter challenge rating">
            <option value="all">All challenge ratings</option>
          </select>
          <select id="monster-terrain-filter" aria-label="Filter terrain">
            <option value="all">All terrains</option>
          </select>
          <select id="monster-role-filter" aria-label="Filter combat role">
            <option value="all">All roles</option>
          </select>
        </div>
        <div id="bestiary-list" style="margin-top: 1rem; display: grid; gap: 0.85rem;"></div>
      </section>

      <section id="compare" class="card">
        <h2>Edition Comparison Dashboard</h2>
        <p>Contrast design philosophies, release windows, and key systems at a glance. Use this dashboard to spot how each ruleset approaches combat cadence, narrative support, and supplemental material.</p>
        <div id="comparison-matrix" style="overflow-x: auto;"></div>
      </section>
    </main>

    <footer>
      Built with WebLLM (Gemma-2-2B-it) so your DM helper runs entirely in the browser. Sources reference the SRD/OGL materials for each edition.
    </footer>

    <script type="module">
      const RULES_DATA = [
        {
          edition: "5th Edition (2014 SRD, 2016 SRD 5.1)",
          tagline: "Modern streamlined rules built on bounded accuracy and advantage/disadvantage.",
          released: "Core trilogy released 2014 · SRD 5.1 Creative Commons refresh 2023",
          playstyle: [
            "Narrative-forward play where backgrounds and bonds steer spotlight moments",
            "Fast combat that leans on advantage/disadvantage instead of dense modifiers",
            "Flexible downtime and exploration pillars supporting episodic or sandbox pacing"
          ],
          adventureHooks: [
            "A wild magic bloom beneath Waterdeep's Yawning Portal warps spells into unpredictable surges",
            "The Emerald Enclave hires the party to reseal a planar rift spilling Fey crossings into the Sword Coast",
            "Faction envoys vie for heroes to mediate a brewing guild war before Luskan descends into chaos"
          ],
          keySystems: [
            "Advantage & Disadvantage mechanics",
            "Proficiency bonus progression",
            "Backgrounds, feats (optional), multiclass prerequisites",
            "Concentration-based spell maintenance",
            "Unified challenge rating and encounter building guidelines"
          ],
          expansions: [
            "Player's Handbook (core classes, species, spells)",
            "Dungeon Master's Guide (magic item creation, optional rules)",
            "Monster Manual + Mordenkainen Presents (creature lore)",
            "Xanathar's Guide to Everything (expanded subclasses, downtime)",
            "Tasha's Cauldron of Everything (group patrons, alternate class features)"
          ],
          settings: [
            {
              name: "Forgotten Realms",
              tone: "Kitchen-sink high fantasy along the Sword Coast with factions, gods, and Realmslore supporting every playstyle.",
              source: {
                label: "Sword Coast Adventurer's Guide",
                url: "https://dnd.wizards.com/products/tabletop-games/rpg-products/sc-adventurers-guide"
              }
            },
            {
              name: "Eberron",
              tone: "Noir pulp adventures with magitech conveniences, dragonmarked intrigue, and post-war espionage.",
              source: {
                label: "Eberron: Rising from the Last War",
                url: "https://dnd.wizards.com/products/eberron-rising-last-war"
              }
            },
            {
              name: "Exandria (Wildemount)",
              tone: "Character-driven drama across war-torn continents where dunamis magic and Vestiges of Divergence shape hero arcs.",
              source: {
                label: "Explorer's Guide to Wildemount",
                url: "https://dnd.wizards.com/products/explorers-guide-wildemount"
              }
            }
          ],
          srds: [
            { label: "Systems Reference Document 5.1", url: "https://media.wizards.com/2023/downloads/dnd/SRD_CC_v5.1.pdf" },
            { label: "Basic Rules", url: "https://dnd.wizards.com/resources/basic-rules" }
          ]
        },
        {
          edition: "One D&D / 2024 Core Rules",
          tagline: "Upcoming refresh with revised classes, species terminology, and weapon masteries.",
          released: "Player's Handbook 2024 · Dungeon Master's Guide 2024 · Monster Manual 2025",
          playstyle: [
            "Bridging 5e familiarity with more codified class progression milestones",
            "Weapon masteries encourage tactical choices for martial characters each turn",
            "Unified spell lists streamline prep for tables juggling multiple casters"
          ],
          adventureHooks: [
            "An arcane bastion prototype malfunctions, merging its demiplane with a frontier keep",
            "Rival traditions of magic duel for control of a ley nexus revealed by the new rules glossary",
            "A dragonflight tests heroes with tiered challenges that unlock epic boons as rewards"
          ],
          keySystems: [
            "Rebalanced class progression with common subclass levels",
            "Weapon mastery properties and new weapon categories",
            "Revised spell lists grouped by class-specific traditions",
            "Species traits grouped into Heritage & Culture blocks",
            "Epic boons and tiered play updates"
          ],
          expansions: [
            "Player's Handbook (2024)",
            "Dungeon Master's Guide (2024) with revised encounter-building and bastions",
            "Monster Manual (2025) introducing updated stat block templates"
          ],
          settings: [
            {
              name: "Greyhawk",
              tone: "Classic sword & sorcery around the Free City and its factions, spotlighting elemental cults and political scheming.",
              source: {
                label: "Return to Greyhawk Preview",
                url: "https://www.dndbeyond.com/posts/1561-return-to-greyhawk-in-2024"
              }
            },
            {
              name: "Planescape: Turn of Fortune's Wheel",
              tone: "Planar intrigue in Sigil where faction philosophies and multiversal secrets shape every choice.",
              source: {
                label: "Planescape: Adventures in the Multiverse",
                url: "https://dnd.wizards.com/products/planescape-adventures-sigil-and-outlands"
              }
            },
            {
              name: "Vecna: Eve of Ruin",
              tone: "High-octane multiverse rescue linking iconic worlds against Vecna's looming apotheosis.",
              source: {
                label: "Vecna: Eve of Ruin",
                url: "https://dnd.wizards.com/products/vecna-eve-of-ruin"
              }
            }
          ],
          srds: [
            { label: "Unearthed Arcana archive", url: "https://www.dndbeyond.com/sources/ua" },
            { label: "Rules Glossary (Playtest 8)", url: "https://www.dndbeyond.com/sources/ua/ph-playtest-8" }
          ]
        },
        {
          edition: "3.5 Edition (Revised d20 System)",
          tagline: "Crunch-heavy rules with granular feats, prestige classes, and tactical combat options.",
          released: "Revised core books 2003 · Supplemental line through 2007",
          playstyle: [
            "Highly tactical combat featuring iterative attacks and stacking modifiers",
            "Character optimization via prestige classes, feat chains, and skill ranks",
            "Simulationist dungeon crawls with detailed subsystems for crafting and spells"
          ],
          adventureHooks: [
            "A forgotten wizard college releases a metamagic plague that alters spell slots across the realm",
            "The party must infiltrate a secret cabal trading forbidden prestige class manuals",
            "An ancient warforged titan reactivates, demanding heroes master combat maneuvers to disable it"
          ],
          keySystems: [
            "Base attack bonus (BAB) and iterative attacks",
            "Skill ranks with cross-class costs",
            "AoO (attacks of opportunity) trigger matrix",
            "Prestige class entry requirements",
            "Metamagic level adjustments and item creation feats"
          ],
          expansions: [
            "Player's Handbook v3.5",
            "Dungeon Master's Guide v3.5",
            "Monster Manual v3.5",
            "Complete series (Arcane, Divine, Warrior, Adventurer)",
            "Tome of Battle, Expanded Psionics Handbook"
          ],
          settings: [
            {
              name: "Forgotten Realms",
              tone: "Expansive Realmslore with region guides, epic NPCs, and high-magic threats calibrated for crunchy play.",
              source: {
                label: "Forgotten Realms Campaign Setting (3e)",
                url: "https://www.dmsguild.com/product/284252/Forgotten-Realms-Campaign-Setting-3e"
              }
            },
            {
              name: "Eberron",
              tone: "Pulp-noir magitech mixing dragonmarked house intrigue with lightning rail heists and pulp relic hunts.",
              source: {
                label: "Eberron Campaign Setting (3.5)",
                url: "https://www.dmsguild.com/product/288607/Eberron-Campaign-Setting-35"
              }
            },
            {
              name: "Living Greyhawk",
              tone: "Organized play sandbox where regional meta-plots let tables explore politics, wars, and heroic legacies.",
              source: {
                label: "Living Greyhawk Gazetteer",
                url: "https://www.dmsguild.com/product/221268/Living-Greyhawk-Gazetteer-3e"
              }
            }
          ],
          srds: [
            { label: "d20 SRD", url: "https://www.d20srd.org/" },
            { label: "3.5 Expanded SRD", url: "https://www.dandwiki.com/wiki/3.5e_SRD" }
          ]
        },
        {
          edition: "Pathfinder 1e (3.5 derivative)",
          tagline: "Paizo's revision with archetypes, favored class bonuses, and robust adventure paths.",
          released: "Core Rulebook 2009 · Unchained & consolidated errata 2015 · Final updates 2019",
          playstyle: [
            "Heroic fantasy with crunchy subsystems for downtime, kingdom building, and mythic tiers",
            "Archetypes and traits tailor classes to campaign tone without rewriting chassis",
            "Dense tactical encounters supported by extensive bestiaries and templates"
          ],
          adventureHooks: [
            "A Pathfinder lodge uncovers a corrupted artifact that twists favored class bonuses",
            "The kingdom's nascent colony needs heroes to chart hexes while fending off rival factions",
            "Mythic echoes awaken in ancient ruins, offering ascension to those who survive their trials"
          ],
          keySystems: [
            "Combat maneuvers (CMB/CMD)",
            "Archetypes to customize base classes",
            "Favored class bonuses and traits",
            "Mythic Adventures & kingdom building subsystems",
            "Extensive bestiary with template rules"
          ],
          expansions: [
            "Core Rulebook",
            "Advanced Player's Guide",
            "Ultimate Combat & Magic",
            "Mythic Adventures",
            "Ultimate Campaign (kingdom & downtime rules)"
          ],
          settings: [
            {
              name: "Inner Sea (Golarion)",
              tone: "Kitchen-sink fantasy where each nation delivers a distinct genre, deity pantheon, and adventure hook density.",
              source: {
                label: "Inner Sea World Guide",
                url: "https://paizo.com/products/btpy8v0z?Pathfinder-Campaign-Setting-The-Inner-Sea-World-Guide"
              }
            },
            {
              name: "Kingmaker",
              tone: "Hex-crawl sandbox that evolves into kingdom management with political dilemmas and wilderness threats.",
              source: {
                label: "Kingmaker Adventure Path",
                url: "https://paizo.com/products/btpy8j5w?Pathfinder-Adventure-Path-Kingmaker"
              }
            },
            {
              name: "Skull & Shackles",
              tone: "Swashbuckling pirate saga of ship battles, infamy, and freedom on the high seas of the Shackles.",
              source: {
                label: "Skull & Shackles Adventure Path",
                url: "https://paizo.com/pathfinder/adventurePath/skullAndShackles"
              }
            }
          ],
          srds: [
            { label: "Archives of Nethys", url: "https://aonprd.com/" }
          ]
        },
        {
          edition: "4th Edition",
          tagline: "Tactical, power-card driven combat with roles and structured encounters.",
          released: "Core launch 2008 · Essentials refresh 2010 · Digital tools sunset 2016",
          playstyle: [
            "Team-focused tactical battles with defined combat roles",
            "Encounter design around set-piece maps, hazards, and skill challenge pacing",
            "Resource management via healing surges and milestone rewards"
          ],
          adventureHooks: [
            "A living dungeon shifts each round, forcing heroes to leverage role synergies to escape",
            "The Raven Queen tasks the party with sealing planar rifts that destabilize the World Axis",
            "An elite warband tournament offers artifact boons to teams that master tactical objectives"
          ],
          keySystems: [
            "At-will/encounter/daily power cadence",
            "Role-based design (Defender, Striker, Leader, Controller)",
            "Healing surges and short-rest resource loops",
            "Skill challenges for narrative resolution",
            "Monster design math with level-based templates"
          ],
          expansions: [
            "Player's Handbooks I-III",
            "Martial, Arcane, Primal, Divine Power",
            "Essentials line (Heroes of the Fallen Lands/Feywild)",
            "Dungeon Master's Guide I-II",
            "Monster Manuals I-III"
          ],
          settings: [
            {
              name: "Nentir Vale",
              tone: "Points-of-Light frontier where Fallcrest, Winterhaven, and roving threats frame heroic-tier sandboxes.",
              source: {
                label: "Nentir Vale Primer",
                url: "https://www.dndbeyond.com/posts/1445-return-to-the-nentir-vale"
              }
            },
            {
              name: "Dark Sun (Athas)",
              tone: "Brutal swords-and-sand survival with psionics, defiling magic, and tyrannical sorcerer-kings.",
              source: {
                label: "Dark Sun Campaign Setting (4e)",
                url: "https://www.dmsguild.com/product/17532/Dark-Sun-Campaign-Setting-4e"
              }
            },
            {
              name: "Eberron",
              tone: "High-action pulp where dragonmarked houses, airships, and manifest zones get tuned for tactical encounters.",
              source: {
                label: "Eberron Campaign Guide (4e)",
                url: "https://www.dmsguild.com/product/17536/Eberron-Campaign-Guide-4e"
              }
            }
          ],
          srds: [
            { label: "4e Compendium (archived)", url: "https://web.archive.org/web/20160817123609/http://www.wizards.com/dndinsider/compendium/database.aspx" },
            { label: "4e Quick Rules Reference", url: "https://rpg.stackexchange.com/questions/12304/quick-reference-for-dnd-4e-rules" }
          ]
        },
        {
          edition: "AD&D 2nd Edition",
          tagline: "THAC0-based combat, proficiencies, and classic campaign settings like Planescape and Dark Sun.",
          released: "Original launch 1989 · Player's Option revisions 1995 · Support through late 1990s",
          playstyle: [
            "Classic dungeon crawls where THAC0 math rewards planning",
            "Character-driven campaigns powered by kits, proficiencies, and setting flavor",
            "High-magic planar adventures leveraging specialty priests and school rivalries"
          ],
          adventureHooks: [
            "A Planescape portal hub jams, scattering keys that must be recovered across the planes",
            "Dark Sun templars recruit off-world heroes to investigate a defiled oasis",
            "The Harpers request a covert mission to sway a city's morale before war erupts"
          ],
          keySystems: [
            "THAC0 progression and descending Armor Class",
            "Non-weapon proficiencies",
            "Spheres of priest magic",
            "Specialist wizards and school opposition",
            "Morale, reaction, and encounter tables"
          ],
          expansions: [
            "Player's Handbook",
            "Dungeon Master's Guide",
            "Monstrous Compendium/Manual",
            "Skills & Powers, Spells & Magic optional rules",
            "Campaign settings: Planescape, Dark Sun, Ravenloft"
          ],
          settings: [
            {
              name: "Planescape",
              tone: "Philosophical planar travel centered on Sigil, factions, and belief-driven conflicts across the multiverse.",
              source: {
                label: "Planescape Campaign Setting (2e)",
                url: "https://www.dmsguild.com/product/431552/Planescape-Campaign-Setting-2e"
              }
            },
            {
              name: "Dark Sun",
              tone: "Harsh desert survival on Athas featuring psionics, ecological collapse, and defiling sorcery.",
              source: {
                label: "Dark Sun Campaign Setting (2e)",
                url: "https://www.dmsguild.com/product/17091/Dark-Sun-Campaign-Setting-Expanded-and-Revised-2e"
              }
            },
            {
              name: "Ravenloft",
              tone: "Gothic horror domains ruled by Darklords where moral choices and fear checks drive the story.",
              source: {
                label: "Ravenloft Campaign Setting (2e)",
                url: "https://www.dmsguild.com/product/17043/Ravenloft-Campaign-Setting-2e"
              }
            }
          ],
          srds: [
            { label: "AD&D 2e Core Rules (archive)", url: "https://annarchive.com/files/Drmg244.pdf" },
            { label: "TSR Reference (mirror)", url: "https://www.dragonsfoot.org/forums/viewtopic.php?t=30584" }
          ]
        },
        {
          edition: "BECMI / Rules Cyclopedia",
          tagline: "Classic basic-to-immortal progression with race-as-class and domain play.",
          released: "BECMI boxed sets 1983-1986 · Rules Cyclopedia compilation 1991",
          playstyle: [
            "Heroic fantasy arcs that graduate characters from village protectors to domain rulers",
            "Streamlined dungeon exploration with race-as-class simplicity",
            "High-level play focused on war machine battles and immortality quests"
          ],
          adventureHooks: [
            "A dominion's war machine muster uncovers sabotage from a rival baron",
            "Mystaran Immortals beckon the heroes to stop a rogue artifact before it reshapes the Hollow World",
            "A caravan disappears along the merchant's road, leaving only strange weapon mastery glyphs behind"
          ],
          keySystems: [
            "Race-as-class progression",
            "Race-specific spell lists",
            "War machine mass combat",
            "Domain management at Name level",
            "Weapon mastery tiers"
          ],
          expansions: [
            "Basic/Expert/Companion/Master/Immortal boxed sets",
            "Rules Cyclopedia",
            "Gazetteer series for Mystara",
            "Wrath of the Immortals",
            "Creature Catalogue"
          ],
          settings: [
            {
              name: "Mystara (Known World)",
              tone: "Classic exploration with nation-focused Gazetteers, pulpy politics, and quirky Immortal meddling.",
              source: {
                label: "Mystara Gazetteer Compilation",
                url: "https://www.dmsguild.com/product/229802/Mystara-Gazetteer-Compilation"
              }
            },
            {
              name: "Hollow World",
              tone: "Lost-world pulp adventures beneath the planet's crust featuring preserved cultures and dinosaur-filled wilds.",
              source: {
                label: "Hollow World Campaign Setting",
                url: "https://www.dmsguild.com/product/17152/Hollow-World-Campaign-Setting-Basic"
              }
            },
            {
              name: "Savage Coast",
              tone: "Swashbuckling frontier of red steel, cursed regions, and colonial intrigue along Mystara's western shores.",
              source: {
                label: "Savage Coast Campaign Book",
                url: "https://www.dmsguild.com/product/17150/Savage-Coast-Campaign-Book"
              }
            }
          ],
          srds: [
            { label: "Rules Cyclopedia Index", url: "https://www.dragonsfoot.org/forums/viewtopic.php?t=36241" }
          ]
        }
      ];

      const ITEMS = [
        {
          name: "Vorpal Sword",
          type: "Weapon",
          rarity: "Legendary",
          edition: "1e+",
          description: "On a critical hit, the sword severs the target's head if it has one and is susceptible to critical hits.",
          source: "DMG (multiple editions)",
          attunement: "Requires attunement by a creature proficient with martial weapons in modern rules; early printings assume any competent wielder.",
          attunementTag: "conditional",
          cost: "Priceless; treated as artifact-tier treasure rather than a market commodity.",
          notes: "Decapitation triggers on natural 20s in later editions; 1e uses a broader critical range against some foes.",
          editionSpecific: true
        },
        {
          name: "Bag of Holding",
          type: "Wondrous Item",
          rarity: "Uncommon",
          edition: "OD&D+",
          description: "Extra-dimensional storage holding up to 500 lb while weighing a fraction of the contents.",
          source: "SRD 5.1, DMG",
          attunement: "No attunement needed; anyone can reach inside to retrieve gear with an action.",
          attunementTag: "none",
          cost: "Typically 2,500–5,000 gp depending on edition and setting economy.",
          notes: "Overfilling or puncturing risks planar rupture; mixing with portable holes can tear a gate to the Astral Plane.",
          editionSpecific: true
        },
        {
          name: "Deck of Many Things",
          type: "Wondrous Item",
          rarity: "Legendary",
          edition: "1e+",
          description: "Draw from the deck to gain boons or banes ranging from treasure and XP to imprisonment.",
          source: "DMG",
          attunement: "No attunement; cards are activated by declaring and drawing.",
          attunementTag: "none",
          cost: "Never sold—its chaos value makes it a plot device instead of trade goods.",
          notes: "Deck size varies by edition: 13-card truncated versions exist alongside the full 22-card spread.",
          editionSpecific: true
        },
        {
          name: "Sun Blade",
          type: "Weapon",
          rarity: "Rare",
          edition: "1e+",
          description: "Versatile finesse longsword emitting radiant damage and bright sunlight on command.",
          source: "SRD 5.1",
          attunement: "Requires attunement by a creature proficient with martial weapons, harmonizing with the blade's solar core.",
          attunementTag: "required",
          cost: "Valued around 15,000 gp in 3.5e pricing; most tables treat it as relic-tier loot.",
          notes: "Functions as a shortsword for finesse users; older editions call it a bastard sword with variable damage dice.",
          editionSpecific: true
        },
        {
          name: "Winged Boots",
          type: "Wondrous Item",
          rarity: "Uncommon",
          edition: "1e+",
          description: "Grants a flying speed equal to your walking speed for limited durations per day.",
          source: "SRD 5.1",
          attunement: "Requires attunement; the wearer channels magic with each step to gain flight.",
          attunementTag: "required",
          cost: "Usually 4,000–5,000 gp where magic gear is traded.",
          notes: "Flight duration refreshes after short rests in 5e; earlier editions use a pooled hour total per day.",
          editionSpecific: true
        },
        {
          name: "Portable Hole",
          type: "Wondrous Item",
          rarity: "Rare",
          edition: "1e+",
          description: "Creates an extradimensional space 10 ft deep that can be folded and carried.",
          source: "SRD 5.1",
          attunement: "No attunement; the hole responds to any creature unfolding it against a surface.",
          attunementTag: "none",
          cost: "Commonly listed around 20,000 gp in pre-5e sources.",
          notes: "Contact with a bag of holding or similar space tears a 1d10 round rift to the Astral Plane in most editions.",
          editionSpecific: true
        },
        {
          name: "Immovable Rod",
          type: "Wondrous Item",
          rarity: "Uncommon",
          edition: "1e+",
          description: "Pressing a button causes the rod to defy gravity and remain fixed in space until released.",
          source: "SRD 5.1",
          attunement: "No attunement needed; activation is purely mechanical.",
          attunementTag: "none",
          cost: "Typically 5,000 gp but varies with availability.",
          notes: "Supports up to 8,000 lb in 5e; AD&D references 10,000 gp weight limits before bending.",
          editionSpecific: true
        },
        {
          name: "Plate Armor",
          type: "Armor",
          rarity: "Standard",
          edition: "All",
          description: "Heavy armor granting high AC with disadvantage on Stealth checks and a Strength requirement in newer editions.",
          source: "PHB",
          attunement: "No attunement; mundane craftsmanship suits any trained wearer.",
          attunementTag: "none",
          cost: "1,500 gp baseline in 5e; Basic/AD&D pricing ranges from 50–400 gp depending on the ruleset.",
          notes: "5e adds STR 15 requirement and disadvantage on Stealth; older editions adjust movement rate instead.",
          editionSpecific: true
        },
        {
          name: "Elven Chain",
          type: "Armor",
          rarity: "Rare",
          edition: "1e+",
          description: "Lightweight chainmail granting advantage on Dexterity checks to avoid stealth penalties.",
          source: "DMG",
          attunement: "Requires attunement by a creature proficient with light armor in 5e; AD&D versions can be worn without attuning.",
          attunementTag: "conditional",
          cost: "Priced around 16,000 gp in 3.5e references; often gifted instead of purchased.",
          notes: "Counts as medium armor in some editions but allows proficiency-free wear for elves in AD&D.",
          editionSpecific: true
        },
        {
          name: "Staff of Power",
          type: "Staff",
          rarity: "Very Rare",
          edition: "1e+",
          description: "Versatile arcane focus with charges for spells, a retributive strike, and AC/attack bonuses.",
          source: "DMG",
          attunement: "Requires attunement by a sorcerer, warlock, or wizard (or similar arcane caster in older systems).",
          attunementTag: "required",
          cost: "Valued at 235,000 gp in 3.5e; otherwise treated as relic-level treasure.",
          notes: "Retributive strike detonates remaining charges; AD&D calls for percentile survival checks on the wielder.",
          editionSpecific: true
        },
        {
          name: "Manual of Quickness of Action",
          type: "Wondrous Item",
          rarity: "Very Rare",
          edition: "1e+",
          description: "Study increases Dexterity permanently once and then loses magic.",
          source: "DMG",
          attunement: "Requires attunement during the 48-hour study period to absorb its magic.",
          attunementTag: "required",
          cost: "About 55,000 gp in 3.5e guidelines; unique lore tomes may command higher bids.",
          notes: "Ability score increase occurs over six days of dedicated study; earlier editions boost Dexterity by a flat amount.",
          editionSpecific: true
        },
        {
          name: "Alchemy Jug",
          type: "Wondrous Item",
          rarity: "Uncommon",
          edition: "5e",
          description: "Produces various liquids each day like mayonnaise, acid, or oil as chosen.",
          source: "SRD 5.1",
          attunement: "No attunement; command words pour the desired fluid.",
          attunementTag: "none",
          cost: "Estimated 2,000 gp in Xanathar-style pricing charts.",
          notes: "Daily allotments reset at dawn; the volume of each liquid is fixed to the SRD table.",
          editionSpecific: false
        },
        {
          name: "Keoghtom's Ointment",
          type: "Wondrous Item",
          rarity: "Uncommon",
          edition: "1e+",
          description: "Salve that heals hit points, cures poison, and disease when applied.",
          source: "DMG",
          attunement: "No attunement; sealed vials activate when unstoppered.",
          attunementTag: "none",
          cost: "Typically sold in lots of 5 doses for 500 gp.",
          notes: "Each dose heals 2d8+2 in 5e; AD&D heals 1d8+2 and neutralizes poison on contact.",
          editionSpecific: true
        },
        {
          name: "Bracers of Defense",
          type: "Wondrous Item",
          rarity: "Rare",
          edition: "1e+",
          description: "Grants AC bonus when not wearing armor or using a shield.",
          source: "SRD 5.1",
          attunement: "Requires attunement; the bands sync to the wearer's aura for a protective field.",
          attunementTag: "required",
          cost: "Around 25,000 gp in AD&D; 5e treatises suggest 6,000 gp when sold.",
          notes: "Ideal for monks and sorcerers; earlier editions set AC bonuses by bracer type (AC 6 through AC 2).",
          editionSpecific: true
        },
        {
          name: "Cloak of Displacement",
          type: "Wondrous Item",
          rarity: "Rare",
          edition: "1e+",
          description: "Projects an illusion causing attackers to have disadvantage until you are hit.",
          source: "DMG",
          attunement: "Requires attunement; the cloak bends light for the wearer after synchronization.",
          attunementTag: "required",
          cost: "Often listed near 50,000 gp in AD&D value charts.",
          notes: "Effect ends until next turn after you take damage in 5e; 3.5 grants a constant 20% miss chance.",
          editionSpecific: true
        }
      ];

      const MONSTERS = [
        {
          name: "Adult Black Dragon",
          size: "Huge",
          creatureType: "Dragon",
          alignment: "Chaotic evil",
          challenge: "14",
          terrain: ["Swamp", "Coastal"],
          role: ["Solo", "Controller"],
          overview: "A patient tyrant that lurks in fetid marshes, reshaping the landscape with acid and dominating local tribes as expendable scouts.",
          signatureAbilities: [
            "Acid Breath (Recharge 5–6): Unleashes a corrosive line that eats through ranks and cover alike, forcing Dexterity saves for half damage.",
            "Amphibious Ambusher: A swim speed and superior darkvision let the dragon strike from underwater tunnels or night skies without warning.",
            "Legendary Actions: Wing beats, tail lashes, and perception sweeps keep the dragon airborne and responsive between turns."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Monstrous Manual (AD&D 2e)", url: "https://www.dmsguild.com/product/17171/Monstrous-Compendium--Volume-One-and-Two" }
          ]
        },
        {
          name: "Behir",
          size: "Huge",
          creatureType: "Monstrosity",
          alignment: "Neutral evil",
          challenge: "11",
          terrain: ["Mountain", "Underdark"],
          role: ["Skirmisher", "Striker"],
          overview: "Serpentine predators that coil around storm-lashed peaks or deep caverns, hunting with sudden pounces and lightning blasts.",
          signatureAbilities: [
            "Multiattack & Swallow: Claws and bites restrain prey so the behir can swallow and keep fighting with a belly full of heroes.",
            "Lightning Breath (Recharge 5–6): A focused blast that punishes tightly packed parties climbing a ridge or tunnel.",
            "Spider Climb: Its innate climbing lets it ambush from ceilings, cliffs, or stalagmites far from melee reprisal."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Monster Manual (1e)", url: "https://www.dmsguild.com/product/17004/Monster-Manual-1e" }
          ]
        },
        {
          name: "Frost Giant",
          size: "Huge",
          creatureType: "Giant",
          alignment: "Neutral evil",
          challenge: "8",
          terrain: ["Arctic", "Mountain"],
          role: ["Brute", "Soldier"],
          overview: "Raid leaders from the frozen north who wield great axes like siege engines and command loyal winter wolves.",
          signatureAbilities: [
            "Greataxe Strikes: High damage per swing makes the giant a threat to any front-liner without strong defenses.",
            "Rock Hurling: Giants keep pressure on distant foes or fortifications with improvised boulders.",
            "Frigid Resilience: Cold immunity and hardy saves let them ignore many Arctic hazards the party relies on."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Against the Giants (1e)", url: "https://www.dmsguild.com/product/17035/G1-3-Against-the-Giants-1e" }
          ]
        },
        {
          name: "Gelatinous Cube",
          size: "Large",
          creatureType: "Ooze",
          alignment: "Unaligned",
          challenge: "2",
          terrain: ["Dungeon", "Underdark"],
          role: ["Controller", "Hazard"],
          overview: "Transparent dungeon sweepers that dissolve gear and creatures alike while sliding silently through corridors.",
          signatureAbilities: [
            "Engulf: Creatures sharing its space are paralyzed and dissolved, making tight halls terrifying chokepoints.",
            "Transparent Form: Without careful perception checks the cube remains unseen until it strikes.",
            "Pseudopod Reach: Extends to capture stragglers or retrieve suspended treasure from within."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "d20 SRD", url: "https://www.d20srd.org/srd/monsters/gelatinousCube.htm" }
          ]
        },
        {
          name: "Goblin Boss",
          size: "Small",
          creatureType: "Humanoid",
          alignment: "Neutral evil",
          challenge: "1",
          terrain: ["Forest", "Cavern", "Urban"],
          role: ["Leader", "Skirmisher"],
          overview: "Cunning commanders who weaponize mobility and minions to harry caravans before slipping back into the dark.",
          signatureAbilities: [
            "Redirect Attack: Uses nearby goblins as unwilling shields to blunt incoming blows.",
            "Multiattack: Combines scimitar and dagger strikes for swingy burst damage on isolated targets.",
            "Nimble Escape: Bonus-action Disengage or Hide keeps the boss alive long enough to rally reinforcements."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "Basic Rules", url: "https://dnd.wizards.com/resources/basic-rules" }
          ]
        },
        {
          name: "Treant",
          size: "Huge",
          creatureType: "Plant",
          alignment: "Chaotic good",
          challenge: "9",
          terrain: ["Forest"],
          role: ["Defender", "Support"],
          overview: "Ancient guardians of woodland realms who animate allies and reshape the battlefield with living roots.",
          signatureAbilities: [
            "Animate Trees: Calls nearby trees into battle, turning a clearing into a crowd of allied bludgeons.",
            "Slam Attacks: Heavy melee swings crush siege gear and punish fire-bearing intruders.",
            "Siege Monster: Deals double damage to structures, making treants ideal for defending or toppling fortifications."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "d20 SRD", url: "https://www.d20srd.org/srd/monsters/treant.htm" }
          ]
        },
        {
          name: "Lich",
          size: "Medium",
          creatureType: "Undead",
          alignment: "Any evil",
          challenge: "21",
          terrain: ["Dungeon", "Urban", "Shadowfell"],
          role: ["Solo", "Artillery"],
          overview: "Immortal spellcasters who trade mortality for arcane supremacy, defending phylacteries with layered wards and minions.",
          signatureAbilities: [
            "Paralyzing Touch: A chilling melee strike that locks down foes for follow-up spells.",
            "Legendary Resistance & Actions: Ensures the lich maintains control of the battlefield despite control effects.",
            "Spellcasting Arsenal: Access to high-level necromancy and control magic lets the lich script entire encounters."
          ],
          sources: [
            { label: "SRD 5.1", url: "https://media.wizards.com/2016/downloads/DND/SRD-OGL_V5.1.pdf" },
            { label: "d20 SRD", url: "https://www.d20srd.org/srd/monsters/lich.htm" }
          ]
        }
      ];

      const rarityOptions = [
        "Common",
        "Uncommon",
        "Rare",
        "Very Rare",
        "Legendary",
        "Artifact",
        "Standard"
      ];

      const navButtons = document.querySelectorAll("nav button");
      const sections = document.querySelectorAll("main section");
      navButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          navButtons.forEach(b => b.classList.remove("active"));
          sections.forEach(sec => sec.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(btn.dataset.target).classList.add("active");
        });
      });

      const monsterQuery = document.getElementById("monster-query");
      const monsterCRSelect = document.getElementById("monster-cr-filter");
      const monsterTerrainSelect = document.getElementById("monster-terrain-filter");
      const monsterRoleSelect = document.getElementById("monster-role-filter");
      const bestiaryList = document.getElementById("bestiary-list");

      const parseCR = (cr) => {
        if (typeof cr === "number") return cr;
        if (typeof cr === "string" && cr.includes("/")) {
          const [num, denom] = cr.split("/").map(Number);
          if (!Number.isNaN(num) && !Number.isNaN(denom) && denom !== 0) {
            return num / denom;
          }
        }
        return Number(cr);
      };

      const uniqueCRs = Array.from(new Set(MONSTERS.map(monster => monster.challenge)))
        .sort((a, b) => parseCR(a) - parseCR(b));
      uniqueCRs.forEach(cr => {
        const option = document.createElement("option");
        option.value = cr;
        option.textContent = `CR ${cr}`;
        monsterCRSelect.appendChild(option);
      });

      const uniqueTerrains = Array.from(new Set(MONSTERS.flatMap(monster => monster.terrain))).sort();
      uniqueTerrains.forEach(terrain => {
        const option = document.createElement("option");
        option.value = terrain;
        option.textContent = terrain;
        monsterTerrainSelect.appendChild(option);
      });

      const uniqueRoles = Array.from(new Set(MONSTERS.flatMap(monster => monster.role))).sort();
      uniqueRoles.forEach(role => {
        const option = document.createElement("option");
        option.value = role;
        option.textContent = role;
        monsterRoleSelect.appendChild(option);
      });

      const renderMonsters = () => {
        const query = monsterQuery.value.toLowerCase().trim();
        const crFilter = monsterCRSelect.value;
        const terrainFilter = monsterTerrainSelect.value;
        const roleFilter = monsterRoleSelect.value;

        bestiaryList.innerHTML = "";

        const results = MONSTERS.filter(monster => {
          const searchableFields = [
            monster.name,
            monster.overview,
            monster.creatureType,
            monster.alignment,
            monster.size,
            monster.signatureAbilities.join(" "),
            monster.terrain.join(" "),
            monster.role.join(" ")
          ]
            .filter(Boolean)
            .map(field => field.toLowerCase());

          const matchesQuery = !query || searchableFields.some(field => field.includes(query));
          const matchesCR = crFilter === "all" || monster.challenge === crFilter;
          const matchesTerrain = terrainFilter === "all" || monster.terrain.includes(terrainFilter);
          const matchesRole = roleFilter === "all" || monster.role.includes(roleFilter);
          return matchesQuery && matchesCR && matchesTerrain && matchesRole;
        });

        if (!results.length) {
          const empty = document.createElement("p");
          empty.textContent = "No monsters match those filters. Try broadening your search or removing a filter.";
          empty.style.opacity = "0.75";
          bestiaryList.appendChild(empty);
          return;
        }

        results.forEach(monster => {
          const card = document.createElement("article");
          card.className = "monster-card";
          const abilityList = monster.signatureAbilities
            .map(ability => `<li>${ability}</li>`)
            .join("");
          const sourceLinks = monster.sources
            .map(source => `<a href="${source.url}" target="_blank" rel="noopener">${source.label}</a>`)
            .join(", ");

          card.innerHTML = `
            <h4>
              ${monster.name}
              <span class="pill">CR ${monster.challenge}</span>
            </h4>
            <div class="monster-meta">
              <span><strong>Size:</strong> ${monster.size}</span>
              <span><strong>Type:</strong> ${monster.creatureType}</span>
              <span><strong>Alignment:</strong> ${monster.alignment}</span>
              <span><strong>Role:</strong> ${monster.role.join(", ")}</span>
              <span><strong>Terrain:</strong> ${monster.terrain.join(", ")}</span>
            </div>
            <p>${monster.overview}</p>
            ${monster.signatureAbilities.length ? `<p><strong>Signature abilities & tactics</strong></p>` : ""}
            ${monster.signatureAbilities.length ? `<ul class="monster-abilities">${abilityList}</ul>` : ""}
            <p style="font-size: 0.85rem; opacity: 0.7;"><strong>Sources:</strong> ${sourceLinks}</p>
          `;

          bestiaryList.appendChild(card);
        });
      };

      monsterQuery.addEventListener("input", renderMonsters);
      monsterCRSelect.addEventListener("change", renderMonsters);
      monsterTerrainSelect.addEventListener("change", renderMonsters);
      monsterRoleSelect.addEventListener("change", renderMonsters);
      renderMonsters();

      const comparisonContainer = document.getElementById("comparison-matrix");
      if (comparisonContainer) {
        const table = document.createElement("table");
        table.className = "comparison-table";

        const headerRow = document.createElement("tr");
        const blank = document.createElement("th");
        blank.scope = "col";
        headerRow.appendChild(blank);
        RULES_DATA.forEach(rule => {
          const th = document.createElement("th");
          th.scope = "col";
          th.textContent = rule.edition;
          headerRow.appendChild(th);
        });

        const thead = document.createElement("thead");
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        const categories = [
          { key: "tagline", label: "Design Thesis" },
          { key: "released", label: "Release Window" },
          { key: "keySystems", label: "Signature Systems", className: "key-systems" },
          { key: "playstyle", label: "Table Feel & Playstyle" },
          { key: "expansions", label: "Essential Expansions" },
          { key: "adventureHooks", label: "Adventure Hooks" },
          { key: "srds", label: "Primary References" }
        ];

        const renderList = (items, mapper = (item) => item) => {
          const ul = document.createElement("ul");
          items.forEach(item => {
            const li = document.createElement("li");
            li.innerHTML = mapper(item);
            ul.appendChild(li);
          });
          return ul;
        };

        categories.forEach(({ key, label, className }) => {
          const row = document.createElement("tr");
          const heading = document.createElement("th");
          heading.scope = "row";
          heading.textContent = label;
          row.appendChild(heading);

          RULES_DATA.forEach(rule => {
            const td = document.createElement("td");
            const value = rule[key];

            if (Array.isArray(value) && value.length) {
              const content = renderList(
                value,
                key === "srds"
                  ? (item) => `<a href="${item.url}" target="_blank" rel="noopener">${item.label}</a>`
                  : (item) => item
              );
              if (className) {
                const wrapper = document.createElement("div");
                wrapper.className = className;
                wrapper.appendChild(content);
                td.appendChild(wrapper);
              } else {
                td.appendChild(content);
              }
            } else if (typeof value === "string" && value.trim()) {
              const paragraph = document.createElement("p");
              paragraph.textContent = value;
              td.appendChild(paragraph);
            } else if (value?.label && value?.url) {
              td.innerHTML = `<a href="${value.url}" target="_blank" rel="noopener">${value.label}</a>`;
            } else {
              const placeholder = document.createElement("span");
              placeholder.style.opacity = "0.65";
              placeholder.textContent = "—";
              td.appendChild(placeholder);
            }

            row.appendChild(td);
          });

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        comparisonContainer.appendChild(table);
      }

      // Populate rules compendium
      const rulesGrid = document.getElementById("rules-grid");
      RULES_DATA.forEach(rule => {
        const details = document.createElement("details");
        const summary = document.createElement("summary");
        summary.innerHTML = `<span>${rule.edition}</span>`;
        details.appendChild(summary);

        const tagline = document.createElement("p");
        tagline.textContent = rule.tagline;
        tagline.style.marginTop = "0.5rem";
        tagline.style.opacity = "0.85";
        details.appendChild(tagline);

        if (rule.released) {
          const meta = document.createElement("div");
          meta.className = "rules-meta";
          const release = document.createElement("span");
          release.innerHTML = `<strong>Released</strong> ${rule.released}`;
          meta.appendChild(release);
          details.appendChild(meta);
        }

        const systems = document.createElement("div");
        systems.className = "rules-section";
        systems.innerHTML = `<strong>Signature systems</strong>`;
        const ul = document.createElement("ul");
        rule.keySystems.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          ul.appendChild(li);
        });
        systems.appendChild(ul);
        details.appendChild(systems);

        if (rule.playstyle?.length) {
          const playstyle = document.createElement("div");
          playstyle.className = "rules-section";
          playstyle.innerHTML = `<strong>Table feel & playstyle</strong>`;
          const playList = document.createElement("ul");
          rule.playstyle.forEach(item => {
            const li = document.createElement("li");
            li.textContent = item;
            playList.appendChild(li);
          });
          playstyle.appendChild(playList);
          details.appendChild(playstyle);
        }

        const expansions = document.createElement("div");
        expansions.className = "rules-section expansion-list";
        expansions.innerHTML = `<strong>Key rulebooks & expansions</strong>`;
        const ulExp = document.createElement("ul");
        rule.expansions.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          ulExp.appendChild(li);
        });
        expansions.appendChild(ulExp);
        details.appendChild(expansions);

        if (rule.settings?.length) {
          const settingsSection = document.createElement("div");
          settingsSection.className = "rules-section";
          settingsSection.innerHTML = `<strong>Iconic Campaign Settings</strong>`;
          const settingsList = document.createElement("ul");

          rule.settings.forEach(setting => {
            const li = document.createElement("li");
            const name = document.createElement("strong");
            name.textContent = setting.name;
            li.appendChild(name);

            if (setting.tone) {
              li.appendChild(document.createTextNode(` — ${setting.tone}`));
            }

            const linkRow = document.createElement("div");
            linkRow.className = "setting-links";

            if (setting.source?.url) {
              const sourceLink = document.createElement("a");
              sourceLink.href = setting.source.url;
              sourceLink.target = "_blank";
              sourceLink.rel = "noopener";
              sourceLink.textContent = setting.source.label || "Sourcebook";
              linkRow.appendChild(sourceLink);
            }

            const askLink = document.createElement("a");
            askLink.href = "#ask";
            askLink.className = "setting-prompt";
            askLink.dataset.prompt = setting.prompt
              || `What signature lore should I highlight when running a ${setting.name} campaign for ${rule.edition}?`;
            askLink.textContent = `Ask the DM about ${setting.name}`;

            if (linkRow.childNodes.length) {
              const divider = document.createElement("span");
              divider.textContent = "·";
              linkRow.appendChild(divider);
            }

            linkRow.appendChild(askLink);
            li.appendChild(linkRow);

            settingsList.appendChild(li);
          });

          settingsSection.appendChild(settingsList);
          details.appendChild(settingsSection);
        }

        if (rule.adventureHooks?.length) {
          const hooks = document.createElement("div");
          hooks.className = "rules-section";
          hooks.innerHTML = `<strong>Adventure hook prompts</strong>`;
          const hookList = document.createElement("ul");
          rule.adventureHooks.forEach(item => {
            const li = document.createElement("li");
            li.textContent = item;
            hookList.appendChild(li);
          });
          hooks.appendChild(hookList);
          details.appendChild(hooks);
        }

        const links = document.createElement("div");
        links.className = "rules-section";
        links.innerHTML = `<strong>Primary references & SRDs</strong>`;
        const linkList = document.createElement("ul");
        rule.srds.forEach(srd => {
          const li = document.createElement("li");
          li.innerHTML = `<a href="${srd.url}" target="_blank" rel="noopener">${srd.label}</a>`;
          linkList.appendChild(li);
        });
        links.appendChild(linkList);
        details.appendChild(links);

        rulesGrid.appendChild(details);
      });

      // Populate item filters
      const raritySelect = document.getElementById("item-filter");
      const attunementSelect = document.getElementById("attunement-filter");
      const typeSelect = document.getElementById("item-type-filter");
      const editionSelect = document.getElementById("edition-filter");
      rarityOptions.forEach(rarity => {
        const option = document.createElement("option");
        option.value = rarity;
        option.textContent = rarity;
        raritySelect.appendChild(option);
      });

      const uniqueTypes = Array.from(new Set(ITEMS.map(item => item.type))).sort();
      uniqueTypes.forEach(type => {
        const option = document.createElement("option");
        option.value = type;
        option.textContent = type;
        typeSelect.appendChild(option);
      });

      const uniqueEditions = Array.from(new Set(ITEMS.map(item => item.edition)));
      uniqueEditions.forEach(edition => {
        const option = document.createElement("option");
        option.value = edition;
        option.textContent = edition;
        editionSelect.appendChild(option);
      });

      const itemsList = document.getElementById("items-list");
      const itemQuery = document.getElementById("item-query");

      const renderItems = () => {
        const query = itemQuery.value.toLowerCase().trim();
        const rarity = raritySelect.value;
        const attunement = attunementSelect.value;
        const type = typeSelect.value;
        const edition = editionSelect.value;
        itemsList.innerHTML = "";
        const results = ITEMS.filter(item => {
          const matchesQuery =
            !query ||
            [item.name, item.description, item.source, item.type, item.edition, item.attunement, item.notes, item.cost]
              .filter(Boolean)
              .some(field => field.toLowerCase().includes(query));
          const matchesRarity = rarity === "all" || item.rarity === rarity;
          const matchesAttunement = attunement === "all" || item.attunementTag === attunement;
          const matchesType = type === "all" || item.type === type;
          const matchesEdition = edition === "all" || item.edition === edition;
          return matchesQuery && matchesRarity && matchesAttunement && matchesType && matchesEdition;
        });

        if (!results.length) {
          const empty = document.createElement("p");
          empty.textContent = "No items match your filters yet. Try a different search term.";
          empty.style.opacity = "0.75";
          itemsList.appendChild(empty);
          return;
        }

        results.forEach(item => {
          const card = document.createElement("article");
          card.className = "item-card";
          const badgePieces = [`<span class="pill">${item.rarity}</span>`];
          if (item.attunementTag === "required") {
            badgePieces.push('<span class="pill attunement">Requires attunement</span>');
          } else if (item.attunementTag === "conditional") {
            badgePieces.push('<span class="pill attunement">Conditional attunement</span>');
          }
          if (item.editionSpecific) {
            badgePieces.push('<span class="pill edition-flag">Edition variants</span>');
          }

          card.innerHTML = `
            <h4>${item.name}</h4>
            <div class="item-meta">
              <span><strong>Type:</strong> ${item.type}</span>
              <span><strong>Edition:</strong> ${item.edition}</span>
              ${badgePieces.join(" ")}
            </div>
            <p>${item.description}</p>
            <p><strong>Attunement:</strong> ${item.attunement}</p>
            <p><strong>Cost:</strong> ${item.cost}</p>
            <p><strong>Notes:</strong> ${item.notes}</p>
            <p style="font-size: 0.85rem; opacity: 0.7;"><strong>Source:</strong> ${item.source}</p>
          `;
          itemsList.appendChild(card);
        });
      };

      itemQuery.addEventListener("input", renderItems);
      raritySelect.addEventListener("change", renderItems);
      attunementSelect.addEventListener("change", renderItems);
      typeSelect.addEventListener("change", renderItems);
      editionSelect.addEventListener("change", renderItems);
      renderItems();

      // WebLLM setup
      const logEl = document.getElementById("chat-log");
      const promptEl = document.getElementById("prompt");
      const sendBtn = document.getElementById("send");
      const statusEl = document.getElementById("status");

      const messages = [
        {
          role: "system",
          content: `You are an expert Dungeon Master and rules archivist for every edition of Dungeons & Dragons.
Provide concise, citation-style answers drawing on SRDs, rulebooks, and designer commentary.
If content might differ between editions, call out each edition explicitly.
Always encourage players to consult the cited books for full rules text.
Avoid reproducing copyrighted text verbatim; summarize mechanics instead.
Stay family friendly and inclusive.`
        }
      ];

      const appendMessage = (role, content) => {
        const bubble = document.createElement("div");
        bubble.className = `bubble ${role}`;
        bubble.textContent = content;
        logEl.appendChild(bubble);
        logEl.scrollTop = logEl.scrollHeight;
      };

      appendMessage("assistant", "Welcome, adventurer! I'm your digital Dungeon Master. Ask me about any rule, edition, or item and I'll guide you to the right table, chapter, or adjudication.");

      const updateStatus = (text, state = "") => {
        statusEl.classList.remove("ready", "generating");
        if (state) statusEl.classList.add(state);
        statusEl.querySelector("strong").textContent = text;
      };

      updateStatus("Initializing engine…");

      const webllm = await import("https://esm.run/@mlc-ai/web-llm");
      const models = webllm.prebuiltAppConfig.model_list;
      const selectedModel =
        models.find(m => /Gemma-2.*2B.*it/i.test(m.model_id))?.model_id
        ?? models.find(m => /Phi-3\.5.*mini.*it/i.test(m.model_id))?.model_id
        ?? models[0].model_id;

      let engine;
      try {
        engine = await webllm.CreateMLCEngine(selectedModel, {
          initProgressCallback: (p) => updateStatus(`${Math.floor(p.progress * 100)}% · ${p.text || p.stage}`)
        });
        updateStatus("Ready to answer questions", "ready");
        sendBtn.disabled = false;
      } catch (err) {
        console.error(err);
        updateStatus("Failed to load WebLLM. Refresh and ensure WebGPU is enabled.");
        return;
      }

      async function streamReply(messages, opts = {}) {
        const chunks = await engine.chat.completions.create({
          messages,
          temperature: 0.5,
          max_tokens: 400,
          stream: true,
          stream_options: { include_usage: true },
          ...opts
        });
        let out = "";
        for await (const c of chunks) {
          const delta = c.choices?.[0]?.delta?.content || "";
          out += delta;
          if (delta) {
            if (!logEl.lastChild || !logEl.lastChild.classList.contains("assistant")) {
              const bubble = document.createElement("div");
              bubble.className = "bubble assistant";
              bubble.textContent = delta;
              logEl.appendChild(bubble);
            } else {
              logEl.lastChild.textContent += delta;
            }
            logEl.scrollTop = logEl.scrollHeight;
          }
          updateStatus("Generating response…", "generating");
        }
        return out.trim();
      }

      const sendPrompt = async () => {
        const text = promptEl.value.trim();
        if (!text) return;
        promptEl.value = "";
        appendMessage("user", text);
        messages.push({ role: "user", content: text });
        sendBtn.disabled = true;
        try {
          const reply = await streamReply(messages);
          messages.push({ role: "assistant", content: reply });
          updateStatus("Ready", "ready");
        } catch (error) {
          console.error(error);
          appendMessage("assistant", "I ran into an error generating that response. Please try again.");
          updateStatus("Encountered an error");
        } finally {
          sendBtn.disabled = false;
        }
      };

      sendBtn.addEventListener("click", sendPrompt);
      promptEl.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && !ev.shiftKey) {
          ev.preventDefault();
          sendPrompt();
        }
      });

        const openAskTab = () => {
          const askButton = document.querySelector('nav button[data-target="ask"]');
          if (askButton && !askButton.classList.contains("active")) {
            askButton.click();
          }
        };

        const wirePromptPrefill = (elements) => {
          elements.forEach(el => {
            el.addEventListener("click", (event) => {
              const prompt = el.dataset.prompt?.trim();
              if (!prompt) return;
              if (el.tagName === "A") {
                event.preventDefault();
              }
              openAskTab();
              promptEl.value = prompt;
              promptEl.focus();
              document.getElementById("ask")?.scrollIntoView({ behavior: "smooth", block: "start" });
            });
          });
        };

        wirePromptPrefill(document.querySelectorAll(".quick-prompts button"));
        wirePromptPrefill(document.querySelectorAll(".setting-prompt"));
    </script>
  </body>
</html>
