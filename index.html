<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>Hero Dossier</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&amp;display=swap" rel="stylesheet"/>
<style>
:root{--bg:#0f1115;--panel:#171a21;--text:#e6e9ef;--sub:#a9b0bb;--accent:#3cc6ff;--hover:#24a9e0;--shadow:0 10px 30px rgba(0,0,0,.35)}
*{box-sizing:border-box}
html{height:100%;-webkit-text-size-adjust:100%}
body{margin:0;height:100%;overflow-x:hidden;background:var(--bg);color:var(--text);font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif;line-height:1.45;-webkit-font-smoothing:antialiased;-webkit-overflow-scrolling:touch}
header{position:sticky;top:0;z-index:20;background:var(--panel);padding:calc(14px + env(safe-area-inset-top)) 16px 10px;box-shadow:var(--shadow)}
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{margin:0;font-size:1.25rem;color:var(--accent);font-weight:700}
.actions{display:flex;gap:8px}
.icon-btn{width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--accent);background:#0b0d12;border-radius:10px;color:var(--accent)}
.icon-btn:active{transform:translateY(1px)}
.icon-tiny{width:32px;height:32px;border-radius:8px}
.tabs{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
.tab{flex:1 0 120px;text-align:center;border:1px solid var(--accent);background:#0b0d12;color:var(--text);border-radius:10px;padding:10px 12px;font-weight:700}
.tab.active{background:var(--accent);color:#041019}
main{max-width:980px;width:min(100%,980px);margin:16px auto;padding:0 12px calc(16px + env(safe-area-inset-bottom))}
section{background:var(--panel);border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:var(--shadow)}
section h2{margin:0 0 10px;font-size:1.05rem;color:var(--accent)}
.grid{display:grid;gap:12px}
.grid-1{grid-template-columns:1fr}
.grid-2{grid-template-columns:1fr}
.grid-3{grid-template-columns:1fr}
@media(min-width:820px){.grid-2{grid-template-columns:repeat(2,1fr)}.grid-3{grid-template-columns:repeat(3,1fr)}}
label{display:block;font-size:.95rem;font-weight:700;margin-bottom:6px}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.inline>*{min-width:0}
input,select,textarea,button{width:100%;border:1px solid var(--accent);background:#0b0d12;color:var(--text);border-radius:12px;padding:12px;font-size:16px;line-height:1.2}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--hover)}
button{background:var(--accent);color:#041019;border:none;font-weight:700;min-height:44px;touch-action:manipulation}
button:active{transform:translateY(1px)}
.btn-sm{padding:8px 10px;border-radius:10px;min-height:36px}
textarea{min-height:100px}
.compact input,.compact select{min-height:44px}
.btns>button{flex:1 0 110px;white-space:nowrap}
.pill{display:inline-block;padding:6px 10px;border:1px solid var(--accent);border-radius:999px;color:var(--accent);font-size:.85rem;white-space:nowrap}
.perk{font-size:.95rem;color:var(--accent)}
.muted{color:var(--sub)}
progress{width:100%;height:18px;-webkit-appearance:none;appearance:none;border:none;border-radius:999px;overflow:hidden;background:#0b0d12}
progress::-webkit-progress-bar{background:#0b0d12}
progress::-webkit-progress-value{background:var(--accent)}
.two{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.cols-2{display:grid;grid-template-columns:1fr;gap:8px}
@media(min-width:820px){.cols-2{grid-template-columns:1fr 1fr}}
.check{display:inline-flex;align-items:center;gap:6px}
.checkbox{width:auto;margin:0}
.death-saves{margin-top:12px}
.hp-top{order:-1}
.hidden{display:none}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;padding:16px}
.overlay.hidden{display:none!important}
.modal-card{background:var(--panel);border:1px solid var(--accent);border-radius:16px;max-width:800px;width:100%;padding:16px;box-shadow:var(--shadow)}
.modal-card h3{margin:0 0 8px;color:var(--accent);font-size:1.05rem}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--panel);border:1px solid var(--accent);padding:10px 12px;border-radius:12px;opacity:0;transform:translateY(10px);transition:opacity .2s, transform .2s;z-index:2000}
.toast.show{opacity:1;transform:translateY(0)}
.card{border:1px solid rgba(60,198,255,.25);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px}
.subhead{display:flex;align-items:center;justify-content:space-between;gap:8px}
.small{font-size:.9rem}
.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.conditions{display:flex;flex-wrap:wrap;gap:8px}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--accent);padding:6px 10px;border-radius:999px}
.sticky-combat{position:sticky;top:calc(64px + env(safe-area-inset-top));z-index:9}
.catalog-list{max-height:360px;overflow:auto;border:1px solid rgba(60,198,255,.25);border-radius:12px;padding:8px}
.catalog-item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px;border-bottom:1px solid rgba(60,198,255,.15)}
.catalog-item:last-child{border-bottom:none}
.catalog-filter{display:flex;gap:8px;align-items:center;margin:8px 0}
.badge{display:inline-block;border:1px solid rgba(60,198,255,.5);padding:2px 6px;border-radius:999px;font-size:.8rem;margin-left:6px}
.compact-btn{padding:8px 10px;border-radius:10px}
.preview{font-size:.9rem;color:var(--sub)}
.perk-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.bar-wrap{position:relative;width:100%}
.bar-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:14px;pointer-events:none}
.bar-overlay.hidden{display:none}
@media print{header,.tabs,.actions,#tools,.sticky-combat .btns,.icon-btn,.modal-card,.overlay{display:none!important} body{background:#fff;color:#000} section{box-shadow:none;border:1px solid #ccc} .pill{border-color:#000;color:#000}}
.sheet{display:none}
.sheet-cs{page-break-inside:avoid;background:#fff;color:#000;border:1px solid #000;border-radius:8px;padding:16px}
.cs-title{font-weight:700}
.cs-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.cs-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.cs-kv{display:flex;justify-content:space-between;gap:12px;border-bottom:1px solid #000;padding:6px 0}
.cs-box{border:1px solid #000;padding:10px;border-radius:8px}
@media print{main{display:none!important} #ccsheet{display:block!important} body{background:#fff!important;color:#000!important}}


.pill-used{background:#900;color:#fff}


.row.btns.two-col{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center}
.row.btns.single-col.center{display:flex;justify-content:center}

</style>
<style>#cloud-scan-info{ display:none !important; }</style></head>
<body><script>window.FIREBASE_COLLECTION = 'saves';</script><script id="firebase-config" type="application/json">{
  "apiKey": "AIzaSyAYENVrM2komgm2Nteg388YewLiVuUOlIw",
  "authDomain": "catalyst-core-e458c.firebaseapp.com",
  "projectId": "catalyst-core-e458c",
  "databaseURL": "https://catalyst-core-e458c-default-rtdb.firebaseio.com",
  "appId": "1:494771671712:web:0587e669cd5f7d3be92fc5",
  "storageBucket": "catalyst-core-e458c.firebasestorage.app",
  "messagingSenderId": "494771671712",
  "measurementId": "G-R3JS5GWKFM"
}</script>
<!-- Safety shim to avoid null refs if legacy scripts expect these -->
<div style="display:none">
<button aria-hidden="true" id="sp-spend" tabindex="-1"></button>
<input aria-hidden="true" id="sp-cost" tabindex="-1" value="0"/>
</div>
<header>
<div class="topbar">
<h1>Catalyst Core: Character Tracker</h1>
<div class="actions">
<button aria-label="Encounter Tracker" class="icon-btn" id="icon-encounter" title="Encounter Tracker">
<svg aria-hidden="true" height="20" viewbox="0 0 24 24" width="20"><path d="M8 6h13M3 12h18M3 18h18" fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path></svg>
</button>
<button aria-label="Load Save" class="icon-btn" id="icon-load" title="Load Save">
<svg aria-hidden="true" height="20" viewbox="0 0 24 24" width="20"><path d="M19 18a3 3 0 0 0 0-6h-1.26A8 8 0 1 0 4 15" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path><path d="M12 7v10m0 0l-3-3m3 3l3-3" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</button>
<button aria-label="Save" class="icon-btn" id="icon-save" title="Save">
<svg aria-hidden="true" height="20" viewbox="0 0 24 24" width="20"><path d="M19 18a3 3 0 0 0 0-6h-1.26A8 8 0 1 0 4 15" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path><path d="M12 17V7m0 0l-3 3m3-3l3 3" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</button>
<button aria-label="Roll/Flip Log" class="icon-btn" id="icon-log" title="Roll/Flip Log">
<svg aria-hidden="true" fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M8 6h13"></path><path d="M8 12h13"></path><path d="M8 18h13"></path><rect height="16" rx="1" width="3" x="3" y="4"></rect>
</svg>
</button>
</div>
</div>
<div class="tabs">
<button class="tab active" data-go="combat">Combat</button>
<button class="tab" data-go="abilities">Abilities</button>
<button class="tab" data-go="powers">Powers</button>
<button class="tab" data-go="gear">Gear</button>
<button class="tab" data-go="story">Story</button>
</div>
</header>
<main>
<section data-tab="combat" id="tools">
<h2>Tools</h2>
<div class="grid grid-2">
<div>
<label>Dice Roller</label>
<div class="row compact">
<select id="dice-type"><option value="4">d4</option><option value="6">d6</option><option value="8">d8</option><option value="10">d10</option><option value="12">d12</option><option value="20">d20</option><option value="100">d100</option></select>
<input class="num" id="dice-count" inputmode="numeric" min="1" type="number" value="1"/>
<button id="roll-dice">Roll</button>
</div>
<div class="muted" id="dice-result"></div>
</div>
<div>
<label>Coin Flip</label>
<div class="inline compact"><button id="flip-coin">Flip</button><span class="pill" id="coin-result"></span></div>
</div>
</div>
</section>
<section class="sticky-combat" data-tab="combat" id="resources">
<h2>Combat Stats</h2>
<div class="grid grid-1">
<div>
<div class="cols-2">
<div class="card">
<label>HP</label>
<div class="two hp-top">
<div class="bar-wrap">
<progress id="hp-bar" max="10" value="10"></progress>
<span aria-hidden="true" class="bar-overlay hidden" id="hp-skull">💀</span>
</div>
<span class="pill" id="hp-total">10/10</span>
</div>
<div class="row"><input id="hp-temp" inputmode="numeric" placeholder="Temp HP" type="number"/></div>
<div class="row btns two-col"><div class="inline"><input id="hp-dmg" inputmode="numeric" placeholder="Amount" type="number"/><button id="hp-take">Damage</button><button id="hp-heal">Heal</button></div><div class="inline"></div></div>
<div class="row btns single-col center"><button id="hp-reset">Reset HP</button></div>
<div class="inline death-saves">
<span class="muted" style="min-width:max-content">Death Saves:</span>
<label class="check" for="ds1"><input aria-label="Death Save 1" class="checkbox" id="ds1" type="checkbox"/><span>1</span></label>
<label class="check" for="ds2"><input aria-label="Death Save 2" class="checkbox" id="ds2" type="checkbox"/><span>2</span></label>
<label class="check" for="ds3"><input aria-label="Death Save 3" class="checkbox" id="ds3" type="checkbox"/><span>3</span></label>
</div>
</div>
<div class="card">
<label>SP</label>
<div class="two"><progress id="sp-bar" max="5" value="5"></progress><span class="pill" id="sp-total">5/5</span></div>
<div class="row"><input id="sp-temp" inputmode="numeric" placeholder="Temp SP" type="number"/></div>
<div class="row btns"><button class="btn-sm sp-step" data-d="-1">-1 SP</button><button class="btn-sm sp-step" data-d="-2">-2 SP</button><button class="btn-sm sp-step" data-d="-3">-3 SP</button><button class="btn-sm sp-step" data-d="-4">-4 SP</button><button class="btn-sm sp-step" data-d="-5">-5 SP</button><button id="sp-reset">Reset SP</button><button class="btn-sm" id="long-rest">Long Rest</button></div>
</div>
</div>
</div>
<div class="cols-2">
<div class="card">
<label>Initiative</label>
<input id="initiative" inputmode="numeric" placeholder="e.g., 17" type="number"/>
<label>Speed (ft)</label>
<input id="speed" inputmode="numeric" placeholder="30" type="number"/>
</div>
<div class="card">
<label>Passive Perception</label>
<input id="passive-perception" readonly="" type="number"/>
<label>Armor/Shield Bonus (Auto)</label>
<input id="armor-bonus" readonly="" type="number"/>
<label>Power/Origin Bonus</label>
<input id="origin-bonus" inputmode="numeric" placeholder="0" type="number"/>
<label>TC</label>
<input id="tc" readonly="" type="number"/>
</div>
</div>
<div class="card">
<label>Conditions</label>
<div class="conditions" id="conditions">
<label class="chip"><input class="checkbox" id="cond-stunned" type="checkbox"/>Stunned</label>
<label class="chip"><input class="checkbox" id="cond-prone" type="checkbox"/>Prone</label>
<label class="chip"><input class="checkbox" id="cond-exhausted" type="checkbox"/>Exhausted</label>
<label class="chip"><input class="checkbox" id="cond-blinded" type="checkbox"/>Blinded</label>
<label class="chip"><input class="checkbox" id="cond-charmed" type="checkbox"/>Charmed</label>
<label class="chip"><input class="checkbox" id="cond-frightened" type="checkbox"/>Frightened</label>
</div>
</div>
<div class="card" id="cinematic-card">
<label>Cinematic Action Point</label>
<p class="preview">Spend this once per session to fuel a dramatic stunt: turn a near-miss into a hit, pull off an extraordinary maneuver, or introduce a bold narrative twist. GM has final say. Resets at session end.</p>
<div class="row"><span class="pill" id="cap-state">Ready</span></div>
<div class="row btns">
<button class="btn-sm" id="cap-use">Use</button>
<button class="btn-sm" id="cap-reset">Reset</button>
</div>
</div>
</div>
</section>
<section data-tab="abilities" id="stats">
<h2>Ability Scores</h2>
<div class="grid grid-3">
<div class="card"><label>STR</label><div class="inline"><select id="str"></select><span class="pill" id="str-mod">+0</span></div></div>
<div class="card"><label>DEX</label><div class="inline"><select id="dex"></select><span class="pill" id="dex-mod">+0</span></div></div>
<div class="card"><label>CON</label><div class="inline"><select id="con"></select><span class="pill" id="con-mod">+0</span></div></div>
<div class="card"><label>INT</label><div class="inline"><select id="int"></select><span class="pill" id="int-mod">+0</span></div></div>
<div class="card"><label>WIS</label><div class="inline"><select id="wis"></select><span class="pill" id="wis-mod">+0</span></div></div>
<div class="card"><label>CHA</label><div class="inline"><select id="cha"></select><span class="pill" id="cha-mod">+0</span></div></div>
</div>
</section>
<section data-tab="abilities" id="skills">
<h2>Skills &amp; Proficiency</h2>
<div class="card">
<div class="row">
<div style="flex:1"><label>Proficiency Bonus</label><input id="prof-bonus" inputmode="numeric" type="number" value="2"/></div>
<div style="flex:1"><label>Power Save Ability (opt)</label><select id="power-save-ability"><option value="str">STR</option><option value="dex">DEX</option><option value="con">CON</option><option value="int">INT</option><option value="wis">WIS</option><option value="cha">CHA</option></select></div>
<div style="flex:1"><label>Power Save DC</label><input id="power-save-dc" readonly="" type="number"/></div>
</div>
</div>
<div class="card"><h3 class="small" style="margin:0 0 6px;color:var(--accent)">Skills</h3><div class="grid grid-1" id="skills-container">
<div class="row skill-row" data-abil="dex" data-skill="acrobatics">
<div style="flex:1 1 220px"><label>Acrobatics <span class="pill">DEX</span></label></div>
<label class="check"><input class="checkbox" id="prof-acrobatics" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-acrobatics" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-acrobatics" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="wis" data-skill="animal">
<div style="flex:1 1 220px"><label>Animal Handling <span class="pill">WIS</span></label></div>
<label class="check"><input class="checkbox" id="prof-animal" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-animal" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-animal" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="int" data-skill="arcana">
<div style="flex:1 1 220px"><label>Arcana <span class="pill">INT</span></label></div>
<label class="check"><input class="checkbox" id="prof-arcana" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-arcana" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-arcana" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="str" data-skill="athletics">
<div style="flex:1 1 220px"><label>Athletics <span class="pill">STR</span></label></div>
<label class="check"><input class="checkbox" id="prof-athletics" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-athletics" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-athletics" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="cha" data-skill="deception">
<div style="flex:1 1 220px"><label>Deception <span class="pill">CHA</span></label></div>
<label class="check"><input class="checkbox" id="prof-deception" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-deception" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-deception" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="int" data-skill="history">
<div style="flex:1 1 220px"><label>History <span class="pill">INT</span></label></div>
<label class="check"><input class="checkbox" id="prof-history" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-history" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-history" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="wis" data-skill="insight">
<div style="flex:1 1 220px"><label>Insight <span class="pill">WIS</span></label></div>
<label class="check"><input class="checkbox" id="prof-insight" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-insight" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-insight" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="cha" data-skill="intimidation">
<div style="flex:1 1 220px"><label>Intimidation <span class="pill">CHA</span></label></div>
<label class="check"><input class="checkbox" id="prof-intimidation" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-intimidation" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-intimidation" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="int" data-skill="investigation">
<div style="flex:1 1 220px"><label>Investigation <span class="pill">INT</span></label></div>
<label class="check"><input class="checkbox" id="prof-investigation" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-investigation" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-investigation" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="wis" data-skill="medicine">
<div style="flex:1 1 220px"><label>Medicine <span class="pill">WIS</span></label></div>
<label class="check"><input class="checkbox" id="prof-medicine" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-medicine" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-medicine" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="int" data-skill="nature">
<div style="flex:1 1 220px"><label>Nature <span class="pill">INT</span></label></div>
<label class="check"><input class="checkbox" id="prof-nature" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-nature" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-nature" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="wis" data-skill="perception">
<div style="flex:1 1 220px"><label>Perception <span class="pill">WIS</span></label></div>
<label class="check"><input class="checkbox" id="prof-perception" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-perception" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-perception" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="cha" data-skill="performance">
<div style="flex:1 1 220px"><label>Performance <span class="pill">CHA</span></label></div>
<label class="check"><input class="checkbox" id="prof-performance" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-performance" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-performance" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="cha" data-skill="persuasion">
<div style="flex:1 1 220px"><label>Persuasion <span class="pill">CHA</span></label></div>
<label class="check"><input class="checkbox" id="prof-persuasion" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-persuasion" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-persuasion" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="int" data-skill="religion">
<div style="flex:1 1 220px"><label>Religion <span class="pill">INT</span></label></div>
<label class="check"><input class="checkbox" id="prof-religion" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-religion" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-religion" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="dex" data-skill="sleight">
<div style="flex:1 1 220px"><label>Sleight of Hand <span class="pill">DEX</span></label></div>
<label class="check"><input class="checkbox" id="prof-sleight" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-sleight" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-sleight" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="dex" data-skill="stealth">
<div style="flex:1 1 220px"><label>Stealth <span class="pill">DEX</span></label></div>
<label class="check"><input class="checkbox" id="prof-stealth" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-stealth" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-stealth" readonly="" type="number"/></div>
</div>
<div class="row skill-row" data-abil="wis" data-skill="survival">
<div style="flex:1 1 220px"><label>Survival <span class="pill">WIS</span></label></div>
<label class="check"><input class="checkbox" id="prof-survival" type="checkbox"/> Proficient</label>
<label class="check"><input class="checkbox" id="exp-survival" type="checkbox"/> Expertise</label>
<div style="flex:0 0 90px"><input id="skill-survival" readonly="" type="number"/></div>
</div></div></div>
<div class="card"><h3 class="small" style="margin:0 0 6px;color:var(--accent)">Saving Throws</h3><div class="grid grid-1" id="saves-container">
<div class="row save-row" data-save="str">
<div style="flex:1 1 220px"><label>STR Save</label></div>
<label class="check"><input class="checkbox" id="save-str" type="checkbox"/> Proficient</label>
<div style="flex:0 0 90px"><input id="savev-str" readonly="" type="number"/></div>
</div>
<div class="row save-row" data-save="dex">
<div style="flex:1 1 220px"><label>DEX Save</label></div>
<label class="check"><input class="checkbox" id="save-dex" type="checkbox"/> Proficient</label>
<div style="flex:0 0 90px"><input id="savev-dex" readonly="" type="number"/></div>
</div>
<div class="row save-row" data-save="con">
<div style="flex:1 1 220px"><label>CON Save</label></div>
<label class="check"><input class="checkbox" id="save-con" type="checkbox"/> Proficient</label>
<div style="flex:0 0 90px"><input id="savev-con" readonly="" type="number"/></div>
</div>
<div class="row save-row" data-save="int">
<div style="flex:1 1 220px"><label>INT Save</label></div>
<label class="check"><input class="checkbox" id="save-int" type="checkbox"/> Proficient</label>
<div style="flex:0 0 90px"><input id="savev-int" readonly="" type="number"/></div>
</div>
<div class="row save-row" data-save="wis">
<div style="flex:1 1 220px"><label>WIS Save</label></div>
<label class="check"><input class="checkbox" id="save-wis" type="checkbox"/> Proficient</label>
<div style="flex:0 0 90px"><input id="savev-wis" readonly="" type="number"/></div>
</div>
<div class="row save-row" data-save="cha">
<div style="flex:1 1 220px"><label>CHA Save</label></div>
<label class="check"><input class="checkbox" id="save-cha" type="checkbox"/> Proficient</label>
<div style="flex:0 0 90px"><input id="savev-cha" readonly="" type="number"/></div>
</div></div></div>
</section>
<section data-tab="powers" id="powers">
<div class="subhead">
<h2>Powers &amp; Special Moves</h2>
<button id="add-power" style="max-width:200px">Add Power</button>
</div>
<div class="grid grid-2" id="powers-container"></div><div class="card" style="grid-column:1/-1"><label>Signature Move</label><div class="grid grid-2"><input id="signatureMoveName" placeholder="Name"/><input id="signatureSP" placeholder="SP Cost"/><input id="signatureSave" placeholder="Saving Throw"/><input id="signatureSpecial" placeholder="Special"/></div>
</div></section>
<section data-tab="gear" id="equipment">
<h2>Equipment &amp; Inventory</h2>
<div class="grid grid-2">
<div class="card">
<div class="subhead"><label>Weapons</label><button id="add-weapon" style="max-width:160px">Add Weapon</button></div>
<div class="grid grid-1" id="weapons-container"></div>
</div>
<div class="card">
<div class="subhead"><label>Armor &amp; Protection</label><button id="add-armor" style="max-width:160px">Add Armor</button></div>
<div class="grid grid-1" id="armor-container"></div>
</div>
<div class="card" style="grid-column:1/-1">
<div class="subhead"><label>Gear &amp; Items</label><button id="add-item" style="max-width:160px">Add Item</button></div>
<div class="grid grid-1" id="items-container"></div>
</div>
</div>
<div class="card">
<label>Notes</label>
<textarea id="inventory-list" placeholder="General inventory notes..." rows="4"></textarea>
</div>
</section>
<section data-tab="story" id="story">
<h2>Character &amp; Story</h2>
<div class="grid grid-2"><div class="card" id="hp-story-pack"><label>Tier Roll &amp; Bonus HP</label><div class="row"><input id="hp-roll" inputmode="numeric" placeholder="Tier Roll" type="number"/><input id="hp-bonus" inputmode="numeric" placeholder="Bonus HP" type="number"/></div></div>
<div class="card"><label>Superhero Identity</label><input id="superhero-identity" placeholder="Night Guardian"/></div>
<div class="card"><label>Secret Identity</label><input id="secret-identity" placeholder="Jane Doe"/></div>
<div class="card"><label>Tier</label><select id="char-tier"><option>Tier 5 – Rookie</option><option>Tier 4 – Emerging Vigilante</option><option>Tier 3 – Field-Tested Operative</option><option>Tier 2 – Respected Force</option><option>Tier 1 – Heroic Figure</option><option>Tier 0 – Transcendent</option></select></div>
<div class="card"><label>Public Identity</label><select id="publicIdentity"><option value="Public">Public</option><option value="Secret">Secret</option></select><input id="vigilanteName" type="hidden"/></div>
<div class="card"><label>Alignment</label><div class="inline"><select id="alignment"><option data-perk="Once per session, auto-succeed a Charisma check with civilians or allies">Paragon (Lawful Light)</option><option data-perk="Once per session, restore 1d6 HP or 1 SP to an ally as a bonus action">Guardian (Neutral Light)</option><option data-perk="Ignore opportunity attacks when moving toward a threat or hostage">Vigilante (Chaotic Light)</option><option data-perk="+1 to all saving throws when acting on orders or directives">Sentinel (Lawful Neutral)</option><option data-perk="Once per session, reroll any roll OR remove one condition from yourself">Outsider (True Neutral)</option><option data-perk="Advantage on Initiative and Deception once per combat">Wildcard (Chaotic Neutral)</option><option data-perk="Once per session, deal maximum damage to enemies labeled 'criminal' by GM">Inquisitor (Lawful Shadow)</option><option data-perk="Heal 1d6 HP when defeating an enemy while no allies are within 10 ft">Anti-Hero (Neutral Shadow)</option><option data-perk="Once per combat, add +1d6 damage when attacking from stealth or surprise">Renegade (Chaotic Shadow)</option></select><span class="perk" id="alignment-perk"></span></div><div class="perk-tools"><button class="btn-sm" id="perk-alignment-use">Mark Used</button><button class="btn-sm" id="perk-alignment-reset">Reset</button><span class="pill" id="perk-alignment-state">Ready</span></div></div>
<div class="card"><label>Classification</label><div class="inline"><select id="classification"><option data-perk="Reroll one failed saving throw per long rest">Mutant</option><option data-perk="Advantage on all Technology-related checks">Enhanced Human</option><option data-perk="Cast one minor magical effect per long rest">Magic User</option><option data-perk="Immune to environmental hazards; no penalty in rough terrain">Alien/Extraterrestrial</option><option data-perk="+2 to Persuasion or Intimidation checks">Mystical Being</option></select><span class="perk" id="classification-perk"></span></div><div class="perk-tools"><button class="btn-sm" id="perk-classification-use">Mark Used</button><button class="btn-sm" id="perk-classification-reset">Reset</button><span class="pill" id="perk-classification-state">Ready</span></div></div>
<div class="card"><label>Primary Power Style</label><div class="inline"><select id="primary-power-style"><option data-perk="Cut one attack by half once per combat encounter">Physical Powerhouse</option><option data-perk="Reroll 1s once per turn">Energy Manipulator</option><option data-perk="+10 ft movement and +1 AC while moving 20+ ft">Speedster</option><option data-perk="For one turn force enemies to reroll all rolls above a 17 once per rest">Telekinetic/Psychic</option><option data-perk="Create a 1‑min decoy illusion once per combat encounter">Illusionist</option><option data-perk="Advantage on Deception; disguise freely">Shape‑shifter</option><option data-perk="+2 to hit and +5 to damage once per turn when using elemental powers">Elemental Controller</option></select><span class="perk" id="primary-power-style-perk"></span></div><div class="perk-tools"><button class="btn-sm" id="perk-primary-use">Mark Used</button><button class="btn-sm" id="perk-primary-reset">Reset</button><span class="pill" id="perk-primary-state">Ready</span></div><input id="primaryPerk" type="hidden"/></div>
<div class="card"><label>Secondary Power Style</label><select id="secondary-power-style"><option>Physical Powerhouse</option><option>Energy Manipulator</option><option>Speedster</option><option>Telekinetic/Psychic</option><option>Illusionist</option><option>Shape-shifter</option><option>Elemental Controller</option></select></div>
<div class="card"><label>Origin Story</label><div class="inline"><select id="origin-story"><option data-perk="Resistance to one damage type">The Accident</option><option data-perk="Reroll a failed CON or INT save once per long rest">The Experiment</option><option data-perk="Use the powers of one other character you've met or are related to once per long rest">The Legacy</option><option data-perk="+5 to hit and +10 to damage when below 1/2 HP">The Awakening</option><option data-perk="Auto-success on one save or +10 to any roll once per long rest">The Pact</option><option data-perk="Once per combat, declare a Skill Move on DC 17 to use a power for free with +1d6 bonus">The Lost Time</option><option data-perk="+5 elemental damage once per round">The Exposure</option><option data-perk="If knocked out, stand with 1 HP and resistance to all damage for 1 round">The Rebirth</option><option data-perk="Create a shield once per combat reducing incoming damage to zero for one turn">The Vigil</option><option data-perk="Once per day take damage for an ally; they heal 1d6 HP and you gain advantage on saves after combat till dawn">The Redemption</option></select><span class="perk" id="origin-story-perk"></span></div><div class="perk-tools"><button class="btn-sm" id="perk-origin-use">Mark Used</button><button class="btn-sm" id="perk-origin-reset">Reset</button><span class="pill" id="perk-origin-state">Ready</span></div></div>
<textarea id="signatureMoveDescription" placeholder="Describe the move" rows="4"></textarea><textarea id="signatureMeaning" placeholder="Why this move matters" rows="3"></textarea></div>
<div class="card" style="grid-column:1/-1"><label>Backstory</label><div class="grid grid-2"><textarea id="prePowerLife" placeholder="Life Before Powers" rows="3"></textarea><textarea id="powerMoment" placeholder="Moment of Awakening" rows="3"></textarea><textarea id="powerMeaning" placeholder="Meaning of Power" rows="3"></textarea><textarea id="powerFear" placeholder="Greatest Fear" rows="3"></textarea><textarea id="walkAway" placeholder="What Would Make You Walk Away?" rows="3"></textarea><textarea id="vulnerability" placeholder="Vulnerability" rows="3"></textarea><textarea id="secret" placeholder="Secret" rows="3"></textarea></div></div>
<div class="card"><label>Allies &amp; Contacts</label><div class="grid grid-2"><input id="trustedAlly" placeholder="Trusted Ally"/><input id="teamAdmire" placeholder="Team You Admire"/></div></div>
<div class="card"><label>Training &amp; Research</label><div class="grid grid-2"><textarea id="research" placeholder="Research" rows="3"></textarea><textarea id="trainTinker" placeholder="Train or Tinker" rows="3"></textarea></div></div>
</section>
</main>
<section aria-hidden="true" class="sheet" id="ccsheet">
<div class="sheet-cs">
<h2>CCCG Character Sheet</h2>
<div class="cs-row">
<div class="cs-box">
<div class="cs-kv"><span class="cs-title">Hero</span><span id="cs-hero"></span></div>
<div class="cs-kv"><span class="cs-title">Secret ID</span><span id="cs-secret"></span></div>
<div class="cs-kv"><span class="cs-title">Tier</span><span id="cs-tier"></span></div>
<div class="cs-kv"><span class="cs-title">Alignment</span><span id="cs-align"></span></div>
<div class="cs-kv"><span class="cs-title">Alignment Perk</span><span id="cs-align-perk"></span></div>
<div class="cs-kv"><span class="cs-title">Classification</span><span id="cs-class"></span></div>
<div class="cs-kv"><span class="cs-title">Classification Perk</span><span id="cs-class-perk"></span></div>
<div class="cs-kv"><span class="cs-title">Primary Power</span><span id="cs-ppower"></span></div>
<div class="cs-kv"><span class="cs-title">Primary Perk</span><span id="cs-ppower-perk"></span></div>
<div class="cs-kv"><span class="cs-title">Secondary Power</span><span id="cs-spower"></span></div>
<div class="cs-kv"><span class="cs-title">Origin</span><span id="cs-origin"></span></div>
<div class="cs-kv"><span class="cs-title">Origin Perk</span><span id="cs-origin-perk"></span></div>
</div>
<div class="cs-box">
<div class="cs-kv"><span class="cs-title">HP</span><span id="cs-hp"></span></div>
<div class="cs-kv"><span class="cs-title">SP</span><span id="cs-sp"></span></div>
<div class="cs-kv"><span class="cs-title">TC</span><span id="cs-tc"></span></div>
<div class="cs-kv"><span class="cs-title">Initiative</span><span id="cs-init"></span></div>
<div class="cs-kv"><span class="cs-title">Speed</span><span id="cs-speed"></span></div>
<div class="cs-kv"><span class="cs-title">Passive Perception</span><span id="cs-pp"></span></div>
<div class="cs-kv"><span class="cs-title">Death Saves</span><span id="cs-ds"></span></div>
<div class="cs-kv"><span class="cs-title">Conditions</span><span id="cs-conds"></span></div>
</div>
</div>
<div class="cs-box" style="margin-top:8px">
<div class="cs-title">Ability Scores</div>
<div class="cs-grid-3" id="cs-abilities"></div>
</div>
<div class="cs-row" style="margin-top:8px">
<div class="cs-box">
<div class="cs-title">Powers</div>
<div id="cs-powers"></div>
</div>
<div class="cs-box">
<div class="cs-title">Weapons &amp; Armor</div>
<div id="cs-gear"></div>
</div>
</div>
<div class="cs-box" style="margin-top:8px">
<div class="cs-title">Items</div>
<div id="cs-items"></div>
</div>
<div class="cs-box" style="margin-top:8px">
<div class="cs-title">Signature Move</div>
<div id="cs-signature"></div>
</div>
<div class="cs-box" style="margin-top:8px">
<div class="cs-title">Notes &amp; Backstory</div>
<div id="cs-backstory"></div>
</div>
</div>
</section>
<div aria-labelledby="id-modal-title" aria-modal="true" class="overlay hidden" id="id-overlay" role="dialog">
<div class="modal-card">
<h3 id="id-modal-title">Cloud</h3><div id="storage-mode-note" style="font-size:0.85rem; opacity:0.85; margin-top:6px;">Storage: auto (Cloud if Firebase configured; falls back to Local)</div>
<input id="modal-doc-id" placeholder="Character name (e.g., Shawn) or full path"/><div style="margin-top:10px; font-weight:600;">Local Saves</div><div id="cloud-save-list" style="margin-top:4px; max-height:140px; overflow:auto; border:1px dashed var(--line,#bbb); padding:6px; border-radius:6px; font-size:0.9rem;"></div><div style="margin-top:10px; font-weight:600;">Cloud Saves</div><div id="save-slot-list" style="margin-top:4px; max-height:140px; overflow:auto; border:1px dashed var(--line,#bbb); padding:6px; border-radius:6px; font-size:0.9rem;"></div>
<div class="modal-actions">
<button id="modal-cancel">Cancel</button>
<button id="modal-confirm">OK</button>
</div>
</div>
</div>
<div aria-labelledby="log-title" aria-modal="true" class="overlay hidden" id="log-overlay" role="dialog">
<div class="modal-card">
<h3 id="log-title">Recent Log</h3>
<div class="grid grid-2">
<div>
<label>Dice Rolls</label>
<div class="log" id="log-dice"></div>
</div>
<div>
<label>Coin Flips</label>
<div class="log" id="log-coin"></div>
</div>
</div>
<div class="modal-actions">
<button id="log-close">Close</button>
</div>
</div>
</div>
<div aria-labelledby="confirm-title" aria-modal="true" class="overlay hidden" id="confirm-overlay" role="dialog">
<div class="modal-card">
<h3 id="confirm-title">Confirm Delete</h3>
<div class="muted" id="confirm-msg" style="margin-top:6px"></div>
<div class="modal-actions">
<button id="confirm-cancel">Cancel</button>
<button id="confirm-ok">Delete</button>
</div>
</div>
</div>
<div aria-labelledby="encounter-title" aria-modal="true" class="overlay hidden" id="encounter-overlay" role="dialog">
<div class="modal-card">
<h3 id="encounter-title">Encounter Tracker</h3>
<div class="row"><div class="pill" id="round-pill">Round 1</div><button class="btn-sm" id="next-round">Next Round</button><button class="btn-sm" id="reset-encounter">Reset</button></div>
<div class="row-3" style="margin-top:8px">
<input id="enc-name" placeholder="Name"/>
<input id="enc-init" placeholder="Init" type="number"/>
<button class="btn-sm" id="enc-add">Add</button>
</div>
<div class="catalog-list" id="enc-list" style="margin-top:8px"></div>
<div class="modal-actions"><button id="enc-close">Close</button></div>
</div>
</div>
<script>
window.addEventListener('DOMContentLoaded',()=>{
  const $=id=>document.getElementById(id);
  const abilities=['str','dex','con','int','wis','cha'];
  abilities.forEach(id=>{const sel=$(id); if(sel){for(let v=10;v<=24;v++) sel.add(new Option(v,v)); if(!sel.value) sel.value='10';}});
  const mod=v=>Math.floor((v-10)/2);
  const clamp=(v,min,max)=>Math.max(min,Math.min(v,max));
  const num=el=>{const n=Number(el?.value);return Number.isFinite(n)?n:NaN};
  let hpZero=false, spZero=false, initTouched=false, booting=true, pendingDeleteEl=null, round=Number(localStorage.getItem('enc-round')||'1');
  function setTab(name){document.querySelectorAll('[data-tab]').forEach(s=>{s.style.display=(s.getAttribute('data-tab')===name)?'block':'none'}); document.querySelectorAll('.tab').forEach(b=>{b.classList.toggle('active', b.getAttribute('data-go')===name)});} 
  document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click',()=>setTab(b.getAttribute('data-go'))));
  setTab('combat');
  const diceHistory=JSON.parse(localStorage.getItem('dice-history')||'[]');
  const coinHistory=JSON.parse(localStorage.getItem('coin-history')||'[]');
  const fmt=ts=>new Date(ts).toLocaleTimeString();
  function renderLogs(){const dl=$('log-dice'), cl=$('log-coin'); if(dl) dl.innerHTML=diceHistory.slice(-10).map(e=>`<div class="log-item"><span>${fmt(e.t)}</span> <b>${e.text}</b></div>`).reverse().join(''); if(cl) cl.innerHTML=coinHistory.slice(-10).map(e=>`<div class="log-item"><span>${fmt(e.t)}</span> <b>${e.text}</b></div>`).reverse().join('');}
  function addDiceLog(text){diceHistory.push({t:Date.now(),text}); if(diceHistory.length>30) diceHistory.splice(0,diceHistory.length-30); localStorage.setItem('dice-history',JSON.stringify(diceHistory));}
  function addCoinLog(text){coinHistory.push({t:Date.now(),text}); if(coinHistory.length>30) coinHistory.splice(0,coinHistory.length-30); localStorage.setItem('coin-history',JSON.stringify(coinHistory));}
  const conditionText={"cond-stunned":"Stunned: You can\'t move and can speak only falteringly. Attacks against you have advantage.","cond-prone":"Prone: You are on the ground; attacks from 5 ft have advantage; your ranged attacks have disadvantage.","cond-exhausted":"Exhausted: Disadvantage on ability checks.","cond-blinded":"Blinded: You can\'t see; attacks against you have advantage; your attacks have disadvantage.","cond-charmed":"Charmed: You can\'t attack the charmer; they have advantage on social checks.","cond-frightened":"Frightened: Disadvantage while the source is in sight; you can\'t move closer."};
  function anyConditions(){return Array.from(document.querySelectorAll('#conditions input[type="checkbox"]')).some(c=>c.checked)}
  function remindConditions(){if(anyConditions()) alert('Reminder: Active conditions — '+Array.from(document.querySelectorAll('#conditions input:checked')).map(c=>c.parentElement.textContent.trim()).join(', '))}
  function perkFor(id){const s=$(id), out=$(id+'-perk'); if(!s||!out) return; out.textContent=s.selectedOptions[0]?.dataset?.perk||''; if(id==='primary-power-style'){const p=$('primaryPerk'); if(p) p.value=out.textContent;}}
  function updatePerks(){['alignment','classification','primary-power-style','origin-story'].forEach(perkFor)}
  function computeArmorAuto(){let body=[],head=[],shield=0,misc=0; document.querySelectorAll("[data-kind='armor']").forEach(card=>{const eq=card.querySelector("input[type='checkbox'][data-field='equipped']"); const bonus=Number(card.querySelector("input[data-field='bonus']")?.value)||0; const slot=card.querySelector("select[data-field='slot']")?.value||'Body'; if(eq && eq.checked){if(slot==='Body') body.push(bonus); else if(slot==='Head') head.push(bonus); else if(slot==='Shield') shield+=bonus; else misc+=bonus;}}); const bodyMax=body.length?Math.max(...body):0; const headMax=head.length?Math.max(...head):0; return bodyMax+headMax+shield+misc}
  function updateAbilityMods(){abilities.forEach(id=>{const v=num($(id)); const m=mod(Number.isNaN(v)?10:v); const b=$(id+'-mod'); if(b) b.textContent=(m>=0?'+':'')+m}); const pp=$('passive-perception'); if(pp) pp.value=10+mod(num($('wis'))||10); const armorAuto=computeArmorAuto(); const ab=$('armor-bonus'); if(ab) ab.value=armorAuto; const tc=$('tc'); if(tc) tc.value=10+mod(num($('dex'))||10)+armorAuto+(num($('origin-bonus'))||0); const init=$('initiative'); if(init){
      let base = mod(num($('dex'))||10);
      let bonus = 0;
      document.querySelectorAll('[data-bonus-init]').forEach(el => { bonus += Number(el.getAttribute('data-bonus-init'))||0; });
      document.querySelectorAll('.init-bonus').forEach(el => {
        if (el.type === 'checkbox') { if (el.checked) bonus += Number(el.value || el.dataset.bonus || 1) || 0; }
        else { bonus += Number(el.value || el.dataset.bonus || 0) || 0; }
      });
      document.querySelectorAll('select').forEach(sel => {
        const o = sel.options && sel.options[sel.selectedIndex];
        if (o && o.dataset && o.dataset.init) bonus += Number(o.dataset.init)||0;
      });
      init.value = base + bonus;
    } const dc=$('power-save-dc'); if(dc){ const abl=$('power-save-ability').value; const m=mod(num($(abl))||10); const pb=num($('prof-bonus'))||0; dc.value=8+pb+m; }}
  function updateHP(){const hb=$('hp-bar'); if(!hb) return; const base=30+mod(num($('con'))||10); const total=base+(num($('hp-roll'))||0)+(num($('hp-bonus'))||0); const prevVal=Number(hb.value); const prevMax=Number(hb.max); const isFresh=(prevMax===0 && hb.dataset.init!=='1'); hb.max=total; if(isFresh){ hb.value=total; hb.dataset.init='1'; } else { hb.value=clamp(Number.isFinite(prevVal)?prevVal:total,0,total); } const temp=Number($('hp-temp')?.value)||0; const hpt=$('hp-total'); if(hpt) hpt.textContent=`${hb.value}/${total}`+(temp?` (+${temp})`:``); const skull=$('hp-skull'); if(skull) skull.classList.toggle('hidden', hb.value>0); if(hb.value<=0 && !hpZero && !booting && !isFresh){ alert('You are in Last Stand!'); hpZero=true; } else if(hb.value>0 && hpZero){ hpZero=false; }}
  function updateSP(){const sb=$('sp-bar'); if(!sb) return; const base=5+mod(num($('con'))||10); const prevVal=Number(sb.value); const prevMax=Number(sb.max); const isFresh=(prevMax===0 && sb.dataset.init!=='1'); sb.max=base; if(isFresh){ sb.value=base; sb.dataset.init='1'; } else { sb.value=clamp(Number.isFinite(prevVal)?prevVal:base,0,base); } const temp=Number($('sp-temp')?.value)||0; const spt=$('sp-total'); if(spt) spt.textContent=`${sb.value}/${base}`+(temp?` (+${temp})`:``); if(sb.value<=0 && !spZero && !booting && !isFresh){ alert('You have run out of SP.'); spZero=true; } else if(sb.value>0 && spZero){ spZero=false; }}
  function setHP(v){const hb=$('hp-bar'); if(!hb) return; hb.value=clamp(v,0,Number(hb.max)||0); updateHP()}
  function setSP(v){const sb=$('sp-bar'); if(!sb) return; sb.value=clamp(v,0,Number(sb.max)||0); updateSP()}
  function roll(n,s){return Array.from({length:n},()=>1+Math.floor(Math.random()*s))}
  $('roll-dice').addEventListener('click',()=>{const s=Number($('dice-type').value||6), c=Number($('dice-count').value||1); const r=roll(c,s); const sum=r.reduce((a,b)=>a+b,0); $('dice-result').textContent=`Rolls: ${r.join(', ')} (Sum: ${sum})`; addDiceLog(`${c}×d${s}: ${r.join(', ')} = ${sum}`); remindConditions()});
  $('flip-coin').addEventListener('click',()=>{const v=Math.random()<.5?'Heads':'Tails'; $('coin-result').textContent=v; addCoinLog(v); remindConditions()});
  
  document.querySelectorAll('#conditions input[type="checkbox"]').forEach(c=>c.addEventListener('change',e=>{if(e.target.checked){const t=conditionText[e.target.id]||'Condition active.'; alert(t)}}));
  function computeSkillTotal(modA, prof, exp){const pb=num($('prof-bonus'))||0; if(exp) return modA+pb*2; if(prof) return modA+pb; return modA}
  const skillDefs=[{id:'acrobatics',name:'Acrobatics',ability:'dex'},{id:'athletics',name:'Athletics',ability:'str'},{id:'stealth',name:'Stealth',ability:'dex'},{id:'perception',name:'Perception',ability:'wis'},{id:'insight',name:'Insight',ability:'wis'},{id:'investigation',name:'Investigation',ability:'int'},{id:'history',name:'History',ability:'int'},{id:'arcana',name:'Arcana',ability:'int'},{id:'survival',name:'Survival',ability:'wis'},{id:'medicine',name:'Medicine',ability:'wis'},{id:'nature',name:'Nature',ability:'int'},{id:'animal',name:'Animal Handling',ability:'wis'},{id:'deception',name:'Deception',ability:'cha'},{id:'intimidation',name:'Intimidation',ability:'cha'},{id:'persuasion',name:'Persuasion',ability:'cha'},{id:'performance',name:'Performance',ability:'cha'},{id:'religion',name:'Religion',ability:'int'},{id:'sleight',name:'Sleight of Hand',ability:'dex'}];
  function buildSkillsUI(){const cont=$('skills-container'); if(!cont) return; cont.innerHTML=''; skillDefs.forEach(sk=>{const row=document.createElement('div'); row.className='row'; row.innerHTML=`<div style="flex:1 1 180px"><label>${sk.name}</label></div><div style="flex:0 0 90px"><span class="pill">${sk.ability.toUpperCase()}</span></div><label class="check"><input id="${sk.id}-prof" type="checkbox" class="checkbox">Proficient</label><label class="check"><input id="${sk.id}-exp" type="checkbox" class="checkbox">Expertise</label><div style="flex:0 0 90px"><input id="${sk.id}-total" type="number" readonly></div>`; cont.appendChild(row); row.querySelector(`#${sk.id}-prof`).addEventListener('change',updateAll); row.querySelector(`#${sk.id}-exp`).addEventListener('change',updateAll);});}
  function buildSavesUI(){const cont=$('saves-container'); if(!cont) return; cont.innerHTML=''; ['str','dex','con','int','wis','cha'].forEach(a=>{const name=a.toUpperCase(); const row=document.createElement('div'); row.className='row'; row.innerHTML=`<div style="flex:1 1 160px"><label>${name} Save</label></div><label class="check"><input id="save-${a}-prof" type="checkbox" class="checkbox">Proficient</label><div style="flex:0 0 90px"><input id="save-${a}-total" type="number" readonly></div>`; cont.appendChild(row); row.querySelector(`#save-${a}-prof`).addEventListener('change',updateAll);});}
  function updateSkills(){skillDefs.forEach(sk=>{const m=mod(num($(sk.ability))||10); const prof=$(`${sk.id}-prof`)?.checked; const exp=$(`${sk.id}-exp`)?.checked; const tot=$(`${sk.id}-total`); if(tot) tot.value=computeSkillTotal(m,prof,exp)}); ['str','dex','con','int','wis','cha'].forEach(a=>{const m=mod(num($(a))||10); const prof=$(`save-${a}-prof`)?.checked; const out=$(`save-${a}-total`); if(out){ const pb=num($('prof-bonus'))||0; out.value=m+(prof?pb:0); }});}
  function updateAll(){updateAbilityMods(); updateHP(); updateSP(); updatePerks(); updateSkills();}
  function hpAdjust(delta){const hb=$('hp-bar'); if(!hb) return; const temp=$('hp-temp'); let d=delta; let tv=Number(temp?.value)||0; if(d<0 && tv>0){const use=Math.min(tv,Math.abs(d)); tv-=use; temp.value=tv; d+=use;} setHP(Number(hb.value)+d);}
  function spAdjust(delta){const sb=$('sp-bar'); if(!sb) return; const temp=$('sp-temp'); let d=delta; let tv=Number(temp?.value)||0; if(d<0 && tv>0){const use=Math.min(tv,Math.abs(d)); tv-=use; temp.value=tv; d+=use;} setSP(Number(sb.value)+d); if(sb.value<=0 && !spZero){ spZero=true; } if(sb.value>0) spZero=false}
  $('hp-take').addEventListener('click',()=>{const a=Number($('hp-dmg').value||0); if(a) hpAdjust(-Math.abs(a)); remindConditions()});
  $('hp-heal').addEventListener('click',()=>{const a=Number($('hp-dmg').value||0); if(a) hpAdjust(Math.abs(a));});
  $('hp-reset').addEventListener('click',()=>{const hb=$('hp-bar'); setHP(Number(hb.max)||0)});
  document.querySelectorAll('.hp-step').forEach(b=>b.addEventListener('click',()=>{const d=Number(b.dataset.d||0); if(d) hpAdjust(d); remindConditions()}));
  $('sp-spend').addEventListener('click',()=>{const a=Number($('sp-cost').value||0); if(a) spAdjust(-Math.abs(a)); remindConditions()});
  document.querySelectorAll('.sp-step').forEach(b=>b.addEventListener('click',()=>{const d=Number(b.dataset.d||0); if(d) spAdjust(d); remindConditions()}));
  $('sp-reset').addEventListener('click',()=>{const sb=$('sp-bar'); setSP(Number(sb.max)||0)});
  $('long-rest').addEventListener('click',()=>{setHP(Number($('hp-bar').max)||0); setSP(Number($('sp-bar').max)||0)});
  ['ds1','ds2','ds3'].forEach(id=>$(id).addEventListener('change',()=>{const c=['ds1','ds2','ds3'].filter(i=>$(i).checked).length; if(c===3 && !booting) alert('You Have Fallen, Your Sacrifice Will Be Remembered')}));
  ['alignment','classification','primary-power-style','origin-story'].forEach(id=>$(id).addEventListener('change',updatePerks));
  abilities.forEach(id=>$(id).addEventListener('change',()=>{if(id==='dex') initTouched=true; updateAll()}));
  ;['hp-roll','hp-bonus','hp-temp','sp-temp','origin-bonus','prof-bonus','power-save-ability'].forEach(id=>$(id).addEventListener('input',updateAll));
  function openModal(id){$(id).classList.remove('hidden')} function closeModal(id){$(id).classList.add('hidden')}
  $('icon-log').addEventListener('click',()=>{renderLogs(); openModal('log-overlay')}); $('log-close').addEventListener('click',()=>closeModal('log-overlay'));
  let saveMode=null; $('icon-save').addEventListener('click',()=>{saveMode='save'; $('id-modal-title').textContent='Save'; $('modal-doc-id').value=$('superhero-identity').value||''; openModal('id-overlay')}); $('icon-load').addEventListener('click',()=>{saveMode='load'; $('id-modal-title').textContent='Load'; $('modal-doc-id').value=''; openModal('id-overlay')}); $('modal-cancel').addEventListener('click',()=>closeModal('id-overlay'));
  $('modal-confirm').addEventListener('click',()=>{const key=($('modal-doc-id').value||'').trim(); if(!key){closeModal('id-overlay'); return;} if(saveMode==='save'){const data=serialize(); localStorage.setItem('save:'+key, JSON.stringify(data)); closeModal('id-overlay'); toast('Saved as '+key);} else {const raw=localStorage.getItem('save:'+key); if(!raw){alert('No save named '+key); return} booting=true; deserialize(JSON.parse(raw)); updateAll(); setTimeout(()=>{booting=false},100); closeModal('id-overlay'); toast('Loaded '+key); }});
  var __exp=$('icon-export'); if(__exp){__exp.addEventListener('click',()=>{buildPrintSheet(); setTimeout(()=>window.print(),0)});}
  function addPower(pref){const idx=Date.now()+Math.floor(Math.random()*1000); const wrap=document.createElement('div'); wrap.className='card'; wrap.dataset.kind='power'; wrap.dataset.idx=idx; wrap.innerHTML=`<div class="row"><input data-field="name" placeholder="Name" value="${pref?.name||''}"><input data-field="sp" placeholder="SP"><input data-field="save" placeholder="Save"><input data-field="range" placeholder="Range"></div><textarea data-field="effect" rows="3" placeholder="Effect">${pref?.effect||''}</textarea><div class="row"><button class="btn-sm" data-act="del">Delete</button></div>`; $('powers-container').appendChild(wrap); wrap.querySelector('[data-act="del"]').addEventListener('click',()=>confirmDelete(wrap,'Delete this power?'))}
  function addWeapon(pref){const idx=Date.now()+Math.floor(Math.random()*1000); const wrap=document.createElement('div'); wrap.className='card'; wrap.dataset.kind='weapon'; wrap.dataset.idx=idx; wrap.innerHTML=`<div class="row"><input data-field="name" placeholder="Name" value="${pref?.name||''}"><input data-field="damage" placeholder="Damage"><input data-field="range" placeholder="Range"></div><div class="row"><button class="btn-sm" data-act="del">Delete</button></div>`; $('weapons-container').appendChild(wrap); wrap.querySelector('[data-act="del"]').addEventListener('click',()=>confirmDelete(wrap,'Delete this weapon?'))}
  function addArmor(pref){const idx=Date.now()+Math.floor(Math.random()*1000); const wrap=document.createElement('div'); wrap.className='card'; wrap.dataset.kind='armor'; wrap.dataset.idx=idx; wrap.innerHTML=`<div class="row"><input data-field="name" placeholder="Name" value="${pref?.name||''}"><select data-field="slot"><option>Body</option><option>Head</option><option>Shield</option><option>Misc</option></select><input data-field="bonus" type="number" inputmode="numeric" placeholder="Bonus" value="${pref?.bonus||0}"><label class="check"><input type="checkbox" data-field="equipped">Equipped</label></div><div class="row"><button class="btn-sm" data-act="del">Delete</button></div>`; $('armor-container').appendChild(wrap); wrap.querySelector('[data-field="slot"]').value=pref?.slot||'Body'; if(pref?.equipped) wrap.querySelector('[data-field="equipped"]').checked=true; wrap.querySelectorAll('input,select').forEach(el=>el.addEventListener('input',()=>{updateAbilityMods()})); wrap.querySelector('[data-act="del"]').addEventListener('click',()=>confirmDelete(wrap,'Delete this armor?'))}
  function addItem(pref){const idx=Date.now()+Math.floor(Math.random()*1000); const wrap=document.createElement('div'); wrap.className='card'; wrap.dataset.kind='item'; wrap.dataset.idx=idx; wrap.innerHTML=`<div class="row"><input data-field="name" placeholder="Name" value="${pref?.name||''}"><input data-field="qty" type="number" inputmode="numeric" placeholder="Qty" value="${pref?.qty||1}"><input data-field="notes" placeholder="Notes" value="${pref?.notes||''}"></div><div class="row"><button class="btn-sm" data-act="del">Delete</button></div>`; $('items-container').appendChild(wrap); wrap.querySelector('[data-act="del"]').addEventListener('click',()=>confirmDelete(wrap,'Delete this item?'))}
  function confirmDelete(node,msg){$('confirm-msg').textContent=msg; pendingDeleteEl=node; $('confirm-overlay').classList.remove('hidden')}
  $('confirm-cancel').addEventListener('click',()=>{$('confirm-overlay').classList.add('hidden'); pendingDeleteEl=null}); $('confirm-ok').addEventListener('click',()=>{if(pendingDeleteEl){pendingDeleteEl.remove(); pendingDeleteEl=null; updateAbilityMods()} $('confirm-overlay').classList.add('hidden')});
  $('add-power').addEventListener('click',()=>addPower()); $('add-weapon').addEventListener('click',()=>addWeapon()); $('add-armor').addEventListener('click',()=>addArmor()); $('add-item').addEventListener('click',()=>addItem());
  function buildPrintSheet(){const text=(id,val)=>{const el=$(id); if(el) el.textContent=val==null?'':String(val)}; const hb=$('hp-bar'), sb=$('sp-bar'); text('cs-hero',$('superhero-identity')?.value||''); text('cs-secret',$('secret-identity')?.value||''); text('cs-tier',$('char-tier')?.value||$('char-tier')?.selectedOptions?.[0]?.text||''); text('cs-align',$('alignment')?.selectedOptions?.[0]?.text||''); text('cs-align-perk',$('alignment-perk')?.textContent||''); text('cs-class',$('classification')?.selectedOptions?.[0]?.text||''); text('cs-class-perk',$('classification-perk')?.textContent||''); text('cs-ppower',$('primary-power-style')?.selectedOptions?.[0]?.text||''); text('cs-ppower-perk',$('primary-power-style-perk')?.textContent||$('primaryPerk')?.value||''); text('cs-spower',$('secondary-power-style')?.value||''); text('cs-origin',$('origin-story')?.selectedOptions?.[0]?.text||''); text('cs-origin-perk',$('origin-story-perk')?.textContent||''); text('cs-hp',`${hb?.value||0}/${hb?.max||0}`); text('cs-sp',`${sb?.value||0}/${sb?.max||0}`); text('cs-tc',$('tc')?.value||''); text('cs-init',$('initiative')?.value||''); text('cs-speed',$('speed')?.value||''); text('cs-pp',$('passive-perception')?.value||''); const ds=['ds1','ds2','ds3'].filter(id=>$(id)?.checked).length; text('cs-ds',`${ds}/3`); const conds=Array.from(document.querySelectorAll('#conditions input:checked')).map(i=>i.parentElement.textContent.trim()).join(', '); text('cs-conds',conds||'None'); const ab=$('cs-abilities'); if(ab){ ab.innerHTML=''; abilities.forEach(id=>{ const score=$(id)?.value||'10'; const m=document.getElementById(id+'-mod')?.textContent||'+0'; const d=document.createElement('div'); d.className='cs-kv'; d.innerHTML=`<span class="cs-title">${id.toUpperCase()}</span><span>${score} (${m})</span>`; ab.appendChild(d); }); } const pp=$('cs-powers'); if(pp){ pp.innerHTML=''; document.querySelectorAll("[data-kind='power']").forEach(card=>{ const name=card.querySelector("[data-field='name']")?.value||'Power'; const sp=card.querySelector("[data-field='sp']")?.value||''; const save=card.querySelector("[data-field='save']")?.value||''; const range=card.querySelector("[data-field='range']")?.value||''; const effect=card.querySelector("[data-field='effect']")?.value||''; const row=document.createElement('div'); row.className='cs-kv'; row.innerHTML=`<span>${name}${sp?` [SP ${sp}]`:''}${save?` [Save ${save}]`:''}${range?` [${range}]`:''}</span><span>${effect}</span>`; pp.appendChild(row); }); } const cg=$('cs-gear'); if(cg){ cg.innerHTML=''; document.querySelectorAll("[data-kind='weapon']").forEach(card=>{ const name=card.querySelector("[data-field='name']")?.value||'Weapon'; const dmg=card.querySelector("[data-field='damage']")?.value||''; const rng=card.querySelector("[data-field='range']")?.value||''; const row=document.createElement('div'); row.className='cs-kv'; row.innerHTML=`<span>${name}</span><span>${dmg}${rng?` (${rng})`:''}</span>`; cg.appendChild(row); }); document.querySelectorAll("[data-kind='armor']").forEach(card=>{ const name=card.querySelector("[data-field='name']")?.value||'Armor'; const slot=card.querySelector("[data-field='slot']")?.value||''; const bonus=card.querySelector("[data-field='bonus']")?.value||0; const eq=card.querySelector("[data-field='equipped']")?.checked?'★ ':''; const row=document.createElement('div'); row.className='cs-kv'; row.innerHTML=`<span>${eq}${name} (${slot})</span><span>+${bonus}</span>`; cg.appendChild(row); }); } const ci=$('cs-items'); if(ci){ ci.innerHTML=''; document.querySelectorAll("[data-kind='item']").forEach(card=>{ const name=card.querySelector("[data-field='name']")?.value||'Item'; const qty=card.querySelector("[data-field='qty']")?.value||1; const notes=card.querySelector("[data-field='notes']")?.value||''; const row=document.createElement('div'); row.className='cs-kv'; row.innerHTML=`<span>${name}</span><span>×${qty}${notes?` — ${notes}`:''}</span>`; ci.appendChild(row); }); } const sig=$('cs-signature'); if(sig){ const name=$('signatureMoveName')?.value||''; const sp=$('signatureSP')?.value||''; const save=$('signatureSave')?.value||''; const spec=$('signatureSpecial')?.value||''; const desc=$('signatureMoveDescription')?.value||''; sig.innerHTML=`<div class="cs-kv"><span>${name}</span><span>${sp?`SP ${sp}`:''}</span></div><div>${desc||''}</div><div>${save||''} ${spec||''}</div>`; } const bs=$('cs-backstory'); if(bs){ const fields=['prePowerLife','powerMoment','powerMeaning','powerFear','walkAway','vulnerability','secret','trustedAlly','teamAdmire','research','trainTinker']; bs.innerHTML=''; fields.forEach(k=>{ const val=$(k)?.value; if(val){ const row=document.createElement('div'); row.className='cs-kv'; row.innerHTML=`<span class="cs-title">${k.replace(/([A-Z])/g,' $1')}</span><span>${val}</span>`; bs.appendChild(row); } }); }}
  function serialize(){const data={}; document.querySelectorAll('input,select,textarea').forEach(el=>{if(el.type==='checkbox') data[el.id||el.dataset.field]=el.checked; else data[el.id||el.dataset.field]=el.value}); data.powers=[]; document.querySelectorAll("[data-kind='power']").forEach(card=>{data.powers.push({name:card.querySelector("[data-field='name']")?.value||'',sp:card.querySelector("[data-field='sp']")?.value||'',save:card.querySelector("[data-field='save']")?.value||'',range:card.querySelector("[data-field='range']")?.value||'',effect:card.querySelector("[data-field='effect']")?.value||''})}); data.weapons=[]; document.querySelectorAll("[data-kind='weapon']").forEach(card=>{data.weapons.push({name:card.querySelector("[data-field='name']")?.value||'',damage:card.querySelector("[data-field='damage']")?.value||'',range:card.querySelector("[data-field='range']")?.value||''})}); data.armor=[]; document.querySelectorAll("[data-kind='armor']").forEach(card=>{data.armor.push({name:card.querySelector("[data-field='name']")?.value||'',slot:card.querySelector("[data-field='slot']")?.value||'Body',bonus:Number(card.querySelector("[data-field='bonus']")?.value)||0,equipped:card.querySelector("[data-field='equipped']")?.checked||false})}); data.items=[]; document.querySelectorAll("[data-kind='item']").forEach(card=>{data.items.push({name:card.querySelector("[data-field='name']")?.value||'',qty:Number(card.querySelector("[data-field='qty']")?.value)||1,notes:card.querySelector("[data-field='notes']")?.value||''})}); return data}
  function deserialize(data){document.querySelectorAll("#powers-container>* , #weapons-container>* , #armor-container>* , #items-container>*").forEach(n=>n.remove()); Object.entries(data||{}).forEach(([k,v])=>{const el=$(k); if(el){ if(el.type==='checkbox') el.checked=!!v; else el.value=v; }}); (data.powers||[]).forEach(p=>addPower(p)); (data.weapons||[]).forEach(w=>addWeapon(w)); (data.armor||[]).forEach(a=>addArmor(a)); (data.items||[]).forEach(i=>addItem(i));}
  function toast(text){let t=document.querySelector('.toast'); if(!t){t=document.createElement('div'); t.className='toast'; document.body.appendChild(t);} t.textContent=text; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200)}
  $('icon-encounter').addEventListener('click',()=>{$('round-pill').textContent='Round '+round; $('encounter-overlay').classList.remove('hidden')}); $('enc-close').addEventListener('click',()=>$('encounter-overlay').classList.add('hidden')); $('next-round').addEventListener('click',()=>{round+=1; localStorage.setItem('enc-round',String(round)); $('round-pill').textContent='Round '+round; const sb=$('sp-bar'); if(sb){ const max=Number(sb.max)||0; const setSP=(v)=>{ sb.value=Math.max(0, Math.min(max, v)); const spt=$('sp-total'); if(spt) spt.textContent=`${sb.value}/${max}`; }; setSP(max);} }); $('reset-encounter').addEventListener('click',()=>{round=1; localStorage.setItem('enc-round','1'); $('round-pill').textContent='Round 1'});
  buildSkillsUI(); buildSavesUI(); updateAll(); setTimeout(()=>{booting=false},100);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const groups = ['alignment','classification','primary','origin'];
  groups.forEach(g => {
    const pill = document.getElementById(`perk-${g}-state`);
    const btnUse = document.getElementById(`perk-${g}-use`);
    const btnReset = document.getElementById(`perk-${g}-reset`);
    function setUsed(v){
      if(!pill) return;
      pill.textContent = v ? 'Used' : 'Ready';
      pill.classList.toggle('pill-used', !!v);
    }
    if(btnUse) btnUse.addEventListener('click', (e)=>{ e.preventDefault?.(); setUsed(true); });
    if(btnReset) btnReset.addEventListener('click', (e)=>{ e.preventDefault?.(); setUsed(false); });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = id => document.getElementById(id);
  const num = v => { const n = Number(v); return Number.isFinite(n) ? n : 0; };

  // Wire SP quick buttons
  document.querySelectorAll('.sp-step').forEach(b => {
    if (b.dataset.bound) return;
    b.addEventListener('click', (e) => {
      e.preventDefault();
      const d = Number(b.dataset.d || 0);
      if (!d) return;
      if (typeof window.spAdjust === 'function') {
        window.spAdjust(d);
      } else {
        const sb = $('sp-bar'); if (!sb) return;
        const max = num(sb.max), cur = num(sb.value);
        const next = Math.max(0, Math.min(max, cur + d));
        sb.value = next;
        const spt = $('sp-total'); if (spt) spt.textContent = `${next}/${max}`;
        try { localStorage.setItem('sp-current', String(next)); } catch(e){}
      }
    });
    b.dataset.bound = '1';
  });

  // Cinematic Action Point state
  function setCapUsed(v){
    const pill = $('cap-state');
    if (pill) { pill.textContent = v ? 'Used' : 'Ready'; pill.classList.toggle('pill-used', !!v); }
    try { localStorage.setItem('cap-used', v ? '1' : '0'); } catch(e){}
  }
  const capUse = $('cap-use'), capReset = $('cap-reset');
  if (capUse && !capUse.dataset.bound) { capUse.addEventListener('click', (e)=>{ e.preventDefault(); setCapUsed(true); }); capUse.dataset.bound='1'; }
  if (capReset && !capReset.dataset.bound) { capReset.addEventListener('click', (e)=>{ e.preventDefault(); setCapUsed(false); }); capReset.dataset.bound='1'; }
  try { const saved = localStorage.getItem('cap-used'); if (saved) setCapUsed(saved === '1'); } catch(e){}
});
</script>
<script>
// v20 — Ensure Skills/Saves content and auto-calc stay present
(function(){
  const $ = id => document.getElementById(id);
  const num = v => { const n = Number(v); return Number.isFinite(n) ? n : 0; };
  const mod = v => Math.floor((v - 10) / 2);
  const setText = (el, val) => { if (!el) return; if ('value' in el) el.value = val; else el.textContent = val; };

  function abilityModFrom(id){
    const el = $(id);
    let v = 10;
    if (el){
      if ('value' in el && el.value !== '') v = Number(el.value);
      else if (el.textContent) v = Number(el.textContent);
    }
    if (!Number.isFinite(v)) v = 10;
    return mod(v);
  }

  function updateSkillsAndSaves(){
    const pb = num($('prof-bonus')?.value) || 2;
    const mods = { str:0,dex:0,con:0,int:0,wis:0,cha:0 };
    ['str','dex','con','int','wis','cha'].forEach(a => mods[a] = abilityModFrom(a));

    // Update ability mod pills when present
    Object.keys(mods).forEach(a => {
      const pill = $(a+'-mod');
      if (pill) setText(pill, (mods[a] >= 0 ? '+' : '') + mods[a]);
    });

    // Skills
    document.querySelectorAll('#skills-container .skill-row').forEach(row => {
      const sid = row.getAttribute('data-skill');
      const abil = row.getAttribute('data-abil') || 'int';
      const out  = $('skill-'+sid);
      if (!out) return;
      const prof = $('prof-'+sid)?.checked;
      const exp  = $('exp-'+sid)?.checked;
      const total = mods[abil] + (exp ? pb*2 : (prof ? pb : 0));
      setText(out, total);
    });

    // Saves
    document.querySelectorAll('#saves-container .save-row').forEach(row => {
      const a = row.getAttribute('data-save');
      const out = $('savev-'+a);
      if (!out) return;
      const prof = $('save-'+a)?.checked;
      setText(out, mods[a] + (prof ? pb : 0));
    });

    // Power Save DC (if present)
    const dc = $('power-save-dc'), psa = $('power-save-ability');
    if (dc){
      const base = (psa && psa.value) || 'wis';
      setText(dc, 8 + pb + (mods[base] || 0));
    }
  }

  function bindRecalc(){
    document.querySelectorAll('input, select').forEach(el => {
      const id=(el.id||'').toLowerCase(), nm=(el.name||'').toLowerCase();
      if (/(str|dex|con|int|wis|cha|prof|ability)/.test(id+nm)){
        if (!el.__boundSkill){ el.addEventListener('input', updateSkillsAndSaves); el.addEventListener('change', updateSkillsAndSaves); el.__boundSkill = 1; }
      }
    });
  }

  function start(){
    updateSkillsAndSaves();
    bindRecalc();
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start);
  else start();

  // Re-apply after small delay and on DOM changes
  /* removed auto-rerun: setTimeout(start, 250); */
/* removed MutationObserver auto-rerun to prevent infinite refresh loop */
})();
</script>
<script>
(function(){
  try {
    if (typeof spAdjust === 'function') window.spAdjust = spAdjust;
    if (typeof hpAdjust === 'function') window.hpAdjust = hpAdjust;
  } catch (e) {}
  try {
    var btn = document.getElementById('icon-export');
    if (btn && !btn.__bound__) {
      btn.addEventListener('click', function(){
        if (typeof buildPrintSheet === 'function') buildPrintSheet();
        setTimeout(function(){ try { window.print(); } catch(e){} }, 0);
      });
      btn.__bound__ = true;
    }
  } catch (e) {}
  try {
    var logBtn = document.getElementById('icon-log');
    if (logBtn && logBtn.__bound__ !== true) {
      // guard for double-binding; if main script already bound, skip
      logBtn.__bound__ = true;
    }
  } catch (e) {}
})();
</script>
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  function num(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
  function mod(score){ return Math.floor((num(score)-10)/2); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function initBarsAtBoot(){
    // Ensure we don't fire zero alerts during boot
    try { window.booting = true; } catch(e){}

    // HP: total = Tier Roll + Bonus HP
    const hb = $('hp-bar');
    if (hb) {
      const roll = num($('hp-roll') && $('hp-roll').value);
      const bonus = num($('hp-bonus') && $('hp-bonus').value);
      const total = roll + bonus;
      hb.max = total || 0;
      // Default to full on first load / empty value
      if (!hb.hasAttribute('data-init') || !num(hb.value)) {
        hb.value = hb.max;
        hb.setAttribute('data-init', '1');
      }
      const temp = num($('hp-temp') && $('hp-temp').value);
      const pill = $('hp-total');
      if (pill) pill.textContent = `${num(hb.value)}/${num(hb.max)}` + (temp ? ` (+${temp})` : ``);
    }

    // SP: base = 5 + CON mod
    const sb = $('sp-bar');
    if (sb) {
      const con = $('con') && $('con').value || 10;
      const base = 5 + mod(con);
      sb.max = base || 0;
      if (!sb.hasAttribute('data-init') || !num(sb.value)) {
        sb.value = sb.max;
        sb.setAttribute('data-init', '1');
      }
      const temp = num($('sp-temp') && $('sp-temp').value);
      const pill = $('sp-total');
      if (pill) pill.textContent = `${num(sb.value)}/${num(sb.max)}` + (temp ? ` (+${temp})` : ``);
    }

    // Release booting flag shortly after initial paint
    setTimeout(function(){ try { window.booting = false; } catch(e){} }, 150);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBarsAtBoot, { once: true });
  } else {
    initBarsAtBoot();
  }
})();
</script>
<script>
(function(){
  const $=id=>document.getElementById(id);
  const num=v=>isFinite(+v)?+v:0;
  const mod=s=>Math.floor((num(s)-10)/2);
  function safe(fn){ try{ fn(); }catch(e){} }

  function init(){
    window.booting = true;

    safe(()=>{
      const hb=$('hp-bar'), roll=$('hp-roll'), bonus=$('hp-bonus'), pill=$('hp-total'), temp=$('hp-temp');
      if(hb){
        let total = 0;
        if (roll && bonus) total = num(roll.value) + num(bonus.value);
        if (!total) total = num(hb.max) || 10;     // fall back to markup default
        hb.max = total; if(!num(hb.value)) hb.value = hb.max;
        if(pill) pill.textContent = `${num(hb.value)}/${num(hb.max)}` + (temp && num(temp.value) ? ` (+${num(temp.value)})` : ``);
      }
    });

    safe(()=>{
      const sb=$('sp-bar'), con=$('con'), pill=$('sp-total'), temp=$('sp-temp');
      if(sb){
        let base = 5 + mod(con && con.value ? con.value : 10);
        if (!base) base = num(sb.max) || 5;        // fall back to markup default
        sb.max = base; if(!num(sb.value)) sb.value = sb.max;
        if(pill) pill.textContent = `${num(sb.value)}/${num(sb.max)}` + (temp && num(temp.value) ? ` (+${num(temp.value)})` : ``);
      }
    });

    setTimeout(()=>{ window.booting=false; },150);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true });
  } else {
    init();
  }
})();
</script>
<script>
// Set this if your old saves lived under a different RTDB path (e.g., 'CCCCG')
// window.FIREBASE_COLLECTION = 'characters';
</script>
<script type="module">
(async () => {
  const cfgEl = document.getElementById('firebase-config');
  if (!cfgEl) return;
  let cfg = null;
  try { cfg = JSON.parse(cfgEl.textContent); } catch(e){ return; }
  if (!cfg || !cfg.measurementId) return;
  try {
    const [{ initializeApp }, { getAnalytics }] = await Promise.all([
      import('https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js'),
      import('https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js')
    ]);
    let app;
    try { app = window.firebaseApp || initializeApp(cfg); window.firebaseApp = app; } catch(e){ app = window.firebaseApp; }
    getAnalytics(app);
    console.log('[Tracker] Firebase Analytics initialized.');
  } catch(e){ /* ignore */ }
})();
</script>
<script type="module">
/**
 * Catalyst Core Save/Load – RTDB-first (rewritten)
 * - Discovers existing saves across multiple RTDB paths
 * - Tries both encoded and raw keys
 * - Prefers the path with the most saves as canonical write target
 * - Falls back to localStorage if RTDB unavailable
 */
(async () => {
  const $ = (id) => document.getElementById(id);
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const DECODE = (s) => { try { return decodeURIComponent(s); } catch { return s; } };
  const ENCODE = (s) => { try { return encodeURIComponent(String(s)); } catch { return String(s); } };
  const TITLE = () => $('id-modal-title');
  const MODAL = () => document.getElementById('id-overlay');
  const INPUT = () => $('modal-doc-id');
  const NOTE  = () => document.getElementById('storage-mode-note') || { textContent: '' };
  const CLOUD_SCAN_INFO = () => document.getElementById('cloud-scan-info');
  const CLOUD_LIST = () => document.getElementById('cloud-save-list');
  const LOCAL_LIST = () => document.getElementById('save-slot-list');

  // --- Firebase boot ---
  let app = null, db = null, auth = null, rtdbReady = false;
  let CANDIDATES = window.RTDB_LIST_CANDIDATES && Array.isArray(window.RTDB_LIST_CANDIDATES) && window.RTDB_LIST_CANDIDATES.length
    ? window.RTDB_LIST_CANDIDATES.slice()
    : (window.FIREBASE_COLLECTION ? [window.FIREBASE_COLLECTION] : ['saves']);

  async function initFirebase() {
    // Grab config from JSON script
    const cfgEl = document.getElementById('firebase-config');
    if (!cfgEl) return;
    let cfg = null;
    try { cfg = JSON.parse(cfgEl.textContent); } catch {}
    if (!cfg || !cfg.apiKey || !cfg.databaseURL) return;

    const [{ initializeApp }, { getAuth, signInAnonymously, onAuthStateChanged }, { getDatabase, ref, get }] = await Promise.all([
      import('https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js'),
      import('https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js'),
      import('https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js')
    ]);

    try { app = window.firebaseApp || initializeApp(cfg); window.firebaseApp = app; }
    catch { app = window.firebaseApp; }
    auth = getAuth(app);
    await new Promise(res => onAuthStateChanged(auth, () => res(), () => res()));
    if (!auth.currentUser) { try { await signInAnonymously(auth); } catch {} }
    db = getDatabase(app);
    rtdbReady = !!db;
    if (rtdbReady) NOTE().textContent = 'Storage: Cloud (Realtime DB)';
    return { getDatabase, ref, get };
  }

  // --- Discovery across candidate paths ---
  async function discoverSaves() {
    const { ref, get } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js');
    if (!db) return { all: [], byPath: {}, primaryPath: null };
    const byPath = {};
    const all = [];
    const scanned = [];

    for (const path of CANDIDATES) {
      scanned.push(path);
      try {
        const snap = await get(ref(db, '/' + path));
        if (snap.exists()) {
          const obj = snap.val() || {};
          const rows = Object.keys(obj).map(id => {
            const rec = obj[id] || {};
            return {
              id: DECODE(id),
              rawId: id,
              path,
              updatedAt: Number(rec.updatedAt || 0),
              hasData: typeof rec.data !== 'undefined'
            };
          });
          rows.sort((a,b)=>b.updatedAt - a.updatedAt);
          byPath[path] = rows;
          rows.forEach(r => all.push(r));
        }
      } catch { /* ignore this path */ }
    }
    // choose primary path: most entries; tie -> first in candidates
    let primaryPath = null;
    let maxLen = -1;
    for (const p of CANDIDATES) {
      const len = (byPath[p] || []).length;
      if (len > maxLen) { maxLen = len; primaryPath = p; }
    }
    if (!primaryPath) primaryPath = CANDIDATES[0] || 'characters';

    if (CLOUD_SCAN_INFO()) CLOUD_SCAN_INFO().textContent = 'Cloud scanned: ' + (scanned.join(', ') || '(none)') + ' — found ' + all.length;
    return { all, byPath, primaryPath };
  }

  // --- Unified service ---
  const Service = {
    state: { discovered: null, primaryPath: null },

    async ensure() {
      if (!rtdbReady) await initFirebase();
      if (rtdbReady && !this.state.discovered) {
        this.state.discovered = await discoverSaves();
        this.state.primaryPath = this.state.discovered.primaryPath;
      }
      return rtdbReady;
    },

    async list() {
      const ok = await this.ensure();
      if (!ok) return { cloud: [], local: listLocal() };
      const { all } = this.state.discovered || { all: [] };
      // Unique by name, keep newest
      const map = new Map();
      for (const r of all) {
        const key = r.id.toLowerCase().trim();
        const prev = map.get(key);
        if (!prev || r.updatedAt > prev.updatedAt) map.set(key, r);
      }
      const uni = Array.from(map.values()).sort((a,b)=>b.updatedAt - a.updatedAt);
      return { cloud: uni, local: listLocal() };
    },

    async save(name, data) {
      const ok = await this.ensure();
      if (ok) {
        const { ref, set } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js');
        const path = this.state.primaryPath || 'characters';
        const key = ENCODE(name);
        const p = `/${path}/${key}`;
        await set(ref(db, p), { data, updatedAt: Date.now(), by: (auth && auth.currentUser && auth.currentUser.uid) || null, name });
        // refresh discovery cache lazily
        this.state.discovered = null;
        localStorage.setItem('last-save-key', name);
        return { where: 'cloud', path };
      }
      // Local fallback
      localSave(name, data);
      return { where: 'local' };
    },

    async load(name) {
      const ok = await this.ensure();
      if (ok) {
        const { ref, get } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js');
        const { all } = this.state.discovered || { all: [] };
        const target = pickBestMatch(all, name);
        if (target) {
          // Try encoded first, then raw
          const encP = `/${target.path}/${ENCODE(target.id)}`;
          const rawP = `/${target.path}/${target.id}`;
          let snap = await get(ref(db, encP));
          if (!snap.exists()) snap = await get(ref(db, rawP));
          if (snap.exists()) {
            const val = snap.val();
            return { where: 'cloud', data: (val && val.data) || null, path: target.path };
          }
        }
      }
      // Local fallback
      const raw = localStorage.getItem('save:'+name);
      if (raw) return { where: 'local', data: JSON.parse(raw) };
      return null;
    }
  };

  // --- Helpers: local storage ---
  function listLocal() {
    const out = [];
    try {
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if (k && k.startsWith('save:')) out.push({ id: k.substring(5), updatedAt: 0, path: 'local' });
      }
    } catch {}
    out.sort((a,b)=>a.id.localeCompare(b.id));
    return out;
  }
  function localSave(name, data) {
    try {
      localStorage.setItem('save:'+name, JSON.stringify(data||{}));
      localStorage.setItem('last-save-key', name);
    } catch {}
  }
  function pickBestMatch(rows, name) {
    if (!rows || !rows.length) return null;
    const n = name.trim().toLowerCase();
    // exact (case-insensitive)
    let best = rows.find(r => r.id.toLowerCase() === n);
    if (best) return best;
    // fuzzy: startsWith
    best = rows.find(r => r.id.toLowerCase().startsWith(n));
    if (best) return best;
    // fallback: most recent
    return rows[0];
  }

  // --- UI wiring (capture phase to own the flow) ---
  function renderLists(list) {
    const cHost = CLOUD_LIST();
    const lHost = LOCAL_LIST();
    if (cHost) {
      if (!list.cloud.length) cHost.innerHTML = '<em>No cloud saves found.</em>';
      else {
        cHost.innerHTML = list.cloud.map(r =>
          '<div class="slot-row" data-k="'+r.id.replace(/</g,'&lt;')+'" style="padding:4px 6px; border:1px solid var(--line,#ccc); margin-bottom:4px; border-radius:4px; cursor:pointer;">'
          + r.id.replace(/</g,'&lt;')
          + ' <button data-cloud-load="'+r.id.replace(/"/g,'&quot;')+'" style="float:right">Load</button>'
          + '</div>'
        ).join('');
        cHost.querySelectorAll('[data-cloud-load]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault(); e.stopPropagation();
            const id = btn.getAttribute('data-cloud-load');
            const res = await Service.load(id);
            if (res && res.data) {
              if (typeof window.deserialize==='function') window.deserialize(res.data);
              if (typeof window.updateAll==='function') window.updateAll();
              alert('Loaded from cloud "'+id+'".');
              MODAL().classList.add('hidden');
            } else alert('Could not load "'+id+'".');
          });
        });
        cHost.querySelectorAll('.slot-row').forEach(row=>{
          row.addEventListener('click', ()=>{ if (INPUT()) INPUT().value = row.dataset.k; });
        });
      }
    }
    if (lHost) {
      if (!list.local.length) lHost.innerHTML = '<em>No local saves.</em>';
      else {
        lHost.innerHTML = list.local.map(r =>
          '<div class="slot-row" data-k="'+r.id.replace(/</g,'&lt;')+'" style="padding:4px 6px; border:1px solid var(--line,#ccc); margin-bottom:4px; border-radius:4px; cursor:pointer;">'
          + r.id.replace(/</g,'&lt;')
          + ' <button data-local-load="'+r.id.replace(/"/g,'&quot;')+'" style="float:right">Load</button>'
          + '</div>'
        ).join('');
        lHost.querySelectorAll('[data-local-load]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault(); e.stopPropagation();
            const id = btn.getAttribute('data-local-load');
            const raw = localStorage.getItem('save:'+id);
            if (!raw) return alert('No local save "'+id+'".');
            try {
              const data = JSON.parse(raw);
              if (typeof window.deserialize==='function') window.deserialize(data);
              if (typeof window.updateAll==='function') window.updateAll();
              alert('Loaded locally "'+id+'".');
              MODAL().classList.add('hidden');
            } catch (err) { alert('Local load failed: '+err.message); }
          });
        });
        lHost.querySelectorAll('.slot-row').forEach(row=>{
          row.addEventListener('click', ()=>{ if (INPUT()) INPUT().value = row.dataset.k; });
        });
      }
    }
  }

  function openModal(mode) {
    if (!MODAL()) return;
    TITLE().textContent = mode === 'save' ? 'Save Character' : 'Load Character';
    INPUT().value = localStorage.getItem('last-save-key') || (document.getElementById('vigilanteName')?.value || '');
    MODAL().classList.remove('hidden');
    // populate lists
    Service.list().then(renderLists);
  }

  function bindUI() {
    const saveBtn = $('icon-save');
    const loadBtn = $('icon-load');
    const confirm = $('modal-confirm');
    const cancel = $('modal-cancel');

    if (saveBtn && !saveBtn.__bound) {
      saveBtn.addEventListener('click', (e) => { e.stopImmediatePropagation(); openModal('save'); }, { capture: true });
      saveBtn.__bound = true;
    }
    if (loadBtn && !loadBtn.__bound) {
      loadBtn.addEventListener('click', (e) => { e.stopImmediatePropagation(); openModal('load'); }, { capture: true });
      loadBtn.__bound = true;
    }
    if (confirm && !confirm.__bound) {
      confirm.addEventListener('click', async (e) => {
        e.stopImmediatePropagation();
        const name = (INPUT().value || '').trim();
        if (!name) return alert('Please enter a name.');
        const isSave = /save/i.test(TITLE().textContent) && !/load/i.test(TITLE().textContent);
        if (isSave) {
          const data = (typeof window.serialize==='function') ? window.serialize() : {};
          const res = await Service.save(name, data);
          alert(res.where === 'cloud' ? `Saved to cloud as "${name}".` : `Saved locally as "${name}".`);
          MODAL().classList.add('hidden');
        } else {
          const res = await Service.load(name);
          if (!res || !res.data) return alert(`No save named "${name}".`);
          if (typeof window.deserialize==='function') window.deserialize(res.data);
          if (typeof window.updateAll==='function') window.updateAll();
          alert(res.where === 'cloud' ? `Loaded from cloud "${name}".` : `Loaded locally "${name}".`);
          MODAL().classList.add('hidden');
        }
      }, { capture: true });
      confirm.__bound = true;
    }
    if (cancel && !cancel.__bound) {
      cancel.addEventListener('click', (e) => { e.stopImmediatePropagation(); MODAL().classList.add('hidden'); }, { capture: true });
      cancel.__bound = true;
    }
  }

  // Boot
  try { await Service.ensure(); } catch {}
  bindUI();
})();
</script>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const num = (v) => { const n = Number(v); return Number.isFinite(n) ? n : 0; };
  const mod = (score) => Math.floor((num(score) - 10) / 2);

  function updateHp(){
    const hb = $('hp-bar'); if (!hb) return;
    const roll  = $('hp-roll'), bonus = $('hp-bonus'), temp = $('hp-temp');
    let max = 0;
    if (roll && bonus) max = num(roll.value) + num(bonus.value);
    if (!max) max = num(hb.max) || 10;  // fallback
    hb.max = max;
    if (!num(hb.value) || num(hb.value) > max) hb.value = max;
    const pill = $('hp-total');
    if (pill) pill.textContent = `${num(hb.value)}/${num(hb.max)}` + (temp && num(temp.value) ? ` (+${num(temp.value)})` : '');
  }

  function updateSp(){
    const sb = $('sp-bar'); if (!sb) return;
    const con = $('con'); const temp = $('sp-temp');
    let max = 5 + mod(con && con.value ? con.value : 10);
    if (!max) max = num(sb.max) || 5;  // fallback
    sb.max = max;
    if (!num(sb.value) || num(sb.value) > max) sb.value = max;
    const pill = $('sp-total');
    if (pill) pill.textContent = `${num(sb.value)}/${num(sb.max)}` + (temp && num(temp.value) ? ` (+${num(temp.value)})` : '');
  }

  // Public hook if other scripts want to refresh bars after changes
  window.refreshBarsSafe = function(){
    try { updateHp(); } catch(e){}
    try { updateSp(); } catch(e){}
  };

  function init(){
    try { window.booting = true; } catch(e){}
    window.refreshBarsSafe();
    // release the booting flag shortly after paint to avoid any false "0" alerts during init
    setTimeout(function(){ try { window.booting = false; } catch(e){} }, 150);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true });
  } else {
    init();
  }
})();
</script>
</body>
</html>