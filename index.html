<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Hero Dossier</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1115;--panel:#171a21;--text:#e6e9ef;--sub:#a9b0bb;--accent:#3cc6ff;--hover:#24a9e0;--shadow:0 10px 30px rgba(0,0,0,.35)}
*{box-sizing:border-box}
html{height:100%;-webkit-text-size-adjust:100%}
body{margin:0;height:100%;overflow-x:hidden;background:var(--bg);color:var(--text);font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif;line-height:1.45;-webkit-font-smoothing:antialiased;-webkit-overflow-scrolling:touch}
header{position:sticky;top:0;z-index:20;background:var(--panel);padding:calc(14px + env(safe-area-inset-top)) 16px 10px;box-shadow:var(--shadow)}
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{margin:0;font-size:1.25rem;color:var(--accent);font-weight:700}
.actions{display:flex;gap:8px}
.icon-btn{width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--accent);background:#0b0d12;border-radius:10px;color:var(--accent)}
.icon-btn:active{transform:translateY(1px)}
.icon-tiny{width:32px;height:32px;border-radius:8px}
.tabs{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
.tab{flex:1 0 120px;text-align:center;border:1px solid var(--accent);background:#0b0d12;color:var(--text);border-radius:10px;padding:10px 12px;font-weight:700}
.tab.active{background:var(--accent);color:#041019}
main{max-width:980px;width:min(100%,980px);margin:16px auto;padding:0 12px calc(16px + env(safe-area-inset-bottom))}
section{background:var(--panel);border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:var(--shadow)}
section h2{margin:0 0 10px;font-size:1.05rem;color:var(--accent)}
.grid{display:grid;gap:12px}
.grid-1{grid-template-columns:1fr}
.grid-2{grid-template-columns:1fr}
.grid-3{grid-template-columns:1fr}
@media(min-width:820px){.grid-2{grid-template-columns:repeat(2,1fr)}.grid-3{grid-template-columns:repeat(3,1fr)}}
label{display:block;font-size:.95rem;font-weight:700;margin-bottom:6px}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.inline>*{min-width:0}
input,select,textarea,button{width:100%;border:1px solid var(--accent);background:#0b0d12;color:var(--text);border-radius:12px;padding:12px;font-size:16px;line-height:1.2}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--hover)}
button{background:var(--accent);color:#041019;border:none;font-weight:700;min-height:44px;touch-action:manipulation}
button:active{transform:translateY(1px)}
.btn-sm{padding:8px 10px;border-radius:10px;min-height:36px}
textarea{min-height:100px}
.compact input,.compact select{min-height:44px}
.btns>button{flex:1 0 110px;white-space:nowrap}
.pill{display:inline-block;padding:6px 10px;border:1px solid var(--accent);border-radius:999px;color:var(--accent);font-size:.85rem;white-space:nowrap}
.perk{font-size:.95rem;color:var(--accent)}
.muted{color:var(--sub)}
progress{width:100%;height:18px;-webkit-appearance:none;appearance:none;border:none;border-radius:999px;overflow:hidden;background:#0b0d12}
progress::-webkit-progress-bar{background:#0b0d12}
progress::-webkit-progress-value{background:var(--accent)}
.two{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.cols-2{display:grid;grid-template-columns:1fr;gap:8px}
@media(min-width:820px){.cols-2{grid-template-columns:1fr 1fr}}
.check{display:inline-flex;align-items:center;gap:6px}
.checkbox{width:auto;margin:0}
.death-saves{margin-top:12px}
.hp-top{order:-1}
.hidden{display:none}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;padding:16px}
.overlay.hidden{display:none!important}
.modal-card{background:var(--panel);border:1px solid var(--accent);border-radius:16px;max-width:800px;width:100%;padding:16px;box-shadow:var(--shadow)}
.modal-card h3{margin:0 0 8px;color:var(--accent);font-size:1.05rem}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--panel);border:1px solid var(--accent);padding:10px 12px;border-radius:12px;opacity:0;transform:translateY(10px);transition:opacity .2s, transform .2s;z-index:2000}
.toast.show{opacity:1;transform:translateY(0)}
.extra-grid{display:grid;gap:10px;grid-template-columns:1fr}
@media(min-width:820px){.extra-grid{grid-template-columns:1fr 1fr}}
.extra-item label{display:block;margin-bottom:6px}
.card{border:1px solid rgba(60,198,255,.25);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px}
.subhead{display:flex;align-items:center;justify-content:space-between;gap:8px}
.small{font-size:.9rem}
.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.conditions{display:flex;flex-wrap:wrap;gap:8px}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--accent);padding:6px 10px;border-radius:999px}
.sticky-combat{position:sticky;top:calc(64px + env(safe-area-inset-top));z-index:9}
.catalog-list{max-height:360px;overflow:auto;border:1px solid rgba(60,198,255,.25);border-radius:12px;padding:8px}
.catalog-item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px;border-bottom:1px solid rgba(60,198,255,.15)}
.catalog-item:last-child{border-bottom:none}
.catalog-filter{display:flex;gap:8px;align-items:center;margin:8px 0}
.badge{display:inline-block;border:1px solid rgba(60,198,255,.5);padding:2px 6px;border-radius:999px;font-size:.8rem;margin-left:6px}
.compact-btn{padding:8px 10px;border-radius:10px}
.preview{font-size:.9rem;color:var(--sub)}
.perk-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.bar-wrap{position:relative;width:100%}
.bar-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:14px;pointer-events:none}
.bar-overlay.hidden{display:none}
@media print{header,.tabs,.actions,#tools,.sticky-combat .btns,.icon-btn,.modal-card,.overlay{display:none!important} body{background:#fff;color:#000} section{box-shadow:none;border:1px solid #ccc} .pill{border-color:#000;color:#000}}
.sheet{display:none}
.sheet-cs{page-break-inside:avoid;background:#fff;color:#000;border:1px solid #000;border-radius:8px;padding:16px}
.cs-title{font-weight:700}
.cs-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.cs-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.cs-kv{display:flex;justify-content:space-between;gap:12px;border-bottom:1px solid #000;padding:6px 0}
.cs-box{border:1px solid #000;padding:10px;border-radius:8px}
@media print{main{display:none!important} #ccsheet{display:block!important} body{background:#fff!important;color:#000!important}}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <h1>Hero Dossier</h1>
    <div class="actions">
      <button id="icon-encounter" class="icon-btn" aria-label="Encounter Tracker" title="Encounter Tracker">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path d="M8 6h13M3 12h18M3 18h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <button id="icon-export" class="icon-btn" aria-label="Export / Print" title="Export / Print">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path d="M6 9V3h12v6M6 14h12v7H6z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M8 14V9h8v5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
      </button>
      <button id="icon-load" class="icon-btn" aria-label="Load from Cloud" title="Load from Cloud">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path d="M19 18a3 3 0 0 0 0-6h-1.26A8 8 0 1 0 4 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 7v10m0 0l-3-3m3 3l3-3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button id="icon-save" class="icon-btn" aria-label="Save to Cloud" title="Save to Cloud">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path d="M19 18a3 3 0 0 0 0-6h-1.26A8 8 0 1 0 4 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 17V7m0 0l-3 3m3-3l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button id="icon-log" class="icon-btn" aria-label="Open Activity Log" title="Open Activity Log">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 7v6l4 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" data-go="combat">Combat</button>
    <button class="tab" data-go="abilities">Abilities</button>
    <button class="tab" data-go="powers">Powers</button>
    <button class="tab" data-go="gear">Gear</button>
    <button class="tab" data-go="story">Story</button>
  </div>
</header>
<main>
  <section id="tools" data-tab="combat">
    <h2>Tools</h2>
    <div class="grid grid-2">
      <div>
        <label>Dice Roller</label>
        <div class="row compact">
          <select id="dice-type"><option value="4">d4</option><option value="6">d6</option><option value="8">d8</option><option value="10">d10</option><option value="12">d12</option><option value="20">d20</option><option value="100">d100</option></select>
          <input id="dice-count" type="number" inputmode="numeric" class="num" value="1" min="1">
          <button id="roll-dice">Roll</button>
        </div>
        <div id="dice-result" class="muted"></div>
      </div>
      <div>
        <label>Coin Flip</label>
        <div class="inline compact"><button id="flip-coin">Flip</button><span id="coin-result" class="pill"></span></div>
      </div>
    </div>
  </section>

  <section id="resources" data-tab="combat" class="sticky-combat">
    <h2>Combat Stats</h2>
    <div class="grid grid-1">
      <div>
        <div class="cols-2">
          <div class="card">
            <label>HP</label>
            <div class="two hp-top">
              <div class="bar-wrap">
                <progress id="hp-bar" value="0" max="0"></progress>
                <span id="hp-skull" class="bar-overlay hidden" aria-hidden="true">ðŸ’€</span>
              </div>
              <span id="hp-total" class="pill">0/0</span>
            </div>
            <div class="row"><input id="hp-roll" type="number" inputmode="numeric" placeholder="Tier Roll"><input id="hp-bonus" type="number" inputmode="numeric" placeholder="Bonus HP"><input id="hp-temp" type="number" inputmode="numeric" placeholder="Temp HP"></div>
            <div class="row btns"><input id="hp-dmg" type="number" inputmode="numeric" placeholder="Amount"><button data-d="-1" class="hp-step">-1</button><button data-d="-5" class="hp-step">-5</button><button data-d="-10" class="hp-step">-10</button><button id="hp-take">Damage</button><button id="hp-heal">Heal</button><button id="hp-reset">Reset HP</button></div>
            <div class="inline death-saves">
              <span class="muted" style="min-width:max-content">Death Saves:</span>
              <label class="check" for="ds1"><input id="ds1" type="checkbox" class="checkbox" aria-label="Death Save 1"><span>1</span></label>
              <label class="check" for="ds2"><input id="ds2" type="checkbox" class="checkbox" aria-label="Death Save 2"><span>2</span></label>
              <label class="check" for="ds3"><input id="ds3" type="checkbox" class="checkbox" aria-label="Death Save 3"><span>3</span></label>
            </div>
          </div>
          <div class="card">
            <label>SP</label>
            <div class="two"><progress id="sp-bar" value="0" max="0"></progress><span id="sp-total" class="pill">0/0</span></div>
            <div class="row"><select id="sp-rule"><option value="regen">Regen 1/round</option><option value="rest">Only on rest</option></select><input id="sp-temp" type="number" inputmode="numeric" placeholder="Temp SP"></div>
            <div class="row btns"><input id="sp-cost" type="number" inputmode="numeric" placeholder="Amount"><button data-d="-1" class="sp-step">Light -1</button><button data-d="-2" class="sp-step">Power -2</button><button data-d="-3" class="sp-step">Signature -3</button><button data-d="-5" class="sp-step">Ultimate -5</button><button id="sp-spend">Spend</button><button id="sp-reset">Reset SP</button><button id="long-rest" class="btn-sm">Long Rest</button></div>
            <label class="check" for="cinematic-AP"><input id="cinematic-AP" type="checkbox" class="checkbox"><span>Cinematic AP</span></label>
          </div>
        </div>
      </div>
      <div class="cols-2">
        <div class="card">
          <label>Initiative</label>
          <input id="initiative" type="number" inputmode="numeric" placeholder="e.g., 17">
          <label>Speed (ft)</label>
          <input id="speed" type="number" inputmode="numeric" placeholder="30">
        </div>
        <div class="card">
          <label>Passive Perception</label>
          <input id="passive-perception" type="number" readonly>
          <label>Armor/Shield Bonus (Auto)</label>
          <input id="armor-bonus" type="number" readonly>
          <label>Power/Origin Bonus</label>
          <input id="origin-bonus" type="number" inputmode="numeric" placeholder="0">
          <label>TC</label>
          <input id="tc" type="number" readonly>
        </div>
      </div>
      <div class="card">
        <label>Conditions</label>
        <div class="conditions" id="conditions">
          <label class="chip"><input type="checkbox" id="cond-stunned" class="checkbox">Stunned</label>
          <label class="chip"><input type="checkbox" id="cond-prone" class="checkbox">Prone</label>
          <label class="chip"><input type="checkbox" id="cond-exhausted" class="checkbox">Exhausted</label>
          <label class="chip"><input type="checkbox" id="cond-blinded" class="checkbox">Blinded</label>
          <label class="chip"><input type="checkbox" id="cond-charmed" class="checkbox">Charmed</label>
          <label class="chip"><input type="checkbox" id="cond-frightened" class="checkbox">Frightened</label>
        </div>
      </div>
    </div>
  </section>

  <section id="stats" data-tab="abilities">
    <h2>Ability Scores</h2>
    <div class="grid grid-3">
      <div class="card"><label>STR</label><div class="inline"><select id="str"></select><span id="str-mod" class="pill">+0</span></div></div>
      <div class="card"><label>DEX</label><div class="inline"><select id="dex"></select><span id="dex-mod" class="pill">+0</span></div></div>
      <div class="card"><label>CON</label><div class="inline"><select id="con"></select><span id="con-mod" class="pill">+0</span></div></div>
      <div class="card"><label>INT</label><div class="inline"><select id="int"></select><span id="int-mod" class="pill">+0</span></div></div>
      <div class="card"><label>WIS</label><div class="inline"><select id="wis"></select><span id="wis-mod" class="pill">+0</span></div></div>
      <div class="card"><label>CHA</label><div class="inline"><select id="cha"></select><span id="cha-mod" class="pill">+0</span></div></div>
    </div>
  </section>

  <section id="skills" data-tab="abilities">
    <h2>Skills & Proficiency</h2>
    <div class="card">
      <div class="row">
        <div style="flex:1"><label>Proficiency Bonus</label><input id="prof-bonus" type="number" inputmode="numeric" value="2"></div>
        <div style="flex:1"><label>Power Save Ability (opt)</label><select id="power-save-ability"><option value="str">STR</option><option value="dex">DEX</option><option value="con">CON</option><option value="int">INT</option><option value="wis">WIS</option><option value="cha">CHA</option></select></div>
        <div style="flex:1"><label>Power Save DC</label><input id="power-save-dc" type="number" readonly></div>
      </div>
    </div>
    <div class="card"><h3 class="small" style="margin:0 0 6px;color:var(--accent)">Skills</h3><div id="skills-container" class="grid grid-1"></div></div>
    <div class="card"><h3 class="small" style="margin:0 0 6px;color:var(--accent)">Saving Throws</h3><div id="saves-container" class="grid grid-1"></div></div>
  </section>

  <section id="powers" data-tab="powers">
    <div class="subhead">
      <h2>Powers & Special Moves</h2>
      <button id="add-power" style="max-width:200px">Add Power</button>
    </div>
    <div id="powers-container" class="grid grid-2"></div>
  </section>

  <section id="equipment" data-tab="gear">
    <h2>Equipment & Inventory</h2>
    <div class="grid grid-2">
      <div class="card">
        <div class="subhead"><label>Weapons</label><button id="add-weapon" style="max-width:160px">Add Weapon</button></div>
        <div id="weapons-container" class="grid grid-1"></div>
      </div>
      <div class="card">
        <div class="subhead"><label>Armor & Protection</label><button id="add-armor" style="max-width:160px">Add Armor</button></div>
        <div id="armor-container" class="grid grid-1"></div>
      </div>
      <div class="card" style="grid-column:1/-1">
        <div class="subhead"><label>Gear & Items</label><button id="add-item" style="max-width:160px">Add Item</button></div>
        <div id="items-container" class="grid grid-1"></div>
      </div>
    </div>
    <div class="card">
      <label>Notes</label>
      <textarea id="inventory-list" rows="4" placeholder="General inventory notes..."></textarea>
    </div>
  </section>

  <section id="story" data-tab="story">
    <h2>Character & Story</h2>
    <div class="grid grid-2">
      <div class="card"><label>Superhero Identity</label><input id="superhero-identity" placeholder="Night Guardian"></div>
      <div class="card"><label>Secret Identity</label><input id="secret-identity" placeholder="Jane Doe"></div>
      <div class="card"><label>Tier</label><select id="char-tier"><option>Tier 5 â€“ Rookie</option><option>Tier 4 â€“ Emerging Vigilante</option><option>Tier 3 â€“ Field-Tested Operative</option><option>Tier 2 â€“ Respected Force</option><option>Tier 1 â€“ Heroic Figure</option><option>Tier 0 â€“ Transcendent</option></select></div>
      <div class="card"><label>Public Identity</label><select id="publicIdentity"><option value="Public">Public</option><option value="Secret">Secret</option></select><input id="vigilanteName" type="hidden"></div>
      <div class="card"><label>Alignment</label><div class="inline"><select id="alignment"><option data-perk="Once per session, auto-succeed a Charisma check with civilians or allies">Paragon (Lawful Light)</option><option data-perk="Once per session, restore 1d6 HP or 1 SP to an ally as a bonus action">Guardian (Neutral Light)</option><option data-perk="Ignore opportunity attacks when moving toward a threat or hostage">Vigilante (Chaotic Light)</option><option data-perk="+1 to all saving throws when acting on orders or directives">Sentinel (Lawful Neutral)</option><option data-perk="Once per session, reroll any roll OR remove one condition from yourself">Outsider (True Neutral)</option><option data-perk="Advantage on Initiative and Deception once per combat">Wildcard (Chaotic Neutral)</option><option data-perk="Once per session, deal maximum damage to enemies labeled 'criminal' by GM">Inquisitor (Lawful Shadow)</option><option data-perk="Heal 1d6 HP when defeating an enemy while no allies are within 10 ft">Anti-Hero (Neutral Shadow)</option><option data-perk="Once per combat, add +1d6 damage when attacking from stealth or surprise">Renegade (Chaotic Shadow)</option></select><span id="alignment-perk" class="perk"></span></div><div class="perk-tools"><select id="perk-alignment-mode"><option value="session">Per Session</option><option value="combat">Per Combat</option><option value="rest">Per Long Rest</option></select><button id="perk-alignment-use" class="btn-sm">Mark Used</button><span id="perk-alignment-state" class="pill">Ready</span></div></div>
      <div class="card"><label>Classification</label><div class="inline"><select id="classification"><option data-perk="Reroll one failed saving throw per long rest">Mutant</option><option data-perk="Advantage on all Technology-related checks">Enhanced Human</option><option data-perk="Cast one minor magical effect per long rest">Magic User</option><option data-perk="Immune to environmental hazards; no penalty in rough terrain">Alien/Extraterrestrial</option><option data-perk="+2 to Persuasion or Intimidation checks">Mystical Being</option></select><span id="classification-perk" class="perk"></span></div><div class="perk-tools"><select id="perk-classification-mode"><option value="session">Per Session</option><option value="combat">Per Combat</option><option value="rest">Per Long Rest</option></select><button id="perk-classification-use" class="btn-sm">Mark Used</button><span id="perk-classification-state" class="pill">Ready</span></div></div>
      <div class="card"><label>Primary Power Style</label><div class="inline"><select id="primary-power-style"><option data-perk="Cut one attack by half once per combat encounter">Physical Powerhouse</option><option data-perk="Reroll 1s once per turn">Energy Manipulator</option><option data-perk="+10 ft movement and +1 AC while moving 20+ ft">Speedster</option><option data-perk="For one turn force enemies to reroll all rolls above a 17 once per rest">Telekinetic/Psychic</option><option data-perk="Create a 1â€‘min decoy illusion once per combat encounter">Illusionist</option><option data-perk="Advantage on Deception; disguise freely">Shapeâ€‘shifter</option><option data-perk="+2 to hit and +5 to damage once per turn when using elemental powers">Elemental Controller</option></select><span id="primary-power-style-perk" class="perk"></span></div><div class="perk-tools"><select id="perk-primary-mode"><option value="combat">Per Combat</option><option value="session">Per Session</option><option value="rest">Per Long Rest</option></select><button id="perk-primary-use" class="btn-sm">Mark Used</button><span id="perk-primary-state" class="pill">Ready</span></div><input id="primaryPerk" type="hidden"></div>
      <div class="card"><label>Secondary Power Style</label><select id="secondary-power-style"><option>Physical Powerhouse</option><option>Energy Manipulator</option><option>Speedster</option><option>Telekinetic/Psychic</option><option>Illusionist</option><option>Shape-shifter</option><option>Elemental Controller</option></select></div>
      <div class="card"><label>Origin Story</label><div class="inline"><select id="origin-story"><option data-perk="Resistance to one damage type">The Accident</option><option data-perk="Reroll a failed CON or INT save once per long rest">The Experiment</option><option data-perk="Use the powers of one other character you've met or are related to once per long rest">The Legacy</option><option data-perk="+5 to hit and +10 to damage when below 1/2 HP">The Awakening</option><option data-perk="Auto-success on one save or +10 to any roll once per long rest">The Pact</option><option data-perk="Once per combat, declare a Skill Move on DC 17 to use a power for free with +1d6 bonus">The Lost Time</option><option data-perk="+5 elemental damage once per round">The Exposure</option><option data-perk="If knocked out, stand with 1 HP and resistance to all damage for 1 round">The Rebirth</option><option data-perk="Create a shield once per combat reducing incoming damage to zero for one turn">The Vigil</option><option data-perk="Once per day take damage for an ally; they heal 1d6 HP and you gain advantage on saves after combat till dawn">The Redemption</option></select><span id="origin-story-perk" class="perk"></span></div><div class="perk-tools"><select id="perk-origin-mode"><option value="rest">Per Long Rest</option><option value="combat">Per Combat</option><option value="session">Per Session</option></select><button id="perk-origin-use" class="btn-sm">Mark Used</button><span id="perk-origin-state" class="pill">Ready</span></div></div>
      <div class="card" style="grid-column:1/-1"><label>Signature Move</label><div class="grid grid-2"><input id="signatureMoveName" placeholder="Name"><input id="signatureSP" placeholder="SP Cost"><input id="signatureSave" placeholder="Saving Throw"><input id="signatureSpecial" placeholder="Special"></div><textarea id="signatureMoveDescription" rows="4" placeholder="Describe the move"></textarea><textarea id="signatureMeaning" rows="3" placeholder="Why this move matters"></textarea></div>
      <div class="card" style="grid-column:1/-1"><label>Backstory</label><div class="grid grid-2"><textarea id="prePowerLife" rows="3" placeholder="Life Before Powers"></textarea><textarea id="powerMoment" rows="3" placeholder="Moment of Awakening"></textarea><textarea id="powerMeaning" rows="3" placeholder="Meaning of Power"></textarea><textarea id="powerFear" rows="3" placeholder="Greatest Fear"></textarea><textarea id="walkAway" rows="3" placeholder="What Would Make You Walk Away?"></textarea><textarea id="vulnerability" rows="3" placeholder="Vulnerability"></textarea><textarea id="secret" rows="3" placeholder="Secret"></textarea></div></div>
      <div class="card"><label>Allies & Contacts</label><div class="grid grid-2"><input id="trustedAlly" placeholder="Trusted Ally"><input id="teamAdmire" placeholder="Team You Admire"></div></div>
      <div class="card"><label>Training & Research</label><div class="grid grid-2"><textarea id="research" rows="3" placeholder="Research"></textarea><textarea id="trainTinker" rows="3" placeholder="Train or Tinker"></textarea></div></div>
      <div class="card"><label>Additional Data</label><div id="extras-container" class="extra-grid"></div></div>
    </div>
  </section>
</main>
<section id="ccsheet" class="sheet" aria-hidden="true">
  <div class="sheet-cs">
    <h2>CCCG Character Sheet</h2>
    <div class="cs-row">
      <div class="cs-box">
        <div class="cs-kv"><span class="cs-title">Hero</span><span id="cs-hero"></span></div>
        <div class="cs-kv"><span class="cs-title">Secret ID</span><span id="cs-secret"></span></div>
        <div class="cs-kv"><span class="cs-title">Tier</span><span id="cs-tier"></span></div>
        <div class="cs-kv"><span class="cs-title">Alignment</span><span id="cs-align"></span></div>
        <div class="cs-kv"><span class="cs-title">Alignment Perk</span><span id="cs-align-perk"></span></div>
        <div class="cs-kv"><span class="cs-title">Classification</span><span id="cs-class"></span></div>
        <div class="cs-kv"><span class="cs-title">Classification Perk</span><span id="cs-class-perk"></span></div>
        <div class="cs-kv"><span class="cs-title">Primary Power</span><span id="cs-ppower"></span></div>
        <div class="cs-kv"><span class="cs-title">Primary Perk</span><span id="cs-ppower-perk"></span></div>
        <div class="cs-kv"><span class="cs-title">Secondary Power</span><span id="cs-spower"></span></div>
        <div class="cs-kv"><span class="cs-title">Origin</span><span id="cs-origin"></span></div>
        <div class="cs-kv"><span class="cs-title">Origin Perk</span><span id="cs-origin-perk"></span></div>
      </div>
      <div class="cs-box">
        <div class="cs-kv"><span class="cs-title">HP</span><span id="cs-hp"></span></div>
        <div class="cs-kv"><span class="cs-title">SP</span><span id="cs-sp"></span></div>
        <div class="cs-kv"><span class="cs-title">TC</span><span id="cs-tc"></span></div>
        <div class="cs-kv"><span class="cs-title">Initiative</span><span id="cs-init"></span></div>
        <div class="cs-kv"><span class="cs-title">Speed</span><span id="cs-speed"></span></div>
        <div class="cs-kv"><span class="cs-title">Passive Perception</span><span id="cs-pp"></span></div>
        <div class="cs-kv"><span class="cs-title">Death Saves</span><span id="cs-ds"></span></div>
        <div class="cs-kv"><span class="cs-title">Conditions</span><span id="cs-conds"></span></div>
      </div>
    </div>
    <div class="cs-box" style="margin-top:8px">
      <div class="cs-title">Ability Scores</div>
      <div class="cs-grid-3" id="cs-abilities"></div>
    </div>
    <div class="cs-row" style="margin-top:8px">
      <div class="cs-box">
        <div class="cs-title">Powers</div>
        <div id="cs-powers"></div>
      </div>
      <div class="cs-box">
        <div class="cs-title">Weapons & Armor</div>
        <div id="cs-gear"></div>
      </div>
    </div>
    <div class="cs-box" style="margin-top:8px">
      <div class="cs-title">Items</div>
      <div id="cs-items"></div>
    </div>
    <div class="cs-box" style="margin-top:8px">
      <div class="cs-title">Signature Move</div>
      <div id="cs-signature"></div>
    </div>
    <div class="cs-box" style="margin-top:8px">
      <div class="cs-title">Notes & Backstory</div>
      <div id="cs-backstory"></div>
    </div>
  </div>
</section>


<div id="id-overlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="id-modal-title">
  <div class="modal-card">
    <h3 id="id-modal-title">Cloud</h3>
    <input id="modal-doc-id" placeholder="Character name (e.g., Shawn) or full path">
    <div class="modal-actions">
      <button id="modal-cancel">Cancel</button>
      <button id="modal-confirm">OK</button>
    </div>
  </div>
</div>

<div id="log-overlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="log-title">
  <div class="modal-card">
    <h3 id="log-title">Recent Log</h3>
    <div class="grid grid-2">
      <div>
        <label>Dice Rolls</label>
        <div id="log-dice" class="log"></div>
      </div>
      <div>
        <label>Coin Flips</label>
        <div id="log-coin" class="log"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button id="log-close">Close</button>
    </div>
  </div>
</div>

<div id="confirm-overlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
  <div class="modal-card">
    <h3 id="confirm-title">Confirm Delete</h3>
    <div id="confirm-msg" class="muted" style="margin-top:6px"></div>
    <div class="modal-actions">
      <button id="confirm-cancel">Cancel</button>
      <button id="confirm-ok">Delete</button>
    </div>
  </div>
</div>

<div id="catalog-overlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="catalog-title">
  <div class="modal-card">
    <h3 id="catalog-title">Add from Catalog</h3>
    <div class="catalog-filter">
      <select id="catalog-kind"><option value="weapon">Weapons</option><option value="armor">Armor</option><option value="item">Items</option><option value="power">Powers</option></select>
      <input id="catalog-search" placeholder="Search..." style="flex:1">
      <button id="catalog-custom" class="compact-btn">Create Custom</button>
      <button id="catalog-refresh" class="compact-btn">Refresh</button>
    </div>
    <div id="catalog-list" class="catalog-list"></div>
    <div class="modal-actions">
      <button id="catalog-cancel">Close</button>
      <button id="catalog-add">Add Selected</button>
    </div>
  </div>
</div>

<div id="encounter-overlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="encounter-title">
  <div class="modal-card">
    <h3 id="encounter-title">Encounter Tracker</h3>
    <div class="row"><div class="pill" id="round-pill">Round 1</div><button id="next-round" class="btn-sm">Next Round</button><button id="reset-encounter" class="btn-sm">Reset</button></div>
    <div class="row-3" style="margin-top:8px">
      <input id="enc-name" placeholder="Name">
      <input id="enc-init" type="number" placeholder="Init">
      <button id="enc-add" class="btn-sm">Add</button>
    </div>
    <div id="enc-list" class="catalog-list" style="margin-top:8px"></div>
    <div class="modal-actions"><button id="enc-close">Close</button></div>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded',()=>{
  const $=id=>document.getElementById(id);
  const abilities=['str','dex','con','int','wis','cha'];
  abilities.forEach(id=>{const sel=$(id); if(sel){for(let v=10;v<=24;v++) sel.add(new Option(v,v)); if(!sel.value) sel.value='10';}});
  const mod=v=>Math.floor((v-10)/2);
  const clamp=(v,min,max)=>Math.max(min,Math.min(v,max));
  const num=el=>{const n=Number(el?.value);return Number.isFinite(n)?n:NaN};
  const clean=v=>v==='Pick One'?'':v;
  let hpZero=false, spZero=false, death=false, initTouched=false;
  let pendingDeleteEl=null;
  let round=Number(localStorage.getItem('enc-round')||'1');

  function setTab(name){document.querySelectorAll('[data-tab]').forEach(s=>{s.style.display=(s.getAttribute('data-tab')===name)?'block':'none'}); document.querySelectorAll('.tab').forEach(b=>{b.classList.toggle('active', b.getAttribute('data-go')===name)});} 
  document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click',()=>setTab(b.getAttribute('data-go'))));
  setTab('combat');

  const diceHistory=JSON.parse(localStorage.getItem('dice-history')||'[]');
  const coinHistory=JSON.parse(localStorage.getItem('coin-history')||'[]');
  const fmt=ts=>new Date(ts).toLocaleTimeString();
  function renderLogs(){const dl=$('log-dice'), cl=$('log-coin'); if(dl) dl.innerHTML=diceHistory.slice(-10).map(e=>`<div class="log-item"><span>${fmt(e.t)}</span><b>${e.text}</b></div>`).reverse().join(''); if(cl) cl.innerHTML=coinHistory.slice(-10).map(e=>`<div class="log-item"><span>${fmt(e.t)}</span><b>${e.text}</b></div>`).reverse().join('');}
  function addDiceLog(text){diceHistory.push({t:Date.now(),text}); if(diceHistory.length>30) diceHistory.splice(0,diceHistory.length-30); localStorage.setItem('dice-history',JSON.stringify(diceHistory));}
  function addCoinLog(text){coinHistory.push({t:Date.now(),text}); if(coinHistory.length>30) coinHistory.splice(0,coinHistory.length-30); localStorage.setItem('coin-history',JSON.stringify(coinHistory));}

  const DEFAULT_CFG={databaseURL:"https://catalyst-core-e458c-default-rtdb.firebaseio.com"};
  const baseURL=(DEFAULT_CFG.databaseURL||'').replace(/\/$/,'');

  function perkFor(id){const s=$(id), out=$(id+'-perk'); if(!s||!out) return; out.textContent=s.selectedOptions[0]?.dataset?.perk||''; if(id==='primary-power-style'){const p=$('primaryPerk'); if(p) p.value=out.textContent;}}
  function updatePerks(){['alignment','classification','primary-power-style','origin-story'].forEach(perkFor)}

  function computeArmorAuto(){
    let body=[],head=[],shield=0,misc=0;
    document.querySelectorAll("input[id^='armor'][id$='Equipped']").forEach(chk=>{
      if(chk.checked){const m=chk.id.match(/^armor(\d+)Equipped$/); if(!m) return; const n=m[1]; const b=Number(document.getElementById('armor'+n+'Bonus')?.value)||0; const slot=document.getElementById('armor'+n+'Slot')?.value||'Body'; if(slot==='Body') body.push(b); else if(slot==='Head') head.push(b); else if(slot==='Shield') shield+=b; else misc+=b;}
    });
    const bodyMax=body.length?Math.max(...body):0; const headMax=head.length?Math.max(...head):0; return bodyMax+headMax+shield+misc;
  }

  function updateAbilityMods(){
    abilities.forEach(id=>{const v=num($(id)); const m=mod(Number.isNaN(v)?10:v); const b=$(id+'-mod'); if(b) b.textContent=(m>=0?'+':'')+m});
    const pp=$('passive-perception'); if(pp) pp.value=10+mod(num($('wis'))||10);
    const armorAuto=computeArmorAuto(); const ab=$('armor-bonus'); if(ab) ab.value=armorAuto;
    const tc=$('tc'); if(tc) tc.value=10+mod(num($('dex'))||10)+armorAuto+(num($('origin-bonus'))||0);
    const init=$('initiative'); if(init && !initTouched){ init.value=mod(num($('dex'))||10); }
  }

  function updateHP(){
    const hb=$('hp-bar'); if(!hb) return;
    const base=30+mod(num($('con'))||10);
    const total=base+(num($('hp-roll'))||0)+(num($('hp-bonus'))||0);
    const prev=Number(hb.value);
    const hadPrev=!Number.isNaN(prev);
    hb.max=total;
    hb.value = hadPrev ? clamp(prev,0,total) : total;
    const temp=Number($('hp-temp')?.value)||0;
    const hpt=$('hp-total');
    if(hpt) hpt.textContent=`${hb.value}/${total}`+(temp?` (+${temp})`:``);
    const skull=$('hp-skull');
    if(skull) skull.classList.toggle('hidden', hb.value>0);
    if(hb.value<=0 && !hpZero){ alert('You are in Last Stand!'); hpZero=true; }
    else if(hb.value>0 && hpZero){ hpZero=false; }
  }

  function updateSP(){
    const sb=$('sp-bar'); if(!sb) return;
    const base=5+mod(num($('con'))||10);
    const prev=Number(sb.value);
    const hadPrev=!Number.isNaN(prev);
    sb.max=base;
    sb.value = hadPrev ? clamp(prev,0,base) : base;
    const temp=Number($('sp-temp')?.value)||0;
    const spt=$('sp-total');
    if(spt) spt.textContent=`${sb.value}/${base}`+(temp?` (+${temp})`:``);
    if(sb.value<=0 && !spZero){ alert('You have run out of SP.'); spZero=true; }
    else if(sb.value>0 && spZero){ spZero=false; }
  }

  const skillDefs=[
    {id:'athletics',name:'Athletics',ability:'str'},
    {id:'acrobatics',name:'Acrobatics',ability:'dex'},
    {id:'stealth',name:'Stealth',ability:'dex'},
    {id:'perception',name:'Perception',ability:'wis'},
    {id:'insight',name:'Insight',ability:'wis'},
    {id:'survival',name:'Survival',ability:'wis'},
    {id:'investigation',name:'Investigation',ability:'int'},
    {id:'technology',name:'Technology',ability:'int'},
    {id:'medicine',name:'Medicine',ability:'wis'},
    {id:'deception',name:'Deception',ability:'cha'},
    {id:'intimidation',name:'Intimidation',ability:'cha'},
    {id:'persuasion',name:'Persuasion',ability:'cha'}
  ];

  function buildSkillsUI(){
    const cont=$('skills-container'); if(!cont) return; cont.innerHTML='';
    skillDefs.forEach(sk=>{
      const row=document.createElement('div'); row.className='row';
      row.innerHTML=`
        <div style="flex:1 1 180px"><label>${sk.name}</label></div>
        <div style="flex:0 0 90px"><span class="pill">${sk.ability.toUpperCase()}</span></div>
        <label class="check"><input id="${sk.id}-prof" type="checkbox" class="checkbox">Proficient</label>
        <label class="check"><input id="${sk.id}-exp" type="checkbox" class="checkbox">Expertise</label>
        <div style="flex:0 0 90px"><input id="${sk.id}-total" type="number" readonly></div>`;
      cont.appendChild(row);
      const pr=$(sk.id+'-prof'); if(pr) pr.addEventListener('change',updateAll); const ex=$(sk.id+'-exp'); if(ex) ex.addEventListener('change',updateAll);
    });
  }

  function buildSavesUI(){
    const cont=$('saves-container'); if(!cont) return; cont.innerHTML='';
    ['str','dex','con','int','wis','cha'].forEach(a=>{
      const name=a.toUpperCase(); const row=document.createElement('div'); row.className='row';
      row.innerHTML=`<div style="flex:1 1 160px"><label>${name} Save</label></div><label class="check"><input id="save-${a}-prof" type="checkbox" class="checkbox">Proficient</label><div style="flex:0 0 90px"><input id="save-${a}-total" type="number" readonly></div>`;
      cont.appendChild(row);
      const pr=$('save-'+a+'-prof'); if(pr) pr.addEventListener('change',updateAll);
    });
  }

  function updateSkills(){
    const pb=num($('prof-bonus'))||0;
    skillDefs.forEach(sk=>{
      const m=mod(num($(sk.ability))||10);
      const prof=$(sk.id+'-prof')?.checked?1:0;
      const exp=$(sk.id+'-exp')?.checked?1:0;
      const mult=exp?2:(prof?1:0);
      const total=m + pb*mult; const out=$(sk.id+'-total'); if(out) out.value=total;
    });
    ['str','dex','con','int','wis','cha'].forEach(a=>{
      const m=mod(num($(a))||10); const prof=$('save-'+a+'-prof')?.checked?1:0; const total=m + (prof?(num($('prof-bonus'))||0):0); const out=$('save-'+a+'-total'); if(out) out.value=total;
    });
    const key=$('power-save-ability')?.value; const pbv=num($('prof-bonus'))||0; const kmod=key?mod(num($(key))||10):0; const pdc=$('power-save-dc'); if(pdc) pdc.value=8+pbv+kmod;
  }

  function updateDerivedWeapons(){
    const pb=num($('prof-bonus'))||0;
    document.querySelectorAll('#weapons-container .card').forEach(card=>{
      const idx=card.getAttribute('data-idx');
      const abSel=$('weapon'+idx+'Ability'); const ability=(abSel?abSel.value:'str');
      const wMod=mod(num($(ability))||10);
      const prof=$('weapon'+idx+'Prof')?.checked?1:0;
      const toHit=wMod + (prof?pb:0);
      const toHitEl=$('weapon'+idx+'ToHit'); if(toHitEl) toHitEl.textContent=(toHit>=0?'+':'')+toHit;
      const dmgStr=$('weapon'+idx+'Damage')?.value||'';
      const dmgEl=$('weapon'+idx+'DmgPrev');
      const modTxt=(wMod>=0?'+':'')+wMod;
      if(dmgEl){
        const m=dmgStr.match(/^(\d+)d(\d+)([+-]\d+)?$/i);
        if(m){ dmgEl.textContent=`${m[1]}d${m[2]} ${modTxt}`; }
        else { dmgEl.textContent=(dmgStr?`${dmgStr} ${modTxt}`:modTxt); }
      }
    });
  }

  function updatePerkStates(){['alignment','classification','primary','origin'].forEach(k=>{const st=$("perk-"+k+"-state"); const used=localStorage.getItem('perk-'+k+'-used')==='1'; if(st) st.textContent=used?'Spent':'Ready';});}
  function resetPerks(kind){['alignment','classification','primary','origin'].forEach(k=>{const mode=$("perk-"+k+"-mode")?.value||'combat'; if((kind==='combat'&&mode==='combat')||(kind==='rest'&&mode!=='session')||(kind==='session')){ localStorage.setItem('perk-'+k+'-used','0'); }}); updatePerkStates();}

  function updateAll(){updatePerks();updateAbilityMods();updateHP();updateSP();updateSkills();updateDerivedWeapons();updatePerkStates();}

  const bind=id=>{const el=$(id); if(!el) return; el.addEventListener('input',updateAll); el.addEventListener('change',updateAll)};
  ['hp-roll','hp-bonus','hp-temp','sp-temp','sp-cost','origin-bonus','initiative','speed','inventory-list','superhero-identity','secret-identity','alignment','classification','primary-power-style','origin-story','char-tier','secondary-power-style','cinematic-AP','publicIdentity','signatureMoveName','signatureSP','signatureSave','signatureSpecial','signatureMoveDescription','signatureMeaning','prePowerLife','powerMoment','powerMeaning','powerFear','walkAway','vulnerability','secret','trustedAlly','teamAdmire','research','trainTinker','vigilanteName','primaryPerk','sp-rule','ds1','ds2','ds3','prof-bonus','power-save-ability','perk-alignment-mode','perk-classification-mode','perk-primary-mode','perk-origin-mode'].forEach(bind);
  abilities.forEach(bind);

  $('initiative')?.addEventListener('input',()=>{initTouched=true});

  function hpChangeBy(amt){const hb=$('hp-bar'); if(!hb) return; let dmg=amt; if(dmg<0){const tempEl=$('hp-temp'); const temp=Number(tempEl?.value)||0; const use=Math.min(temp,Math.abs(dmg)); if(tempEl) tempEl.value=String(temp-use); dmg+=use; } hb.value=clamp(Number(hb.value)+(dmg),0,Number(hb.max)); updateHP();}
  function spChangeBy(amt){const sb=$('sp-bar'); if(!sb) return; let d=amt; if(d<0){const tempEl=$('sp-temp'); const temp=Number(tempEl?.value)||0; const use=Math.min(temp,Math.abs(d)); if(tempEl) tempEl.value=String(temp-use); d+=use; } sb.value=clamp(Number(sb.value)+(d),0,Number(sb.max)); updateSP();}

  document.querySelectorAll('.hp-step').forEach(b=>b.addEventListener('click',()=>{hpChangeBy(Number(b.getAttribute('data-d')))}));
  document.querySelectorAll('.sp-step').forEach(b=>b.addEventListener('click',()=>{spChangeBy(Number(b.getAttribute('data-d')))}));

  $('hp-take')?.addEventListener('click',()=>{const amt=num($('hp-dmg'))||0; hpChangeBy(-Math.abs(amt));});
  $('hp-heal')?.addEventListener('click',()=>{const amt=num($('hp-dmg'))||0; hpChangeBy(Math.abs(amt));});
  $('hp-reset')?.addEventListener('click',()=>{const hb=$('hp-bar'); if(!hb) return; hb.value=hb.max; updateHP();});

  $('sp-spend')?.addEventListener('click',()=>{const amt=num($('sp-cost'))||0; spChangeBy(-Math.abs(amt));});
  $('sp-reset')?.addEventListener('click',()=>{const sb=$('sp-bar'); if(!sb) return; sb.value=sb.max; resetPerks('combat'); updateSP();});
  $('long-rest')?.addEventListener('click',()=>{const hb=$('hp-bar'); if(hb){hb.value=hb.max} const sb=$('sp-bar'); if(sb){sb.value=sb.max} resetPerks('rest'); updateAll();});

  ;['ds1','ds2','ds3'].forEach(id=>{const el=$(id); if(el) el.addEventListener('change',()=>{const all=['ds1','ds2','ds3'].every(k=>$(k)?.checked); if(all && !death){alert('You Have Fallen, Your Sacrifice Will Be Remembered'); death=true} else if(!all && death){death=false}})});

  const CONDITIONS={ 'cond-stunned':{name:'Stunned',desc:'You canâ€™t move; attackers have advantage; you fail STR/DEX saves.'}, 'cond-prone':{name:'Prone',desc:'On the ground; melee attackers have advantage; ranged attacks against you have disadvantage.'}, 'cond-exhausted':{name:'Exhausted',desc:'Suffer cumulative penalties; reduce with rest (GM adjudication).'}, 'cond-blinded':{name:'Blinded',desc:'You canâ€™t see; attacks against you have advantage; your attacks have disadvantage.'}, 'cond-charmed':{name:'Charmed',desc:'You canâ€™t attack the charmer; they have advantage on social checks vs you.'}, 'cond-frightened':{name:'Frightened',desc:'Disadvantage while the source is in sight; canâ€™t move closer.'} };
  Object.entries(CONDITIONS).forEach(function(entry){ var id=entry[0], meta=entry[1]; var el=$(id); if(!el) return; el.addEventListener('change', function(){ if(el.checked){ alert(meta.name+': '+meta.desc+'\n\nUncheck the condition when it ends.'); } }); });
  document.addEventListener('click', function(e){ var btn=e.target.closest && e.target.closest('button'); if(!btn) return; var active=[]; Object.entries(CONDITIONS).forEach(function(entry){ var id=entry[0], meta=entry[1]; var box=$(id); if(box && box.checked) active.push(meta.name); }); if(active.length){ alert('Reminder: You are suffering from: '+active.join(', ')+'. Uncheck the condition box to clear.'); } });
  $('roll-dice')?.addEventListener('click',()=>{ const sides=+$('dice-type').value; const count=+$('dice-count').value; const rolls=Array.from({length:count},()=>Math.floor(Math.random()*sides)+1); const sum=rolls.reduce((a,b)=>a+b,0); const text=`d${sides}Ã—${count}: [${rolls.join(', ')}] â†’ ${sum}`; $('dice-result').textContent=`Rolls: ${rolls.join(', ')} (Sum: ${sum})`; addDiceLog(text); });
  $('flip-coin')?.addEventListener('click',()=>{const r=(Math.random()<.5?'Heads':'Tails'); $('coin-result').textContent=r; addCoinLog(r)});

  function serialize(){
    const out={};
    document.querySelectorAll('input,select,textarea').forEach(el=>{ if(!el.id) return; out[el.id]=el.type==='checkbox'?el.checked:el.value; });
    out.hpCurrent=$('hp-bar')?.value||0; out.spCurrent=$('sp-bar')?.value||0; out.updatedAt=Date.now(); Object.entries(extraKeyMap).forEach(([orig,id])=>{const el=$(id); if(!el) return; out[orig]=(el.type==='checkbox')?!!el.checked:el.value; delete out[id];}); return out;
  }

  function setSelectByText(id,text){const sel=$(id); if(!sel) return; const idx=Array.from(sel.options).findIndex(o=>o.text.trim()===String(text).trim()); if(idx>=0) sel.selectedIndex=idx;}

  const legacyMap={
    vigilanteName:'superhero-identity',
    secretIdentity:'secret-identity',
    publicIdentity:'publicIdentity',
    primaryPowerStyle:'primary-power-style',
    secondaryPowerStyle:'secondary-power-style',
    primaryPerk:'primaryPerk',
    signatureMoveName:'signatureMoveName',
    signatureSP:'signatureSP',
    signatureSave:'signatureSave',
    signatureSpecial:'signatureSpecial',
    signatureMoveDescription:'signatureMoveDescription',
    signatureMeaning:'signatureMeaning',
    prePowerLife:'prePowerLife',
    powerMoment:'powerMoment',
    powerMeaning:'powerMeaning',
    powerFear:'powerFear',
    walkAway:'walkAway',
    vulnerability:'vulnerability',
    secret:'secret',
    trustedAlly:'trustedAlly',
    teamAdmire:'teamAdmire',
    research:'research',
    trainTinker:'trainTinker',
    speed:'speed'
  };

  function importLegacyToFields(data){
    if(!data) return;
    Object.entries(legacyMap).forEach(([oldKey,newId])=>{
      if(data[oldKey]==null) return;
      const el=$(newId);
      if(!el) return;
      if(el.tagName==='SELECT'){
        setSelectByText(newId, data[oldKey]);
      }else if(el.type==='checkbox'){
        el.checked=!!data[oldKey];
      }else{
        el.value=clean(data[oldKey]);
      }
    });
  }

  function applyData(data){
    importLegacyToFields(data);
    buildPowersFromData(data);
    buildEquipmentFromData(data);
    Object.entries(data||{}).forEach(([k,v])=>{const el=$(k); if(el){ if(el.type==='checkbox') el.checked=!!v; else el.value=clean(v);}});
    if(data&&data.vigilanteName&&$('superhero-identity')) $('superhero-identity').value=data.vigilanteName;
    if(data&&data.publicIdentity){const v=String(data.publicIdentity).toLowerCase(); if($('publicIdentity')) $('publicIdentity').value=v.includes('public')?'Public':'Secret';}
    if(data&&data.primaryPowerStyle) setSelectByText('primary-power-style',data.primaryPowerStyle);
    if(data&&data.secondaryPowerStyle) setSelectByText('secondary-power-style',data.secondaryPowerStyle);
    if(data&&data.hpCurrent!=null) $('hp-bar').value=Number(data.hpCurrent);
    if(data&&data.spCurrent!=null) $('sp-bar').value=Number(data.spCurrent);
    renderExtrasFiltered(data);
    updateAll();
  }

  function toast(msg){const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),300);},2200);}

  function resolvePaths(id){if(!id) return []; const name=String(id).trim(); if(/^https?:\/\//i.test(name)) return [name]; if(name.startsWith('/')) return [name.replace(/^\//,'')]; const variants=[name,name.toLowerCase(),name.replace(/\s+/g,'-').toLowerCase()]; const paths=[]; variants.forEach(v=>paths.push(`saves/${v}`)); variants.forEach(v=>paths.push(`characters/${v}`)); return paths;}
  function toURL(p){if(/^https?:\/\//i.test(p)) return p.endsWith('.json')?p:(p.replace(/\/$/,'')+'.json'); return `${baseURL}/${p.replace(/^\//,'')}.json`;}
  async function restGet(url){const r=await fetch(url,{method:'GET'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();}
  async function restPatch(url,body){const r=await fetch(url,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();}

  async function saveDoc(){const input=$('modal-doc-id'); const id=input?.value?.trim()||localStorage.getItem('lastDocId')||''; if(!id){toast('Enter Character ID'); return} let path=localStorage.getItem('lastPathUsed'); if(!path){path=id.startsWith('/')?id.replace(/^\//,''):`saves/${id}`;} const merged=serialize(); try{await restPatch(toURL(path),merged); localStorage.setItem('lastDocId',id); localStorage.setItem('lastPathUsed',path); toast('Saved: '+path);}catch(e){toast('Save failed');}}
  async function loadDoc(){const input=$('modal-doc-id'); const id=input?.value?.trim()||localStorage.getItem('lastDocId')||''; if(!id){toast('Enter Character ID'); return} const candidates=resolvePaths(id); for(const p of candidates){ try{const data=await restGet(toURL(p)); if(data&&typeof data==='object'){applyData(data); localStorage.setItem('lastDocId',id); localStorage.setItem('lastPathUsed',p); toast('Loaded: '+p); return;}}catch(e){} } toast('No doc found');}

  const overlay=$('id-overlay'), modalTitle=$('id-modal-title'), modalInput=$('modal-doc-id'), modalConfirm=$('modal-confirm'), modalCancel=$('modal-cancel'); let modalMode='save';
  function openIdModal(mode){modalMode=mode; if(modalTitle) modalTitle.textContent=(mode==='save'?'Save to Cloud':'Load from Cloud'); if(modalConfirm) modalConfirm.textContent=(mode==='save'?'Save':'Load'); const last=localStorage.getItem('lastDocId')||''; if(modalInput) modalInput.value=last.trim(); overlay?.classList.remove('hidden'); modalInput?.focus();}
  function closeIdModal(){overlay?.classList.add('hidden');}
  modalCancel?.addEventListener('click',closeIdModal); overlay?.addEventListener('click',e=>{if(e.target===overlay) closeIdModal()}); modalInput?.addEventListener('keydown',e=>{if(e.key==='Enter'){modalConfirm?.click()} if(e.key==='Escape'){closeIdModal()}}); modalConfirm?.addEventListener('click',()=>{const id=modalInput?.value?.trim(); if(!id){modalInput?.focus(); return} localStorage.setItem('lastDocId',id); if(modalMode==='save'){saveDoc()} else {loadDoc()} closeIdModal()}); $('icon-save')?.addEventListener('click',()=>openIdModal('save')); $('icon-load')?.addEventListener('click',()=>openIdModal('load'));

  const logOpen=$('icon-log'), logOverlay=$('log-overlay'), logClose=$('log-close'); logOpen?.addEventListener('click',()=>{renderLogs(); logOverlay?.classList.remove('hidden');}); logClose?.addEventListener('click',()=>{logOverlay?.classList.add('hidden');}); logOverlay?.addEventListener('click',e=>{if(e.target===logOverlay) logOverlay.classList.add('hidden');});

  const cOv=$('confirm-overlay'), cCancel=$('confirm-cancel'), cOk=$('confirm-ok'); cCancel?.addEventListener('click',()=>{pendingDeleteEl=null; cOv?.classList.add('hidden');}); cOk?.addEventListener('click',()=>{if(pendingDeleteEl){pendingDeleteEl.remove(); pendingDeleteEl=null; updateAll();} cOv?.classList.add('hidden');}); cOv?.addEventListener('click',e=>{if(e.target===cOv){pendingDeleteEl=null; cOv.classList.add('hidden');}});

  function syncDuplicates(){const hero=$('superhero-identity'), vig=$('vigilanteName'); if(hero&&vig){hero.addEventListener('input',()=>{vig.value=hero.value}); vig.addEventListener('input',()=>{hero.value=vig.value});}}

  const CATALOG_DEFAULT={
    weapons:[
      {name:'Light Baton',type:'Melee',damage:'1d6',range:'reach 5ft',ability:'str',prof:true,notes:''},
      {name:'Auto Pistol',type:'Ranged',damage:'1d6',range:'30/90',ability:'dex',prof:true,notes:'semi-auto'},
      {name:'Arc Blade',type:'Melee',damage:'1d8',range:'reach 5ft',ability:'str',prof:true,notes:'energized'}
    ],
    armor:[
      {name:'Kevlar Vest',slot:'Body',bonus:2,notes:''},
      {name:'Ballistic Helmet',slot:'Head',bonus:1,notes:''},
      {name:'Riot Shield',slot:'Shield',bonus:2,notes:'heavy'}
    ],
    items:[
      {name:'Medkit',qty:1,notes:'restore 1d6 HP'},
      {name:'Grapple Gun',qty:1,notes:'30ft'}
    ],
    powers:[
      {name:'Force Push',range:'30ft',effect:'Knockback',sp:'1',save:'STR 12',desc:''}
    ]
  };
  let CATALOG=CATALOG_DEFAULT;
  async function loadCatalog(){
    try{ const candidates=['catalog','gear','gear-catalog','premadeCatalog']; let merged={...CATALOG_DEFAULT}; for(const p of candidates){ try{ const data=await restGet(toURL(p)); if(data&&typeof data==='object'){ merged={...merged,...data}; } } catch(e){} } CATALOG=merged; }
    catch(e){ CATALOG=CATALOG_DEFAULT; }
  }

  const catOverlay=$('catalog-overlay'); const catKind=$('catalog-kind'); const catSearch=$('catalog-search'); const catList=$('catalog-list'); const catCancel=$('catalog-cancel'); const catAdd=$('catalog-add'); const catCustom=$('catalog-custom'); const catRefresh=$('catalog-refresh'); let currentKind='weapon';
  function renderCatalog(){ if(!catList) return; const list=(CATALOG[(currentKind+'s')]||[]); const q=(catSearch?.value||'').toLowerCase(); catList.innerHTML=''; list.filter(x=>!q||JSON.stringify(x).toLowerCase().includes(q)).forEach((it,i)=>{
      const row=document.createElement('div'); row.className='catalog-item';
      row.innerHTML=`<input type=\"checkbox\" id=\"cat-${currentKind}-${i}\"><div><div><b>${it.name||it.title||'Item'}</b>${it.type?` <span class='badge'>${it.type}</span>`:''}${it.slot?` <span class='badge'>${it.slot}</span>`:''}</div><div class='preview'>${it.damage?`DMG: ${it.damage} `:''}${it.range?`Range: ${it.range} `:''}${it.bonus!=null?`Bonus: ${it.bonus} `:''}${it.effect?`Effect: ${it.effect} `:''}${it.notes?`| ${it.notes}`:''}</div></div><div class='muted'>${(it.ability||'').toUpperCase()}</div>`;
      catList.appendChild(row);
    }); }
  function openCatalog(kind){ currentKind=(kind==='power'?'power':(kind==='weapon'?'weapon':(kind==='armor'?'armor':'item'))); if(catKind) catKind.value=currentKind; if($('catalog-title')) $('catalog-title').textContent=`Add ${currentKind.charAt(0).toUpperCase()+currentKind.slice(1)}`; catOverlay?.classList.remove('hidden'); renderCatalog(); }
  function closeCatalog(){ catOverlay?.classList.add('hidden'); }
  catCancel?.addEventListener('click', closeCatalog);
  catOverlay?.addEventListener('click', e=>{ if(e.target===catOverlay) closeCatalog(); });
  catKind?.addEventListener('change', ()=>{ currentKind=catKind.value; renderCatalog(); });
  catSearch?.addEventListener('input', renderCatalog);
  catRefresh?.addEventListener('click', async ()=>{ await loadCatalog(); renderCatalog(); toast('Catalog refreshed'); });
  catCustom?.addEventListener('click', ()=>{ if(currentKind==='weapon'){ addWeaponRow(nextIndexFrom($('weapons-container')), {}); } else if(currentKind==='armor'){ addArmorRow(nextIndexFrom($('armor-container')), {}); } else if(currentKind==='item'){ addItemRow(nextIndexFrom($('items-container')), {}); } else if(currentKind==='power'){ addPowerCard(nextIndexFrom($('powers-container')), {}); } updateAll(); closeCatalog(); });
  catAdd?.addEventListener('click', ()=>{
    const list=(CATALOG[(currentKind+'s')]||[]);
    const contId = currentKind==='weapon'?'weapons-container':(currentKind==='armor'?'armor-container':(currentKind==='power'?'powers-container':'items-container'));
    const cont=$(contId);
    list.forEach((it,i)=>{
      const cb=document.getElementById(`cat-${currentKind}-${i}`); if(!cb||!cb.checked) return;
      if(currentKind==='weapon'){
        const n=nextIndexFrom(cont); addWeaponRow(n,{
          ['weapon'+n+'Name']:it.name||'', ['weapon'+n+'Type']:it.type||'', ['weapon'+n+'Damage']:it.damage||'', ['weapon'+n+'Range']:it.range||'', ['weapon'+n+'Ability']:(it.ability||'str'), ['weapon'+n+'Prof']:!!it.prof, ['weapon'+n+'Notes']:it.notes||''
        });
      } else if(currentKind==='armor'){
        const n=nextIndexFrom(cont); addArmorRow(n,{
          ['armor'+n+'Name']:it.name||'', ['armor'+n+'Slot']:it.slot||'Body', ['armor'+n+'Bonus']:(it.bonus||0), ['armor'+n+'Equipped']:!!it.equipped, ['armor'+n+'Notes']:it.notes||''
        });
      } else if(currentKind==='item'){
        const n=nextIndexFrom(cont); addItemRow(n,{
          ['item'+n+'Name']:it.name||'', ['item'+n+'Qty']:(it.qty||1), ['item'+n+'Notes']:it.notes||'', ['item'+n+'Max']:(it.max||0), ['item'+n+'Charges']:(it.charges||0)
        });
      } else if(currentKind==='power'){
        const n=nextIndexFrom(cont); addPowerCard(n,{
          ['power'+n+'Name']:it.name||'', ['power'+n+'Range']:it.range||'', ['power'+n+'Effect']:it.effect||'', ['power'+n+'SP']:it.sp||'', ['power'+n+'Save']:it.save||'', ['power'+n+'Desc']:it.desc||'', ['power'+n+'Max']:(it.max||0), ['power'+n+'Charges']:(it.charges||0), ['power'+n+'Usage']:(it.usage||'atwill')
        });
      }
    });
    updateAll(); closeCatalog();
  });

  const perkButtons=[['alignment'],['classification'],['primary'],['origin']];
  perkButtons.forEach(([k])=>{
    const btn=$('perk-'+k+'-use'); if(btn) btn.addEventListener('click',()=>{ localStorage.setItem('perk-'+k+'-used','1'); updatePerkStates(); });
  });

  function renderEncounter(){ $('round-pill').textContent='Round '+round; const cont=$('enc-list'); if(!cont) return; const list=JSON.parse(localStorage.getItem('enc-list')||'[]'); list.sort((a,b)=>b.init-a.init); cont.innerHTML=''; list.forEach((p,i)=>{ const row=document.createElement('div'); row.className='catalog-item'; row.innerHTML=`<div class='pill'>${p.init}</div><div><b>${p.name}</b></div><button class='compact-btn' data-i='${i}'>Remove</button>`; cont.appendChild(row); row.querySelector('button').addEventListener('click',()=>{const arr=JSON.parse(localStorage.getItem('enc-list')||'[]'); arr.splice(i,1); localStorage.setItem('enc-list',JSON.stringify(arr)); renderEncounter();}); }); }
  $('icon-encounter')?.addEventListener('click',()=>{renderEncounter(); $('encounter-overlay')?.classList.remove('hidden');});
  $('enc-close')?.addEventListener('click',()=>{$('encounter-overlay')?.classList.add('hidden');});
  $('encounter-overlay')?.addEventListener('click',e=>{ if(e.target=== $('encounter-overlay')) $('encounter-overlay').classList.add('hidden'); });
  $('enc-add')?.addEventListener('click',()=>{const name=$('enc-name').value.trim(); const init=num($('enc-init'))||0; if(!name) return; const list=JSON.parse(localStorage.getItem('enc-list')||'[]'); list.push({name,init}); localStorage.setItem('enc-list',JSON.stringify(list)); $('enc-name').value=''; $('enc-init').value=''; renderEncounter();});
  $('next-round')?.addEventListener('click',()=>{round+=1; localStorage.setItem('enc-round',String(round)); renderEncounter();});
  $('reset-encounter')?.addEventListener('click',()=>{round=1; localStorage.setItem('enc-round','1'); localStorage.removeItem('enc-list'); renderEncounter();});

  
  const extraKeyMap={};
  const sanitizeKey=k=>'extra-'+String(k).replace(/[^a-zA-Z0-9_-]/g,'-');
  function ensureExtraField(key,value){const container=$('extras-container'); if(!container) return; if(legacyMap[key]) return; if(/^power\d+(Name|Range|Effect|SP|Save|Desc|Max|Charges|Usage)$/i.test(key)) return; if(extraKeyMap[key]){const el=$(extraKeyMap[key]); if(!el) return; if(el.type==='checkbox') el.checked=!!value; else el.value=clean(value??''); return;} const id=sanitizeKey(key); extraKeyMap[key]=id; const wrap=document.createElement('div'); wrap.className='extra-item'; const label=document.createElement('label'); label.textContent=key.replace(/([a-z])([A-Z])/g,'$1 $2'); let input; if(typeof value==='boolean'){input=document.createElement('input'); input.type='checkbox'; input.className='checkbox'; input.checked=!!value;} else if(typeof value==='number'){input=document.createElement('input'); input.type='number'; input.value=value;} else {const s=String(value??''); if(s.length>120||s.indexOf('\n')>-1){input=document.createElement('textarea'); input.rows=3; input.value=clean(s);} else {input=document.createElement('input'); input.type='text'; input.value=clean(s);} } input.id=id; input.addEventListener('input',updateAll); input.addEventListener('change',updateAll); wrap.appendChild(label); wrap.appendChild(input); container.appendChild(wrap); }
  function renderExtrasFiltered(data){const container=$('extras-container'); if(!container) return; container.innerHTML=''; Object.keys(extraKeyMap).forEach(k=>delete extraKeyMap[k]); const known=new Set(Object.values(legacyMap)); Object.entries(data||{}).forEach(([k,v])=>{ if(legacyMap[k]) return; if(/^power\d+(Name|Range|Effect|SP|Save|Desc|Max|Charges|Usage)$/i.test(k)) return; ensureExtraField(k,v); });}

  function nextIndexFrom(container){let max=0; (container.querySelectorAll('[data-idx]')||[]).forEach(el=>{const n=Number(el.getAttribute('data-idx')); if(Number.isFinite(n)) max=Math.max(max,n)}); return max+1;}
  function attachDelete(btn,target,label){ if(!btn) return; btn.addEventListener('click',()=>{pendingDeleteEl=target; const m=$('confirm-msg'); if(m) m.textContent='Delete '+label+'?'; $('confirm-overlay')?.classList.remove('hidden');});}

  function addPowerCard(n,data={}){const container=$('powers-container'); if(!container) return; const card=document.createElement('div'); card.className='card'; card.setAttribute('data-idx',String(n)); const head=document.createElement('div'); head.className='subhead'; head.innerHTML=`<span class="pill">Power ${n}</span><button class="icon-btn icon-tiny delete-btn" aria-label="Delete"><svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M3 6h18M8 6v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>`; const grid=document.createElement('div'); grid.className='row-2'; const fields=[{k:'Name',label:'Name',type:'text'},{k:'Range',label:'Range',type:'text'},{k:'Effect',label:'Effect',type:'text'},{k:'SP',label:'SP Cost',type:'text'},{k:'Save',label:'Saving Throw',type:'text'},{k:'Max',label:'Max Charges',type:'number'},{k:'Charges',label:'Charges',type:'number'}]; fields.forEach(f=>{const wrap=document.createElement('div'); wrap.innerHTML=`<label>${f.label}</label><input id="power${n}${f.k}" type="${f.type}">`; grid.appendChild(wrap);}); const usage=document.createElement('div'); usage.innerHTML=`<label>Usage Reset</label><select id="power${n}Usage"><option value="atwill">At-Will</option><option value="combat">Per Combat</option><option value="rest">Per Long Rest</option><option value="session">Per Session</option></select>`; grid.appendChild(usage); const controls=document.createElement('div'); controls.style.gridColumn='1/-1'; controls.innerHTML=`<div class="inline"><button class="btn-sm" id="power${n}Use">Use</button><button class="btn-sm" id="power${n}Reset">Reset</button><span class="pill" id="power${n}State">Ready</span></div>`; const desc=document.createElement('div'); desc.style.gridColumn='1/-1'; desc.innerHTML=`<label>Description</label><textarea id="power${n}Desc" rows="3"></textarea>`; card.appendChild(head); card.appendChild(grid); card.appendChild(controls); card.appendChild(desc); container.appendChild(card); ['Name','Range','Effect','SP','Save','Desc','Max','Charges'].forEach(k=>{const id=`power${n}${k}`; const el=$(id); if(!el) return; if(data[id]!=null) el.value=clean(data[id]); el.addEventListener('input',updateAll); el.addEventListener('change',updateAll);}); const u=$('power'+n+'Usage'); if(u){ if(data['power'+n+'Usage']) u.value=data['power'+n+'Usage']; u.addEventListener('change',updateAll);} attachDelete(card.querySelector('.delete-btn'),card,'Power '+n); const useBtn=$('power'+n+'Use'), resetBtn=$('power'+n+'Reset'); if(useBtn) useBtn.addEventListener('click',()=>{const cur=$('power'+n+'Charges'); let v=Number(cur.value)||0; if(v>0){cur.value=String(v-1);} else {const st=$('power'+n+'State'); if(st) st.textContent='Spent';} updateAll();}); if(resetBtn) resetBtn.addEventListener('click',()=>{const max=$('power'+n+'Max'); const cur=$('power'+n+'Charges'); const m=Number(max.value)||0; cur.value=String(m); $('power'+n+'State').textContent='Ready'; updateAll();});}
  function buildPowersFromData(data){const container=$('powers-container'); if(!container) return; container.innerHTML=''; const seen=new Set(); Object.keys(data||{}).forEach(k=>{const m=k.match(/^power(\d+)(Name|Range|Effect|SP|Save|Desc|Max|Charges|Usage)$/i); if(m) seen.add(Number(m[1]));}); const ids=Array.from(seen).sort((a,b)=>a-b); if(ids.length===0){addPowerCard(1,{}); return;} ids.forEach(n=>addPowerCard(n,data));}

  function addWeaponRow(n,data={}){const box=$('weapons-container'); if(!box) return; const row=document.createElement('div'); row.className='card'; row.setAttribute('data-idx',String(n)); const head=document.createElement('div'); head.className='subhead'; head.innerHTML=`<span class="pill">Weapon ${n}</span><button class="icon-btn icon-tiny delete-btn" aria-label="Delete"><svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M3 6h18M8 6v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>`; const grid=document.createElement('div'); grid.className='row-3'; grid.innerHTML=`<div><label>Name</label><input id="weapon${n}Name"></div><div><label>Type</label><input id="weapon${n}Type" placeholder="Melee/Ranged"></div><div><label>Damage/Effect</label><input id="weapon${n}Damage" placeholder="1d6 or text"></div><div><label>Range</label><input id="weapon${n}Range"></div><div><label>Ability</label><select id="weapon${n}Ability"><option value="str">STR</option><option value="dex">DEX</option><option value="int">INT</option><option value="wis">WIS</option><option value="cha">CHA</option></select></div><div><label>Proficient</label><input id="weapon${n}Prof" type="checkbox" class="checkbox"></div><div><label>Ammo/Charges</label><div class="inline"><button class="compact-btn" id="weapon${n}AmmoDec">-</button><input id="weapon${n}Ammo" type="number" value="0" style="max-width:100px"><button class="compact-btn" id="weapon${n}AmmoInc">+</button></div></div><div><label>To-Hit</label><div class="pill" id="weapon${n}ToHit">+0</div></div><div><label>Damage (preview)</label><div class="pill" id="weapon${n}DmgPrev">+0</div></div><div style="grid-column:1/-1"><label>Notes</label><input id="weapon${n}Notes"></div>`; row.appendChild(head); row.appendChild(grid); box.appendChild(row); ['Name','Type','Damage','Range','Notes','Ammo'].forEach(k=>{const id=`weapon${n}${k}`; const el=$(id); if(el){ if(data[id]!=null) el.value=clean(data[id]); el.addEventListener('input',updateAll); el.addEventListener('change',updateAll);}}); const ab=$('weapon'+n+'Ability'); if(ab){ if(data['weapon'+n+'Ability']) ab.value=data['weapon'+n+'Ability']; ab.addEventListener('change',updateAll);} const pr=$('weapon'+n+'Prof'); if(pr){ pr.checked=!!data['weapon'+n+'Prof']; pr.addEventListener('change',updateAll);} attachDelete(row.querySelector('.delete-btn'),row,'Weapon '+n); const dec=$('weapon'+n+'AmmoDec'), inc=$('weapon'+n+'AmmoInc'); if(dec) dec.addEventListener('click',()=>{const a=$('weapon'+n+'Ammo'); a.value=String(Math.max(0,(Number(a.value)||0)-1)); updateAll();}); if(inc) inc.addEventListener('click',()=>{const a=$('weapon'+n+'Ammo'); a.value=String((Number(a.value)||0)+1); updateAll();});}

  function addArmorRow(n,data={}){const box=$('armor-container'); if(!box) return; const row=document.createElement('div'); row.className='card'; row.setAttribute('data-idx',String(n)); const head=document.createElement('div'); head.className='subhead'; head.innerHTML=`<span class="pill">Armor ${n}</span><button class="icon-btn icon-tiny delete-btn" aria-label="Delete"><svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M3 6h18M8 6v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>`; const grid=document.createElement('div'); grid.className='row-3'; grid.innerHTML=`<div><label>Name</label><input id="armor${n}Name"></div><div><label>Slot</label><select id="armor${n}Slot"><option>Body</option><option>Head</option><option>Shield</option><option>Misc</option></select></div><div><label>Armor Bonus</label><input id="armor${n}Bonus" type="number"></div><div><label>Equipped</label><input id="armor${n}Equipped" type="checkbox" class="checkbox"></div><div style="grid-column:1/-1"><label>Notes</label><input id="armor${n}Notes"></div>`; row.appendChild(head); row.appendChild(grid); box.appendChild(row); ['Name','Bonus','Notes'].forEach(k=>{const id=`armor${n}${k}`; const el=$(id); if(el){ if(data[id]!=null) el.value=clean(data[id]); el.addEventListener('input',updateAll); el.addEventListener('change',updateAll);}}); const slotEl=$('armor'+n+'Slot'); if(slotEl){ if(data['armor'+n+'Slot']) slotEl.value=data['armor'+n+'Slot']; slotEl.addEventListener('change',updateAll);} const eq=$('armor'+n+'Equipped'); if(eq){ eq.checked=!!data['armor'+n+'Equipped']; eq.addEventListener('change',()=>{ const slot=$('armor'+n+'Slot')?.value||'Body'; if(eq.checked && (slot==='Body'||slot==='Head')){ document.querySelectorAll(`#armor-container .card`).forEach(c=>{ const idx=c.getAttribute('data-idx'); if(idx!==String(n)){ const s=$('armor'+idx+'Slot')?.value; if(s===slot){ const e=$('armor'+idx+'Equipped'); if(e) e.checked=false; } } }); } updateAll(); }); }
      attachDelete(row.querySelector('.delete-btn'),row,'Armor '+n);}

  function addItemRow(n,data={}){const box=$('items-container'); if(!box) return; const row=document.createElement('div'); row.className='card'; row.setAttribute('data-idx',String(n)); const head=document.createElement('div'); head.className='subhead'; head.innerHTML=`<span class="pill">Item ${n}</span><button class="icon-btn icon-tiny delete-btn" aria-label="Delete"><svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M3 6h18M8 6v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>`; const grid=document.createElement('div'); grid.className='row-3'; grid.innerHTML=`<div><label>Name</label><input id="item${n}Name"></div><div><label>Qty</label><input id="item${n}Qty" type="number" value="1"></div><div><label>Max Charges</label><input id="item${n}Max" type="number" value="0"></div><div><label>Charges</label><div class="inline"><button class="compact-btn" id="item${n}ChgDec">-</button><input id="item${n}Charges" type="number" value="0" style="max-width:100px"><button class="compact-btn" id="item${n}ChgInc">+</button></div></div><div style="grid-column:1/-1"><label>Notes</label><input id="item${n}Notes"></div>`; row.appendChild(head); row.appendChild(grid); box.appendChild(row); ['Name','Qty','Notes','Max','Charges'].forEach(k=>{const id=`item${n}${k}`; const el=$(id); if(el){ if(data[id]!=null) el.value=clean(data[id]); el.addEventListener('input',updateAll); el.addEventListener('change',updateAll);}}); const dec=$('item'+n+'ChgDec'), inc=$('item'+n+'ChgInc'); if(dec) dec.addEventListener('click',()=>{const a=$('item'+n+'Charges'); a.value=String(Math.max(0,(Number(a.value)||0)-1)); updateAll();}); if(inc) inc.addEventListener('click',()=>{const a=$('item'+n+'Charges'); const m=Number($('item'+n+'Max')?.value)||0; a.value=String(Math.min(m||999,(Number(a.value)||0)+1)); updateAll();}); attachDelete(row.querySelector('.delete-btn'),row,'Item '+n);}

  function buildEquipmentFromData(data){$('weapons-container').innerHTML=''; $('armor-container').innerHTML=''; $('items-container').innerHTML=''; const wSeen=new Set(), aSeen=new Set(), iSeen=new Set(); Object.keys(data||{}).forEach(k=>{let m=k.match(/^weapon(\d+)(Name|Type|Damage|Range|Ability|Prof|Ammo|Notes)$/i); if(m) wSeen.add(Number(m[1])); m=k.match(/^armor(\d+)(Name|Slot|Bonus|Equipped|Notes)$/i); if(m) aSeen.add(Number(m[1])); m=k.match(/^item(\d+)(Name|Qty|Notes|Max|Charges)$/i); if(m) iSeen.add(Number(m[1]));}); const wIds=Array.from(wSeen).sort((a,b)=>a-b), aIds=Array.from(aSeen).sort((a,b)=>a-b), iIds=Array.from(iSeen).sort((a,b)=>a-b); if(wIds.length===0) addWeaponRow(1,{}); else wIds.forEach(n=>addWeaponRow(n,data)); if(aIds.length===0) addArmorRow(1,{}); else aIds.forEach(n=>addArmorRow(n,data)); if(iIds.length===0) addItemRow(1,{}); else iIds.forEach(n=>addItemRow(n,data));}

  $('add-power')?.addEventListener('click',()=>{openCatalog('power')});
  $('add-weapon')?.addEventListener('click',()=>{openCatalog('weapon')});
  $('add-armor')?.addEventListener('click',()=>{openCatalog('armor')});
  $('add-item')?.addEventListener('click',()=>{openCatalog('item')});

  function importFromShawnHint(){ if(localStorage.getItem('hint-load')!=='1'){ const t=document.createElement('div'); t.className='toast show'; t.textContent='Tip: Click the cloud icon to Load, enter "Shawn" to pull your test data.'; document.body.appendChild(t); setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),300);},2500); localStorage.setItem('hint-load','1'); } }

  
  function buildPrintSheet(){
  const $=id=>document.getElementById(id);
  const abilities=['str','dex','con','int','wis','cha'];
  const text=(id,val)=>{const el=$(id); if(el) el.textContent=val==null?'':String(val)};
  if(typeof updateAll==='function') updateAll();
  text('cs-hero',$('superhero-identity')?.value||'');
  text('cs-secret',$('secret-identity')?.value||'');
  text('cs-tier',$('char-tier')?.value||$('char-tier')?.selectedOptions?.[0]?.text||'');
  text('cs-align',$('alignment')?.selectedOptions?.[0]?.text||'');
  text('cs-align-perk',document.getElementById('alignment-perk')?.textContent||'');
  text('cs-class',$('classification')?.selectedOptions?.[0]?.text||'');
  text('cs-class-perk',document.getElementById('classification-perk')?.textContent||'');
  text('cs-ppower',$('primary-power-style')?.selectedOptions?.[0]?.text||'');
  text('cs-ppower-perk',document.getElementById('primary-power-style-perk')?.textContent||document.getElementById('primaryPerk')?.value||'');
  text('cs-spower',$('secondary-power-style')?.value||'');
  text('cs-origin',$('origin-story')?.selectedOptions?.[0]?.text||'');
  text('cs-origin-perk',document.getElementById('origin-story-perk')?.textContent||'');
  const hb=$('hp-bar'); const sb=$('sp-bar');
  text('cs-hp',`${hb?.value||0}/${hb?.max||0}`);
  text('cs-sp',`${sb?.value||0}/${sb?.max||0}`);
  text('cs-tc',$('tc')?.value||'');
  text('cs-init',$('initiative')?.value||'');
  text('cs-speed',$('speed')?.value||'');
  text('cs-pp',$('passive-perception')?.value||'');
  const ds=['ds1','ds2','ds3'].filter(id=>$(id)?.checked).length; text('cs-ds',`${ds}/3`);
  const conds=Array.from(document.querySelectorAll('#conditions input:checked')).map(i=>i.parentElement.textContent.trim()).join(', ');
  text('cs-conds',conds||'None');
  const ab=$('cs-abilities'); if(ab){ ab.innerHTML=''; abilities.forEach(id=>{ const score=$(id)?.value||'10'; const m=document.getElementById(id+'-mod')?.textContent||'+0'; const d=document.createElement('div'); d.className='cs-kv'; d.innerHTML=`<span class="cs-title">${id.toUpperCase()}</span><span>${score} (${m})</span>`; ab.appendChild(d); }); }
  const pp=$('cs-powers'); if(pp){ pp.innerHTML=''; document.querySelectorAll('#powers-container [data-idx]').forEach(card=>{ const idx=card.getAttribute('data-idx'); const name=$('power'+idx+'Name')?.value||'Power'; const sp=$('power'+idx+'SP')?.value||''; const save=$('power'+idx+'Save')?.value||''; const effect=$('power'+idx+'Effect')?.value||''; const desc=$('power'+idx+'Desc')?.value||''; const row=document.createElement('div'); row.className='cs-kv'; row.innerHTML=`<span>${name}${sp?` [SP ${sp}]`:''}${save?` [Save ${save}]`:''}</span><span>${effect||desc}</span>`; pp.appendChild(row); }); }
  const cg=$('cs-gear'); if(cg){ cg.innerHTML=''; document.querySelectorAll('#weapons-container [data-idx]').forEach(card=>{ const idx=card.getAttribute('data-idx'); const name=$('weapon'+idx+'Name')?.value||'Weapon'; const dmg=$('weapon'+idx+'Damage')?.value||''; const rng=$('weapon'+idx+'Range')?.value||''; const row=document.createElement('div'); row.className='cs-kv'; row.innerHTML=`<span>${name}</span><span>${dmg}${rng?` (${rng})`:''}</span>`; cg.appendChild(row); }); document.querySelectorAll('#armor-container [data-idx]').forEach(card=>{ const idx=card.getAttribute('data-idx'); const name=$('armor'+idx+'Name')?.value||'Armor'; const slot=$('armor'+idx+'Slot')?.value||''; const bonus=$('armor'+idx+'Bonus')?.value||0; const eq=$('armor'+idx+'Equipped')?.checked?'â˜… ':''; const row=document.createElement('div'); row.className='cs-kv'; row.innerHTML=`<span>${eq}${name} (${slot})</span><span>+${bonus}</span>`; cg.appendChild(row); }); }
  const ci=$('cs-items'); if(ci){ ci.innerHTML=''; document.querySelectorAll('#items-container [data-idx]').forEach(card=>{ const idx=card.getAttribute('data-idx'); const name=$('item'+idx+'Name')?.value||'Item'; const qty=$('item'+idx+'Qty')?.value||1; const notes=$('item'+idx+'Notes')?.value||''; const row=document.createElement('div'); row.className='cs-kv'; row.innerHTML=`<span>${name}</span><span>Ã—${qty}${notes?` â€” ${notes}`:''}</span>`; ci.appendChild(row); }); }
  const sig=$('cs-signature'); if(sig){ const name=$('signatureMoveName')?.value||''; const sp=$('signatureSP')?.value||''; const save=$('signatureSave')?.value||''; const spec=$('signatureSpecial')?.value||''; const desc=$('signatureMoveDescription')?.value||''; sig.innerHTML=`<div class=\"cs-kv\"><span>${name}</span><span>${sp?`SP ${sp}`:''}</span></div><div>${desc||''}</div><div>${save||''} ${spec||''}</div>`; }
  const bs=$('cs-backstory'); if(bs){ const fields=['prePowerLife','powerMoment','powerMeaning','powerFear','walkAway','vulnerability','secret','trustedAlly','teamAdmire','research','trainTinker']; bs.innerHTML=''; fields.forEach(k=>{ const val=$(k)?.value; if(val){ const row=document.createElement('div'); row.className='cs-kv'; row.innerHTML=`<span class=\"cs-title\">${k.replace(/([A-Z])/g,' $1')}</span><span>${val}</span>`; bs.appendChild(row); } }); }
}

$('icon-export')?.addEventListener('click',()=>{ buildPrintSheet(); setTimeout(()=>window.print(),0); });

async function init(){
    await loadCatalog();
    buildSkillsUI(); buildSavesUI();
    updateAll();
    importFromShawnHint();
  }
  init();
});
</script>
</body>
</html>
