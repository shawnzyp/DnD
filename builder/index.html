<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Character Builder</title>
  <meta name="theme-color" content="#0b1014" />
  <link rel="manifest" href="../manifest.webmanifest" />
  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/builder.css" />
  <script src="../js/loader.js" defer></script>
  <script src="../js/app.js" type="module" defer></script>
  
</head>
<body class="app-shell builder-page" data-modules="builder-wizard,builder-summary">
  <a class="skip-link" href="#builder-main">Skip to builder content</a>
  <header class="app-header surface-blur builder-header">
    <div class="builder-header__top">
      <div class="header-group">
        <p class="eyebrow">Character toolkit</p>
        <h1 class="page-title">Character Builder</h1>
      </div>
      <div class="builder-header__actions">
        <button
          type="button"
          id="open-about-modal"
          class="pill-button"
          data-open-about
          aria-haspopup="dialog"
          aria-controls="about-legal-modal"
        >
          About &amp; Legal
        </button>
      </div>
    </div>
    <div class="builder-header__progress">
      <p id="step-indicator" class="builder-header__step" role="status" aria-live="polite">Step 1 of 7 · Identity</p>
      <div
        id="step-progressbar"
        class="sr-only"
        role="progressbar"
        aria-valuemin="1"
        aria-valuemax="7"
        aria-valuenow="1"
        aria-valuetext="Identity"
      ></div>
      <nav id="step-progress" class="step-progress" aria-label="Builder steps">
        <ol>
          <li data-step-item data-step="identity" aria-current="step"><span class="step-index">1</span><span class="step-label">Identity</span></li>
          <li data-step-item data-step="classLevel"><span class="step-index">2</span><span class="step-label">Class &amp; Level</span></li>
          <li data-step-item data-step="abilities"><span class="step-index">3</span><span class="step-label">Ability Scores</span></li>
          <li data-step-item data-step="feats"><span class="step-index">4</span><span class="step-label">Feats</span></li>
          <li data-step-item data-step="equipment"><span class="step-index">5</span><span class="step-label">Equipment</span></li>
          <li data-step-item data-step="familiar"><span class="step-index">6</span><span class="step-label">Companions</span></li>
          <li data-step-item data-step="finalize"><span class="step-index">7</span><span class="step-label">Finalize</span></li>
        </ol>
      </nav>
    </div>
    <p id="builder-pack-meta" class="builder-header__meta" aria-live="polite">Loading System Reference Document…</p>
    <div class="builder-header__controls">
      <div class="pack-buttons">
        <button type="button" id="builder-import-file" class="pill-button">Import JSON</button>
        <button type="button" id="builder-import-url" class="pill-button">Add from URL</button>
        <button type="button" id="builder-reload-packs" class="pill-button">Reload Packs</button>
      </div>
      <p id="builder-pack-status" class="pack-status" aria-live="polite"></p>
    </div>
    <input type="file" id="builder-pack-file" accept="application/json" hidden />
  </header>
  <main class="app-main builder-main" id="builder-main" tabindex="-1">
    <form id="builder-form" class="grid" novalidate>
      <section class="step active" data-step="identity">
        <h2>Identity</h2>
        <label>Character name
          <input type="text" name="name" placeholder="Ailith Stormbreath" required />
        </label>
        <div class="picker-field">
          <span class="picker-label" id="race-picker-label">Race or ancestry</span>
          <button
            type="button"
            class="picker-trigger"
            data-picker-trigger="race"
            aria-haspopup="dialog"
            aria-expanded="false"
            aria-labelledby="race-picker-label race-picker-value"
            data-placeholder="Choose a race"
          >
            <span class="picker-trigger-value" id="race-picker-value" data-picker-value>Choose a race</span>
            <span class="picker-trigger-detail" data-picker-detail></span>
          </button>
          <input type="hidden" name="race" />
        </div>
        <p class="step-hint" data-race-summary aria-live="polite">Choose a race to see ability score bonuses.</p>
        <div class="picker-field">
          <span class="picker-label" id="background-picker-label">Background</span>
          <button
            type="button"
            class="picker-trigger"
            data-picker-trigger="background"
            aria-haspopup="dialog"
            aria-expanded="false"
            aria-labelledby="background-picker-label background-picker-value"
            data-placeholder="Choose a background"
            data-allow-custom="true"
          >
            <span class="picker-trigger-value" id="background-picker-value" data-picker-value>Choose a background</span>
            <span class="picker-trigger-detail" data-picker-detail></span>
          </button>
          <input type="hidden" name="background" />
        </div>
        <label>Alignment
          <select name="alignment">
            <option value="">Select alignment</option>
            <option>Lawful Good</option>
            <option>Neutral Good</option>
            <option>Chaotic Good</option>
            <option>Lawful Neutral</option>
            <option>True Neutral</option>
            <option>Chaotic Neutral</option>
            <option>Lawful Evil</option>
            <option>Neutral Evil</option>
            <option>Chaotic Evil</option>
          </select>
        </label>
      </section>
      <section class="step" data-step="classLevel">
        <h2>Class &amp; Level</h2>
        <div class="class-rows" data-class-rows>
          <div class="class-row" data-class-row>
            <label>
              <span class="class-row-label">Primary class</span>
              <select data-class-select>
                <option value="">Choose a class</option>
              </select>
            </label>
            <label>
              <span class="class-row-label">Level</span>
              <input type="number" min="1" max="20" value="1" data-class-level />
            </label>
            <button type="button" data-class-remove class="class-remove" hidden aria-label="Remove class">Remove</button>
            <input type="hidden" name="classes[]" value='{"class":"","level":1}' />
          </div>
        </div>
        <div class="class-actions">
          <button type="button" data-class-add class="class-add" disabled>Add another class</button>
          <span class="class-total" aria-live="polite">Total level <strong data-class-total>1</strong></span>
        </div>
        <label>Subclass focus
          <input type="text" name="subclass" placeholder="Circle of Stars" />
        </label>
        <ul class="class-warnings" data-class-warnings aria-live="polite"></ul>
        <div class="step-hint" data-class-summary aria-live="polite">
          <span data-class-summary-text>Pick a class to view hit die and proficiencies.</span>
          <ul class="step-hint-list" data-class-summary-warnings hidden></ul>
        </div>
        <input type="hidden" name="level" value="1" data-class-total-field />
      </section>
      <section class="step" data-step="abilities">
        <h2>Ability Scores</h2>
        <div class="grid two">
          <label>Generation method
            <select name="abilityMethod">
              <option value="standard-array">Standard Array (15, 14, 13, 12, 10, 8)</option>
              <option value="point-buy">27-Point Buy</option>
              <option value="roll-4d6-drop">Roll 4d6 (drop lowest)</option>
              <option value="roll-3d6">Roll 3d6</option>
              <option value="manual">Manual Entry</option>
            </select>
          </label>
          <label>Total score pool
            <input type="number" name="scorePool" value="27" />
          </label>
        </div>
        <div class="grid two" id="abilities-grid" data-ability-grid>
          <!-- ability inputs inserted by wizard.js -->
        </div>
        <p class="step-hint" data-ability-summary aria-live="polite">Standard Array · Assign each score once.</p>
      </section>
      <section class="step" data-step="feats">
        <h2>Feats &amp; Talents</h2>
        <div class="feat-toolbar">
          <label>Search feats
            <input type="search" data-feat-search placeholder="Search feats" autocomplete="off" />
          </label>
          <div class="feat-filters" data-feat-filters role="group" aria-label="Feat filters">
            <button type="button" class="pill-button" data-filter="all" aria-pressed="true">All</button>
            <button type="button" class="pill-button" data-filter="available" aria-pressed="false">Available</button>
            <button type="button" class="pill-button" data-filter="locked" aria-pressed="false">Locked</button>
            <button type="button" class="pill-button" data-filter="selected" aria-pressed="false">Selected</button>
          </div>
        </div>
        <div class="feat-grid" data-feat-grid role="list" aria-label="Feat options">
          <p class="feat-empty">Load a ruleset to browse feats.</p>
        </div>
        <p class="step-hint" id="feat-prereqs" data-feat-summary aria-live="polite">
          Browse feats, spend your slots, and review unmet prerequisites.
        </p>
        <label>Bonus feat slots
          <input type="number" name="featBonusSlots" value="0" min="0" step="1" data-feat-bonus />
        </label>
        <input type="hidden" name="feats" value="[]" data-feat-field />
      </section>
      <section class="step" data-step="equipment">
        <h2>Equipment</h2>
        <p class="step-hint" data-equipment-summary aria-live="polite">
          Build your loadout to track proficiency, attunement, and encumbrance.
        </p>
        <div class="equipment-grid" data-equipment-root>
          <div class="equipment-group" data-equipment-group="weapons">
            <h3>Weapons</h3>
            <div class="equipment-controls">
              <input type="search" data-equipment-input placeholder="Search weapons" list="weapon-options" autocomplete="off" />
              <input type="number" min="1" value="1" data-equipment-quantity aria-label="Weapon quantity" />
              <button type="button" data-equipment-action="add" data-equipment-category="weapons">Add</button>
            </div>
            <ul class="equipment-list" data-equipment-list>
              <li class="equipment-empty">No weapons selected.</li>
            </ul>
          </div>
          <div class="equipment-group" data-equipment-group="armor">
            <h3>Armor &amp; Shields</h3>
            <div class="equipment-controls">
              <input type="search" data-equipment-input placeholder="Search armor" list="armor-options" autocomplete="off" />
              <input type="number" min="1" value="1" data-equipment-quantity aria-label="Armor quantity" />
              <button type="button" data-equipment-action="add" data-equipment-category="armor">Add</button>
            </div>
            <ul class="equipment-list" data-equipment-list>
              <li class="equipment-empty">No armor selected.</li>
            </ul>
          </div>
          <div class="equipment-group" data-equipment-group="gear">
            <h3>Adventuring Gear</h3>
            <div class="equipment-controls">
              <input type="search" data-equipment-input placeholder="Search gear" list="gear-options" autocomplete="off" />
              <input type="number" min="1" value="1" data-equipment-quantity aria-label="Gear quantity" />
              <button type="button" data-equipment-action="add" data-equipment-category="gear">Add</button>
            </div>
            <ul class="equipment-list" data-equipment-list>
              <li class="equipment-empty">No gear tracked yet.</li>
            </ul>
          </div>
          <div class="equipment-group" data-equipment-group="attunements">
            <h3>Attunements</h3>
            <p class="equipment-empty" data-equipment-feedback>Choose up to three magic items requiring attunement.</p>
            <div class="equipment-controls">
              <input type="search" data-equipment-input placeholder="Track attuned item" list="attunement-options" autocomplete="off" />
              <button type="button" data-equipment-action="add" data-equipment-category="attunements">Add</button>
            </div>
            <ul class="equipment-list" data-equipment-list>
              <li class="equipment-empty">No attuned items.</li>
            </ul>
          </div>
        </div>
        <input type="hidden" name="equipmentWeapons" value="[]" data-equipment-field="weapons" />
        <input type="hidden" name="equipmentArmor" value="[]" data-equipment-field="armor" />
        <input type="hidden" name="equipmentGear" value="[]" data-equipment-field="gear" />
        <input type="hidden" name="equipmentAttunements" value="[]" data-equipment-field="attunements" />
      </section>
      <section class="step" data-step="familiar">
        <h2>Companions &amp; Familiars</h2>
        <p class="step-hint">Choose a companion to track alongside your character. Filter by challenge rating or prerequisite features, then record overrides and notes for quick reference.</p>
        <div class="companion-picker" data-familiar-root>
          <div class="companion-toolbar">
            <label>Search roster
              <input type="search" data-familiar-search placeholder="Search companions" autocomplete="off" />
            </label>
            <label>Challenge rating
              <select data-familiar-filter="cr">
                <option value="">All CR</option>
              </select>
            </label>
            <label>Requires feature
              <select data-familiar-filter="feature">
                <option value="">Any feature</option>
              </select>
            </label>
          </div>
          <div class="companion-body">
            <div class="companion-list" data-familiar-list role="listbox" aria-label="Available companions">
              <p class="companion-empty" data-familiar-empty>No companions loaded yet.</p>
            </div>
            <div class="companion-detail" data-familiar-detail>
              <p>Select a companion to view its statistics and description.</p>
            </div>
          </div>
        </div>
        <div class="wildshape-manager" data-wildshape-root>
          <header class="wildshape-header">
            <div>
              <h3>Wild Shape Forms</h3>
              <p>Track beast forms you can assume, filter them by challenge rating, and store their core statistics.</p>
            </div>
          </header>
          <div class="wildshape-toolbar">
            <label>Search beasts
              <input type="search" data-wildshape-search placeholder="Search beasts" autocomplete="off" />
            </label>
            <label>Max CR
              <select data-wildshape-filter="cr">
                <option value="">Any CR</option>
              </select>
            </label>
          </div>
          <div class="wildshape-body">
            <div class="wildshape-list" data-wildshape-list role="listbox" aria-label="Available beasts">
              <p class="wildshape-empty" data-wildshape-empty>No beast forms loaded yet.</p>
            </div>
            <div class="wildshape-detail" data-wildshape-detail>
              <p>Select a beast to review its statistics. Add tracked forms for quick access in the summary.</p>
            </div>
            <div class="wildshape-tracked" data-wildshape-tracked>
              <h4>Tracked forms</h4>
              <p class="wildshape-tracked-empty" data-wildshape-tracked-empty>No forms tracked yet.</p>
              <ul class="wildshape-tracked-list" data-wildshape-tracked-list></ul>
            </div>
          </div>
        </div>
        <div class="companion-fields">
          <label>Companion name
            <input type="text" name="familiarName" placeholder="Nimbus" data-familiar-name />
          </label>
          <div class="companion-overrides">
            <label>AC override
              <input type="number" min="0" step="1" inputmode="numeric" data-familiar-override="ac" placeholder="Use base AC" />
            </label>
            <label>HP override
              <input type="number" min="0" step="1" inputmode="numeric" data-familiar-override="hp" placeholder="Use base HP" />
            </label>
            <label>Speed override
              <input type="text" data-familiar-override="speed" placeholder="e.g. 30 ft., fly 60 ft." />
            </label>
          </div>
          <label>Notes
            <textarea name="familiarNotes" placeholder="Track hit points, special abilities, and personality" data-familiar-notes></textarea>
          </label>
        </div>
        <input type="hidden" name="familiarData" value="{}" data-familiar-field />
      </section>
      <section class="step" data-step="finalize" id="finalize">
        <h2>Finalize &amp; Export</h2>
        <p style="margin:0 0 0.75rem;color:var(--muted);">Review your summary, generate a printable sheet, or export your data for VTT import.</p>
        <div class="grid">
          <button type="button" data-action="print" class="ghost" style="justify-self:flex-start;">Print builder sheet</button>
          <button type="button" data-action="export" class="ghost" style="justify-self:flex-start;">Export JSON</button>
          <button type="button" data-action="import" class="ghost" style="justify-self:flex-start;">Import JSON</button>
          <button type="button" data-action="share" class="ghost" style="justify-self:flex-start;">Share link</button>
        </div>
        <p data-share-details style="color:var(--muted);margin:0.5rem 0 0;">Preparing share details…</p>
        <p data-share-status aria-live="polite" style="margin:0.25rem 0 0;color:var(--muted);" hidden></p>
        <small style="color:var(--muted);">Your progress is saved automatically.</small>
      </section>
    </form>
  </main>
  <datalist id="item-options"></datalist>
  <datalist id="weapon-options"></datalist>
  <datalist id="armor-options"></datalist>
  <datalist id="gear-options"></datalist>
  <datalist id="attunement-options"></datalist>
  <p class="legal-link">
    <button type="button" data-open-about aria-haspopup="dialog" aria-controls="about-legal-modal">About &amp; Legal</button>
    ·
    <a href="../LEGAL/NOTICE.txt" target="_blank" rel="noopener noreferrer">Open SRD 5.1 notice</a>
  </p>
  <aside id="summary-panel" aria-live="polite">
    <div id="summary-root" class="summary-empty">Start filling out the wizard to see your live sheet.</div>
  </aside>
  <nav class="sticky-nav" aria-label="Wizard navigation">
    <div class="nav-group utility">
      <button type="button" class="ghost" id="builder-undo" aria-label="Undo last change" disabled>Undo</button>
      <button type="button" class="ghost" id="builder-redo" aria-label="Redo change" disabled>Redo</button>
      <button type="button" class="ghost" id="builder-export-state">Export</button>
      <button type="button" class="ghost" id="builder-import-state">Import</button>
    </div>
    <div class="nav-group primary">
      <button type="button" class="secondary" id="prev-step">Back</button>
      <button type="button" class="ghost" id="toggle-summary">Summary</button>
      <button type="button" class="primary" id="next-step">Next</button>
    </div>
  </nav>
  <input type="file" id="builder-state-file" accept="application/json" hidden />
  <div id="about-legal-modal" aria-hidden="true">
    <div class="modal-backdrop" data-close-modal></div>
    <section class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="about-legal-title" tabindex="-1">
      <div class="modal-header">
        <h2 id="about-legal-title">About Quest Kit</h2>
        <button type="button" class="modal-close" data-close-modal aria-label="Close about and legal modal">×</button>
      </div>
      <section>
        <h3>Builder flow</h3>
        <p>Move step by step through the identity, class, abilities, equipment, and familiar sections. Your selections are saved automatically every time you type or change a field.</p>
      </section>
      <section>
        <h3>Data packs</h3>
        <p>Quest Kit merges SRD 5.1 data with any custom packs you have imported. You can manage packs from the home screen, and their sources are listed in the builder header for quick reference.</p>
      </section>
      <section>
        <h3>Offline &amp; PWA tips</h3>
        <p>The builder caches your progress locally using IndexedDB so you can pick up where you left off offline. Add Quest Kit to your home screen to use it as an installable PWA with background sync when you reconnect.</p>
      </section>
      <section>
        <h3>SRD 5.1 legal notice</h3>
        <p>Quest Kit uses material from the official System Reference Document. Review the summary below or <a href="../LEGAL/NOTICE.txt" target="_blank" rel="noopener noreferrer">open the full notice</a>.</p>
        <pre id="legal-notice-text">Loading legal notice…</pre>
      </section>
    </section>
  </div>
  <div class="coachmark-overlay" id="coachmark-overlay" aria-hidden="true"></div>
  <script>
    (function () {
      const root = document.documentElement;
      const updateViewportMetrics = () => {
        const viewport = window.visualViewport;
        if (viewport) {
          const height = viewport.height;
          const bottomOffset = Math.max(
            0,
            window.innerHeight - (viewport.height + viewport.offsetTop)
          );
          root.style.setProperty('--viewport-height', `${height}px`);
          root.style.setProperty('--viewport-bottom-offset', `${bottomOffset}px`);
        } else {
          root.style.setProperty('--viewport-height', `${window.innerHeight}px`);
          root.style.setProperty('--viewport-bottom-offset', '0px');
        }
      };
      updateViewportMetrics();
      window.addEventListener('resize', updateViewportMetrics);
      if ('onorientationchange' in window) {
        window.addEventListener('orientationchange', updateViewportMetrics);
      }
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', updateViewportMetrics);
        window.visualViewport.addEventListener('scroll', updateViewportMetrics);
      }
    })();
  </script>
  <script src="./wizard.js" type="module" defer></script>
  <script src="./summary.js" type="module" defer></script>
</body>
</html>
