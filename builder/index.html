<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Character Builder</title>
  <link rel="preload" href="/builder/wizard.js" as="script">
  <script src="/js/loader.js" defer></script>
  <style>
    :root {
      color-scheme: dark light;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --bg: #0d1117;
      --fg: #f4f6fb;
      --muted: rgba(244, 246, 251, 0.7);
      --surface: rgba(244, 246, 251, 0.05);
      --accent: #5bd6a0;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 1rem 1.5rem 0.5rem;
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(13,17,23,0.95) 0%, rgba(13,17,23,0.5) 100%);
      backdrop-filter: blur(20px);
      z-index: 3;
      display: grid;
      gap: 0.35rem;
    }
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    h1 {
      margin: 0;
      font-size: 1.35rem;
    }
    .header-actions {
      display: flex;
      gap: 0.5rem;
    }
    #open-about-modal {
      padding: 0.45rem 0.85rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.08);
      color: var(--fg);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
    }
    #open-about-modal:hover,
    #open-about-modal:focus {
      background: rgba(91, 214, 160, 0.18);
      border-color: rgba(91, 214, 160, 0.4);
      outline: none;
    }
    #step-indicator {
      margin: 0;
      font-size: 0.82rem;
      color: var(--muted);
    }
    .pack-meta {
      margin: 0.25rem 0 0;
      font-size: 0.75rem;
      color: var(--muted);
    }
    .pack-controls {
      margin-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .pack-controls .pack-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .pill-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.08);
      color: var(--fg);
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: background 140ms ease, border-color 140ms ease, transform 140ms ease;
    }
    .pill-button:hover {
      background: rgba(255, 255, 255, 0.14);
      border-color: rgba(255, 255, 255, 0.28);
      transform: translateY(-1px);
    }
    .pill-button:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .pack-status {
      margin: 0;
      flex: 1;
      min-width: 160px;
      font-size: 0.72rem;
      color: var(--muted);
    }
    main {
      flex: 1;
      padding: 1rem 1.5rem 7rem;
      display: grid;
      gap: 1.25rem;
    }
    section.step {
      display: none;
      flex-direction: column;
      gap: 0.75rem;
    }
    section.step.active {
      display: flex;
    }
    .step h2 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
    }
    label {
      display: grid;
      gap: 0.35rem;
      font-size: 0.82rem;
      color: var(--muted);
    }
    input, select, textarea {
      padding: 0.75rem 0.8rem;
      border-radius: 0.8rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.05);
      color: var(--fg);
      font-size: 0.95rem;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    .grid {
      display: grid;
      gap: 0.75rem;
    }
    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }
    .ability {
      display: grid;
      gap: 0.35rem;
      padding: 0.75rem;
      border-radius: 0.8rem;
      background: rgba(91, 214, 160, 0.12);
      border: 1px solid rgba(91, 214, 160, 0.25);
      color: var(--fg);
    }
    .ability span {
      font-size: 0.75rem;
      color: var(--muted);
    }
    .sticky-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      padding: 0.75rem calc(env(safe-area-inset-left) + 1rem) calc(env(safe-area-inset-bottom) + 1rem);
      gap: 0.75rem;
      background: linear-gradient(180deg, rgba(13,17,23,0.2) 0%, rgba(13,17,23,0.95) 80%);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      z-index: 5;
    }
    .sticky-nav button {
      flex: 1;
      padding: 0.85rem 1rem;
      border-radius: 0.9rem;
      border: none;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 120ms ease, background 120ms ease;
    }
    .sticky-nav button.primary {
      background: var(--accent);
      color: #042417;
    }
    .sticky-nav button.secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--fg);
    }
    .sticky-nav button.ghost {
      flex: 0.75;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--muted);
    }
    #summary-panel {
      position: fixed;
      inset: auto 0 calc(env(safe-area-inset-bottom) + 4.5rem);
      margin: 0 1rem;
      background: rgba(13,17,23,0.94);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 1rem;
      padding: 0;
      max-height: clamp(320px, 45vh, 520px);
      overflow-y: auto;
      transform: translateY(110%);
      transition: transform 220ms ease;
      z-index: 4;
      box-shadow: 0 1.5rem 3.5rem -1.5rem rgba(0,0,0,0.6);
    }
    #summary-panel.visible {
      transform: translateY(0);
    }
    #summary-root {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      padding: 1.1rem 1.25rem 1.4rem;
    }
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
    }
    .summary-header h3 {
      margin: 0;
      font-size: 1.05rem;
    }
    .summary-header p {
      margin: 0.25rem 0 0;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .summary-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-end;
    }
    .summary-actions button {
      border-radius: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.05);
      color: var(--fg);
      font-size: 0.75rem;
      padding: 0.45rem 0.75rem;
      cursor: pointer;
    }
    .summary-actions button.primary {
      background: var(--accent);
      color: #042417;
      border-color: transparent;
    }
    .summary-accordion {
      display: grid;
      gap: 0.75rem;
    }
    .summary-accordion details {
      border-radius: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.03);
      padding: 0.1rem 0.9rem 0.9rem;
    }
    .summary-accordion details summary {
      list-style: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      margin: 0 -0.2rem;
      padding: 0.65rem 0.2rem;
    }
    .summary-accordion details summary::-webkit-details-marker {
      display: none;
    }
    .summary-accordion details[open] summary {
      color: var(--accent);
    }
    .summary-accordion .section-body {
      display: grid;
      gap: 0.6rem;
      font-size: 0.82rem;
    }
    .abilities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.65rem;
    }
    .ability-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      padding: 0.6rem 0.75rem;
      display: grid;
      gap: 0.4rem;
    }
    .ability-card header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    .ability-card strong {
      font-size: 1.2rem;
    }
    .ability-card span.modifier {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .resource-grid {
      display: grid;
      gap: 0.65rem;
    }
    .resource-grid .resource-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      padding: 0.7rem 0.75rem;
      display: grid;
      gap: 0.5rem;
    }
    .resource-card h4 {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .resource-card label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.78rem;
      color: var(--muted);
    }
    .resource-card input, .resource-card select {
      border-radius: 0.6rem;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color: var(--fg);
      padding: 0.4rem 0.5rem;
      font-size: 0.8rem;
      min-width: 0;
    }
    .counter-list {
      display: grid;
      gap: 0.6rem;
    }
    .counter-item {
      display: grid;
      gap: 0.5rem;
      background: rgba(255,255,255,0.05);
      padding: 0.65rem 0.75rem;
      border-radius: 0.75rem;
    }
    .counter-item header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .counter-controls {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .counter-controls input, .counter-controls select {
      width: 60px;
      text-align: center;
    }
    .counter-controls button {
      border-radius: 0.6rem;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.06);
      color: var(--fg);
      font-size: 0.75rem;
      padding: 0.3rem 0.5rem;
      cursor: pointer;
    }
    .summary-banner {
      background: rgba(91,214,160,0.12);
      border: 1px solid rgba(91,214,160,0.35);
      color: var(--fg);
      border-radius: 0.75rem;
      padding: 0.6rem 0.75rem;
      font-size: 0.78rem;
      display: grid;
      gap: 0.4rem;
    }
    .summary-banner button {
      justify-self: flex-start;
      border-radius: 0.6rem;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: var(--fg);
      font-size: 0.75rem;
      padding: 0.35rem 0.55rem;
      cursor: pointer;
    }
    .summary-empty {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .summary-toast {
      font-size: 0.76rem;
      color: var(--muted);
      text-align: right;
    }
    .legal-link {
      padding: 0.75rem 1.5rem;
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
    }
    .legal-link button,
    .legal-link a {
      font: inherit;
      color: inherit;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    .legal-link button:hover,
    .legal-link button:focus {
      text-decoration: underline;
      outline: none;
    }
    #about-legal-modal {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 10;
    }
    #about-legal-modal.visible {
      display: block;
    }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(7, 11, 17, 0.75);
      backdrop-filter: blur(12px);
    }
    .modal-panel {
      position: absolute;
      inset: auto 1rem 1.5rem;
      background: rgba(13,17,23,0.97);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 1rem;
      padding: 1.25rem 1.35rem;
      max-height: min(80vh, 640px);
      overflow-y: auto;
      box-shadow: 0 1.5rem 3.5rem -1.25rem rgba(0,0,0,0.65);
      display: grid;
      gap: 1rem;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }
    .modal-close {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--fg);
      border-radius: 999px;
      width: 2rem;
      height: 2rem;
      font-size: 1.1rem;
      line-height: 1;
      cursor: pointer;
    }
    .modal-close:hover,
    .modal-close:focus {
      background: rgba(91, 214, 160, 0.2);
      border-color: rgba(91, 214, 160, 0.4);
      outline: none;
    }
    .modal-panel section {
      display: grid;
      gap: 0.4rem;
    }
    .modal-panel h3 {
      margin: 0;
      font-size: 0.95rem;
    }
    #legal-notice-text {
      background: rgba(255,255,255,0.04);
      border-radius: 0.75rem;
      padding: 0.75rem;
      white-space: pre-wrap;
      font-size: 0.72rem;
      line-height: 1.45;
    }
    #about-legal-modal a {
      color: var(--accent);
    }
    body.modal-open {
      overflow: hidden;
    }
    .coachmark-overlay {
      position: fixed;
      inset: 0;
      z-index: 9;
      display: none;
    }
    .coachmark-overlay.active {
      display: block;
    }
    .coachmark-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(7, 11, 17, 0.65);
      backdrop-filter: blur(4px);
    }
    .coachmark-card {
      position: absolute;
      max-width: 320px;
      background: rgba(13,17,23,0.95);
      border-radius: 0.9rem;
      border: 1px solid rgba(91, 214, 160, 0.35);
      padding: 1rem 1.1rem;
      display: grid;
      gap: 0.6rem;
      box-shadow: 0 1.25rem 3rem -1.5rem rgba(0,0,0,0.65);
    }
    .coachmark-card h3 {
      margin: 0;
      font-size: 0.9rem;
    }
    .coachmark-card p {
      margin: 0;
      font-size: 0.78rem;
      color: var(--muted);
    }
    .coachmark-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    .coachmark-actions button {
      border: none;
      border-radius: 999px;
      padding: 0.45rem 0.85rem;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .coachmark-actions button.primary {
      background: var(--accent);
      color: #042417;
      font-weight: 600;
    }
    .coachmark-actions button.secondary {
      background: rgba(255,255,255,0.08);
      color: var(--fg);
    }
    .coachmark-highlight {
      position: relative;
      box-shadow: 0 0 0 2px rgba(91, 214, 160, 0.8), 0 0 0 8px rgba(91, 214, 160, 0.2);
      border-radius: 0.9rem;
      transition: box-shadow 160ms ease;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <h1>Character Builder</h1>
      <div class="header-actions">
        <button type="button" id="open-about-modal" data-open-about aria-haspopup="dialog" aria-controls="about-legal-modal">About &amp; Legal</button>
      </div>
    </div>
    <p id="step-indicator">Step 1 of 7 · Identity</p>
    <p id="builder-pack-meta" class="pack-meta" aria-live="polite">Loading System Reference Document…</p>
    <div class="pack-controls">
      <div class="pack-buttons">
        <button type="button" id="builder-import-file" class="pill-button">Import JSON</button>
        <button type="button" id="builder-import-url" class="pill-button">Add from URL</button>
        <button type="button" id="builder-reload-packs" class="pill-button">Reload Packs</button>
      </div>
      <p id="builder-pack-status" class="pack-status" aria-live="polite"></p>
    </div>
    <input type="file" id="builder-pack-file" accept="application/json" hidden />
  </header>
  <main>
    <form id="builder-form" class="grid" novalidate>
      <section class="step active" data-step="identity">
        <h2>Identity</h2>
        <label>Character name
          <input type="text" name="name" placeholder="Ailith Stormbreath" required />
        </label>
        <label>Background
          <input type="text" name="background" placeholder="Wanderer" list="background-options" />
        </label>
        <label>Alignment
          <select name="alignment">
            <option value="">Select alignment</option>
            <option>Lawful Good</option>
            <option>Neutral Good</option>
            <option>Chaotic Good</option>
            <option>Lawful Neutral</option>
            <option>True Neutral</option>
            <option>Chaotic Neutral</option>
            <option>Lawful Evil</option>
            <option>Neutral Evil</option>
            <option>Chaotic Evil</option>
          </select>
        </label>
      </section>
      <section class="step" data-step="classLevel">
        <h2>Class &amp; Level</h2>
        <div class="grid two">
          <label>Primary class
            <select name="class">
              <option value="">Choose a class</option>
            </select>
          </label>
          <label>Level
            <input type="number" min="1" max="20" name="level" value="1" />
          </label>
        </div>
        <label>Subclass focus
          <input type="text" name="subclass" placeholder="Circle of Stars" />
        </label>
      </section>
      <section class="step" data-step="abilities">
        <h2>Ability Scores</h2>
        <div class="grid two">
          <label>Generation method
            <select name="abilityMethod">
              <option>Standard Array</option>
              <option>Point Buy</option>
              <option>Manual Entry</option>
            </select>
          </label>
          <label>Total score pool
            <input type="number" name="scorePool" value="27" />
          </label>
        </div>
        <div class="grid two" id="abilities-grid">
          <!-- ability inputs inserted by wizard.js -->
        </div>
      </section>
      <section class="step" data-step="feats">
        <h2>Feats &amp; Talents</h2>
        <label>Signature feat
          <input type="text" name="signatureFeat" placeholder="Alert" list="feat-options" />
        </label>
        <label>Bonus feats
          <textarea name="bonusFeats" placeholder="Great Weapon Master, Mage Slayer"></textarea>
        </label>
      </section>
      <section class="step" data-step="equipment">
        <h2>Equipment</h2>
        <label>Weapon loadout
          <textarea name="weapons" placeholder="Longsword, hand crossbow"></textarea>
        </label>
        <label>Armor &amp; defenses
          <textarea name="armor" placeholder="Half-plate, cloak of protection"></textarea>
        </label>
        <label>Adventuring gear
          <input type="text" name="gear" placeholder="Explorer's pack, sending stones" list="item-options" />
        </label>
      </section>
      <section class="step" data-step="familiar">
        <h2>Companions &amp; Familiars</h2>
        <label>Companion name
          <input type="text" name="familiarName" placeholder="Nimbus" />
        </label>
        <label>Creature type
          <select name="familiarType">
            <option value="">Select a creature</option>
          </select>
        </label>
        <label>Notes
          <textarea name="familiarNotes" placeholder="Track hit points, special abilities, and personality"></textarea>
        </label>
      </section>
      <section class="step" data-step="finalize" id="finalize">
        <h2>Finalize &amp; Export</h2>
        <p style="margin:0 0 0.75rem;color:var(--muted);">Review your summary, generate a printable sheet, or export your data for VTT import.</p>
        <div class="grid">
          <button type="button" data-action="print" class="ghost" style="justify-self:flex-start;">Print builder sheet</button>
          <button type="button" data-action="export" class="ghost" style="justify-self:flex-start;">Export JSON</button>
        </div>
        <small style="color:var(--muted);">Your progress is saved automatically.</small>
      </section>
    </form>
  </main>
  <datalist id="background-options"></datalist>
  <datalist id="feat-options"></datalist>
  <datalist id="item-options"></datalist>
  <p class="legal-link">
    <button type="button" data-open-about aria-haspopup="dialog" aria-controls="about-legal-modal">About &amp; Legal</button>
    ·
    <a href="/LEGAL/NOTICE.txt" target="_blank" rel="noopener noreferrer">Open SRD 5.1 notice</a>
  </p>
  <aside id="summary-panel" aria-live="polite">
    <div id="summary-root" class="summary-empty">Start filling out the wizard to see your live sheet.</div>
  </aside>
  <nav class="sticky-nav" aria-label="Wizard navigation">
    <button type="button" class="secondary" id="prev-step">Back</button>
    <button type="button" class="ghost" id="toggle-summary">Summary</button>
    <button type="button" class="primary" id="next-step">Next</button>
  </nav>
  <div id="about-legal-modal" aria-hidden="true">
    <div class="modal-backdrop" data-close-modal></div>
    <section class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="about-legal-title" tabindex="-1">
      <div class="modal-header">
        <h2 id="about-legal-title">About Quest Kit</h2>
        <button type="button" class="modal-close" data-close-modal aria-label="Close about and legal modal">×</button>
      </div>
      <section>
        <h3>Builder flow</h3>
        <p>Move step by step through the identity, class, abilities, equipment, and familiar sections. Your selections are saved automatically every time you type or change a field.</p>
      </section>
      <section>
        <h3>Data packs</h3>
        <p>Quest Kit merges SRD 5.1 data with any custom packs you have imported. You can manage packs from the home screen, and their sources are listed in the builder header for quick reference.</p>
      </section>
      <section>
        <h3>Offline &amp; PWA tips</h3>
        <p>The builder caches your progress locally using IndexedDB so you can pick up where you left off offline. Add Quest Kit to your home screen to use it as an installable PWA with background sync when you reconnect.</p>
      </section>
      <section>
        <h3>SRD 5.1 legal notice</h3>
        <p>Quest Kit uses material from the official System Reference Document. Review the summary below or <a href="/LEGAL/NOTICE.txt" target="_blank" rel="noopener noreferrer">open the full notice</a>.</p>
        <pre id="legal-notice-text">Loading legal notice…</pre>
      </section>
    </section>
  </div>
  <div class="coachmark-overlay" id="coachmark-overlay" aria-hidden="true"></div>
  <script src="/builder/wizard.js" type="module" defer></script>
  <script src="/builder/summary.js" type="module" defer></script>
</body>
</html>
